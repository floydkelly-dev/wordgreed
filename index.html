<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Greed</title>
    <link id="favicon" rel="icon" href="https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Lobster+Two:ital,wght@1,700&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9BVWMWR6X5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9BVWMWR6X5');
    </script>
    <style>
        :root {
            --primary-color: #a78bfa; --primary-color-dark: #8b5cf6; --primary-color-light: #c4b5fd; --primary-text-dark: #1e1b4b; --panel-bg: rgba(55, 25, 85, 0.4); --panel-border: rgba(167, 139, 250, 0.3);
        }
        body.theme-red { --primary-color: #f87171; --primary-color-dark: #ef4444; --primary-color-light: #fca5a5; --primary-text-dark: #7f1d1d; --panel-bg: rgba(127, 29, 29, 0.4); --panel-border: rgba(239, 68, 68, 0.3); }
        body.theme-green { --primary-color: #4ade80; --primary-color-dark: #22c55e; --primary-color-light: #86efac; --primary-text-dark: #14532d; --panel-bg: rgba(22, 101, 52, 0.4); --panel-border: rgba(34, 197, 94, 0.3); }
        body.theme-blue { --primary-color: #60a5fa; --primary-color-dark: #3b82f6; --primary-color-light: #93c5fd; --primary-text-dark: #1e3a8a; --panel-bg: rgba(30, 58, 138, 0.4); --panel-border: rgba(59, 130, 246, 0.3); }
        body.theme-christmas { --primary-color: #ef4444; --primary-color-dark: #b91c1c; --primary-color-light: #fca5a5; --primary-text-dark: #fef2f2; --panel-bg: rgba(22, 101, 52, 0.6); --panel-border: rgba(220, 38, 38, 0.5); }
        body.theme-halloween { --primary-color: #f97316; --primary-color-dark: #ea580c; --primary-color-light: #fb923c; --primary-text-dark: #fef2f2; --panel-bg: rgba(28, 25, 23, 0.6); --panel-border: rgba(249, 115, 22, 0.5); }
        body.theme-winter { --primary-color: #67e8f9; --primary-color-dark: #0891b2; --primary-color-light: #a5f3fc; --primary-text-dark: #0c4a6e; --panel-bg: rgba(224, 242, 254, 0.4); --panel-border: rgba(56, 189, 248, 0.5); }
        body.theme-beach { --primary-color: #2dd4bf; --primary-color-dark: #0d9488; --primary-color-light: #5eead4; --primary-text-dark: #0f766e; --panel-bg: rgba(253, 230, 138, 0.4); --panel-border: rgba(6, 182, 212, 0.5); }
        body.theme-grove { --primary-color: #f59e0b; --primary-color-dark: #d97706; --primary-color-light: #fbbf24; --primary-text-dark: #1a2e05; --panel-bg: rgba(34, 197, 94, 0.4); --panel-border: rgba(134, 239, 172, 0.5); }
        body.theme-dark-purple { --primary-color: #5b21b6; --primary-color-dark: #4c1d95; --primary-color-light: #7c3aed; --primary-text-dark: #e0e7ff; --panel-bg: rgba(23, 2, 46, 0.5); --panel-border: rgba(109, 40, 217, 0.5); }
        body.theme-grayscale { --primary-color: #9ca3af; --primary-color-dark: #6b7280; --primary-color-light: #d1d5db; --primary-text-dark: #f3f4f6; --panel-bg: rgba(107, 114, 128, 0.4); --panel-border: rgba(156, 163, 175, 0.5); }
        body.theme-stage-lights { --primary-color: #ec4899; --primary-color-dark: #db2777; --primary-color-light: #f472b6; --primary-text-dark: #fdf2f8; --panel-bg: rgba(13, 13, 33, 0.6); --panel-border: rgba(236, 72, 153, 0.5); }
        body.theme-dark-aqua { --primary-color: #2dd4bf; --primary-color-dark: #14b8a6; --primary-color-light: #5eead4; --primary-text-dark: #ccfbf1; --panel-bg: rgba(15, 23, 42, 0.6); --panel-border: rgba(6, 182, 212, 0.5); }
        body.theme-brownstone { --primary-color: #a16207; --primary-color-dark: #854d0e; --primary-color-light: #ca8a04; --primary-text-dark: #fefce8; --panel-bg: rgba(66, 32, 6, 0.6); --panel-border: rgba(161, 98, 7, 0.5); }
        
        @keyframes move-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(125deg, #000000, #0c1e42, #1e3a8a, #000000); background-size: 400% 400%; animation: move-gradient 20s ease infinite; overflow: hidden; }
        
        #physics-canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 100; }

        .game-title-style { 
            font-family: 'Lobster Two', cursive; 
            color: #FDD835;
            font-weight: 700; 
            font-style: italic; 
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 3px 0 #4a2c0f, 3px 3px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .coin-rotate { display: inline-block; animation: spin 5s linear infinite; }
        @keyframes fly-along-path { 0% { offset-distance: 0%; opacity: 1; transform: scale(1); } 100% { offset-distance: 100%; opacity: 0; transform: scale(0.5); } }
        @keyframes emoji-fly-to-orb { 0% { opacity: 1; transform: scale(1.5) rotate(0deg); } 100% { opacity: 0.5; transform: scale(0.5) rotate(180deg); } }
        @keyframes coin-swirl-in { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 100% { transform: scale(0) rotate(360deg); opacity: 0; } }
        @keyframes diamond-vortex { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(720deg); opacity: 0; } }
        @keyframes game-over-swirl { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(-360deg); opacity: 0; } }
        .coin { position: absolute; top: 0; left: 0; width: 20px; height: 20px; background-color: #FFD700; border-radius: 50%; border: 2px solid #B8860B; pointer-events: none; z-index: 100; }
        @keyframes pulse-glow-red { 0%, 100% { box-shadow: 0 0 8px #ef4444, 0 0 15px #ef4444; } 50% { box-shadow: 0 0 12px #f87171, 0 0 25px #f87171; } }
        @keyframes pulse-glow-fire { 0%, 100% { box-shadow: 0 0 10px #fb923c, 0 0 20px #fb923c; } 50% { box-shadow: 0 0 15px #f97316, 0 0 30px #f97316; } }
        @keyframes wild-pulse-animation { 0%, 100% { transform: scale(1); box-shadow: 0 0 15px #F59E0B, 0 0 30px #F59E0B; } 50% { transform: scale(1.2) rotate(10deg); box-shadow: 0 0 25px #facc15, 0 0 50px #facc15; } }
        @keyframes big-pulse-animation { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.25); } }
        #jackpot-square.wild-pulse { animation: wild-pulse-animation 0.5s infinite ease-in-out !important; }
        @keyframes endgame-jackpot-pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px #fde047, 0 0 40px #fde047; } 50% { transform: scale(2); box-shadow: 0 0 40px #fbbf24, 0 0 80px #fbbf24; } }
        #jackpot-square.endgame-pulse { animation: endgame-jackpot-pulse 0.5s infinite ease-in-out !important; z-index: 210; }
        #jackpot-square.cooldown { background-color: #4b5563 !important; border-color: #6b7280 !important; cursor: not-allowed; }
        #solve-button.big-pulse { animation: big-pulse-animation 1.5s ease-in-out infinite; }
        .prize-tile { animation: pulse-glow-blue 1.5s infinite; cursor: pointer; font-size: 2rem; }
        .prize-tile.red-bomb { background-color: #ef4444 !important; animation-name: pulse-glow-red; }
        .prize-tile.green-bomb { background-color: #22c55e !important; animation-name: pulse-glow-green; cursor: grab; }
        .prize-tile.fire-bomb { background-color: #f97316 !important; animation-name: pulse-glow-fire; }
        .glass-panel { background-color: rgba(20, 20, 40, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        #start-modal .glass-panel, #welcome-bonus-modal .glass-panel { box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), 0 0 0 2px #f59e0b; }
        .word-puzzle-tile { background-color: #FFFFFF !important; color: #111827 !important; border: 2px solid #d1d5db; cursor: grab; }
        .word-puzzle-tile.dragging { opacity: 0.5; cursor: grabbing; }
        .word-puzzle-tile.solved { background-color: #15803d !important; color: #FFFFFF !important; border-color: #14532d; box-shadow: inset 3px 3px 4px rgba(0, 0, 0, 0.5); cursor: default; }
        .greed-panel { background-color: var(--panel-bg); border: 1px solid var(--panel-border); }
        #solve-button { background-color: var(--primary-color); color: var(--primary-text-dark); border: 1px solid var(--primary-color-light); box-shadow: 0 2px 5px rgba(0,0,0,0.4); transition: all 0.2s ease; flex-shrink: 0; }
        #solve-button:hover { background-color: var(--primary-color-dark); color: #FFFFFF; }
        #solve-button:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        #solve-button:disabled { background-color: #6b7280; color: #d1d5db; cursor: not-allowed; }
        #solve-button.cooldown-timer { font-size: 1.25rem; font-family: 'Inter', sans-serif; }
        
        .event-text {
            font-family: 'Lobster Two', cursive; font-size: 5rem; color: #FDD835;
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 2px 0 #4a2c0f, 3px 2px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
            animation: event-flash 2s ease-out forwards;
        }
        .event-text.long-flash { animation-duration: 4s; }
        .event-text.green-glow {
            color: #4ade80;
            text-shadow: -2px -2px 0 #14532d, 2px -2px 0 #14532d, -2px 2px 0 #14532d, 2px 2px 0 #14532d, 0 0 10px #4ade80, 0 0 20px #22c55e;
        }
        @keyframes event-flash { 0%, 100% { opacity: 0; transform: scale(0.8); } 20%, 80% { opacity: 1; transform: scale(1.1); } }
        
        @keyframes button-shimmer { 0% { transform: translateX(-100%) skewX(-15deg); } 100% { transform: translateX(200%) skewX(-15deg); } }
        .glassy-button {
            border: 1px solid; box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease-out; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .glassy-button::before {
            content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: button-shimmer 4s infinite linear;
        }
        .glassy-button:active { transform: translateY(2px); border-bottom-width: 2px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); }
        @keyframes start-button-pulse { 0%, 100% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } 5% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 20px #3b82f6, 0 0 40px #3b82f6; } 15% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } }
        #start-game-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; animation: start-button-pulse 15s infinite; }
        #claim-bonus-button { background: linear-gradient(145deg, #16a34a, #15803d); border-color: #4ade80; border-bottom: 4px solid #14532d; }
        #play-again-button { background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af; border-bottom: 4px solid #1f2937; }
        #close-help-button, #close-about-button, #close-playlist-button, #close-setup-button, #close-daily-rewards-button, #close-trading-post-button, #close-riches-button, #close-tips-button, #close-privacy-button, #close-giving-button, #close-give-all-button, #close-badges-button, #close-weather-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; }
        #about-button, #privacy-policy-button { background: linear-gradient(145deg, #8b5cf6, #7c3aed); border-color: #a78bfa; border-bottom: 4px solid #5b21b6; }
        #setup-button, #give-it-all-button, #confirm-give-all-button { background: linear-gradient(145deg, #22c55e, #15803d); border-color: #4ade80; border-bottom: 4px solid #14532d; }
        #weather-button { background: linear-gradient(145deg, #0ea5e9, #0284c7); border-color: #38bdf8; border-bottom: 4px solid #0369a1; }
        #daily-rewards-button { background: linear-gradient(145deg, #f59e0b, #d97706); border-color: #fbbf24; border-bottom: 4px solid #92400e; }
        #tips-button, #badges-button { background: linear-gradient(145deg, #f97316, #ea580c); border-color: #fb923c; border-bottom: 4px solid #c2410c; }
        #confirm-reset-button { background: linear-gradient(145deg, #f87171, #ef4444); border-color: #fca5a5; border-bottom: 4px solid #7f1d1d; }
        
        #freebie-orbs-container { position: absolute; bottom: 1rem; right: 1rem; display: flex; gap: 0.5rem; }
        @keyframes orb-pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px #fff, 0 0 20px var(--glow-color, #fff), 0 0 30px var(--glow-color, #fff); opacity: 0.7; } 50% { transform: scale(1.1); box-shadow: 0 0 20px #fff, 0 0 40px var(--glow-color, #fff), 0 0 60px var(--glow-color, #fff); opacity: 1; } }
        @keyframes orb-tilt { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .freebie-orb {
            width: 3.5rem; height: 3.5rem; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem;
            position: relative;
            animation: orb-pulse 4s infinite ease-in-out;
        }
        .freebie-orb.occupied { animation: orb-pulse 4s infinite ease-in-out, orb-tilt 2s infinite ease-in-out; }
        .freebie-orb::after { content: ''; position: absolute; inset: -2px; border-radius: 50%; background: radial-gradient(circle at 70% 20%, rgba(255,255,255,0.5), transparent); z-index: -1; }
        
        #theme-buttons-container { display: none; } /* Hiding old theme buttons */
        .score-decay { color: #ef4444 !important; }
        .greed-icon {
            width: 3rem; height: 3rem; background-color: var(--primary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.75rem; border: 1px solid var(--primary-color-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); cursor: pointer; color: white;
        }
        @keyframes ice-shimmer { 0% { background-position: -100% 0; } 100% { background-position: 100% 0; } }
        @keyframes crack-fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        .ice-block {
            position: absolute; background: linear-gradient(145deg, rgba(173, 216, 230, 0.5), rgba(135, 206, 250, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.5), 0 4px 6px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 50; overflow: hidden;
        }
        .ice-block::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: ice-shimmer 3s infinite linear;
        }
        #bomb-drag-preview { position: absolute; border: 3px dashed #22c55e; background-color: rgba(34, 197, 94, 0.3); pointer-events: none; z-index: 200; display: none; }
        @keyframes cash-money-pulse { 0%, 100% { box-shadow: 0 0 15px #4ade80, 0 0 30px #4ade80; } 50% { box-shadow: 0 0 25px #22c55e, 0 0 50px #22c55e; } }
        .cash-money-prize { background-color: #16a34a !important; animation: cash-money-pulse 0.7s infinite ease-in-out; }
        @keyframes fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        @keyframes twinkle { 0%, 100% { transform: scale(0); opacity: 0; } 50% { transform: scale(1); opacity: 1; } }
        .falling-coin { position: absolute; font-size: 1.5rem; animation: fall linear forwards; pointer-events: none; }
        .sparkle { position: absolute; width: 8px; height: 8px; background-color: #fde047; border-radius: 50%; box-shadow: 0 0 5px #fde047, 0 0 10px #facc15; animation: twinkle ease-in-out infinite; pointer-events: none; }
        
        @keyframes fall-sway {
            0% { transform: translateY(-100%) translateX(0vw) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            50% { transform: translateY(50vh) translateX(5vw) rotate(180deg); }
            100% { transform: translateY(100vh) translateX(-5vw) rotate(360deg); opacity: 0; }
        }
        .falling-snowflake, .falling-heart, .falling-trophy { position: absolute; top: -10%; font-size: 1.5rem; animation: fall-sway linear forwards; pointer-events: none; z-index: 55; }
        .falling-heart.gray { filter: grayscale(100%); }

        input[type=range].styled-slider { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range].styled-slider:focus { outline: none; }
        input[type=range].styled-slider::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].styled-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; margin-top: -7px; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }
        input[type=range].styled-slider::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].styled-slider::-moz-range-thumb { height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }
        
        #playlist-container { max-height: 220px; overflow-y: auto; background-color: rgba(0,0,0,0.2); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); padding: 0.5rem; border-radius: 0.5rem;}
        .playlist-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; transition: background-color 0.2s; user-select: none; cursor: pointer; }
        .playlist-item:hover { background-color: rgba(0,0,0,0.4); }
        .now-playing-indicator { font-size: 0.75rem; color: var(--primary-color-light); font-style: italic; display: none; }
        .playlist-item.now-playing { background-color: rgba(139, 92, 246, 0.3); }
        .playlist-item.now-playing .now-playing-indicator { display: block; }
        #playlist-controls { background-color: rgba(0,0,0,0.2); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); padding: 0.5rem; border-radius: 9999px; display: flex; align-items: center; gap: 0.5rem;}
        #playlist-controls button { width: 2.5rem; height: 2.5rem; }
        #playlist-shuffle.shuffle-active { background: var(--primary-color); }
        #player-name-input { background-color: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); }
        #player-name-input.invalid-input { border-color: #ef4444 !important; box-shadow: 0 0 8px #ef4444; }
        #theme-store-container { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 1rem; flex-wrap: nowrap; cursor: grab; user-select: none; }
        #theme-store-container.grabbing { cursor: grabbing; }
        #theme-store-container::-webkit-scrollbar { height: 8px; }
        #theme-store-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #theme-store-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        .theme-item {
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
            position: relative; overflow: hidden; flex-shrink: 0; width: 160px; height: 110px;
        }
        .theme-item > div { position: relative; z-index: 1; }
        .theme-item.active { border-color: var(--primary-color-light); box-shadow: 0 0 10px var(--primary-color); }
        .theme-item.locked::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 0.5rem; z-index: 2; }
        .theme-item.locked::after { content: '🔒'; position: absolute; bottom: 0.25rem; right: 0.5rem; font-size: 1.75rem; z-index: 3; transform: none; }
        
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .calendar-day {
            background-color: rgba(0,0,0,0.2); border: 2px solid var(--panel-border);
            border-radius: 0.5rem; padding: 0.25rem; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 80px; position: relative;
        }
        .calendar-day.claimed { background-color: #166534; color: #a7f3d0; cursor: not-allowed; }
        .calendar-day.today { background-color: var(--primary-color); border-color: var(--primary-color-light); cursor: pointer; }
        .calendar-day.today.claimed { background-color: #166534; border-color: #14532d; }
        .calendar-day.future { background-color: rgba(0,0,0,0.1); color: #6b7280; }
        .calendar-day.past-day { background-color: rgba(22, 59, 41, 0.5); color: #4b5563; cursor: not-allowed; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); }
        .calendar-day.double-bonus { border-color: #fde047; }
        .calendar-day.triple-bonus { border-color: #f87171; }
        .day-number { font-weight: bold; font-size: 0.9rem; position: absolute; top: 2px; right: 5px; }
        .reward-text { font-size: 0.65rem; line-height: 1; }
        #calendar-legend { grid-column: span 4; align-self: stretch; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; padding: 0.5rem 0.75rem; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem;}
        
        @keyframes bonus-reveal { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .bonus-item { animation: bonus-reveal 0.5s ease-out forwards; }
        
        @keyframes pulse-glow-warm { 0%, 100% { box-shadow: 0 0 10px #f59e0b, 0 0 20px #f59e0b; } 50% { box-shadow: 0 0 20px #fbbf24, 0 0 40px #fbbf24; } }
        .nonsense-freebie-special {
            background-color: black;
            border: 2px solid #f59e0b;
            animation: pulse-glow-warm 1s infinite ease-in-out;
        }
        @keyframes emoji-flyout { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        
        #help-modal .glass-panel { text-align: center; }
        #help-modal table { margin-left: auto; margin-right: auto; }
        #help-modal-footer { display: flex; flex-direction: column; align-items: center; width: 100%; gap: 0.75rem; }
        
        @keyframes pulse-glow-amber { 0%, 100% { box-shadow: 0 0 15px #f59e0b, 0 0 30px #f59e0b, inset 0 2px 4px rgba(255, 255, 255, 0.4); transform: scale(1); } 50% { box-shadow: 0 0 30px #fbbf24, 0 0 60px #fbbf24, inset 0 2px 4px rgba(255, 255, 255, 0.4); transform: scale(1.05); } }
        .trade-button-pulse { animation: pulse-glow-amber 1.5s infinite ease-in-out; }

        .trade-item, .giving-item { border: 2px solid var(--panel-border); transition: all 0.2s ease-in-out; }
        .trade-item.selected, .giving-item.selected { border-color: var(--primary-color-light); background-color: var(--panel-bg); box-shadow: 0 0 10px var(--primary-color); }

        #tips-carousel { position: relative; width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; }
        .tip-card { background-color: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 1rem; padding: 2rem; width: 80%; text-align: center; font-size: 1.25rem; position: absolute; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        .tip-card.active { opacity: 1; pointer-events: auto; }
        .carousel-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.3); border-radius: 50%; width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 2rem; z-index: 10; }
        .carousel-arrow:hover { background: rgba(0,0,0,0.5); }
        #carousel-prev { left: 1rem; }
        #carousel-next { right: 1rem; }

        #privacy-policy-content {
            background-color: rgba(0,0,0,0.4); border: 1px solid var(--panel-border); box-shadow: inset 2px 2px 8px rgba(0,0,0,0.6);
            padding: 1rem; border-radius: 0.5rem; height: 300px; overflow-y: auto; text-align: left; font-size: 0.875rem; color: #d1d5db;
        }
        
        @keyframes badge-glow { 0%, 100% { box-shadow: 0 0 8px #fde047, 0 0 15px #fde047; } 50% { box-shadow: 0 0 12px #fbbf24, 0 0 25px #fbbf24; } }
        .badge-info-card.earned .badge-info-emoji { animation: badge-glow 2s infinite; }
        .badge-info-card.earned .badge-info-emoji-heart { font-size: 3.5rem; text-shadow: 0 0 10px #f472b6, 0 0 20px #db2777; }
        #badges-panel {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0)); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 2px 4px 0 rgba(0,0,0,0.5);
        }
        .badge-item {
            width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;
            position: relative; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), rgba(255,255,255,0) 70.71%), radial-gradient(circle at 70% 70%, rgba(0,0,0,0.2), rgba(0,0,0,0) 70.71%);
            border: 1px solid rgba(255,255,255,0.1); animation: badge-pulse-glow 3s infinite ease-in-out;
        }
        #badges-info-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; width: 100%; max-height: 50vh; overflow-y: auto; padding: 1rem; }
        .badge-info-card { background-color: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 0.5rem; padding: 0.75rem; display: flex; align-items: center; gap: 1rem; height: 90px; }
        .badge-info-card.locked { opacity: 0.6; }
        .badge-info-emoji { font-size: 3rem; flex-shrink: 0; }
        
        #riches-inventory {
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 1rem; width: 100%;
            max-height: 40vh; overflow-y: auto; padding: 1rem; background-color: rgba(0,0,0,0.2);
            border-radius: 0.5rem; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
        }
        .riches-card { background-color: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 0.5rem; padding: 1rem; text-align: center; }
        
        @keyframes pulse-glow-high-score { 0%, 100% { text-shadow: 0 0 5px #fff, 0 0 10px #fde047, 0 0 15px #fde047, 0 0 20px #fbbf24; } 50% { text-shadow: 0 0 10px #fff, 0 0 20px #fde047, 0 0 30px #fbbf24, 0 0 40px #f59e0b; } }
        #high-score-display {
            text-shadow: 1px 1px 0px #000, -1px -1px 0px #fff, 1px -1px 0px #000, -1px 1px 0px #fff;
            animation: pulse-glow-high-score 3s infinite ease-in-out;
        }
        #total-bags-display, #high-score-display {
             text-shadow: 2px 2px 0 rgba(0,0,0,0.3), 
                         inset 1px 1px 1px rgba(255,255,255,0.2), 
                         inset -1px -1px 1px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">
    <canvas id="physics-canvas"></canvas>
    <script src="config.js" defer></script>

    <!-- Audio Player for background music -->
    <audio id="background-music" loop></audio>

    <!-- Main Game Container -->
    <div id="game-container" class="hidden flex-col md:flex-row gap-4 justify-center md:items-stretch">
        <!-- Game Grid Section -->
        <div class="flex flex-col gap-1 items-center">
            <div class="relative">
                <div id="game-grid" class="grid grid-cols-9 gap-1 bg-slate-800/70 p-3 rounded-xl shadow-2xl border border-slate-700/50"></div>
                <div id="bomb-drag-preview"></div>
            </div>
            <div id="badges-panel" class="w-full mt-2 p-2 rounded-xl flex justify-center items-center gap-2 h-20"></div>
        </div>

        <!-- Score & Control Panel -->
        <div id="score-panel" class="glass-panel p-4 rounded-xl w-full max-w-xs md:w-[20rem] flex flex-col justify-between gap-3 relative">
            <div class="flex-grow flex flex-col gap-2"> 
                <div class="relative w-full h-24 flex justify-center items-center flex-shrink-0">
                    <h1 class="game-title-style text-6xl relative" style="width: 15rem; height: 7rem; left: 1rem;">
                        <span class="absolute" style="top: 0; left: 0;">Word</span>
                        <span class="absolute" style="top: 2.7rem; left: 2.5rem;">Greed</span>
                    </h1>
                </div>
                <div class="p-2 flex justify-around text-center flex-shrink-0">
                    <div><span class="text-sm font-bold text-slate-300">LEVEL</span><div id="level-display" class="text-2xl font-bold text-white">1</div></div>
                    <div><span class="text-sm font-bold text-slate-300">TIME</span><div id="timer-display" class="text-2xl font-bold text-white">10:00</div></div>
                </div>
                <div id="score-container" class="greed-panel p-3 rounded-lg text-center flex flex-col gap-2 flex-grow">
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="text-4xl coin-rotate" style="filter: drop-shadow(0 0 5px #fde047);">🪙</div>
                        <div class="text-4xl" style="filter: drop-shadow(0 0 5px #fde047);">💰</div>
                        <div id="coins-display" class="text-lg font-bold text-white">0</div>
                        <div id="bags-of-money-display" class="text-lg font-bold text-green-400">0</div>
                    </div>
                    <div id="greed-content" class="mx-auto flex flex-col items-center justify-center gap-1 flex-grow">
                        <div class="flex items-center justify-center gap-2"><span class="text-sm font-bold text-violet-200">GREED SCORE</span></div>
                        <hr class="border-violet-300/20 w-full my-1">
                        <div class="flex items-center justify-center gap-2 mt-1">
                            <button id="solve-button" class="w-12 h-12 rounded-full text-3xl font-black flex items-center justify-center">✅</button>
                            <div id="greed-icons-container" class="flex items-center justify-center gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="freebie-orbs-container"></div>
        </div>
    </div>

    <!-- Start Modal -->
    <div id="start-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-panel p-8 pb-12 rounded-2xl text-center flex flex-col items-center gap-6 w-full max-w-md relative overflow-hidden">
            <h1 class="game-title-style text-8xl relative" style="width: 22rem; height: 10rem;">
                <span class="absolute" style="top: 0; left: 1rem;">Word</span>
                <span class="absolute" style="top: 4rem; left: 5rem;">Greed</span>
            </h1>
            <p class="text-lg text-slate-300">Drag and drop letters to solve jumbled words. Grab Big Prizes and Get Greedy!</p>
            <button id="start-game-button" class="glassy-button text-white font-bold py-3 px-8 rounded-lg text-2xl">Start Game</button>
            <div class="absolute bottom-2 right-4 text-xs text-slate-500">v4.0</div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl text-center flex flex-col items-center gap-4 w-full max-w-lg relative overflow-hidden">
             <h3 class="text-3xl font-bold text-amber-300 mb-2">Game Over!</h3>
             <div class="grid grid-cols-2 gap-4 w-full">
                <div id="final-score-panel" class="greed-panel p-4 rounded-lg" style="box-shadow: inset 2px 2px 8px rgba(0,0,0,0.6), 0 1px 1px rgba(255,255,255,0.2);">
                    <h4 class="text-lg font-bold text-slate-300 mb-2">Final Score</h4>
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="text-3xl">🪙</div>
                        <div class="text-3xl">💰</div>
                        <div id="final-coins-display" class="text-lg font-bold text-white">0</div>
                        <div id="final-bags-display" class="text-lg font-bold text-green-400">0</div>
                    </div>
                </div>
                <div id="leaderboard-panel" class="greed-panel p-4 rounded-lg">
                    <h4 class="text-lg font-bold text-slate-300 mb-2">Leaderboard</h4>
                    <div id="leaderboard-list" class="text-left text-sm space-y-1">
                        <p>1. PlayerOne - 1.2B</p>
                        <p>2. You - <span id="leaderboard-your-score">0</span></p>
                        <p>3. PlayerTwo - 800M</p>
                    </div>
                </div>
             </div>
            <button id="play-again-button" class="glassy-button mt-4 text-white font-bold py-3 px-6 rounded-lg text-xl">Play Again</button>
        </div>
    </div>
    
    <div id="event-text-container" class="hidden fixed inset-0 flex items-center justify-center pointer-events-none z-[80]">
        <div id="event-text" class="event-text text-center"></div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-3 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300">How to Play</h2>
            <table class="w-full text-sm my-2">
                <tbody>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">✅</td><td class="py-1 pr-2 font-bold text-green-400">Complete Words</td><td class="py-1 text-slate-300">Drag letters to solve words for <strong>10,000 coins</strong>. Solve all 4 for a big bonus!<br>Press the green checkmark for Quick Solve.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">🎁</td><td class="py-1 pr-2 font-bold text-white">Present</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">1,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">🏆</td><td class="py-1 pr-2 font-bold text-white">Trophy</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">3,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">💎</td><td class="py-1 pr-2 font-bold text-white">Diamond</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">20,000,000</span> coins & board clear.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">⚡</td><td class="py-1 pr-2 font-bold text-white">Lightning</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">20,000</span> coins, but <strong class="text-red-400">resets Bags of Money!</strong></td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">💣</td><td class="py-1 pr-2 font-bold text-green-400">Green Bomb</td><td class="py-1 text-slate-300">Drag to a puzzle to solve key letters & collect prizes.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">💣</td><td class="py-1 pr-2 font-bold text-red-400">Red Bomb</td><td class="py-1 text-slate-300">GAME OVER!</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">❄️</td><td class="py-1 pr-2 font-bold text-blue-300">Snowflake</td><td class="py-1 text-slate-300">Freezes all prizes for 15 seconds.</td></tr>
                </tbody>
            </table>
            <div id="help-modal-footer" class="mt-2">
                <div class="flex justify-center w-full items-center gap-2 max-w-xs mx-auto">
                    <button id="volume-toggle-button" class="text-2xl hover:text-white text-slate-300 transition-colors"></button>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" class="styled-slider">
                </div>
                <div class="flex justify-center w-full flex-wrap items-center gap-2">
                    <button id="playlist-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Playlist</button>
                    <button id="daily-rewards-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Daily</button>
                    <button id="weather-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Weather</button>
                    <button id="tips-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Tips</button>
                    <button id="badges-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Badges</button>
                    <button id="setup-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Setup</button>
                    <button id="about-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">About</button>
                    <button id="close-help-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Close</button>
                </div>
            </div>
            <div class="absolute bottom-2 right-4 text-xs text-slate-500">v4.0</div>
        </div>
    </div>

    <!-- Weather Modal -->
    <div id="weather-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative">
            <h2 class="text-2xl font-bold text-amber-300">Weather Control</h2>
            <p class="text-slate-300 text-center">Adjust the wind speed. The wind always blows from left to right, pushing coins towards the score panel.</p>
            <div class="w-full px-4">
                <label for="wind-speed-slider" class="text-lg font-bold text-white">Wind Speed: <span id="wind-speed-label">Normal</span></label>
                <input type="range" id="wind-speed-slider" min="0" max="2" step="1" value="0" class="styled-slider mt-2">
                <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span>Normal</span>
                    <span>Breezy</span>
                    <span>Wowzers!</span>
                </div>
            </div>
            <button class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-sm mt-4" style="background: linear-gradient(145deg, #38bdf8, #0ea5e9);">Link to Live Weather (Coming Soon)</button>
            <button id="close-weather-button" class="glassy-button mt-2 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Badges Info Modal -->
    <div id="badges-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Badges</h2>
            <div id="badges-info-container"></div>
            <button id="close-badges-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Tips Modal -->
    <div id="tips-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Game Tips</h2>
            <div id="tips-carousel" class="w-full">
                <div id="carousel-prev" class="carousel-arrow">⬅️</div>
                <div id="tip-card-container" class="w-full h-full flex items-center justify-center"></div>
                <div id="carousel-next" class="carousel-arrow">➡️</div>
            </div>
            <button id="close-tips-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">About Word Greed</h2>
            <div class="text-slate-300 space-y-2">
                <p>Created by: <span class="font-bold text-white">Floyd Kelly</span></p>
                <p>Music by: <span class="font-bold text-white">Floyd Kelly and Udio</span></p>
                <p><span class="font-bold text-white">Concept:</span> Floyd Kelly, <span class="font-bold text-white">Code:</span> Google Gemini</p>
                <p>Version: <span class="font-bold text-white">4.0</span></p>
                <p>Build Date: <span class="font-bold text-white">August 13, 2025</span></p>
                <p><a href="https://floydkellycreates.wordpress.com/contact-me/" target="_blank" class="text-purple-300 hover:text-purple-200">Contact the Developer</a></p>
            </div>
            <div class="flex justify-between w-full mt-4">
                <button id="privacy-policy-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-sm">Privacy Policy</button>
                <button id="close-about-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Privacy Policy</h2>
            <div id="privacy-policy-content">Loading...</div>
            <button id="close-privacy-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Playlist Modal -->
    <div id="playlist-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative">
            <h2 class="text-2xl font-bold text-amber-300">Soundtrack Playlist</h2>
            <div id="playlist-container" class="w-full space-y-1 my-2 text-left"></div>
            <div id="playlist-controls" class="flex items-center justify-center gap-4 my-4">
                <button id="playlist-prev" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.006V5.994a1 1 0 00-1.555-.832L4.16 9.168a1 1 0 000 1.664l4.286 4.001zM11 5h2v10h-2V5z"></path></svg></button>
                <button id="playlist-play-pause" class="glassy-button p-3 rounded-full w-14 h-14" style="background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd;"></button>
                <button id="playlist-next" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 5.168A1 1 0 0010 5.994v8.012a1 1 0 001.555.832l4.286-4.001a1 1 0 000-1.664l-4.286-4.001zM7 5h2v10H7V5z"></path></svg></button>
                <button id="playlist-shuffle" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.083 4.083a.75.75 0 011.06 0L9.47 8.414l1.72-1.72a.75.75 0 111.06 1.06l-1.72 1.72 4.327 4.327a.75.75 0 01-1.06 1.06L9.47 10.586l-1.72 1.72a.75.75 0 11-1.06-1.06l1.72-1.72L4.083 5.143a.75.75 0 010-1.06zM6.5 14.25a.75.75 0 01.75-.75h8a.75.75 0 010 1.5h-8a.75.75 0 01-.75-.75zm0-8.5a.75.75 0 01.75-.75h8a.75.75 0 010 1.5h-8a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg></button>
            </div>
            <button id="close-playlist-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Setup & Store Modal -->
    <div id="setup-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Player Setup & Store</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center">
                <div class="greed-panel p-2 rounded-lg"><label for="player-name-input" class="text-sm font-bold text-slate-300">PLAYER NAME</label><input type="text" id="player-name-input" class="w-full mt-1 p-1 rounded-md text-center text-lg font-bold" placeholder="Enter Name"></div>
                <div class="greed-panel p-2 rounded-lg"><div class="text-sm font-bold text-slate-300">TOTAL MONEY BAGS</div><div id="total-bags-display" class="text-2xl font-bold text-green-400">0</div></div>
                <div class="greed-panel p-2 rounded-lg"><div class="text-sm font-bold text-slate-300">Highest Score</div><div id="high-score-display" class="text-2xl font-bold text-white">0</div></div>
            </div>
            <div class="greed-panel p-4 rounded-lg">
                <h3 class="text-lg font-bold text-amber-300 text-left mb-3">Awarded Goodies</h3>
                <div class="flex items-center justify-between">
                    <div id="nonsense-freebies-container" class="grid grid-cols-8 gap-2 flex-grow"></div>
                    <button id="trade-goodies-button" class="glassy-button text-white font-bold rounded-lg text-lg ml-4" style="background: linear-gradient(145deg, #f59e0b, #d97706); border-color: #fbbf24; width: 160px; height: 55px;">Trade</button>
                </div>
            </div>
            <div class="mt-2">
                <h3 class="text-lg font-bold text-amber-300 text-left">Theme Store</h3>
                <div id="theme-store-container" class="mt-2"></div>
            </div>
            <div class="flex justify-between items-center mt-4">
                <div class="flex items-center gap-4">
                    <button id="riches-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-sm" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;">View Riches</button>
                    <div id="user-id-container" class="text-xs text-slate-400"></div>
                </div>
                <button id="reset-progress-button" class="text-xs text-red-400 hover:text-red-300">Reset Progress</button>
                <button id="close-setup-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Reset Modal -->
    <div id="confirm-reset-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-sm relative text-center">
            <h2 class="text-xl font-bold text-red-400">Reset Progress?</h2>
            <p class="text-slate-300">Are you sure? All your stats, money bags, and unlocked themes will be permanently deleted.</p>
            <div class="flex items-center gap-4 mt-4">
                <button id="cancel-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Cancel</button>
                <button id="confirm-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Daily Rewards Modal -->
    <div id="daily-rewards-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Daily Rewards</h2>
            <div id="calendar-grid" class="w-full"></div>
            <button id="close-daily-rewards-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Welcome Bonus Modal -->
    <div id="welcome-bonus-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[70] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">Welcome Back!</h2>
            <p class="text-slate-300">Here's your daily bonus for playing!</p>
            <div id="bonus-rewards-container" class="flex items-center justify-center gap-4 my-4 flex-wrap"></div>
            <button id="claim-bonus-button" class="glassy-button text-white font-bold py-3 px-8 rounded-lg text-xl">Claim!</button>
        </div>
    </div>

    <!-- Trading Post Modal -->
    <div id="trading-post-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Trading Post</h2>
            <div id="available-trades-container" class="grid grid-cols-4 gap-4 mt-4"></div>
            <div class="flex justify-center mt-4 gap-4">
                 <button id="give-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;">Give</button>
                 <button id="execute-trade-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #22c55e, #15803d); border-color: #4ade80;" disabled>Trade</button>
                <button id="close-trading-post-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Giving Modal -->
    <div id="giving-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[70] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Give to Charity</h2>
            <p id="giving-confirmation-text" class="text-slate-300 text-center text-lg">Select an item from your riches to donate and earn a badge!</p>
            <div id="giving-inventory" class="grid grid-cols-4 gap-4 mt-4"></div>
            <div class="flex justify-center mt-4 gap-4">
                <button id="give-it-all-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Give It All Away</button>
                <button id="close-giving-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Give It All Away Modal -->
    <div id="give-all-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[80] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Give It All Away</h2>
            <p class="text-slate-300 text-center">Select a player from the leaderboard to gift your entire inventory to.</p>
            <div class="flex gap-4 mt-4">
                <div class="w-1/2 greed-panel p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-slate-300 mb-2">Your Inventory</h3>
                    <div id="give-all-inventory-list" class="text-left text-sm space-y-1 max-h-48 overflow-y-auto"></div>
                </div>
                <div class="w-1/2 greed-panel p-4 rounded-lg">
                     <h3 class="text-lg font-bold text-slate-300 mb-2">Leaderboard</h3>
                    <div id="give-all-leaderboard-list" class="text-left text-sm space-y-1 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <div class="flex justify-center mt-4 gap-4">
                <button id="confirm-give-all-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" disabled>Confirm Gift</button>
                <button id="close-give-all-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Riches Modal -->
    <div id="riches-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-5xl relative">
             <h2 class="text-2xl font-bold text-amber-300 text-center">Your Riches</h2>
             <div id="riches-inventory" class="min-h-[200px]"></div>
             <hr class="w-full border-t border-slate-600 my-4">
             <div id="net-worth-panel"></div>
             <button id="close-riches-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg self-center">Close</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { Engine, Render, Runner, World, Bodies, Body, Events } = Matter;

        const gridContainer = document.getElementById('game-grid');
        const musicPlayer = document.getElementById('background-music');
        const playerNameInput = document.getElementById('player-name-input');
        const physicsCanvas = document.getElementById('physics-canvas');

        let auth, db, userId, engine, runner;
        let isFirebaseConnected = false;
        let ground, scorePanelBody;
        let wordTileBodies = [];

        let coins = 0, bagsOfMoney = 0, draggedTile = null, playerData = {}, currentLevel = 1;
        const totalGameTime = 600;
        let timeRemaining = totalGameTime, mainTimerInterval = null, prizeSpawnerTimeout = null;
        let diamondSequenceTimeout = null, puzzles = [], trophyCollectedThisLevel = false;
        let diamondCollectedThisLevel = false, currentDiamondValue = 20000000;
        let solveButtonClicks = 0, solveButtonCooldown = 0, solveButtonTimerInterval = null;
        let isGamePaused = true, isGameOver = false, timeSinceLastSolve = 0;
        let scoreDecayInterval = null, impTimeout = null, isFrozen = false, thawTimeout = null;
        let jackpotEventAvailable = true, specialJackpotTimeout = null, specialCashEmojiSpawned = false;
        let timedEvents = { sixMin: true, threeMin: true, heartEvent1: true, heartEvent2: true };
        let isSpecialAnimationActive = false;
        let startModalAnimationInterval = null, maxSameEmoji = 4, isDraggingBomb = false;
        let lastVolume = 0.5, solveButtonPulseManager = null;
        let freezeAnimationInterval = null, heartAnimationInterval = null, gameOverAnimationInterval = null;
        let badgesModalAnimationInterval = null;
        let endgameJackpotActive = false;
        let levelGoodies = [];
        let selectedTrade = null;
        let selectedDonation = null;
        let jackpotClickSession = 0;
        let jackpotClickTimeout;
        let freebieSpawnInterval = null;
        let freebieOrbs = [null, null, null, null];
        let windSpeed = 0; // 0: Normal, 1: Breezy, 2: Wowzers!
        
        const songDatabase = [
            { id: '001', title: 'Word Greed', filename: 'wordgreed001.mp3' },
            { id: '002', title: 'Diamond Focus', filename: 'wordgreed002.mp3' },
            { id: '003', title: 'Elevated Echoes', filename: 'wordgreed003.mp3' },
            { id: '004', title: 'Smooth Vibes', filename: 'wordgreed004.mp3' },
            { id: '005', title: 'Cash Flow', filename: 'wordgreed005.mp3' },
            { id: '006', title: 'Golden Glow', filename: 'wordgreed006.mp3' },
            { id: '007', title: 'Rich Shadows', filename: 'wordgreed007.mp3' },
            { id: '008', title: 'Reversal of Fortune', filename: 'wordgreed008.mp3' },
            { id: '009', title: 'Ascending Choices', filename: 'wordgreed009.mp3' },
            { id: '010', title: 'Soul Beyond Desires', filename: 'wordgreed010.mp3' }
        ];
        let verifiedPlaylist = [], userPlaylist = [], originalUserPlaylist = [];
        let currentTrackIndex = 0, isShuffled = false;
        const musicBaseURL = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/';
        const mutedIconHref = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png';
        const speakerSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M 20 40 L 40 40 L 60 20 L 60 80 L 40 60 L 20 60 Z" fill="white" stroke="black" stroke-width="2"/><path d="M 70 30 C 80 40, 80 60, 70 70" stroke="white" stroke-width="5" fill="none"/><path d="M 80 20 C 95 35, 95 65, 80 80" stroke="white" stroke-width="5" fill="none"/></svg>`;
        const speakerIconHref = `data:image/svg+xml,${encodeURIComponent(speakerSVG)}`;

        const wordBank = ["ABROAD","ACCEPT","ACCESS","ACROSS","ACTION","ACTIVE","ADMIRE","ADVICE","AFFAIR","AFFECT","AFFORD","AGENCY","AGENDA","ALMOST","ALWAYS","AMOUNT","ANIMAL","ANNUAL","ANSWER","ANYONE","ANYWAY","APART","APPEAL","APPEAR","APPLY","APPROVE","AROUND","ARRIVE","ARTIST","ASLEEP","ASPECT","ASSESS","ASSIST","ASSUME","ATTACK","ATTEND","ATTRACT","AUTHOR","AWARD","BALANCE","BECOME","BEHAVE","BELIEF","BELONG","BENEATH","BENEFIT","BESIDE","BEYOND","BISHOP","BORDER","BOTTLE","BOTTOM","BRANCH","BREATH","BRIDGE","BRIEFLY","BRIGHT","BROKEN","BUDGET","BURDEN","CAMERA","CANCEL","CANCER","CANDLE","CAPITAL","CAREER","CAREFUL","CENTRAL","CENTURY","CERTAIN","CHAIR","CHALLENGE","CHANCE","CHANGE","CHARGE","CHOICE","CHOOSE","CHURCH","CIRCLE","CLIENT","CLIMB","CLOSELY","CLOSER","COFFEE","COLLECT","COLLEGE","COLUMN","COMBINE","COMFORT","COMMAND","COMMENT","COMMIT","COMMON","COMPARE","COMPETE","COMPLEX","CONCEPT","CONCERN","CONFIRM","CONFLICT","CONNECT","CONSENT","CONSIST","CONTACT","CONTAIN","CONTENT","CONTEST","CONTEXT","CONTROL","CONVERT","CORNER","COUNCIL","COUNTY","COUPLE","COVER","CREATE","CREDIT","CRISIS","CRITERION","CRITIC","CROWD","CULTURE","CURRENT","CUSTOM","DAMAGE","DANGER","DEALER","DEBATE","DECADE","DECIDE","DECLARE","DECREASE","DEEPLY","DEFAULT","DEFENCE","DEFEND","DEFINE","DEGREE","DELAY","DELIVER","DEMAND","DEPEND","DEPICT","DEPOSIT","DEPUTY","DERIVE","DESIGN","DESIRE","DESPITE","DESTROY","DETAIL","DETECT","DEVELOP","DEVICE","DEVOTE","DIFFER","DIFFICULT","DINNER","DIRECT","DISCUSS","DISEASE","DISMISS","DISPLAY","DISTANT","DIVIDE","DIVISION","DOCTOR","DOCUMENT","DOUBLE","DOUBT","DOZEN","DREAM","DRINK","DRIVE","EAGER","EARLY","EARTH","EASTERN","ECONOMIC","ECONOMY","EDITOR","EDUCATE","EFFECT","EFFORT","EIGHT","EITHER","ELDERLY","ELECT","ELEMENT","ELSE","EMERGE","EMPHASIS","EMPLOY","ENABLE","ENCOURAGE","ENGINE","ENJOY","ENOUGH","ENSURE","ENTER","ENTIRE","ENTITLE","EQUALLY","EQUIP","ESCAPE","ESSAY","ESSENTIAL","ESTATE","ETHNIC","EVENT","EVERY","EXACTLY","EXAMINE","EXAMPLE","EXCEED","EXCEPT","EXCHANGE","EXCITE","EXCLUDE","EXCUSE","EXERCISE","EXIST","EXPECT","EXPENSE","EXPERIENCE","EXPERT","EXPLAIN","EXPLORE","EXPOSE","EXPRESS","EXTEND","EXTENT","EXTERNAL","EXTRA","EXTREME","FACTOR","FACULTY","FAILED","FAILURE","FAIRLY","FAITH","FAMLIAR","FAMOUS","FARMER","FASHION","FATHER","FAVOUR","FEELING","FEMALE","FIFTEEN","FIGHT","FIGURE","FINANCE","FINALLY","FINGER","FINISH","FLIGHT","FLOWER","FOLLOW","FOOTBALL","FORCE","FOREIGN","FOREST","FORGET","FORMAL","FORMER","FORWARD","FOUND","FOURTH","FRAME","FREEDOM","FRIEND","FUNCTION","FUTURE","GARDEN","GATHER","GENERAL","GENERATION","GENTLE","GLOBAL","GOLDEN","GROUND","GROWTH","GUARD","GUILTY","HANDLE","HAPPEN","HARDLY","HEALTH","HEAVILY","HEIGHT","HENCE","HOLIDAY","HORSE","HOSPITAL","HOUSE","HOWEVER","HUMAN","HUSBAND","IMPACT","IMPLY","IMPORT","IMPOSE","IMPROVE","INCLUDE","INCREASE","INDEED","INDICATE","INDIVIDUAL","INDUSTRY","INFORM","INITIAL","INJURY","INSIDE","INSIST","INSTANCE","INSTEAD","INSTITUTE","INTEND","INTEREST","INTERNAL","INVOLVE","ISLAND","ISSUE","ITSELF","JOINT","JUDGE","JUDGMENT","JUNIOR","JUSTICE","LABOUR","LANGUAGE","LARGELY","LATTER","LAUGH","LAWYER","LEADER","LEAGUE","LEARN","LEAVE","LEGAL","LENGTH","LESSON","LETTER","LEVEL","LIBERAL","LIBRARY","LICENCE","LIMIT","LIMITED","LITTLE","LOCAL","LONDON","LONGER","MACHINE","MAJOR","MANAGE","MANAGER","MANNER","MANY","MARKET","MARRIAGE","MATCH","MATERIAL","MATTER","MEASURE","MEDIA","MEDICAL","MEETING","MEMBER","MEMORY","MENTAL","MENTION","MERELY","METHOD","MIDDLE","MIGHT","MILE","MILITARY","MINISTER","MINORITY","MINUTE","MISSION","MISTAKE","MODEL","MODERN","MODULE","MOMENT","MONEY","MONTH","MORAL","MORNING","MOTHER","MOTION","MOTOR","MOUNTAIN","MOUTH","MOVEMENT","MOVIE","MUCH","MUSIC","MYSELF","NARROW","NATION","NATIONAL","NATIVE","NATURAL","NATURE","NEARLY","NECESSARY","NEEDLE","NEITHER","NERVE","NETWORK","NEVER","NEWLY","NIGHT","NOBODY","NORMAL","NORTHERN","NOTICE","NOTION","NOWHERE","NUMBER","OBJECT","OBSERVE","OBTAIN","OBVIOUS","OCCASION","OCCUR","OFFENCE","OFFER","OFFICE","OFFICER","OFFICIAL","OFTEN","ONCE","ONLINE","ONLY","ONTO","OPENING","OPERATE","OPPORTUNITY","OPPOSE","OPPOSITE","ORDER","ORDINARY","ORGANISE","ORIGIN","ORIGINAL","OTHER","OUGHT","OUTCOME","OUTSIDE","OVERALL","OWNER","PACKAGE","PAINT","PANEL","PARENT","PARISH","PARLIAMENT","PARTLY","PARTNER","PARTY","PASSAGE","PATIENT","PATTERN","PEACE","PEOPLE","PERFORM","PERHAPS","PERIOD","PERMIT","PERSON","PERSONAL","PHONE","PHOTO","PHYSICAL","PICTURE","PIECE","PLACE","PLANNING","PLANT","PLASTIC","PLAYER","POCKET","POINT","POLICE","POLICY","POLITICAL","POLLUTION","POPULAR","POSITION","POSITIVE","POSSIBLE","POSTER","POWER","PRACTICE","PREFER","PREPARE","PRESENCE","PRESENT","PRESIDENT","PRESS","PRESSURE","PRETTY","PREVIOUS","PRICE","PRIMARY","PRINCIPLE","PRINT","PRIOR","PRIORITY","PRISON","PRIVATE","PROBABLY","PROBLEM","PROCEDURE","PROCESS","PRODUCE","PRODUCT","PROFESSION","PROFILE","PROFIT","PROGRAM","PROGRESS","PROJECT","PROMISE","PROMOTE","PROPER","PROPERTY","PROPOSE","PROTECT","PROVIDE","PUBLIC","PUBLISH","PURPOSE","PUSH","QUALITY","QUARTER","QUESTION","QUICKLY","QUITE","RAISE","RANGE","RAPIDLY","RATELY","RATHER","REACH","REACTION","READER","READING","READY","REALISE","REALLY","REASON","RECALL","RECEIVE","RECENT","RECENTLY","RECOGNISE","RECORD","RECOVER","REDUCE","REFER","REFLECT","REFORM","REFUSE","REGARD","REGION","REGIONAL","REGULAR","RELATE","RELATION","RELATIVE","RELEASE","RELEVANT","RELIEF","RELIGION","REMAIN","REMEMBER","REMOVE","REPEAT","REPLACE","REPLY","REPORT","REPRESENT","REQUEST","REQUIRE","RESEARCH","RESOURCE","RESPECT","RESPOND","RESPONSE","RESULT","RETAIN","RETURN","REVEAL","REVENUE","REVIEW","REVOLUTION","RIGHT","RING","RISE","ROAD","ROLE","ROOM","ROUND","ROUTE","ROYAL","RULE","SAFETY","SALE","SAME","SAMPLE","SAVE","SCALE","SCENE","SCHEME","SCHOOL","SCIENCE","SCORE","SCREEN","SEARCH","SEASON","SECOND","SECRETARY","SECTION","SECTOR","SECURE","SEEM","SELECT","SENIOR","SENSE","SENSITIVE","SENTENCE","SEPARATE","SEQUENCE","SERIES","SERIOUS","SERVANT","SERVICE","SESSION","SETTLE","SEVEN","SEVERAL","SEVERE","SHARE","SHEET","SHOOT","SHORT","SHOT","SHOULD","SHOULDER","SHOUT","SHOW","SIDE","SIGHT","SIGN","SIGNAL","SILENCE","SIMPLE","SIMPLY","SINCE","SINGLE","SISTER","SITE","SITUATION","SIZE","SKILL","SKIN","SLEEP","SLIGHTLY","SLOWLY","SOCIAL","SOCIETY","SOLDIER","SOLUTION","SOME","SOMEHOW","SOMEONE","SOMETHING","SOMETIMES","SOMEWHAT","SOON","SORRY","SORT","SOUND","SOURCE","SOUTHERN","SPACE","SPEAK","SPECIAL","SPECIFIC","SPEECH","SPEED","SPEND","SPIRIT","SPORT","SPOT","SPREAD","SPRING","SQUARE","STAFF","STAGE","STAND","STANDARD","START","STATE","STATEMENT","STATION","STATUS","STAY","STEP","STILL","STOCK","STONE","STOP","STORE","STORY","STRAIGHT","STRANGE","STRATEGY","STREET","STRENGTH","STRESS","STRIKE","STRONG","STRUCTURE","STUDENT","STUDIO","STUDY","STYLE","SUBJECT","SUBMIT","SUCCEED","SUCCESS","SUCH","SUDDENLY","SUFFER","SUGGEST","SUMMER","SUPPORT","SUPPOSE","SURELY","SURFACE","SURVEY","SURVIVE","SWITCH","SYSTEM","TABLE","TAKE","TALK","TARGET","TASK","TEACH","TEACHER","TEAM","TECHNOLOGY","TELEPHONE","TELEVISION","TEMPERATURE","TERM","TERRIBLE","TEST","THANKS","THEATRE","THEIR","THEME","THEMSELVES","THEN","THEORY","THERE","THESE","THEY","THING","THINK","THIRD","THIRTY","THIS","THOSE","THOUGH","THOUSAND","THREAT","THREATEN","THREE","THROUGH","THROW","TICKET","TIME","TITLE","TODAY","TOGETHER","TOMORROW","TONE","TONIGHT","TOTAL","TOTALLY","TOUCH","TOUR","TOWARDS","TOWN","TRADE","TRADITION","TRAFFIC","TRAIN","TRAINING","TRANSFER","TRANSPORT","TRAVEL","TREAT","TREATMENT","TREATY","TREE","TREND","TRIAL","TRIP","TROOP","TROUBLE","TRUE","TRUST","TRUTH","TWENTY","TWICE","TYPE","UNDER","UNDERSTAND","UNION","UNIQUE","UNIT","UNITED","UNIVERSITY","UNLESS","UNLIKE","UNTIL","UPON","UPPER","URBAN","USER","USUAL","USUALLY","VALLEY","VALUE","VARIETY","VARIOUS","VEHICLE","VERSION","VERY","VIDEO","VIEW","VILLAGE","VIOLENCE","VISION","VISIT","VISITOR","VOICE","VOLUME","VOTE","WAIT","WALK","WALL","WANT","WAR","WATCH","WATER","WAY","WEALTH","WEAPON","WEAR","WEATHER","WEEK","WEEKEND","WEIGHT","WELCOME","WELL","WESTERN","WHAT","WHATEVER","WHEN","WHERE","WHETHER","WHICH","WHILE","WHITE","WHOLE","WHOM","WHOSE","WIDE","WIDELY","WIFE","WILD","WILL","WINDOW","WINE","WINTER","WISH","WITHIN","WITHOUT","WOMAN","WONDER","WOOD","WORD","WORK","WORKER","WORLD","WORRY","WORTH","WOULD","WRITE","WRITER","WRONG","YARD","YEAR","YOUNG","YOURSELF","YOUTH"];
        const prizeEmojis = [ { emoji: '🎁', value: 1500000, type: 'coins' }, { emoji: '🏆', value: 3500000, type: 'trophy' }, { emoji: '💎', value: 20000000, type: 'diamond' }, { emoji: '💣', value: 0, type: 'game_over' }, { emoji: '💣', value: 0, type: 'green_bomb' }, { emoji: '🪙', value: 5000, type: 'coins' }, { emoji: '⚡', value: 20000, type: 'lightning' }, { emoji: '❄️', value: 0, type: 'freeze' }, { emoji: '🔥', value: 400, type: 'fire_column'}, { emoji: '💰', value: 1000000, type: 'cash_money' } ];
        const nonsenseFreebies = ['🌭','🍕','🍔','🍟','🍗','🥠','🍩', '🍰', '🍭', '🍋‍🟩', '🧋', '🍷', '🍫', '☕', '🍪', ' ', '🛰️', '☄️'];
        const puzzleLayouts = [ { length: 5, indices: [11, 12, 13, 14, 15] }, { length: 7, indices: [28, 29, 30, 31, 32, 33, 34] }, { length: 7, indices: [46, 47, 48, 49, 50, 51, 52] }, { length: 5, indices: [65, 66, 67, 68, 69] } ];
        const trades = [
            { id: 'trade001', name: '10 🌭 for 1 Food Truck', cost: { '🌭': 10 }, reward: { type: 'inventory', item: '🚚', amount: 1 } },
            { id: 'trade003', name: '20 🍕 for 1 Pizzeria', cost: { '🍕': 20 }, reward: { type: 'inventory', item: '🍕', amount: 1 } },
            { id: 'trade004', name: '25 🍔 for 1 Burger Chain', cost: { '🍔': 25 }, reward: { type: 'inventory', item: '🍔', amount: 1 } },
            { id: 'trade005', name: '30 🍟 for 1 Potato Farm', cost: { '🍟': 30 }, reward: { type: 'inventory', item: '🥔', amount: 1 } },
            { id: 'trade006', name: '25 🍗 for 1 Chicken Farm', cost: { '🍗': 25 }, reward: { type: 'inventory', item: '🐔', amount: 1 } },
            { id: 'trade007', name: '20 🥠 for 1 Chip Plant', cost: { '🥠': 20 }, reward: { type: 'inventory', item: '💽', amount: 1 } },
            { id: 'trade008', name: '15 🍩 for 1 Donut Shop', cost: { '🍩': 15 }, reward: { type: 'inventory', item: '🍩', amount: 1 } },
            { id: 'trade009', name: '10 🍰 for 1 TV Show', cost: { '🍰': 10 }, reward: { type: 'inventory', item: '📺', amount: 1 } },
            { id: 'trade010', name: '5 🍭 for 1 Candy Vendor', cost: { '🍭': 5 }, reward: { type: 'inventory', item: '🍬', amount: 1 } },
            { id: 'trade011', name: '2 🍋‍🟩 for 2M Money Bags', cost: { '🍋‍🟩': 2 }, reward: { type: 'bags', amount: 2000000 } },
            { id: 'trade012', name: '1 🧋 for 2K Coins', cost: { '🧋': 1 }, reward: { type: 'coins', amount: 2000 } },
            { id: 'trade013', name: '1 🍷 for 1 Restaurant', cost: { '🍷': 1 }, reward: { type: 'inventory', item: '🍷', amount: 1 } },
            { id: 'trade014', name: '10 🍫 for 1 Candy Factory', cost: { '🍫': 10 }, reward: { type: 'inventory', item: '🏭', amount: 1 } },
            { id: 'trade015', name: '20 ☕ for 1 Headache', cost: { '☕': 20 }, reward: { type: 'inventory', item: '🤕', amount: 1 } },
            { id: 'trade016', name: '25 🍪 for 2 Gold Mines', cost: { '🍪': 25 }, reward: { type: 'inventory', item: '⛏️', amount: 2 } },
            { id: 'trade017', name: '27 🚀 for 1 Spaceship', cost: { '🚀': 27 }, reward: { type: 'inventory', item: '🚀', amount: 1 } },
            { id: 'trade018', name: '40 🛰️ for 1 SATNAV', cost: { '🛰️': 40 }, reward: { type: 'inventory', item: '🛰️', amount: 1 } },
            { id: 'trade019', name: '83 ☄️ for 1 Space Colony', cost: { '☄️': 83 }, reward: { type: 'inventory', item: '☄️', amount: 1 } }
        ];
        const inventoryItemNames = {
            '🚚': 'Food Truck', '🏛️': 'Diner', '🍕': 'Pizzeria', '🍔': 'Burger Chain',
            '🥔': 'Potato Farm', '🐔': 'Chicken Farm', '💽': 'Chip Plant', '🍩': 'Donut Shop',
            '📺': 'TV Show', '🍬': 'Candy Vendor', '🍷': 'Restaurant', '🏭': 'Candy Factory',
            '🤕': 'Headache', '⛏️': 'Gold Mine', '🚀': 'Spaceship', '🛰️': 'SATNAV', '☄️': 'Space Colony'
        };
        const tips = [
            "💡 Tip! The green bomb is your friend! Drag it anywhere and drop on a word to auto solve.",
            "💡 Another Tip! The green bomb has a range of 9 squares and will capture all freebies!",
            "💡 Tip! If you lose a big chunk of coins during game play, keep playing and in seconds be rich again!",
            "💡 Tip! The green checkmark is your friend to quick solve.",
            "💡 Wow! Another tip for you. Use the green checkmark to break an ice level with ease!",
            "💡 Tip! Clear a column when you select a fire tile and collect all the freebies and arrange letters in words."
        ];
        let currentTipIndex = 0;
        
        // --- Physics Engine Setup ---
        function setupPhysics() {
            engine = Engine.create();
            engine.world.gravity.y = 0.6; // Simulate coin weight

            const render = Render.create({
                canvas: physicsCanvas,
                engine: engine,
                options: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    wireframes: false,
                    background: 'transparent'
                }
            });

            // Create boundaries
            const wallOptions = { isStatic: true, render: { visible: false } };
            ground = Bodies.rectangle(window.innerWidth / 2, window.innerHeight + 20, window.innerWidth, 60, wallOptions);
            const leftWall = Bodies.rectangle(-30, window.innerHeight / 2, 60, window.innerHeight, wallOptions);
            const rightWall = Bodies.rectangle(window.innerWidth + 30, window.innerHeight / 2, 60, window.innerHeight, wallOptions);
            
            // Score panel collision body
            const scorePanelEl = document.getElementById('score-panel');
            const scoreRect = scorePanelEl.getBoundingClientRect();
            scorePanelBody = Bodies.rectangle(scoreRect.left + scoreRect.width / 2, scoreRect.top + scoreRect.height / 2, scoreRect.width, scoreRect.height, { isStatic: true, render: { visible: false } });

            World.add(engine.world, [ground, leftWall, rightWall, scorePanelBody]);
            
            runner = Runner.create();
            Runner.run(runner, engine);
            // Render.run(render); // Only enable for debugging collisions

            // Cleanup loop
            Events.on(engine, 'afterUpdate', () => {
                engine.world.bodies.forEach(body => {
                    if (body.label === 'coin' && body.position.y > window.innerHeight + 50) {
                        World.remove(engine.world, body);
                    }
                });
            });
        }
        
        function updatePhysicsBoundaries() {
            // Update ground
            Body.setPosition(ground, { x: window.innerWidth / 2, y: window.innerHeight + 20 });
            Body.setVertices(ground, [
                { x: 0, y: window.innerHeight },
                { x: window.innerWidth, y: window.innerHeight },
                { x: window.innerWidth, y: window.innerHeight + 40 },
                { x: 0, y: window.innerHeight + 40 }
            ]);

            // Update score panel
            const scorePanelEl = document.getElementById('score-panel');
            const scoreRect = scorePanelEl.getBoundingClientRect();
            Body.setPosition(scorePanelBody, { x: scoreRect.left + scoreRect.width / 2, y: scoreRect.top + scoreRect.height / 2 });
             Body.setVertices(scorePanelBody, [
                { x: scoreRect.left, y: scoreRect.top },
                { x: scoreRect.right, y: scoreRect.top },
                { x: scoreRect.right, y: scoreRect.bottom },
                { x: scoreRect.left, y: scoreRect.bottom }
            ]);

            // Update word tiles
            World.remove(engine.world, wordTileBodies);
            wordTileBodies = [];
            document.querySelectorAll('.word-puzzle-tile').forEach(tile => {
                const rect = tile.getBoundingClientRect();
                const body = Bodies.rectangle(rect.left + rect.width / 2, rect.top + rect.height / 2, rect.width, rect.height, { isStatic: true, render: { fillStyle: 'rgba(255,0,0,0.2)' } });
                wordTileBodies.push(body);
            });
            World.add(engine.world, wordTileBodies);
        }

        function triggerPhysicsCoinAnimation(startElement, count = 15, magnitude = 1, explosionType = 'normal') {
            const startRect = startElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;

            const windForceMap = [0.0005, 0.002, 0.005]; // Normal, Breezy, Wowzers
            const currentWindForce = windForceMap[windSpeed] || 0.0005;

            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const force = Math.random() * 5 * magnitude;
                
                const coinBody = Bodies.circle(startX, startY, 10, {
                    label: 'coin',
                    restitution: 0.6, // bounciness
                    friction: 0.1,
                    render: {
                        sprite: {
                            texture: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAACFElEQVQ4y62VzStEURjHn/97F1lIykvWSi5IuTcnF1kYkpQlK2XlJpI/oFBKykvZ+J+QhZJSlmxkZGRhY+XlGnnP6dydO3fOvXfOnG6nU+8+3+d8z/M8z3kK/v9RUMCgYg0gA+gCpoA+YBX4A6bAAdACVoAasIAscA14aZ4G/gI2gZfAGDAJtAKfS2Yd2B/4A+gDfoA8sARUAYeBq8A1sAisA+uA/wGdgGvAOnAXGAa+A3eBvUAfMDSdRxH4A3gNfAOeA/eBf2AamAWeARdAPfAfeBCYBW4D14GnwHngOvAduAicB24D+4FdwMvQYwzYAi4A24BvQBOwB5wGvgN3gVfAfeA+8B/4EHgQeA5cBq4D54HrwHfgIvA8uA3sB3uB3cBD0KMM2AIOAduAb0ATsAecBj4Dd4FXwH3gPvA/+BB4EHgOXAauA+eB68B34CLwPLgN7Ad7gd3AQ9CjDNwBjgGbgG9AE7AHnAY+A3eBV8B94D7wH/gQeBB4DlwGrgPngevAd+Ai8Dy4DewHe4HdWEgW+ApsB+4D7wP/gQeBx4DlwGvgPnAeuA58By4Cz4PbwH5gN7AbGAp9yoDNwDHgI/AbaAL2gNPAN+AOcBV4BdwH7gP/gQeBB4HnwGXgOnAeeA68By4Cz4PbwH5gN7AbGAp9yoDZwBHga+Ab0ARsAWeBz8B94BVwH7gP/Ac+BB4EHgeXgevAeeA68B24CDwPbgP7gd3AbmAg9CkDNwEHgY3AtyAJ2APOA5+B+8Ar4D5wH/gPPAgeBB4HlwHrgfPAdeA7cBF4HtwG9gO7gd3AQOhTBm4CR4BvwDcgCdgDzgefgfvAK+A+cB/4D/wHHgQeBJ4Dl4HrwHngOvAduAg8D24D+4HdwG5gIPS5L/4A+gDfgDxgCagCDgNXgWvAErAOrAP+B3QCXAN2gVfAAdACVrCAHHANKAPqgAzQBSyAitUaDPwG4s3a/Jt3pLwAAAAASUVORK5CYII=',
                            xScale: 1,
                            yScale: 1
                        }
                    }
                });

                let forceVector = { x: Math.cos(angle) * force, y: Math.sin(angle) * force };
                
                // Add brownian motion/randomness
                forceVector.x += (Math.random() - 0.5) * 0.5;
                forceVector.y += (Math.random() - 0.5) * 0.5;

                Body.applyForce(coinBody, coinBody.position, forceVector);
                
                // Apply wind
                Body.applyForce(coinBody, coinBody.position, { x: currentWindForce, y: 0 });

                World.add(engine.world, coinBody);
            }
        }

        function generatePuzzlesForLevel() {
            puzzles = [];
            let availableWords = [...wordBank];
            puzzleLayouts.forEach(layout => {
                const wordsOfLength = availableWords.filter(w => w.length === layout.length);
                if (wordsOfLength.length > 0) {
                    const word = wordsOfLength[Math.floor(Math.random() * wordsOfLength.length)];
                    puzzles.push({ word: word, indices: layout.indices, solved: false });
                    availableWords = availableWords.filter(w => w !== word); 
                }
            });
        }
        
        function startLevel() {
            document.getElementById('level-display').textContent = currentLevel;
            trophyCollectedThisLevel = false;
            diamondCollectedThisLevel = false;
            solveButtonClicks = 0;
            timeSinceLastSolve = 0;
            clearTimeout(diamondSequenceTimeout);
            clearTimeout(thawTimeout);
            document.getElementById('greed-icons-container').innerHTML = '';
            generatePuzzlesForLevel();
            initializeGrid();
            updatePhysicsBoundaries();
        }

        function initializeGrid() {
            gridContainer.innerHTML = '';
            puzzles.forEach(p => p.scrambled = shuffleWord(p.word));
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);

            for (let i = 0; i < 81; i++) {
                const tile = document.createElement('div');
                tile.classList.add('w-10', 'h-10', 'md:w-11', 'md:h-11', 'flex', 'items-center', 'justify-center', 'text-2xl', 'font-bold', 'rounded-lg', 'select-none');
                tile.id = `tile-${i}`;

                if (allPuzzleIndices.includes(i)) {
                    for (const puzzle of puzzles) {
                        if (puzzle.indices.includes(i)) {
                            const letterIndex = puzzle.indices.indexOf(i);
                            tile.textContent = puzzle.scrambled[letterIndex];
                            tile.classList.add('word-puzzle-tile');
                            tile.dataset.puzzleIndex = puzzles.indexOf(puzzle);
                            tile.draggable = true;
                            addDragListeners(tile);
                            break;
                        }
                    }
                } else if (i === 40) {
                    tile.id = 'jackpot-square';
                    tile.classList.add('bg-amber-500', 'border-2', 'border-amber-300', 'text-4xl');
                    tile.textContent = '💰';
                    tile.addEventListener('click', onJackpotClick);
                } else {
                    tile.classList.add('bg-slate-900/50', 'border', 'border-slate-800/50');
                }
                gridContainer.appendChild(tile);
            }
        }

        function shuffleWord(word) {
            let array = word.split('');
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            let shuffled = array.join('');
            return shuffled === word ? shuffleWord(word) : shuffled;
        }

        function addDragListeners(tile) {
            tile.addEventListener('dragstart', handleDragStart);
            tile.addEventListener('dragover', handleDragOver);
            tile.addEventListener('drop', handleDrop);
            tile.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            if (timeRemaining <= 0) return;
            draggedTile = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
            if (draggedTile.dataset.prizeType === 'green_bomb') {
                isDraggingBomb = true;
                document.getElementById('bomb-drag-preview').style.display = 'block';
            }
        }

        function handleDragOver(e) { 
            e.preventDefault(); 
            if (isDraggingBomb) {
                const targetTile = e.target.closest('#game-grid > div');
                if (targetTile) {
                    const preview = document.getElementById('bomb-drag-preview');
                    const rect = targetTile.getBoundingClientRect();
                    const gridRect = gridContainer.getBoundingClientRect();
                    const size = rect.width;
                    preview.style.width = `${size * 3}px`;
                    preview.style.height = `${size * 3}px`;
                    preview.style.left = `${rect.left - gridRect.left - size}px`;
                    preview.style.top = `${rect.top - gridRect.top - size}px`;
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('#game-grid > div');
            if (!dropTarget) return;

            if (isDraggingBomb && draggedTile) {
                startGreenBombSequence(dropTarget);
                draggedTile.textContent = '';
                draggedTile.classList.remove('prize-tile', 'green-bomb');
                draggedTile.draggable = false;
            }
            else if (dropTarget.classList.contains('word-puzzle-tile') && 
                draggedTile && draggedTile.classList.contains('word-puzzle-tile') &&
                dropTarget.dataset.puzzleIndex === draggedTile.dataset.puzzleIndex &&
                draggedTile !== dropTarget && !dropTarget.classList.contains('solved')) {
                const tempText = draggedTile.textContent;
                draggedTile.textContent = dropTarget.textContent;
                dropTarget.textContent = tempText;
                checkAllPuzzles();
            }
        }
        
        function handleDragEnd(e) { 
            e.target.classList.remove('dragging'); 
            if (isDraggingBomb) {
                isDraggingBomb = false;
                document.getElementById('bomb-drag-preview').style.display = 'none';
            }
            draggedTile = null;
        }

        function checkAllPuzzles() {
            let allWordsOnBoardAreSolved = true;
            puzzles.forEach((puzzle) => {
                if (!puzzle.solved) {
                    let currentWord = '';
                    puzzle.indices.forEach(index => { currentWord += document.getElementById(`tile-${index}`).textContent; });
                    if (currentWord === puzzle.word) {
                        puzzle.solved = true;
                        timeSinceLastSolve = 0;
                        coins += 10000;
                        updateScoreDisplay();
                        flashScore('gain');
                        const middleTileIndex = puzzle.indices[Math.floor(puzzle.indices.length / 2)];
                        const startTile = document.getElementById(`tile-${middleTileIndex}`);
                        if (!isFrozen) {
                            triggerPhysicsCoinAnimation(startTile, 15, 1);
                        }
                        puzzle.indices.forEach(index => {
                            const tile = document.getElementById(`tile-${index}`);
                            tile.classList.add('solved');
                            tile.draggable = false;
                        });
                    } else {
                        allWordsOnBoardAreSolved = false;
                    }
                }
            });

            if (allWordsOnBoardAreSolved && puzzles.length > 0) {
                if (isFrozen) endFreeze();
                coins += 100000;
                updateScoreDisplay();
                flashScore('gain');
                showEventText("Level Up!");
                flashLevelPanel();
                currentLevel++;
                setTimeout(() => startLevel(), 1500);
            }
        }

        function formatScore(num) {
            if (num < 1000) return num.toString();
            const si = [ { value: 1E12, symbol: "T" }, { value: 1E9, symbol: "B" }, { value: 1E6, symbol: "M" }, { value: 1E3, symbol: "K" } ];
            const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
            for (let i = 0; i < si.length; i++) {
                if (num >= si[i].value) { return (num / si[i].value).toFixed(1).replace(rx, "$1") + si[i].symbol; }
            }
            return num.toLocaleString();
        }

        function updateScoreDisplay() {
            bagsOfMoney = Math.floor(coins * 0.01);
            document.getElementById('coins-display').textContent = coins.toLocaleString();
            document.getElementById('bags-of-money-display').textContent = bagsOfMoney.toLocaleString();
            document.getElementById('coins-display').classList.remove('score-decay');
        }

        function flashScore(type = 'gain') {
            const coinsDisplay = document.getElementById('coins-display');
            const flashClass = type === 'gain' ? 'gain-flash' : 'deduct-flash';
            coinsDisplay.classList.remove('gain-flash', 'deduct-flash');
            void coinsDisplay.offsetWidth;
            coinsDisplay.classList.add(flashClass);
            setTimeout(() => { coinsDisplay.classList.remove(flashClass); }, 800);
        }

        function flashLevelPanel() {
            const levelDisplay = document.getElementById('level-display');
            levelDisplay.classList.add('level-flash');
            setTimeout(() => { levelDisplay.classList.remove('level-flash'); }, 1500);
        }
        
        function updateTimer() {
            if (timeRemaining > 0 && !isGamePaused) {
                timeRemaining--;
                timeSinceLastSolve++;
                const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
                const seconds = (timeRemaining % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${minutes}:${seconds}`;

                if (timeRemaining <= 5 && timeRemaining > 0 && !isGameOver) {
                    activateEndgameJackpot();
                }
            } else if (timeRemaining <= 0) {
                endGame();
            }
        }
        
        function activateEndgameJackpot() {
            if (endgameJackpotActive || isGameOver) return;
            endgameJackpotActive = true;
            const jackpotSquare = document.getElementById('jackpot-square');
            jackpotSquare.classList.add('endgame-pulse');
            const endgameJackpotHandler = () => {
                if (isGameOver) return; 
                coins += 1000000000;
                updateScoreDisplay();
                showEventText("Jackpot!", true, true);
                jackpotSquare.classList.remove('endgame-pulse');
            };
            jackpotSquare.addEventListener('click', endgameJackpotHandler, { once: true });
        }

        function onSolveButtonClick() {
            if (timeRemaining <= 0 || solveButtonCooldown > 0) return;
            const unsolvedPuzzles = puzzles.filter(p => !p.solved);
            if (unsolvedPuzzles.length === 0) return;

            const solveButton = document.getElementById('solve-button');
            solveButton.classList.remove('big-pulse');
            timeSinceLastSolve = 0;
            solveButtonClicks++;
            triggerPhysicsCoinAnimation(document.getElementById('solve-button'), 20, 1.2);
            coins -= 200000;
            updateScoreDisplay();
            flashScore('deduct');

            const puzzleToSolve = unsolvedPuzzles[Math.floor(Math.random() * unsolvedPuzzles.length)];
            puzzleToSolve.indices.forEach((tileIndex, letterIndex) => {
                document.getElementById(`tile-${tileIndex}`).textContent = puzzleToSolve.word[letterIndex];
            });
            checkAllPuzzles();

            if (solveButtonClicks >= 4) {
                startSolveButtonCooldown();
            }
        }

        function startSolveButtonCooldown() {
            solveButtonCooldown = 60;
            const solveButton = document.getElementById('solve-button');
            solveButton.disabled = true;
            solveButton.classList.remove('text-3xl');
            solveButton.classList.add('cooldown-timer');
            
            solveButtonTimerInterval = setInterval(() => {
                if (solveButtonCooldown > 0) {
                    solveButtonCooldown--;
                    solveButton.textContent = `0:${solveButtonCooldown.toString().padStart(2, '0')}`;
                } else {
                    clearInterval(solveButtonTimerInterval);
                    solveButton.textContent = '✅';
                    solveButton.classList.remove('cooldown-timer');
                    solveButton.classList.add('text-3xl');
                    solveButton.disabled = false;
                    solveButtonClicks = 0;
                }
            }, 1000);
        }

        function onJackpotClick(event) {
            const jackpotSquare = event.currentTarget;
            if (jackpotSquare.classList.contains('cooldown') || jackpotSquare.classList.contains('wild-pulse') || jackpotSquare.classList.contains('endgame-pulse')) return;

            clearTimeout(jackpotClickTimeout);
            jackpotClickSession++;
            timeSinceLastSolve = 0;
            coins += 50000;
            updateScoreDisplay();
            flashScore('gain');

            if (jackpotClickSession === 3) {
                triggerPhysicsCoinAnimation(jackpotSquare, 50, 1.5, 'explosion');
            } else if (jackpotClickSession === 5) {
                triggerPhysicsCoinAnimation(jackpotSquare, 100, 2.5, 'big_explosion');
            } else {
                triggerPhysicsCoinAnimation(jackpotSquare, 15, 1);
            }

            jackpotClickTimeout = setTimeout(() => {
                jackpotClickSession = 0;
            }, 2000); // 2-second window for consecutive clicks
        }

        function scheduleNextPrizeSpawn() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen || isSpecialAnimationActive) return;
            const timeElapsed = totalGameTime - timeRemaining;
            const progress = timeElapsed / totalGameTime;
            const maxDelay = 2500;
            const minDelay = 100;
            const currentDelay = minDelay + (maxDelay - minDelay) * Math.pow(1 - progress, 3);

            prizeSpawnerTimeout = setTimeout(() => {
                spawnPrizeEmoji();
                scheduleNextPrizeSpawn();
            }, currentDelay);
        }

        function spawnNonsenseFreebie() {
            if (isGamePaused || isGameOver) return;
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            let emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;
            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            
            const goodieEmoji = nonsenseFreebies[Math.floor(Math.random() * nonsenseFreebies.length)];

            tile.textContent = goodieEmoji;
            tile.classList.add('prize-tile', 'nonsense-freebie-special');
            tile.dataset.goodie = goodieEmoji;
            
            const clickHandler = () => {
                clearTimeout(despawnTimer);
                tile.textContent = '';
                tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                
                // Flyout animation
                const tileRect = tile.getBoundingClientRect();
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * (2 * Math.PI);
                    const flyout = document.createElement('div');
                    flyout.textContent = goodieEmoji;
                    flyout.style.position = 'fixed';
                    flyout.style.left = `${tileRect.left + tileRect.width / 2}px`;
                    flyout.style.top = `${tileRect.top + tileRect.height / 2}px`;
                    flyout.style.fontSize = '1.5rem';
                    flyout.style.pointerEvents = 'none';
                    flyout.style.zIndex = '200';
                    flyout.style.setProperty('--tx', `${Math.cos(angle) * 100}px`);
                    flyout.style.setProperty('--ty', `${Math.sin(angle) * 100}px`);
                    flyout.style.animation = `emoji-flyout 0.5s ease-out forwards`;
                    document.body.appendChild(flyout);
                    setTimeout(() => flyout.remove(), 500);
                }

                // Update inventory and fly to orb
                playerData.nonsenseFreebiesCollected[goodieEmoji] = (playerData.nonsenseFreebiesCollected[goodieEmoji] || 0) + 25;
                savePlayerProfile();
                populateSetupModal();
                flyGoodieToOrb(goodieEmoji, tile);
            };

            const despawnTimer = setTimeout(() => {
                tile.textContent = '';
                tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                tile.removeEventListener('click', clickHandler);
            }, 10000);

            tile.addEventListener('click', clickHandler, { once: true });
        }

        function flyGoodieToOrb(emoji, startElement) {
            const orbIndex = freebieOrbs.indexOf(null);
            const targetOrbIndex = orbIndex !== -1 ? orbIndex : (freebieOrbs.length); // Target the next available or the 5th position
            
            const orbsContainer = document.getElementById('freebie-orbs-container');
            const targetOrb = orbsContainer.children[targetOrbIndex] || orbsContainer.children[freebieOrbs.length - 1]; // Fallback to last orb
            if (!targetOrb) return;

            const startRect = startElement.getBoundingClientRect();
            const endRect = targetOrb.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;

            const flyingEmoji = document.createElement('div');
            flyingEmoji.textContent = emoji;
            flyingEmoji.style.position = 'fixed';
            flyingEmoji.style.left = `${startX}px`;
            flyingEmoji.style.top = `${startY}px`;
            flyingEmoji.style.fontSize = '2rem';
            flyingEmoji.style.zIndex = '200';
            flyingEmoji.style.pointerEvents = 'none';
            
            const controlX = startX + (endX - startX) * 0.2 + (Math.random() - 0.5) * 200;
            const controlY = Math.min(startY, endY) - 150 + (Math.random() - 0.5) * 100;
            const path = `M ${startX},${startY} Q ${controlX},${controlY} ${endX},${endY}`;
            
            flyingEmoji.style.animation = `emoji-fly-to-orb 1s ease-in-out forwards`;
            flyingEmoji.style.offsetPath = `path("${path}")`;
            document.body.appendChild(flyingEmoji);

            setTimeout(() => {
                flyingEmoji.remove();
                updateOrbs(emoji);
            }, 1000);
        }

        function updateOrbs(newEmoji) {
            const full = freebieOrbs.every(o => o !== null);
            if (full) {
                // Shift orbs left
                for (let i = 0; i < freebieOrbs.length - 1; i++) {
                    freebieOrbs[i] = freebieOrbs[i+1];
                }
                freebieOrbs[freebieOrbs.length - 1] = newEmoji;
                showEventText("10,000,000 Gift!", true, true);
                coins += 10000000;
                updateScoreDisplay();
            } else {
                const index = freebieOrbs.indexOf(null);
                freebieOrbs[index] = newEmoji;
            }
            renderOrbs();
        }

        function renderOrbs() {
            const container = document.getElementById('freebie-orbs-container');
            container.innerHTML = '';
            for(let i = 0; i < 4; i++) {
                const orb = document.createElement('div');
                orb.className = 'freebie-orb';
                const emoji = freebieOrbs[i];
                if (emoji) {
                    orb.textContent = emoji;
                    orb.classList.add('occupied');
                    orb.style.setProperty('--glow-color', ['#ffadad', '#ffd6a5', '#fdffb6', '#caffbf'][i % 4]);
                }
                container.appendChild(orb);
            }
        }

        function spawnPrizeEmoji() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen) return;

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            let emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;

            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            const newTile = tile.cloneNode(false);
            tile.parentNode.replaceChild(newTile, tile);
            
            let prizePool = prizeEmojis.filter(p => p.type !== 'cash_money');
            const prize = prizePool[Math.floor(Math.random() * prizePool.length)];

            newTile.textContent = prize.emoji;
            newTile.dataset.prizeValue = prize.value;
            newTile.dataset.prizeType = prize.type;
            newTile.classList.add('prize-tile');
            if (prize.type === 'game_over') newTile.classList.add('red-bomb');
            else if (prize.type === 'green_bomb') {
                newTile.classList.add('green-bomb');
                newTile.draggable = true;
                addDragListeners(newTile);
            }
            else if (prize.type === 'fire_column') newTile.classList.add('fire-bomb');
            
            const clickHandler = () => {
                clearTimeout(despawnTimer);
                if (newTile.dataset.prizeType === 'game_over') { endGame(true); } 
                else if (newTile.dataset.prizeType === 'diamond') { startDiamondSequence(newTile); } 
                else if (newTile.dataset.prizeType === 'green_bomb') { startGreenBombSequence(newTile); }
                else if (newTile.dataset.prizeType === 'fire_column') { startFireColumnSequence(newTile); }
                else if (newTile.dataset.prizeType === 'freeze') { startFreezeSequence(); }
                else if (newTile.dataset.prizeType === 'lightning') {
                    coins = 0;
                    coins += parseInt(newTile.dataset.prizeValue);
                    updateScoreDisplay();
                    triggerPhysicsCoinAnimation(newTile, 15, 1);
                }
                else {
                    coins += parseInt(newTile.dataset.prizeValue);
                    updateScoreDisplay();
                    flashScore('gain');
                    triggerPhysicsCoinAnimation(newTile, 15, 1);
                    if (newTile.dataset.prizeType === 'trophy' && !trophyCollectedThisLevel) {
                        trophyCollectedThisLevel = true;
                        updateGreedPanelWithTrophy();
                        showEventText("Oh Yeah!");
                    }
                }
                if (newTile.dataset.prizeType !== 'green_bomb' || !isDraggingBomb) {
                    newTile.textContent = '';
                    newTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            };

            const despawnTimer = setTimeout(() => {
                newTile.textContent = '';
                newTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                newTile.removeEventListener('click', clickHandler);
            }, 5000);

            newTile.addEventListener('click', clickHandler, { once: true });
        }

        function showEventText(text, greenGlow = false, longFlash = false) {
            if (isGamePaused && !longFlash) return;
            const eventTextContainer = document.getElementById('event-text-container');
            const eventText = document.getElementById('event-text');
            eventText.innerHTML = text;
            eventText.classList.toggle('green-glow', greenGlow);
            eventText.classList.toggle('long-flash', longFlash);
            
            eventTextContainer.classList.remove('hidden');
            const duration = longFlash ? 4000 : 2000;
            setTimeout(() => {
                eventTextContainer.classList.add('hidden');
                eventText.classList.remove('green-glow', 'long-flash');
            }, duration);
        }

        function startDiamondSequence(clickedTile) {
            isSpecialAnimationActive = true;
            coins += currentDiamondValue;
            updateScoreDisplay();
            flashScore('gain');
            showEventText("Diamonds, oh yeah!");
            currentDiamondValue = Math.floor(currentDiamondValue / 2);
            updateGreedPanelWithDiamond();

            document.querySelectorAll('.prize-tile').forEach(t => {
                if (t !== clickedTile) { 
                    t.textContent = ''; 
                    t.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const diamondTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if(tile) {
                        tile.textContent = '💎';
                        tile.classList.add('temp-diamond');
                        diamondTiles.push(tile);
                    }
                }
            }
            diamondSequenceTimeout = setTimeout(() => triggerVortexAnimation(diamondTiles), 2000);
        }

        function triggerVortexAnimation(diamondTiles) {
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            diamondTiles.forEach(tile => {
                if (!tile || !document.body.contains(tile)) return;
                const startRect = tile.getBoundingClientRect();
                const startX = startRect.left;
                const startY = startRect.top;

                const flyingDiamond = document.createElement('div');
                flyingDiamond.textContent = '💎';
                flyingDiamond.style.position = 'fixed';
                flyingDiamond.style.left = `${startX}px`;
                flyingDiamond.style.top = `${startY}px`;
                flyingDiamond.style.zIndex = '200';
                flyingDiamond.style.fontSize = '2rem';
                flyingDiamond.style.setProperty('--start-x', `0px`);
                flyingDiamond.style.setProperty('--start-y', `0px`);
                flyingDiamond.style.setProperty('--end-x', `${endX - startX}px`);
                flyingDiamond.style.setProperty('--end-y', `${endY - startY}px`);
                flyingDiamond.style.animation = `diamond-vortex 1s ease-in forwards`;
                document.body.appendChild(flyingDiamond);

                tile.textContent = '';
                tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                setTimeout(() => flyingDiamond.remove(), 1000);
            });

            setTimeout(() => {
                 isSpecialAnimationActive = false;
                 scheduleNextPrizeSpawn();
            }, 1500);
        }
        
        function getAdjacentIndices(index) {
            const indices = [];
            const row = Math.floor(index / 9);
            const col = index % 9;
            for (let r = -1; r <= 1; r++) {
                for (let c = -1; c <= 1; c++) {
                    const newRow = row + r;
                    const newCol = col + c;
                    if (newRow >= 0 && newRow < 9 && newCol >= 0 && newCol < 9) {
                        indices.push(newRow * 9 + newCol);
                    }
                }
            }
            return indices;
        }

        function startGreenBombSequence(bombTile) {
            playerData.greenBombsUsed++;
            const bombIndex = parseInt(bombTile.id.split('-')[1]);
            const adjacentIndices = getAdjacentIndices(bombIndex);
            
            adjacentIndices.forEach(index => {
                const adjTile = document.getElementById(`tile-${index}`);
                if (adjTile) {
                    if (adjTile.classList.contains('prize-tile')) {
                        const prizeValue = parseInt(adjTile.dataset.prizeValue) || 0;
                        if (prizeValue > 0) {
                            coins += prizeValue;
                            triggerPhysicsCoinAnimation(adjTile, 10, 0.8);
                        }
                        adjTile.textContent = '';
                        adjTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                    } else if (adjTile.classList.contains('word-puzzle-tile') && !adjTile.classList.contains('solved')) {
                        const puzzleIndex = parseInt(adjTile.dataset.puzzleIndex);
                        const puzzle = puzzles[puzzleIndex];
                        const letterIndex = puzzle.indices.indexOf(index);
                        const correctLetter = puzzle.word[letterIndex];
                        
                        for (const i of puzzle.indices) {
                            const sourceTile = document.getElementById(`tile-${i}`);
                            if (sourceTile && sourceTile.textContent === correctLetter) {
                                const tempText = adjTile.textContent;
                                adjTile.textContent = sourceTile.textContent;
                                sourceTile.textContent = tempText;
                                break;
                            }
                        }
                    }
                }
            });
            setTimeout(() => {
                updateScoreDisplay();
                checkAllPuzzles();
                savePlayerProfile();
            }, 100);
        }

        function startFireColumnSequence(fireTile) {
            const fireIndex = parseInt(fireTile.id.split('-')[1]);
            const column = fireIndex % 9;
            let collectedFromColumn = 0;

            for (let i = column; i < 81; i += 9) {
                const tileInColumn = document.getElementById(`tile-${i}`);
                if (tileInColumn && tileInColumn !== fireTile) { 
                    if (tileInColumn.classList.contains('prize-tile')) {
                        const prizeValue = parseInt(tileInColumn.dataset.prizeValue) || 0;
                        if (prizeValue > 0) {
                            collectedFromColumn += prizeValue;
                            triggerPhysicsCoinAnimation(tileInColumn, 10, 0.8);
                        }
                        tileInColumn.textContent = '';
                        tileInColumn.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';

                    } else if (tileInColumn.classList.contains('word-puzzle-tile') && !tileInColumn.classList.contains('solved')) {
                        const puzzleIndex = parseInt(tileInColumn.dataset.puzzleIndex);
                        const puzzle = puzzles[puzzleIndex];
                        const letterIndex = puzzle.indices.indexOf(i);
                        const correctLetter = puzzle.word[letterIndex];
                        
                        if (tileInColumn.textContent !== correctLetter) {
                            for (const sourceIndex of puzzle.indices) {
                                const sourceTile = document.getElementById(`tile-${sourceIndex}`);
                                if (sourceTile && sourceTile.textContent === correctLetter) {
                                    const tempText = tileInColumn.textContent;
                                    tileInColumn.textContent = sourceTile.textContent;
                                    sourceTile.textContent = tempText;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            const fireBombValue = parseInt(fireTile.dataset.prizeValue) || 400;
            coins += fireBombValue + collectedFromColumn;
            updateScoreDisplay();
            flashScore('gain');
            checkAllPuzzles();
        }

        function endGame(isBomb = false) {
            isGameOver = true;
            const jackpotSquare = document.getElementById('jackpot-square');
            if (jackpotSquare) jackpotSquare.classList.remove('endgame-pulse');
            saveGameResult();
            checkAndAwardBadges(coins);
            clearInterval(mainTimerInterval);
            clearInterval(freebieSpawnInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(diamondSequenceTimeout);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            endFreeze();
            endHeartAnimation();
            clearInterval(solveButtonPulseManager);
            timeRemaining = 0;
            document.getElementById('timer-display').textContent = "00:00";
            triggerSwirlAnimation();
            setTimeout(showGameOverModal, 1500);
        }

        function triggerSwirlAnimation() {
            const elementsToSwirl = document.querySelectorAll('#game-grid > div');
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            elementsToSwirl.forEach(el => {
                if (el.textContent) {
                    const startRect = el.getBoundingClientRect();
                    const startX = startRect.left;
                    const startY = startRect.top;
                    const flyingEl = el.cloneNode(true);
                    flyingEl.style.position = 'fixed';
                    flyingEl.style.left = `${startX}px`;
                    flyingEl.style.top = `${startY}px`;
                    flyingEl.style.zIndex = '200';
                    flyingEl.style.margin = '0';
                    flyingEl.style.setProperty('--start-x', `0px`);
                    flyingEl.style.setProperty('--start-y', `0px`);
                    flyingEl.style.setProperty('--end-x', `${endX - startX}px`);
                    flyingEl.style.setProperty('--end-y', `${endY - startY}px`);
                    flyingEl.style.animation = `game-over-swirl 1.5s ease-in forwards`;
                    document.body.appendChild(flyingEl);
                    el.textContent = '';
                    el.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });
        }

        function showGameOverModal() {
            document.getElementById('final-coins-display').textContent = coins.toLocaleString();
            document.getElementById('final-bags-display').textContent = bagsOfMoney.toLocaleString();
            document.getElementById('leaderboard-your-score').textContent = formatScore(coins);
            const gameOverModal = document.getElementById('game-over-modal');
            gameOverModal.classList.remove('hidden');

            gameOverAnimationInterval = setInterval(() => { 
                const animations = ['🪙', '❄️', '💖'];
                const animationChar = animations[Math.floor(Math.random() * animations.length)];
                
                const el = document.createElement('div');
                el.textContent = animationChar;
                el.style.left = `${Math.random() * 100}%`;
                el.style.animationDuration = `${Math.random() * 2 + 3}s`;
                el.style.fontSize = `${Math.random() * 1 + 0.5}rem`;
                el.style.position = 'fixed';
                el.style.top = '-5%';
                el.style.zIndex = '100';

                if (animationChar === '🪙') el.classList.add('falling-coin');
                else if (animationChar === '❄️') el.classList.add('falling-snowflake');
                else if (animationChar === '💖') el.classList.add('falling-heart', 'gray');

                animationContainer.appendChild(el);
                setTimeout(() => el.remove(), 5000);
            }, 200);
        }
        
        function pauseGame() {
            isGamePaused = true;
            if (runner) Runner.stop(runner);
            clearInterval(mainTimerInterval);
            clearInterval(freebieSpawnInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
        }

        function resumeGame() {
            if (isGameOver) return;
            isGamePaused = false;
            if (runner) Runner.start(runner, engine);
            mainTimerInterval = setInterval(updateTimer, 1000);
            freebieSpawnInterval = setInterval(spawnNonsenseFreebie, 60000);
            if (!isFrozen) {
                scheduleNextPrizeSpawn();
            }
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
        }

        function handleScoreDecay() {
            if (isGamePaused || isGameOver) return;
            if (timeSinceLastSolve > 20) {
                const decayAmount = Math.floor(Math.pow(timeSinceLastSolve - 19, 1.5) * 10);
                coins -= decayAmount;
                if (coins < 0) coins = 0;
                updateScoreDisplay();
                document.getElementById('coins-display').classList.add('score-decay');
            } else {
                document.getElementById('coins-display').classList.remove('score-decay');
            }
        }

        function startFreezeSequence() {
            isFrozen = true;
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(impTimeout);
            
            clearInterval(freezeAnimationInterval);
            freezeAnimationInterval = setInterval(() => {
                const snowflake = document.createElement('div');
                snowflake.classList.add('falling-snowflake');
                snowflake.textContent = '❄️';
                snowflake.style.left = `${Math.random() * 100}%`;
                snowflake.style.animationDuration = `${Math.random() * 3 + 4}s`;
                snowflake.style.fontSize = `${Math.random() * 1 + 0.75}rem`;
                document.body.appendChild(snowflake);
                setTimeout(() => snowflake.remove(), 7000);
            }, 200);

            thawTimeout = setTimeout(endFreeze, 15000);
        }

        function endFreeze() {
            clearInterval(freezeAnimationInterval);
            freezeAnimationInterval = null;
            clearTimeout(thawTimeout);
            isFrozen = false;
            if (!isGamePaused && !isGameOver) {
                setTimeout(() => scheduleNextPrizeSpawn(), 500);
            }
        }
        
        function spawnHeartAnimation() {
            if (heartAnimationInterval) return;
            heartAnimationInterval = setInterval(() => {
                const heart = document.createElement('div');
                heart.classList.add('falling-heart');
                heart.textContent = '💖';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.animationDuration = `${Math.random() * 4 + 5}s`;
                heart.style.fontSize = `${Math.random() * 1 + 0.75}rem`;
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 9000);
            }, 500);
            setTimeout(endHeartAnimation, 8000);
        }

        function endHeartAnimation() {
            clearInterval(heartAnimationInterval);
            heartAnimationInterval = null;
        }

        function startGame() {
            musicPlayer.muted = true;
            playTrack(currentTrackIndex);
            musicPlayer.play().catch(e => console.error("Audio play failed on initial click:", e));

            const todayStr = new Date().toISOString().split('T')[0];
            if (playerData.lastLoginDate !== todayStr) {
                showWelcomeBonus();
            } else {
                actuallyStartGame();
            }
        }

        function actuallyStartGame() {
            musicPlayer.muted = false;
            musicPlayer.volume = lastVolume;
            document.getElementById('volume-slider').value = lastVolume;
            updateVolumeIcon(lastVolume);
            
            document.getElementById('start-modal').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('game-container').classList.add('flex');
            clearInterval(startModalAnimationInterval);
            
            isGamePaused = false;
            resumeGame();
        }

        function restartGame() {
            clearInterval(gameOverAnimationInterval);
            document.getElementById('game-over-modal').classList.add('hidden');
            coins = 0;
            bagsOfMoney = 0;
            currentLevel = 1;
            timeRemaining = totalGameTime;
            isGameOver = false;
            isGamePaused = false;
            trophyCollectedThisLevel = false;
            diamondCollectedThisLevel = false;
            currentDiamondValue = 20000000;
            solveButtonClicks = 0;
            solveButtonCooldown = 0;
            timeSinceLastSolve = 0;
            isFrozen = false;
            jackpotEventAvailable = true;
            specialCashEmojiSpawned = false;
            endgameJackpotActive = false;
            freebieOrbs = [null, null, null, null];
            
            clearInterval(mainTimerInterval);
            clearInterval(freebieSpawnInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(diamondSequenceTimeout);
            clearInterval(solveButtonTimerInterval);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            clearTimeout(thawTimeout);
            clearInterval(solveButtonPulseManager);
            endFreeze();
            endHeartAnimation();

            levelGoodies = [...nonsenseFreebies];
            document.getElementById('timer-display').textContent = "10:00";
            const solveButton = document.getElementById('solve-button');
            solveButton.textContent = '✅';
            solveButton.classList.remove('cooldown-timer', 'big-pulse');
            solveButton.classList.add('text-3xl');
            solveButton.disabled = false;
            updateScoreDisplay();
            renderOrbs();
            startLevel(); 
            resumeGame();
        }

        function playNextTrack() {
            if (userPlaylist.length === 0) return;
            const nextIndex = (currentTrackIndex + 1) % userPlaylist.length;
            playTrack(nextIndex);
        }

        function playPreviousTrack() {
            if (userPlaylist.length === 0) return;
            const prevIndex = (currentTrackIndex - 1 + userPlaylist.length) % userPlaylist.length;
            playTrack(prevIndex);
        }

        function playTrack(index) {
            if (userPlaylist.length === 0 || index < 0 || index >= userPlaylist.length) return;
            currentTrackIndex = index;
            const trackName = userPlaylist[currentTrackIndex];
            musicPlayer.src = musicBaseURL + trackName;
            
            const playPromise = musicPlayer.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => updateNowPlayingIndicator()).catch(error => {
                    if (error.name !== 'AbortError') console.error("Audio play failed for " + trackName + ":", error);
                });
            }
        }
        
        function setupAudioControls() {
            const volumeSlider = document.getElementById('volume-slider');
            const volumeToggleButton = document.getElementById('volume-toggle-button');
            const playlistPlayPauseBtn = document.getElementById('playlist-play-pause');
            const playlistNextBtn = document.getElementById('playlist-next');
            const playlistPrevBtn = document.getElementById('playlist-prev');
            const playlistShuffleBtn = document.getElementById('playlist-shuffle');

            volumeSlider.value = lastVolume;
            updateVolumeIcon(musicPlayer.volume);

            volumeSlider.addEventListener('input', (e) => {
                const newVolume = parseFloat(e.target.value);
                musicPlayer.volume = newVolume;
                updateVolumeIcon(newVolume);
                if (newVolume > 0) lastVolume = newVolume;
            });

            volumeToggleButton.addEventListener('click', () => {
                if (musicPlayer.volume > 0) {
                    musicPlayer.volume = 0;
                    volumeSlider.value = 0;
                    updateVolumeIcon(0);
                } else {
                    musicPlayer.volume = lastVolume;
                    volumeSlider.value = lastVolume;
                    updateVolumeIcon(lastVolume);
                }
            });

            playlistPlayPauseBtn.addEventListener('click', () => musicPlayer.paused ? musicPlayer.play() : musicPlayer.pause());
            playlistNextBtn.addEventListener('click', playNextTrack);
            playlistPrevBtn.addEventListener('click', playPreviousTrack);
            playlistShuffleBtn.addEventListener('click', toggleShuffle);

            musicPlayer.addEventListener('play', updatePlayPauseIcon);
            musicPlayer.addEventListener('pause', updatePlayPauseIcon);
            updatePlayPauseIcon();
        }

        function updatePlayPauseIcon() {
            const playlistPlayPauseBtn = document.getElementById('playlist-play-pause');
            if (musicPlayer.paused) {
                playlistPlayPauseBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>`;
            } else {
                playlistPlayPauseBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75zM14.25 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z"></path></svg>`;
            }
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            document.getElementById('playlist-shuffle').classList.toggle('shuffle-active', isShuffled);
            const currentTrackFilename = userPlaylist[currentTrackIndex];
            
            if (isShuffled) {
                for (let i = userPlaylist.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [userPlaylist[i], userPlaylist[j]] = [userPlaylist[j], userPlaylist[i]];
                }
            } else {
                userPlaylist = [...originalUserPlaylist];
            }
            currentTrackIndex = userPlaylist.findIndex(filename => filename === currentTrackFilename);
            if (currentTrackIndex === -1) currentTrackIndex = 0; // Fallback
            populatePlaylistModal(); // Re-render to show new order
        }

        function updateVolumeIcon(volume) {
            const volumeToggleButton = document.getElementById('volume-toggle-button');
            const favicon = document.getElementById('favicon');
            if (volume === 0) {
                volumeToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`;
                favicon.href = mutedIconHref;
            } else {
                 volumeToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
                 favicon.href = speakerIconHref;
            }
        }

        function updateNowPlayingIndicator() {
            document.querySelectorAll('.playlist-item').forEach((item) => {
                item.classList.remove('now-playing');
                const trackTitle = item.querySelector('.song-title').textContent;
                const currentTrackInfo = songDatabase.find(t => t.filename === userPlaylist[currentTrackIndex]);
                if (currentTrackInfo && trackTitle === currentTrackInfo.title) {
                    item.classList.add('now-playing');
                }
            });
        }

        function populatePlaylistModal() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';
            const playlistToRender = isShuffled ? userPlaylist.map(filename => songDatabase.find(t => t.filename === filename)) : verifiedPlaylist;
            playlistToRender.forEach(track => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.innerHTML = `<span class="song-title">${track.title}</span><span class="now-playing-indicator">Now Playing...</span>`;
                container.appendChild(item);
                item.addEventListener('click', () => {
                    const playIndex = userPlaylist.findIndex(filename => filename === track.filename);
                    if (playIndex !== -1) playTrack(playIndex);
                });
            });
            updateNowPlayingIndicator();
        }
        
        async function buildVerifiedPlaylist() {
            const checkTrack = async (track) => {
                try {
                    const response = await fetch(musicBaseURL + track.filename, { method: 'HEAD' });
                    return response.ok;
                } catch (error) { return false; }
            };
            const checks = songDatabase.map(track => checkTrack(track));
            const results = await Promise.all(checks);
            verifiedPlaylist = songDatabase.filter((_, index) => results[index]);
            userPlaylist = verifiedPlaylist.map(track => track.filename);
            originalUserPlaylist = [...userPlaylist];
        }
        
        function getDefaultPlayerData() {
            return {
                userId: userId || 'local',
                name: 'Player',
                moneyBags: 0,
                highScore: 0,
                unlockedSkins: ['default'],
                activeSkin: 'default',
                lastLoginDate: null,
                lastDailyClaim: null,
                claimedDays: [],
                nonsenseFreebiesCollected: {},
                inventory: {},
                unlockedBadges: [],
                gamesPlayed: 0,
                greenBombsUsed: 0,
                windSpeed: 0,
            };
        }

        function loadPlayerFromLocalStorage() {
            const savedData = localStorage.getItem('wordGreedPlayerData');
            if (savedData) {
                playerData = { ...getDefaultPlayerData(), ...JSON.parse(savedData) };
                 if (!playerData.unlockedBadges) playerData.unlockedBadges = [];
                 if (!playerData.gamesPlayed) playerData.gamesPlayed = 0;
                 if (!playerData.greenBombsUsed) playerData.greenBombsUsed = 0;
                 if (typeof playerData.windSpeed !== 'number') playerData.windSpeed = 0;
            } else {
                playerData = getDefaultPlayerData();
            }
            windSpeed = playerData.windSpeed;
            applyTheme(playerData.activeSkin);
            populateSetupModal();
            displayBadges();
        }
        
        async function syncWithFirebase() {
            if (!isFirebaseConnected || !userId) return;
            const playerDocRef = doc(db, "players", userId);
            try {
                const docSnap = await getDoc(playerDocRef);
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    playerData.highScore = Math.max(playerData.highScore || 0, cloudData.highScore || 0);
                    playerData.moneyBags = Math.max(playerData.moneyBags || 0, cloudData.moneyBags || 0);
                    playerData.gamesPlayed = Math.max(playerData.gamesPlayed || 0, cloudData.gamesPlayed || 0);
                    playerData.greenBombsUsed = Math.max(playerData.greenBombsUsed || 0, cloudData.greenBombsUsed || 0);
                    const localBadges = new Set(playerData.unlockedBadges || []);
                    const cloudBadges = new Set(cloudData.unlockedBadges || []);
                    playerData.unlockedBadges = Array.from(new Set([...localBadges, ...cloudBadges]));
                    console.log("Player data synced with Firebase.");
                }
                await savePlayerProfile();
                displayBadges();
            } catch (error) {
                console.error("Error syncing with Firestore:", error);
            }
        }

        async function savePlayerProfile() {
            localStorage.setItem('wordGreedPlayerData', JSON.stringify(playerData));
            if (isFirebaseConnected && userId) {
                const playerDocRef = doc(db, "players", userId);
                try {
                    const dataToSave = JSON.parse(JSON.stringify(playerData));
                    await setDoc(playerDocRef, dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving player profile to Firestore:", error);
                }
            }
        }

        function canAffordAnyTrade() {
            return trades.some(trade => {
                const costItem = Object.keys(trade.cost)[0];
                const costAmount = trade.cost[costItem];
                const playerAmount = playerData.nonsenseFreebiesCollected[costItem] || 0;
                return playerAmount >= costAmount;
            });
        }

        function updateTradeButtonPulse() {
            const tradeButton = document.getElementById('trade-goodies-button');
            if (tradeButton) {
                tradeButton.classList.toggle('trade-button-pulse', canAffordAnyTrade());
            }
        }

        function openTradingPost() {
            document.getElementById('setup-modal').classList.add('hidden');
            populateTradingPost();
            document.getElementById('trading-post-modal').classList.remove('hidden');
        }

        function populateTradingPost() {
            const container = document.getElementById('available-trades-container');
            container.innerHTML = '';
            selectedTrade = null;
            document.getElementById('execute-trade-button').disabled = true;

            trades.forEach(trade => {
                const costItem = Object.keys(trade.cost)[0];
                const costAmount = trade.cost[costItem];
                const playerAmount = playerData.nonsenseFreebiesCollected[costItem] || 0;
                const canAfford = playerAmount >= costAmount;
                const item = document.createElement('div');
                item.className = `trade-item p-2 rounded-lg text-center ${canAfford ? 'cursor-pointer' : 'opacity-50'}`;
                const rewardItem = trade.reward.item || (trade.reward.type === 'bags' ? '💰' : '🪙');
                item.innerHTML = `
                    <div class="text-2xl">${costItem} ➜ ${rewardItem}</div>
                    <div class="text-xs font-bold">${trade.name}</div>
                    <div class="text-xs text-slate-400">Cost: ${costAmount}</div>
                `;
                if (canAfford) {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.trade-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedTrade = trade;
                        document.getElementById('execute-trade-button').disabled = false;
                    });
                }
                container.appendChild(item);
            });
        }
        
        function executeTrade() {
            if (!selectedTrade) return;
            const costItem = Object.keys(selectedTrade.cost)[0];
            const costAmount = selectedTrade.cost[costItem];
            const playerAmount = playerData.nonsenseFreebiesCollected[costItem] || 0;

            if (playerAmount >= costAmount) {
                playerData.nonsenseFreebiesCollected[costItem] -= costAmount;
                if (selectedTrade.reward.type === 'bags') playerData.moneyBags += selectedTrade.reward.amount;
                else if (selectedTrade.reward.type === 'coins') { coins += selectedTrade.reward.amount; updateScoreDisplay(); }
                else if (selectedTrade.reward.type === 'inventory') {
                    const rewardItem = selectedTrade.reward.item;
                    playerData.inventory[rewardItem] = (playerData.inventory[rewardItem] || 0) + selectedTrade.reward.amount;
                }
                showEventText("Trade Successful!", true);
                savePlayerProfile();
                populateTradingPost();
                populateSetupModal();
                selectedTrade = null;
                document.getElementById('execute-trade-button').disabled = true;
            } else {
                showEventText("Not enough items!", false);
            }
        }
        
        function populateRichesModal() {
            const container = document.getElementById('riches-inventory');
            container.innerHTML = '';
            const inventory = playerData.inventory || {};
            const items = Object.keys(inventory);

            if (items.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-slate-400">You have no special riches yet. Trade for them at the Trading Post!</p>`;
            } else {
                items.forEach(item => {
                    const count = inventory[item];
                    const name = inventoryItemNames[item] || 'Item';
                    const itemEl = document.createElement('div');
                    itemEl.className = 'riches-card';
                    itemEl.innerHTML = `<div class="text-5xl">${item}</div><div class="text-md font-bold mt-2">${name}</div><div class="text-sm text-slate-300">x${count}</div>`;
                    container.appendChild(itemEl);
                });
            }
            document.getElementById('net-worth-panel').innerHTML = calculateNetWorth();
        }

        function calculateNetWorth() {
            const totalItems = Object.values(playerData.inventory || {}).reduce((a, b) => a + b, 0);
            const uniqueItemTypes = Object.keys(playerData.inventory || {}).length;
            const totalBags = playerData.moneyBags || 0;
            let description = "";
            if (totalItems === 0 && totalBags < 100000) description = "Your financial portfolio consists mainly of pocket lint and a half-hearted IOU. Keep trading!";
            else if (uniqueItemTypes <= 2 && totalBags < 1000000) description = "You're a specialist! You've clearly cornered the market on... well, *something*. Your cash flow is a respectable trickle, but your focus is admirable.";
            else if (uniqueItemTypes > 2 && totalBags < 5000000) description = "A diversified portfolio! Your assets are spread wisely across various sectors of the emoji economy. You're officially 'financially intriguing'.";
            else if (totalItems > 10 && totalBags < 20000000) description = "You've built a small but powerful empire. Your name is whispered in the boardrooms of digital diners and virtual food trucks. Your cash flow is a mighty river.";
            else if (totalItems > 20 && totalBags >= 20000000) description = "Your net worth requires scientific notation to express. You don't have cash flow; you have a cash tsunami. Your financial advisor is a well-dressed parrot you taught to squawk 'Buy!'.";
            else description = "Your financial situation is an enigma, wrapped in a riddle, and coated in chocolate. Keep up the good work, whatever it is you're doing!";
            return `<h3 class="text-lg font-bold text-amber-300">Net Worth Analysis</h3><p class="text-slate-300 mt-2">${description}</p>`;
        }
        
        function populateSetupModal() {
            playerNameInput.value = playerData.name || 'Player';
            playerNameInput.classList.toggle('invalid-input', !playerData.name?.trim());
            document.getElementById('total-bags-display').textContent = (playerData.moneyBags || 0).toLocaleString();
            document.getElementById('high-score-display').textContent = (playerData.highScore || 0).toLocaleString();
            
            const userIdContainer = document.getElementById('user-id-container');
            if (userId && isFirebaseConnected) {
                userIdContainer.innerHTML = `<span>ID: ${userId}</span><button id="copy-userid-button" class="bg-slate-700 px-2 py-1 rounded hover:bg-slate-600">Copy</button>`;
                document.getElementById('copy-userid-button').addEventListener('click', () => {
                    navigator.clipboard.writeText(userId).then(() => showEventText("User ID Copied!"), () => console.error('Failed to copy'));
                });
            } else {
                userIdContainer.innerHTML = '<span>Offline Mode</span>';
            }

            populateThemeStore();
            populateNonsenseFreebies();
            updateTradeButtonPulse();
        }

        function populateNonsenseFreebies() {
            const container = document.getElementById('nonsense-freebies-container');
            container.innerHTML = '';
            nonsenseFreebies.forEach(freebie => {
                const count = playerData.nonsenseFreebiesCollected?.[freebie] || 0;
                const item = document.createElement('div');
                item.className = 'text-center';
                const isTradable = trades.some(trade => Object.keys(trade.cost)[0] === freebie && count >= trade.cost[freebie]);
                item.innerHTML = `<div class="text-2xl ${isTradable ? 'trade-button-pulse rounded-md' : ''}">${freebie}</div><div class="text-xs font-bold text-slate-300">${count}</div>`;
                container.appendChild(item);
            });
        }

        function applyTheme(themeId) {
            document.body.className = 'text-white flex items-center justify-center min-h-screen p-4';
            if (themeId !== 'default') {
                document.body.classList.add(`theme-${themeId}`);
            }
        }

        const themes = [
            { id: 'default', name: 'Purple Haze', cost: 0, colors: ['#a78bfa', '#8b5cf6'] },
            { id: 'blue', name: 'Ocean Blue', cost: 1000000, colors: ['#60a5fa', '#3b82f6'] },
            { id: 'green', name: 'Emerald City', cost: 3000000, colors: ['#4ade80', '#22c55e'] },
            { id: 'red', name: 'Ruby Rush', cost: 5000000, colors: ['#f87171', '#ef4444'] },
            { id: 'christmas', name: 'Christmas', cost: 7000000, colors: ['#dc2626', '#166534'] },
            { id: 'halloween', name: 'Halloween', cost: 9000000, colors: ['#f97316', '#4a044e'] },
            { id: 'winter', name: 'Winter', cost: 11000000, colors: ['#67e8f9', '#0c4a6e'] },
            { id: 'beach', name: 'Beach', cost: 13000000, colors: ['#fde047', '#2dd4bf'] },
            { id: 'grove', name: 'Grove Palms', cost: 15000000, colors: ['#22c55e', '#f59e0b'] },
            { id: 'dark-purple', name: 'Dark Purples', cost: 20000000, colors: ['#5b21b6', '#4c1d95'] },
            { id: 'grayscale', name: 'Grayscale', cost: 25000000, colors: ['#6b7280', '#374151'] },
            { id: 'stage-lights', name: 'Stage Lights', cost: 30000000, colors: ['#ec4899', '#8b5cf6'] },
            { id: 'dark-aqua', name: 'Dark Aqua', cost: 35000000, colors: ['#2dd4bf', '#0d9488'] },
            { id: 'brownstone', name: 'Brownstone', cost: 40000000, colors: ['#a16207', '#854d0e'] }
        ];

        function populateThemeStore() {
            const container = document.getElementById('theme-store-container');
            container.innerHTML = '';
            themes.forEach(theme => {
                const isUnlocked = playerData.unlockedSkins?.includes(theme.id);
                const isActive = playerData.activeSkin === theme.id;
                const item = document.createElement('div');
                item.className = `theme-item p-2 rounded-lg flex flex-col items-center justify-start ${isActive ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
                item.style.background = `linear-gradient(145deg, ${theme.colors[0]}, ${theme.colors[1]})`;
                item.dataset.themeId = theme.id;
                
                let costHTML = isUnlocked ? '<span class="text-xs text-green-300">Unlocked</span>' : `<span class="text-xs">💰 ${theme.cost.toLocaleString()}</span>`;
                item.innerHTML = `<div class="w-full text-center pt-2"><span class="font-bold text-sm">${theme.name}</span>${costHTML}</div>`;

                if (isUnlocked) {
                    item.addEventListener('click', () => {
                        playerData.activeSkin = theme.id;
                        applyTheme(theme.id);
                        savePlayerProfile();
                        populateThemeStore();
                    });
                } else {
                    item.addEventListener('click', () => {
                        if (playerData.moneyBags >= theme.cost) {
                            playerData.moneyBags -= theme.cost;
                            playerData.unlockedSkins.push(theme.id);
                            playerData.activeSkin = theme.id;
                            applyTheme(theme.id);
                            savePlayerProfile();
                            populateSetupModal();
                        } else {
                            showEventText(`Need ${ (theme.cost - playerData.moneyBags).toLocaleString() } more 💰!`);
                        }
                    });
                }
                container.appendChild(item);
            });
        }

        function showWelcomeBonus() {
            const bonusCoins = Math.floor(Math.random() * 49001) + 1000;
            const bonusBags = Math.floor(Math.random() * 11);
            const container = document.getElementById('bonus-rewards-container');
            container.innerHTML = `<div class="bonus-item text-center"><div class="text-5xl">🪙</div><div class="text-xl font-bold">${bonusCoins.toLocaleString()}</div></div><div class="bonus-item text-center" style="animation-delay: 0.2s;"><div class="text-5xl">💰</div><div class="text-xl font-bold">${bonusBags.toLocaleString()}</div></div>`;
            for (let i = 0; i < 2; i++) {
                const randomFreebie = nonsenseFreebies[Math.floor(Math.random() * nonsenseFreebies.length)];
                const randomQty = Math.floor(Math.random() * 4) + 1;
                const freebieEl = document.createElement('div');
                freebieEl.className = 'bonus-item text-center';
                freebieEl.style.animationDelay = `${0.4 + i * 0.2}s`;
                freebieEl.innerHTML = `<div class="text-5xl">${randomFreebie}</div><div class="text-xl font-bold">x${randomQty}</div>`;
                container.appendChild(freebieEl);
                playerData.nonsenseFreebiesCollected[randomFreebie] = (playerData.nonsenseFreebiesCollected[randomFreebie] || 0) + randomQty;
            }
            document.getElementById('welcome-bonus-modal').classList.remove('hidden');
            document.getElementById('claim-bonus-button').onclick = () => {
                playerData.moneyBags += bonusBags;
                coins += bonusCoins;
                updateScoreDisplay();
                playerData.lastLoginDate = new Date().toISOString().split('T')[0];
                savePlayerProfile();
                document.getElementById('welcome-bonus-modal').classList.add('hidden');
                actuallyStartGame();
            };
        }

        const dailyRewards = Array.from({ length: 31 }, (_, i) => {
            const day = i + 1;
            const coinReward = Math.floor(1000 * Math.pow(day, 2.5));
            const bagReward = Math.floor(5 * Math.pow(day, 1.5));
            let bonus = 1;
            if (day === 7 || day === 21) bonus = 2;
            if (day === 10 || day === 20 || day === 30) bonus = 3;
            return { day, coins: coinReward, bags: bagReward, bonus: bonus };
        });
        dailyRewards[30] = { day: 31, coins: 100000000, bags: 5000, bonus: 3 };

        function populateCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const todayDay = today.getDate();

            for (let i = 1; i <= 35; i++) {
                if (i <= dailyRewards.length) {
                    const reward = dailyRewards[i - 1];
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    const isClaimed = playerData.claimedDays?.includes(reward.day);
                    const isToday = reward.day === todayDay;
                    dayEl.innerHTML = `<div class="day-number">${reward.day}</div><div class="reward-text">🪙 ${formatScore(reward.coins * reward.bonus)}</div><div class="reward-text">💰 ${formatScore(reward.bags * reward.bonus)}</div>`;
                    if (reward.bonus === 2) dayEl.classList.add('double-bonus');
                    if (reward.bonus === 3) dayEl.classList.add('triple-bonus');
                    if (isClaimed) {
                        dayEl.classList.add('claimed');
                        dayEl.innerHTML += '<div class="text-xs font-bold mt-1">CLAIMED</div>';
                    } else if (isToday && playerData.lastDailyClaim !== todayStr) {
                        dayEl.classList.add('today');
                        dayEl.addEventListener('click', () => claimDailyReward(reward));
                    } else if (isToday && playerData.lastDailyClaim === todayStr) {
                        dayEl.classList.add('today', 'claimed');
                        dayEl.innerHTML += '<div class="text-xs font-bold mt-1">CLAIMED</div>';
                    } else if (reward.day > todayDay) {
                        dayEl.classList.add('future');
                    } else {
                        dayEl.classList.add('past-day');
                    }
                    grid.appendChild(dayEl);
                } else if (i === 32) {
                    const legendEl = document.createElement('div');
                    legendEl.id = 'calendar-legend';
                    legendEl.innerHTML = `<div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full border-2 border-yellow-300"></div> 2x Bonus</div><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full border-2 border-red-500"></div> 3x Bonus</div>`;
                    grid.appendChild(legendEl);
                }
            }
        }

        function claimDailyReward(reward) {
            const todayStr = new Date().toISOString().split('T')[0];
            if (playerData.lastDailyClaim === todayStr || playerData.claimedDays.includes(reward.day)) {
                showEventText("Already Claimed Today!");
                return;
            }
            const randomFreebie = nonsenseFreebies[Math.floor(Math.random() * nonsenseFreebies.length)];
            playerData.nonsenseFreebiesCollected[randomFreebie] = (playerData.nonsenseFreebiesCollected[randomFreebie] || 0) + 1;
            playerData.moneyBags += (reward.bags * reward.bonus);
            coins += (reward.coins * reward.bonus);
            updateScoreDisplay();
            showEventText(`+${randomFreebie} Claimed!<br>New Prizes Tomorrow!`, true, true);
            playerData.claimedDays.push(reward.day);
            playerData.lastDailyClaim = todayStr;
            savePlayerProfile();
            populateCalendar();
        }
        
        function saveGameResult() {
            playerData.moneyBags += bagsOfMoney;
            if (coins > playerData.highScore) playerData.highScore = coins;
            playerData.gamesPlayed++;
            savePlayerProfile();
        }

        function populateTipsCarousel() {
            const container = document.getElementById('tip-card-container');
            container.innerHTML = '';
            tips.forEach((tip, index) => {
                const card = document.createElement('div');
                card.className = 'tip-card';
                card.textContent = tip;
                if (index === currentTipIndex) card.classList.add('active');
                container.appendChild(card);
            });
        }

        function showTip(index) {
            const tips = [
                "Use keyboard shortcuts to speed up your workflow.",
                "Keep your workspace tidy to improve focus.",
                "Drink plenty of water throughout the day.",
                "Break down large tasks into smaller, manageable steps."
            ];
            const tipElement = document.getElementById('tip-of-the-day');

            if (tipElement && tips[index]) {
                // Fade out
                tipElement.style.opacity = 0;
                
                // Wait for the fade out to finish, then change text and fade in
                setTimeout(() => {
                    tipElement.textContent = tips[index];
                    tipElement.style.opacity = 1;
                }, 200); // This duration should match your CSS transition
            }
        }

        // Example logic to cycle through tips
        let currentTipIndex = 0;
        document.addEventListener('DOMContentLoaded', () => {
            // This assumes you have an element with id="tip-of-the-day"
            // and maybe a button with id="next-tip-btn" in your HTML body.
            
            // Show the first tip
            showTip(currentTipIndex);

            const nextTipButton = document.getElementById('next-tip-btn');
            if(nextTipButton) {
                nextTipButton.addEventListener('click', () => {
                    currentTipIndex = (currentTipIndex + 1) % tips.length;
                    showTip(currentTipIndex);
                });
            }
        });
    </script>
</body>
</html>
