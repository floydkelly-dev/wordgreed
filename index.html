<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Greed</title>
    <link id="favicon" rel="icon" href="https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Lobster+Two:ital,wght@1,700&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9BVWMWR6X5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-9BVWMWR6X5');
    </script>
    <style>
        :root {
            --primary-color: #a78bfa; --primary-color-dark: #8b5cf6; --primary-color-light: #c4b5fd; --primary-text-dark: #1e1b4b; --panel-bg: rgba(55, 25, 85, 0.4); --panel-border: rgba(167, 139, 250, 0.3);
        }
        body.theme-red { --primary-color: #f87171; --primary-color-dark: #ef4444; --primary-color-light: #fca5a5; --primary-text-dark: #7f1d1d; --panel-bg: rgba(127, 29, 29, 0.4); --panel-border: rgba(239, 68, 68, 0.3); }
        body.theme-green { --primary-color: #4ade80; --primary-color-dark: #22c55e; --primary-color-light: #86efac; --primary-text-dark: #14532d; --panel-bg: rgba(22, 101, 52, 0.4); --panel-border: rgba(34, 197, 94, 0.3); }
        body.theme-blue { --primary-color: #60a5fa; --primary-color-dark: #3b82f6; --primary-color-light: #93c5fd; --primary-text-dark: #1e3a8a; --panel-bg: rgba(30, 58, 138, 0.4); --panel-border: rgba(59, 130, 246, 0.3); }
        body.theme-christmas { --primary-color: #ef4444; --primary-color-dark: #b91c1c; --primary-color-light: #fca5a5; --primary-text-dark: #166534; --panel-bg: rgba(22, 101, 52, 0.6); --panel-border: rgba(220, 38, 38, 0.5); }
        body.theme-halloween { --primary-color: #f97316; --primary-color-dark: #ea580c; --primary-color-light: #fb923c; --primary-text-dark: #4a044e; --panel-bg: rgba(28, 25, 23, 0.6); --panel-border: rgba(249, 115, 22, 0.5); }
        body.theme-winter { --primary-color: #67e8f9; --primary-color-dark: #0891b2; --primary-color-light: #a5f3fc; --primary-text-dark: #1e3a8a; --panel-bg: rgba(224, 242, 254, 0.4); --panel-border: rgba(56, 189, 248, 0.5); }
        body.theme-beach { --primary-color: #2dd4bf; --primary-color-dark: #0d9488; --primary-color-light: #5eead4; --primary-text-dark: #134e4a; --panel-bg: rgba(253, 230, 138, 0.4); --panel-border: rgba(6, 182, 212, 0.5); }
        body.theme-grove { --primary-color: #f59e0b; --primary-color-dark: #d97706; --primary-color-light: #fbbf24; --primary-text-dark: #1a2e05; --panel-bg: rgba(34, 197, 94, 0.4); --panel-border: rgba(134, 239, 172, 0.5); }
        body.theme-dark-purple { --primary-color: #5b21b6; --primary-color-dark: #4c1d95; --primary-color-light: #7c3aed; --primary-text-dark: #e0e7ff; --panel-bg: rgba(23, 2, 46, 0.5); --panel-border: rgba(109, 40, 217, 0.5); }
        body.theme-grayscale { --primary-color: #9ca3af; --primary-color-dark: #6b7280; --primary-color-light: #d1d5db; --primary-text-dark: #111827; --panel-bg: rgba(107, 114, 128, 0.4); --panel-border: rgba(156, 163, 175, 0.5); }
        body.theme-stage-lights { --primary-color: #ec4899; --primary-color-dark: #db2777; --primary-color-light: #f472b6; --primary-text-dark: #1e1b4b; --panel-bg: rgba(13, 13, 33, 0.6); --panel-border: rgba(236, 72, 153, 0.5); }
        body.theme-dark-aqua { --primary-color: #2dd4bf; --primary-color-dark: #14b8a6; --primary-color-light: #5eead4; --primary-text-dark: #0f766e; --panel-bg: rgba(15, 23, 42, 0.6); --panel-border: rgba(6, 182, 212, 0.5); }
        body.theme-brownstone { --primary-color: #a16207; --primary-color-dark: #854d0e; --primary-color-light: #ca8a04; --primary-text-dark: #422006; --panel-bg: rgba(66, 32, 6, 0.6); --panel-border: rgba(161, 98, 7, 0.5); }
        
        @keyframes move-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(125deg, #000000, #0c1e42, #1e3a8a, #000000); background-size: 400% 400%; animation: move-gradient 20s ease infinite; overflow-x: hidden; }
        
        .game-title-style { 
            font-family: 'Lobster Two', cursive; 
            color: #FDD835;
            font-weight: 700; 
            font-style: italic; 
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 3px 0 #4a2c0f, 3px 3px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .coin-rotate { display: inline-block; animation: spin 5s linear infinite; }
        @keyframes fly-along-path { 0% { offset-distance: 0%; opacity: 1; } 100% { offset-distance: 100%; opacity: 0; } }
        @keyframes coin-swirl-in { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 100% { transform: scale(0) rotate(360deg); opacity: 0; } }
        @keyframes diamond-vortex { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(720deg); opacity: 0; } }
        @keyframes game-over-swirl { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(-360deg); opacity: 0; } }
        @keyframes big-coin-tumble { 0% { transform: scale(8) rotate(0deg); opacity: 1; } 50% { transform: scale(5) rotate(360deg); } 100% { transform: scale(1) rotate(720deg); opacity: 1; } }
        .coin { position: absolute; top: 0; left: 0; width: 20px; height: 20px; background-color: #FFD700; border-radius: 50%; border: 2px solid #B8860B; pointer-events: none; z-index: 100; }
        @keyframes pulse-glow-red { 0%, 100% { box-shadow: 0 0 8px #ef4444, 0 0 15px #ef4444; } 50% { box-shadow: 0 0 12px #f87171, 0 0 25px #f87171; } }
        @keyframes pulse-glow-fire { 0%, 100% { box-shadow: 0 0 10px #fb923c, 0 0 20px #fb923c; } 50% { box-shadow: 0 0 15px #f97316, 0 0 30px #f97316; } }
        @keyframes wild-pulse-animation { 0%, 100% { transform: scale(1); box-shadow: 0 0 15px #F59E0B, 0 0 30px #F59E0B; } 50% { transform: scale(1.2) rotate(10deg); box-shadow: 0 0 25px #facc15, 0 0 50px #facc15; } }
        @keyframes big-pulse-animation { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.25); } }
        #jackpot-square.wild-pulse { animation: wild-pulse-animation 0.5s infinite ease-in-out !important; }
        @keyframes endgame-jackpot-pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px #fde047, 0 0 40px #fde047; } 50% { transform: scale(2); box-shadow: 0 0 40px #fbbf24, 0 0 80px #fbbf24; } }
        #jackpot-square.endgame-pulse { animation: endgame-jackpot-pulse 0.5s infinite ease-in-out !important; z-index: 210; }
        #jackpot-square.cooldown { background-color: #4b5563 !important; border-color: #6b7280 !important; cursor: not-allowed; }
        #solve-button.big-pulse { animation: big-pulse-animation 1.5s ease-in-out infinite; }
        .prize-tile { animation: pulse-glow-blue 1.5s infinite; cursor: pointer; font-size: 2rem; }
        .prize-tile.red-bomb { background-color: #ef4444 !important; animation-name: pulse-glow-red; }
        .prize-tile.green-bomb { background-color: #22c55e !important; animation-name: pulse-glow-green; cursor: grab; }
        .prize-tile.fire-bomb { background-color: #f97316 !important; animation-name: pulse-glow-fire; }
        .glass-panel { background-color: rgba(20, 20, 40, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        #start-modal .glass-panel, #welcome-bonus-modal .glass-panel { box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), 0 0 0 2px #f59e0b; }
        .word-puzzle-tile { background-color: #FFFFFF !important; color: #111827 !important; border: 2px solid #d1d5db; cursor: grab; }
        .word-puzzle-tile.dragging { opacity: 0.5; cursor: grabbing; }
        .word-puzzle-tile.solved { background-color: #15803d !important; color: #FFFFFF !important; border-color: #14532d; box-shadow: inset 3px 3px 4px rgba(0, 0, 0, 0.5); cursor: default; }
        .greed-panel { background-color: var(--panel-bg); border: 1px solid var(--panel-border); }
        #solve-button { background-color: var(--primary-color); color: var(--primary-text-dark); border: 1px solid var(--primary-color-light); box-shadow: 0 2px 5px rgba(0,0,0,0.4); transition: all 0.2s ease; flex-shrink: 0; }
        #solve-button:hover { background-color: var(--primary-color-dark); color: #FFFFFF; }
        #solve-button:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        #solve-button:disabled { background-color: #6b7280; color: #d1d5db; cursor: not-allowed; }
        #solve-button.cooldown-timer { font-size: 1.25rem; font-family: 'Inter', sans-serif; }
        
        .event-text {
            font-family: 'Lobster Two', cursive; font-size: 5rem; color: #FDD835;
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 2px 0 #4a2c0f, 3px 2px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
            animation: event-flash 2s ease-out forwards;
        }
        .event-text.long-flash { animation-duration: 4s; }
        .event-text.green-glow {
            color: #4ade80;
            text-shadow: -2px -2px 0 #14532d, 2px -2px 0 #14532d, -2px 2px 0 #14532d, 2px 2px 0 #14532d, 0 0 10px #4ade80, 0 0 20px #22c55e;
        }
        @keyframes event-flash { 0%, 100% { opacity: 0; transform: scale(0.8); } 20%, 80% { opacity: 1; transform: scale(1.1); } }
        
        @keyframes button-shimmer { 0% { transform: translateX(-100%) skewX(-15deg); } 100% { transform: translateX(200%) skewX(-15deg); } }
        .glassy-button {
            border: 1px solid; box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease-out; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .glassy-button::before {
            content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: button-shimmer 4s infinite linear;
        }
        .glassy-button:active { transform: translateY(2px); border-bottom-width: 2px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); }
        @keyframes start-button-pulse { 0%, 100% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } 5% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 20px #3b82f6, 0 0 40px #3b82f6; } 15% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } }
        #start-game-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; animation: start-button-pulse 15s infinite; }
        #claim-bonus-button { background: linear-gradient(145deg, #16a34a, #15803d); border-color: #4ade80; border-bottom: 4px solid #14532d; }
        #play-again-button { background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af; border-bottom: 4px solid #1f2937; }
        #close-help-button, #close-about-button, #close-playlist-button, #close-setup-button, #close-daily-rewards-button, #close-trading-post-button, #close-riches-button, #close-tips-button, #close-privacy-button, #close-giving-button, #close-badges-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; }
        #about-button, #privacy-policy-button { background: linear-gradient(145deg, #8b5cf6, #7c3aed); border-color: #a78bfa; border-bottom: 4px solid #5b21b6; }
        #setup-button { background: linear-gradient(145deg, #22c55e, #15803d); border-color: #4ade80; border-bottom: 4px solid #14532d; }
        #daily-rewards-button { background: linear-gradient(145deg, #f59e0b, #d97706); border-color: #fbbf24; border-bottom: 4px solid #92400e; }
        #tips-button, #badges-button { background: linear-gradient(145deg, #f97316, #ea580c); border-color: #fb923c; border-bottom: 4px solid #c2410c; }
        #confirm-reset-button { background: linear-gradient(145deg, #f87171, #ef4444); border-color: #fca5a5; border-bottom: 4px solid #7f1d1d; }
        .theme-button { width: 2.5rem; height: 2.5rem; border-radius: 50%; background-color: var(--panel-bg); border: 1px solid var(--panel-border); color: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; position: relative; }
        .theme-button:hover .tooltip { opacity: 1; visibility: visible; }
        .theme-button.difficulty-active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.6); transform: translateY(1px); }
        .theme-button svg { transform: scale(0.9); }
        .tooltip { visibility: hidden; opacity: 0; width: 120px; background-color: black; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; transition: opacity 0.3s; font-size: 0.75rem; }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: black transparent transparent transparent; }
        #help-button { font-size: 1.25rem; font-weight: bold; }
        #difficulty-default .orb { fill: #8B5CF6; } #difficulty-easy .orb { fill: #3B82F6; } #difficulty-medium .orb { fill: #F59E0B; } #difficulty-hard .orb { fill: #EF4444; }
        .score-decay { color: #ef4444 !important; }
        .greed-icon {
            width: 3rem; height: 3rem; background-color: var(--primary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.75rem; border: 1px solid var(--primary-color-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); cursor: pointer; color: white;
        }
        @keyframes ice-shimmer { 0% { background-position: -100% 0; } 100% { background-position: 100% 0; } }
        @keyframes crack-fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes ice-fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(90deg); opacity: 0; } }
        .ice-block {
            position: absolute; background: linear-gradient(145deg, rgba(173, 216, 230, 0.5), rgba(135, 206, 250, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.5), 0 4px 6px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 50; overflow: hidden;
        }
        .ice-block::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: ice-shimmer 3s infinite linear;
        }
        .ice-block.cracked {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44"><path d="M 10 0 L 10 15 L 0 20 L 10 25 L 10 44 M 20 0 L 25 10 L 15 15 L 25 20 L 20 44 M 35 0 L 30 22 L 44 28" stroke="rgba(255,255,255,0.7)" stroke-width="1" fill="none"/></svg>'), linear-gradient(145deg, rgba(173, 216, 230, 0.6), rgba(135, 206, 250, 0.7));
            background-size: cover; animation: crack-fade-in 0.2s forwards;
        }
        #bomb-drag-preview { position: absolute; border: 3px dashed #22c55e; background-color: rgba(34, 197, 94, 0.3); pointer-events: none; z-index: 200; display: none; }
        @keyframes cash-money-pulse { 0%, 100% { box-shadow: 0 0 15px #4ade80, 0 0 30px #4ade80; } 50% { box-shadow: 0 0 25px #22c55e, 0 0 50px #22c55e; } }
        .cash-money-prize { background-color: #16a34a !important; animation: cash-money-pulse 0.7s infinite ease-in-out; }
        @keyframes fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        @keyframes twinkle { 0%, 100% { transform: scale(0); opacity: 0; } 50% { transform: scale(1); opacity: 1; } }
        .falling-coin { position: absolute; font-size: 1.5rem; animation: fall linear forwards; pointer-events: none; }
        .sparkle { position: absolute; width: 8px; height: 8px; background-color: #fde047; border-radius: 50%; box-shadow: 0 0 5px #fde047, 0 0 10px #facc15; animation: twinkle ease-in-out infinite; pointer-events: none; }
        
        @keyframes fall-sway {
            0% { transform: translateY(-100%) translateX(0vw) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            50% { transform: translateY(50vh) translateX(5vw) rotate(180deg); }
            100% { transform: translateY(100vh) translateX(-5vw) rotate(360deg); opacity: 0; }
        }
        .falling-snowflake, .falling-heart, .falling-trophy {
            position: absolute; /* Changed to absolute for modal containment */
            top: -10%;
            font-size: 1.5rem;
            animation: fall-sway linear forwards;
            pointer-events: none;
            z-index: 55;
        }

        input[type=range].volume-slider { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range].volume-slider:focus { outline: none; }
        input[type=range].volume-slider::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].volume-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; margin-top: -7px; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }
        input[type=range].volume-slider::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].volume-slider::-moz-range-thumb { height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }
        /* Playlist & Setup Styles */
        #playlist-container { max-height: 220px; overflow-y: auto; background-color: rgba(0,0,0,0.2); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); padding: 0.5rem; border-radius: 0.5rem;}
        .playlist-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; transition: background-color 0.2s; user-select: none; cursor: pointer; }
        .playlist-item:hover { background-color: rgba(0,0,0,0.4); }
        .now-playing-indicator { font-size: 0.75rem; color: var(--primary-color-light); font-style: italic; display: none; }
        .playlist-item.now-playing { background-color: rgba(139, 92, 246, 0.3); }
        .playlist-item.now-playing .now-playing-indicator { display: block; }
        #playlist-controls { background-color: rgba(0,0,0,0.2); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); padding: 0.5rem; border-radius: 9999px; display: flex; align-items: center; gap: 0.5rem;}
        #playlist-controls button { width: 2.5rem; height: 2.5rem; }
        #playlist-controls button.shuffle-active { background: var(--primary-color); }
        #player-name-input { background-color: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); }
        #player-name-input.invalid-input { border-color: #ef4444 !important; box-shadow: 0 0 8px #ef4444; }
        #theme-store-container { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 1rem; flex-wrap: nowrap; }
        #theme-store-container::-webkit-scrollbar { height: 8px; }
        #theme-store-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #theme-store-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        .theme-item {
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
            position: relative; overflow: hidden; flex-shrink: 0; width: 160px; height: 110px;
        }
        .theme-item > div { position: relative; z-index: 1; }
        .theme-item.active { border-color: var(--primary-color-light); box-shadow: 0 0 10px var(--primary-color); }
        .theme-item.locked::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            border-radius: 0.5rem;
            z-index: 2;
        }
        .theme-item.locked::after {
            content: ' ';
            position: absolute;
            bottom: 0.25rem;
            right: 0.5rem;
            font-size: 1.75rem;
            z-index: 3;
            transform: none;
        }
        /* Daily Rewards Calendar */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .calendar-day {
            background-color: rgba(0,0,0,0.2); border: 2px solid var(--panel-border);
            border-radius: 0.5rem; padding: 0.25rem; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 80px; position: relative;
        }
        .calendar-day.claimed { background-color: #166534; color: #a7f3d0; cursor: not-allowed; }
        .calendar-day.today { background-color: var(--primary-color); border-color: var(--primary-color-light); cursor: pointer; }
        .calendar-day.today.claimed { background-color: #166534; border-color: #14532d; }
        .calendar-day.future { background-color: rgba(0,0,0,0.1); color: #6b7280; }
        .calendar-day.past-day { background-color: rgba(22, 59, 41, 0.5); color: #4b5563; cursor: not-allowed; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); }
        .calendar-day.double-bonus { border-color: #fde047; }
        .calendar-day.triple-bonus { border-color: #f87171; }
        .day-number { font-weight: bold; font-size: 0.9rem; position: absolute; top: 2px; right: 5px; }
        .reward-text { font-size: 0.65rem; line-height: 1; }
        #calendar-legend { grid-column: span 4; align-self: stretch; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; padding: 0.5rem 0.75rem; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem;}
        /* Welcome Bonus Animation */
        @keyframes bonus-reveal {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .bonus-item { animation: bonus-reveal 0.5s ease-out forwards; }
        #nonsense-freebies-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
        }
        .freebie-item { text-align: center; font-size: 1.25rem; }
        .freebie-count { font-size: 0.75rem; font-weight: bold; color: var(--primary-color-light); }
        .freebie-item.tradable {
            animation: pulse-glow-amber 1.5s infinite ease-in-out;
            border-radius: 0.5rem;
        }
        /* Help Modal Footer Layout */
        #help-modal-footer {
            display: flex; flex-direction: column; align-items: center; width: 100%; gap: 0.75rem;
        }
        /* Setup Modal Scroll FIX */
        #setup-modal > .glass-panel { /* max-height: 90vh; overflow-y: auto; */ }
        /* Background Clouds */
        @keyframes slide {
            0% { transform: translateX(-25%); }
            100% { transform: translateX(25%); }
        }
        .clouds {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 200%;
            height: 100%;
            display: block;
            z-index: -1;
            background-repeat: repeat-x;
            animation: slide 120s linear infinite;
            opacity: 0.3;
        }
        #clouds-day {
            background-image: url('https://placehold.co/2048x1024/87CEEB/FFFFFF?text=Day+Clouds+Here'); /* Replace with your day cloud PNG */
        }
        #clouds-night {
            background-image: url('https://placehold.co/2048x1024/000033/FFFFFF?text=Night+Clouds+Here'); /* Replace with your night cloud PNG */
        }

        @keyframes pulse-glow-amber { 
            0%, 100% { 
                box-shadow: 0 0 15px #f59e0b, 0 0 30px #f59e0b, inset 0 2px 4px rgba(255, 255, 255, 0.4);
                transform: scale(1);
            } 
            50% { 
                box-shadow: 0 0 30px #fbbf24, 0 0 60px #fbbf24, inset 0 2px 4px rgba(255, 255, 255, 0.4);
                transform: scale(1.05);
            } 
        }
        .trade-button-pulse {
            animation: pulse-glow-amber 1.5s infinite ease-in-out;
        }

        .trade-item, .giving-item {
            border: 2px solid var(--panel-border);
            transition: all 0.2s ease-in-out;
        }
        .trade-item.selected, .giving-item.selected {
            border-color: var(--primary-color-light);
            background-color: var(--panel-bg);
            box-shadow: 0 0 10px var(--primary-color);
        }

        /* Tips Modal & Carousel */
        #tips-carousel {
            position: relative;
            width: 100%;
            height: 200px; /* Adjust height as needed */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tip-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 2rem;
            width: 80%;
            text-align: center;
            font-size: 1.25rem;
            position: absolute;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .tip-card.active {
            opacity: 1;
            pointer-events: auto;
        }
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 2rem;
            z-index: 10;
        }
        .carousel-arrow:hover {
            background: rgba(0,0,0,0.5);
        }
        #carousel-prev { left: 1rem; }
        #carousel-next { right: 1rem; }

        /* User ID Display */
        #user-id-container {
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        #copy-userid-button {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        #copy-userid-button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        /* Privacy Policy Modal */
        #privacy-policy-content {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid var(--panel-border);
            box-shadow: inset 2px 2px 8px rgba(0,0,0,0.6);
            padding: 1rem;
            border-radius: 0.5rem;
            height: 300px;
            overflow-y: auto;
            text-align: left;
            font-size: 0.875rem;
            color: #d1d5db;
        }
        #privacy-policy-content::-webkit-scrollbar { width: 8px; }
        #privacy-policy-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #privacy-policy-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }

        /* Badges Panel */
        @keyframes badge-pulse-glow {
            0%, 100% {
                opacity: 0.8;
                box-shadow: inset 0 3px 5px rgba(255,255,255,0.2), 0 4px 6px rgba(0,0,0,0.4);
            }
            50% {
                opacity: 1;
                box-shadow: inset 0 3px 5px rgba(255,255,255,0.3), 0 4px 6px rgba(0,0,0,0.4), 0 0 10px rgba(255,255,255,0.2);
            }
        }
        #badges-panel {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 2px 4px 0 rgba(0,0,0,0.5);
        }
        .badge-item {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            position: relative;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), rgba(255,255,255,0) 70.71%),
                        radial-gradient(circle at 70% 70%, rgba(0,0,0,0.2), rgba(0,0,0,0) 70.71%);
            border: 1px solid rgba(255,255,255,0.1);
            animation: badge-pulse-glow 3s infinite ease-in-out;
        }
        
        /* Riches Modal */
        #riches-inventory {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            width: 100%;
            max-height: 40vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
        }
        .riches-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        #net-worth-panel {
            background-color: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }
        
        /* Badges Info Modal */
        #badges-modal .glass-panel {
            background: radial-gradient(ellipse at center, rgba(30, 30, 60, 0.7) 0%, rgba(10, 10, 20, 0.8) 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            border-right: 1px solid rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(0,0,0,0.3);
            box-shadow: 0 15px 30px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        #badges-info-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            width: 100%;
            max-height: 50vh;
            overflow-y: auto;
            padding: 1rem;
        }
        .badge-info-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .badge-info-card.locked {
            opacity: 0.6;
        }
        .badge-info-emoji {
            font-size: 3rem;
            flex-shrink: 0;
        }

        /* Goodie Rush Styles */
        @keyframes orb-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 15px var(--primary-color-light), 0 0 30px var(--primary-color); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px var(--primary-color-light), 0 0 50px var(--primary-color); }
        }
        .goodie-orb {
            width: 60px; height: 60px; /* Increased size */
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            position: relative;
            background-color: rgba(167, 139, 250, 0.15); /* More translucent */
            border: 1px solid rgba(196, 181, 253, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            animation: orb-pulse 2.5s infinite ease-in-out;
        }
        .goodie-orb .emoji {
            font-size: 2.5rem; /* Adjusted emoji size */
            z-index: 10; /* Ensure emoji is on top */
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .goodie-orb::before { /* Fresnel effect */
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.6), transparent 50%);
            pointer-events: none;
        }
        .goodie-orb:hover {
            transform: scale(1.15);
            background-color: rgba(167, 139, 250, 0.3);
        }
        .goodie-orb.spent {
            opacity: 0.4;
            cursor: not-allowed;
            animation: none;
            background-color: rgba(100, 100, 120, 0.2);
            border-color: rgba(150, 150, 170, 0.4);
        }
        .goodie-rush-tile {
            cursor: pointer;
            background-color: #000;
            border: 2px solid #444;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.8), 0 0 10px var(--primary-color), 3px 3px 5px rgba(0,0,0,0.7);
            transform: perspective(500px) rotateX(20deg);
            animation: cash-money-pulse 1s infinite ease-in-out;
            font-size: 2.5rem;
            z-index: 20;
        }
        .goodie-rush-tile.disappearing {
            transition: transform 0.5s, opacity 0.5s;
            transform: scale(0.1);
            opacity: 0;
        }
        #leaderboard-list {
             max-height: 200px;
             overflow-y: auto;
        }


    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">
    <script src="config.js" defer></script>

    <div id="clouds-day" class="clouds hidden"></div>
    <div id="clouds-night" class="clouds hidden"></div>

    <!-- Audio Player for background music -->
    <audio id="background-music">
        <!-- Source will be set dynamically by JavaScript -->
    </audio>

    <!-- Main Game Container -->
    <div id="game-container" class="hidden flex-col md:flex-row gap-4 justify-center md:items-stretch">
        <!-- Game Grid Section -->
        <div class="flex flex-col gap-1 items-center">
            <div class="relative">
                <div id="game-grid" class="grid grid-cols-9 gap-1 bg-slate-800/70 p-3 rounded-xl shadow-2xl border border-slate-700/50"></div>
                <!-- This div is used to show a preview of the green bomb's effect area -->
                <div id="bomb-drag-preview"></div>
            </div>
            <!-- Badges Panel -->
            <div id="badges-panel" class="w-full mt-2 p-2 rounded-xl flex justify-center items-center gap-2 h-20">
                <!-- Badges will be injected here -->
            </div>
        </div>

        <!-- Score & Control Panel -->
        <div id="score-panel" class="glass-panel p-4 rounded-xl w-full max-w-xs md:w-[20rem] flex flex-col justify-between gap-3 relative">
            <div class="flex-grow flex flex-col gap-2"> 
                <!-- Game Title -->
                <div class="relative w-full h-24 flex justify-center items-center flex-shrink-0">
                    <h1 class="game-title-style text-6xl relative" style="width: 15rem; height: 7rem; left: 1rem;">
                        <span class="absolute" style="top: 0; left: 0;">Word</span>
                        <span class="absolute" style="top: 2.7rem; left: 2.5rem;">Greed</span>
                    </h1>
                </div>
                <!-- Level and Timer Display -->
                <div class="p-2 flex justify-around text-center flex-shrink-0">
                    <div><span class="text-sm font-bold text-slate-300">LEVEL</span><div id="level-display" class="text-2xl font-bold text-white">1</div></div>
                    <div><span class="text-sm font-bold text-slate-300">TIME</span><div id="timer-display" class="text-2xl font-bold text-white">10:00</div></div>
                </div>
                <!-- Score Container -->
                <div id="score-container" class="greed-panel p-3 rounded-lg text-center flex flex-col gap-2 flex-grow">
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="text-4xl coin-rotate" style="filter: drop-shadow(0 0 5px #fde047);">🪙</div>
                        <div class="text-4xl" style="filter: drop-shadow(0 0 5px #fde047);">💰</div>
                        <div id="coins-display" class="text-lg font-bold text-white">0</div>
                        <div id="bags-of-money-display" class="text-lg font-bold text-green-400">0</div>
                    </div>
                    <!-- Greed Score and Solve Button -->
                    <div id="greed-content" class="mx-auto flex flex-col items-center justify-center gap-1 flex-grow">
                        <div class="flex items-center justify-center gap-2"><span class="text-sm font-bold text-violet-200">GREED SCORE</span></div>
                        <hr class="border-violet-300/20 w-full my-1">
                        <div class="flex items-center justify-center gap-2 mt-1">
                            <button id="solve-button" class="w-12 h-12 rounded-full text-3xl font-black flex items-center justify-center">✅</button>
                            <div id="greed-icons-container" class="flex items-center justify-center gap-2"></div>
                        </div>
                    </div>
                </div>
                 <!-- Goodie Rush Orbs -->
                <div id="goodie-rush-panel" class="greed-panel p-2 mt-2 rounded-lg">
                    <div class="flex justify-center items-center gap-2">
                         <button id="help-button" class="theme-button">?</button>
                         <div id="goodie-orbs-container" class="flex justify-center items-center gap-2">
                            <!-- Goodie orbs will be injected here -->
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Modal -->
    <div id="start-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-panel p-8 pb-12 rounded-2xl text-center flex flex-col items-center gap-6 w-full max-w-md relative overflow-hidden">
            <h1 class="game-title-style text-8xl relative" style="width: 22rem; height: 10rem;">
                <span class="absolute" style="top: 0; left: 1rem;">Word</span>
                <span class="absolute" style="top: 4rem; left: 5rem;">Greed</span>
            </h1>
            <p class="text-lg text-slate-300">Drag and drop letters to solve jumbled words. Grab Big Prizes and Get Greedy!</p>
<button id="start-game-button" class="glassy-button text-white font-bold py-3 px-8 rounded-lg text-2xl" disabled>Loading Game...</button>            <div class="absolute bottom-2 right-4 text-xs text-slate-500">v3.9</div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-6 rounded-2xl flex flex-col items-center gap-4 w-full max-w-3xl relative">
             <h3 class="text-3xl font-bold text-amber-300 mb-4">Game Over!</h3>
             <div class="flex flex-col md:flex-row gap-4 w-full">
                <!-- Left Side: Stats -->
                <div id="final-stats-panel" class="w-full md:w-1/2 greed-panel p-4 rounded-lg">
                    <h4 class="text-xl font-bold text-violet-200 mb-3 text-center">Your Stats</h4>
                    <div class="grid grid-cols-2 gap-4 text-center mb-4">
                        <div>
                            <div class="text-4xl">🪙</div>
                            <div id="final-coins-display" class="text-lg font-bold text-white">0</div>
                        </div>
                        <div>
                            <div class="text-4xl">💰</div>
                            <div id="final-bags-display" class="text-lg font-bold text-green-400">0</div>
                        </div>
                    </div>
                    <hr class="border-violet-300/20 w-full my-3">
                    <h5 class="text-md font-bold text-violet-200 mb-2 text-center">Goodies Collected This Round</h5>
                    <div id="final-goodies-inventory" class="grid grid-cols-4 gap-2 text-center max-h-40 overflow-y-auto p-1">
                        <!-- Collected goodies will be injected here -->
                    </div>
                </div>
                <!-- Right Side: Leaderboard -->
                <div id="leaderboard-panel" class="w-full md:w-1/2 greed-panel p-4 rounded-lg">
                     <h4 class="text-xl font-bold text-violet-200 mb-3 text-center">Leaderboard</h4>
                     <div id="leaderboard-list" class="space-y-2">
                        <!-- Leaderboard entries will be injected here -->
                     </div>
                </div>
             </div>
            <button id="play-again-button" class="glassy-button mt-4 text-white font-bold py-3 px-8 rounded-lg text-xl">Play Again</button>
        </div>
    </div>
    
    <!-- Floating Event Text (e.g., "Level Up!") -->
    <div id="event-text-container" class="hidden fixed inset-0 flex items-center justify-center pointer-events-none z-[80]">
        <div id="event-text" class="event-text text-center"></div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-3 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300">How to Play</h2>
            <table class="w-full text-sm my-2">
                <tbody>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">✅</td><td class="py-1 pr-2 font-bold text-green-400">Complete Words</td><td class="py-1 text-slate-300">Drag letters to solve words for <strong>10,000 coins</strong>. Solve all 4 for a big bonus!<br>Press the green checkmark for Quick Solve.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">🎁</td><td class="py-1 pr-2 font-bold text-white">Present</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">1,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">🏆</td><td class="py-1 pr-2 font-bold text-white">Trophy</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">3,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">💎</td><td class="py-1 pr-2 font-bold text-white">Diamond</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">20,000,000</span> coins & board clear.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">⚡</td><td class="py-1 pr-2 font-bold text-white">Lightning</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">20,000</span> coins, but <strong class="text-red-400">resets Bags of Money!</strong></td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">💣</td><td class="py-1 pr-2 font-bold text-green-400">Green Bomb</td><td class="py-1 text-slate-300">Drag to a puzzle to solve key letters & collect prizes.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">💣</td><td class="py-1 pr-2 font-bold text-red-400">Red Bomb</td><td class="py-1 text-slate-300">GAME OVER!</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">❄️</td><td class="py-1 pr-2 font-bold text-blue-300">Snowflake</td><td class="py-1 text-slate-300">Freezes all prizes for 15 seconds.</td></tr>
                </tbody>
            </table>
            <div id="help-modal-footer" class="mt-2">
                <div class="flex justify-center w-full items-center gap-2 max-w-xs mx-auto">
                    <button id="volume-toggle-button" class="text-2xl hover:text-white text-slate-300 transition-colors"></button>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" class="volume-slider">
                </div>
                <div class="flex justify-center w-full flex-wrap items-center gap-2">
                    <button id="playlist-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Playlist</button>
                    <button id="daily-rewards-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Daily</button>
                    <button id="tips-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Tips</button>
                    <button id="badges-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Badges</button>
                    <button id="setup-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Setup</button>
                    <button id="about-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">About</button>
                    <button id="close-help-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Close</button>
                </div>
            </div>
            <div class="absolute bottom-2 right-4 text-xs text-slate-500">v3.9</div>
        </div>
    </div>

    <!-- Badges Info Modal -->
    <div id="badges-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Badges</h2>
            <div id="badges-info-container">
                <!-- Badge info cards will be injected here -->
            </div>
            <button id="close-badges-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Tips Modal -->
    <div id="tips-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Game Tips</h2>
            <div id="tips-carousel" class="w-full">
                <div id="carousel-prev" class="carousel-arrow">⬅️</div>
                <div id="tip-card-container" class="w-full h-full flex items-center justify-center">
                    <!-- Tip cards will be injected here -->
                </div>
                <div id="carousel-next" class="carousel-arrow">➡️</div>
            </div>
            <button id="close-tips-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">About Word Greed</h2>
            <div class="text-slate-300 space-y-2">
                <p>Created by: <span class="font-bold text-white">Floyd Kelly</span></p>
                <p>Music by: <span class="font-bold text-white">Floyd Kelly and Udio</span></p>
                <p><span class="font-bold text-white">Concept:</span> Floyd Kelly, <span class="font-bold text-white">Code:</span> Google Gemini</p>
                <p>Version: <span class="font-bold text-white">3.9</span></p>
                <p>Build Date: <span class="font-bold text-white">August 11, 2025</span></p>
                <p><a href="https://floydkellycreates.wordpress.com/contact-me/" target="_blank" class="text-purple-300 hover:text-purple-200">Contact the Developer</a></p>
            </div>
            <div class="flex justify-between w-full mt-4">
                <button id="privacy-policy-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-sm">Privacy Policy</button>
                <button id="close-about-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Privacy Policy</h2>
            <div id="privacy-policy-content">
                Loading...
            </div>
            <button id="close-privacy-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Playlist Modal -->
    <div id="playlist-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative">
            <h2 class="text-2xl font-bold text-amber-300">Soundtrack Playlist</h2>
            <div id="playlist-container" class="w-full space-y-1 my-2 text-left">
                <!-- Playlist items will be injected here by JS -->
            </div>
            <div id="playlist-controls" class="flex items-center justify-center gap-4 my-4">
                <button id="playlist-prev" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.006V5.994a1 1 0 00-1.555-.832L4.16 9.168a1 1 0 000 1.664l4.286 4.001zM11 5h2v10h-2V5z"></path></svg>
                </button>
                <button id="playlist-play-pause" class="glassy-button p-3 rounded-full w-14 h-14" style="background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd;">
                    <!-- Play/Pause SVG will be injected here -->
                </button>
                <button id="playlist-next" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 5.168A1 1 0 0010 5.994v8.012a1 1 0 001.555.832l4.286-4.001a1 1 0 000-1.664l-4.286-4.001zM7 5h2v10H7V5z"></path></svg>
                </button>
                <button id="playlist-shuffle" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;">
                     <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.083 4.083a.75.75 0 011.06 0L9.47 8.414l1.72-1.72a.75.75 0 111.06 1.06l-1.72 1.72 4.327 4.327a.75.75 0 01-1.06 1.06L9.47 10.586l-1.72 1.72a.75.75 0 11-1.06-1.06l1.72-1.72L4.083 5.143a.75.75 0 010-1.06zM6.5 14.25a.75.75 0 01.75-.75h8a.75.75 0 010 1.5h-8a.75.75 0 01-.75-.75zm0-8.5a.75.75 0 01.75-.75h8a.75.75 0 010 1.5h-8a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <button id="close-playlist-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Setup & Store Modal -->
    <div id="setup-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Player Setup & Store</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center">
                <div class="greed-panel p-2 rounded-lg">
                    <label for="player-name-input" class="text-sm font-bold text-slate-300">PLAYER NAME</label>
                    <input type="text" id="player-name-input" class="w-full mt-1 p-1 rounded-md text-center text-lg font-bold" placeholder="Enter Name">
                </div>
                <div class="greed-panel p-2 rounded-lg">
                    <div class="text-sm font-bold text-slate-300">TOTAL MONEY BAGS</div>
                    <div id="total-bags-display" class="text-2xl font-bold text-green-400">0</div>
                </div>
                <div class="greed-panel p-2 rounded-lg">
                    <div class="text-sm font-bold text-slate-300">Highest Score</div>
                    <div id="high-score-display" class="text-2xl font-bold text-white">0</div>
                </div>
            </div>

            <div class="greed-panel p-4 rounded-lg">
                <h3 class="text-lg font-bold text-amber-300 text-left mb-3">Awarded Goodies</h3>
                <div class="flex items-center justify-between">
                    <div id="nonsense-freebies-container" class="flex-grow">
                        <!-- Nonsense freebies will be injected here -->
                    </div>
                    <button id="trade-goodies-button" class="glassy-button text-white font-bold rounded-lg text-lg ml-4" style="background: linear-gradient(145deg, #f59e0b, #d97706); border-color: #fbbf24; width: 160px; height: 55px;">Trade</button>
                </div>
            </div>
            
            <div class="mt-2">
                <h3 class="text-lg font-bold text-amber-300 text-left">Theme Store</h3>
                <div id="theme-store-container" class="mt-2">
                    <!-- Themes will be injected here -->
                </div>
            </div>
            <div class="flex justify-between items-center mt-4">
                <div class="flex items-center gap-4">
                    <button id="riches-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-sm" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;">View Riches</button>
                    <div id="user-id-container">
                        <span id="user-id-display"></span>
                        <button id="copy-userid-button">Copy</button>
                    </div>
                </div>
                <button id="reset-progress-button" class="text-xs text-red-400 hover:text-red-300">Reset Progress</button>
                <button id="close-setup-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Reset Modal -->
    <div id="confirm-reset-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-sm relative text-center">
            <h2 class="text-xl font-bold text-red-400">Reset Progress?</h2>
            <p class="text-slate-300">Are you sure? All your stats, money bags, and unlocked themes will be permanently deleted.</p>
            <div class="flex items-center gap-4 mt-4">
                <button id="cancel-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Cancel</button>
                <button id="confirm-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Daily Rewards Modal -->
    <div id="daily-rewards-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Daily Rewards</h2>
            <div id="calendar-grid" class="w-full">
                <!-- Calendar will be populated by JS -->
            </div>
            <button id="close-daily-rewards-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Welcome Bonus Modal -->
    <div id="welcome-bonus-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[70] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">Welcome Back!</h2>
            <p class="text-slate-300">Here's your daily bonus for playing!</p>
            <div id="bonus-rewards-container" class="flex items-center justify-center gap-4 my-4 flex-wrap">
                <!-- Bonus items will be injected here -->
            </div>
            <button id="claim-bonus-button" class="glassy-button text-white font-bold py-3 px-8 rounded-lg text-xl">Claim!</button>
        </div>
    </div>

    <!-- Trading Post Modal -->
    <div id="trading-post-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Trading Post</h2>
            <div class="flex gap-4 mt-4">
                <div id="available-trades-container" class="w-1/2 grid grid-cols-2 gap-2">
                    <!-- Available trades will be injected here -->
                </div>
                <div id="trade-preview-panel" class="w-1/2 greed-panel flex flex-col items-center justify-center p-4 rounded-lg">
                    <div id="trade-preview-emoji" class="text-8xl">❔</div>
                    <div id="trade-preview-name" class="text-xl font-bold mt-2">Select a Trade</div>
                </div>
            </div>
            <div class="flex justify-center mt-4 gap-4">
                 <button id="give-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;">Give</button>
                 <button id="execute-trade-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #22c55e, #15803d); border-color: #4ade80;" disabled>Trade</button>
                <button id="close-trading-post-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Giving Modal -->
    <div id="giving-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[70] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Give to Charity</h2>
            <p id="giving-confirmation-text" class="text-slate-300 text-center text-sm">Select an item from your riches to donate and earn a badge!</p>
            <div id="giving-inventory" class="grid grid-cols-4 gap-4 mt-4">
                <!-- Inventory items for giving will be injected here -->
            </div>
            <div class="flex justify-center mt-4 gap-4">
                <button id="execute-give-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;" disabled>Give Selected Item</button>
                <button id="close-giving-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Riches Modal -->
    <div id="riches-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-3xl relative">
             <h2 class="text-2xl font-bold text-amber-300 text-center">Your Riches</h2>
             <div id="riches-inventory" class="min-h-[200px]">
                <!-- Inventory items will be injected here -->
             </div>
             <hr class="w-full border-t border-slate-600 my-4">
             <div id="net-worth-panel">
                <!-- Net worth description will be injected here -->
             </div>
             <button id="close-riches-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg self-center">Close</button>
        </div>
    </div>
    
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const gridContainer = document.getElementById('game-grid');
        const musicPlayer = document.getElementById('background-music');
        const playerNameInput = document.getElementById('player-name-input');
        const goodieOrbsContainer = document.getElementById('goodie-orbs-container');

        // --- Firebase State ---
        let auth, db, userId;
        let isFirebaseConnected = false;

        // --- Game Data & State ---
        let coins = 0, bagsOfMoney = 0, draggedTile = null, playerData = {}, currentLevel = 1;
        const totalGameTime = 600; // 10 minutes
        let timeRemaining = totalGameTime, mainTimerInterval = null, prizeSpawnerTimeout = null;
        let diamondSequenceTimeout = null, puzzles = [], trophyCollectedThisLevel = false;
        let diamondCollectedThisLevel = false, currentDiamondValue = 20000000;
        let solveButtonClicks = 0, solveButtonCooldown = 0, solveButtonTimerInterval = null;
        let isGamePaused = true, isGameOver = false, timeSinceLastSolve = 0;
        let scoreDecayInterval = null, impTimeout = null, isFrozen = false, thawTimeout = null;
        let jackpotEventAvailable = true, specialJackpotTimeout = null, specialCashEmojiSpawned = false;
        let timedEvents = { sixMin: true, threeMin: true, heartEvent1: true, heartEvent2: true };
        let isSpecialAnimationActive = false;
        let startModalAnimationInterval = null, maxSameEmoji = 4, isDraggingBomb = false;
        let lastVolume = 0.5, solveButtonPulseManager = null;
        let freezeAnimationInterval = null, heartAnimationInterval = null, gameOverAnimationInterval = null;
        let badgesModalAnimationInterval = null;
        let endgameJackpotActive = false;
        let levelGoodies = [];
        let selectedTrade = null;
        let selectedDonation = null;
        
        // --- Goodie Rush State ---
        let isGoodieRushActive = false;
        let goodieRushTimerInterval = null;
        let goodieRushTimeRemaining = 20; // 20 seconds
        let goodieOrbs = [];
        let currentGoodieRushCollections = {};


        // --- Playlist Data ---
        const songDatabase = [
            { id: '001', title: 'Word Greed', filename: 'wordgreed001.mp3' },
            { id: '002', title: 'Diamond Focus', filename: 'wordgreed002.mp3' },
            { id: '003', title: 'Elevated Echoes', filename: 'wordgreed003.mp3' },
            { id: '004', title: 'Smooth Vibes', filename: 'wordgreed004.mp3' },
            { id: '005', title: 'Cash Flow', filename: 'wordgreed005.mp3' },
            { id: '006', title: 'Golden Glow', filename: 'wordgreed006.mp3' },
            { id: '007', title: 'Rich Shadows', filename: 'wordgreed007.mp3' },
            { id: '008', title: 'Reversal of Fortune', filename: 'wordgreed008.mp3' },
            { id: '009', title: 'Ascending Choices', filename: 'wordgreed009.mp3' },
            { id: '010', title: 'Soul Beyond Desires', filename: 'wordgreed010.mp3' }
        ];
        let verifiedPlaylist = [], userPlaylist = [], originalUserPlaylist = [];
        let currentTrackIndex = 0, isShuffled = false;
        const musicBaseURL = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/';
        const mutedIconHref = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png';
        const speakerSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M 20 40 L 40 40 L 60 20 L 60 80 L 40 60 L 20 60 Z" fill="white" stroke="black" stroke-width="2"/><path d="M 70 30 C 80 40, 80 60, 70 70" stroke="white" stroke-width="5" fill="none"/><path d="M 80 20 C 95 35, 95 65, 80 80" stroke="white" stroke-width="5" fill="none"/></svg>`;
        const speakerIconHref = `data:image/svg+xml,${encodeURIComponent(speakerSVG)}`;

        // --- Word Bank & Prize Data ---
        const wordBank = ["ABROAD","ACCEPT","ACCESS","ACROSS","ACTION","ACTIVE","ADMIRE","ADVICE","AFFAIR","AFFECT","AFFORD","AGENCY","AGENDA","ALMOST","ALWAYS","AMOUNT","ANIMAL","ANNUAL","ANSWER","ANYONE","ANYWAY","APART","APPEAL","APPEAR","APPLY","APPROVE","AROUND","ARRIVE","ARTIST","ASLEEP","ASPECT","ASSESS","ASSIST","ASSUME","ATTACK","ATTEND","ATTRACT","AUTHOR","AWARD","BALANCE","BECOME","BEHAVE","BELIEF","BELONG","BENEATH","BENEFIT","BESIDE","BEYOND","BISHOP","BORDER","BOTTLE","BOTTOM","BRANCH","BREATH","BRIDGE","BRIEFLY","BRIGHT","BROKEN","BUDGET","BURDEN","CAMERA","CANCEL","CANCER","CANDLE","CAPITAL","CAREER","CAREFUL","CENTRAL","CENTURY","CERTAIN","CHAIR","CHALLENGE","CHANCE","CHANGE","CHARGE","CHOICE","CHOOSE","CHURCH","CIRCLE","CLIENT","CLIMB","CLOSELY","CLOSER","COFFEE","COLLECT","COLLEGE","COLUMN","COMBINE","COMFORT","COMMAND","COMMENT","COMMIT","COMMON","COMPARE","COMPETE","COMPLEX","CONCEPT","CONCERN","CONFIRM","CONFLICT","CONNECT","CONSENT","CONSIST","CONTACT","CONTAIN","CONTENT","CONTEST","CONTEXT","CONTROL","CONVERT","CORNER","COUNCIL","COUNTY","COUPLE","COVER","CREATE","CREDIT","CRISIS","CRITERION","CRITIC","CROWD","CULTURE","CURRENT","CUSTOM","DAMAGE","DANGER","DEALER","DEBATE","DECADE","DECIDE","DECLARE","DECREASE","DEEPLY","DEFAULT","DEFENCE","DEFEND","DEFINE","DEGREE","DELAY","DELIVER","DEMAND","DEPEND","DEPICT","DEPOSIT","DEPUTY","DERIVE","DESIGN","DESIRE","DESPITE","DESTROY","DETAIL","DETECT","DEVELOP","DEVICE","DEVOTE","DIFFER","DIFFICULT","DINNER","DIRECT","DISCUSS","DISEASE","DISMISS","DISPLAY","DISTANT","DIVIDE","DIVISION","DOCTOR","DOCUMENT","DOUBLE","DOUBT","DOZEN","DREAM","DRINK","DRIVE","EAGER","EARLY","EARTH","EASTERN","ECONOMIC","ECONOMY","EDITOR","EDUCATE","EFFECT","EFFORT","EIGHT","EITHER","ELDERLY","ELECT","ELEMENT","ELSE","EMERGE","EMPHASIS","EMPLOY","ENABLE","ENCOURAGE","ENGINE","ENJOY","ENOUGH","ENSURE","ENTER","ENTIRE","ENTITLE","EQUALLY","EQUIP","ESCAPE","ESSAY","ESSENTIAL","ESTATE","ETHNIC","EVENT","EVERY","EXACTLY","EXAMINE","EXAMPLE","EXCEED","EXCEPT","EXCHANGE","EXCITE","EXCLUDE","EXCUSE","EXERCISE","EXIST","EXPECT","EXPENSE","EXPERIENCE","EXPERT","EXPLAIN","EXPLORE","EXPOSE","EXPRESS","EXTEND","EXTENT","EXTERNAL","EXTRA","EXTREME","FACTOR","FACULTY","FAILED","FAILURE","FAIRLY","FAITH","FAMLIAR","FAMOUS","FARMER","FASHION","FATHER","FAVOUR","FEELING","FEMALE","FIFTEEN","FIGHT","FIGURE","FINANCE","FINALLY","FINGER","FINISH","FLIGHT","FLOWER","FOLLOW","FOOTBALL","FORCE","FOREIGN","FOREST","FORGET","FORMAL","FORMER","FORWARD","FOUND","FOURTH","FRAME","FREEDOM","FRIEND","FUNCTION","FUTURE","GARDEN","GATHER","GENERAL","GENERATION","GENTLE","GLOBAL","GOLDEN","GROUND","GROWTH","GUARD","GUILTY","HANDLE","HAPPEN","HARDLY","HEALTH","HEAVILY","HEIGHT","HENCE","HOLIDAY","HORSE","HOSPITAL","HOUSE","HOWEVER","HUMAN","HUSBAND","IMPACT","IMPLY","IMPORT","IMPOSE","IMPROVE","INCLUDE","INCREASE","INDEED","INDICATE","INDIVIDUAL","INDUSTRY","INFORM","INITIAL","INJURY","INSIDE","INSIST","INSTANCE","INSTEAD","INSTITUTE","INTEND","INTEREST","INTERNAL","INVOLVE","ISLAND","ISSUE","ITSELF","JOINT","JUDGE","JUDGMENT","JUNIOR","JUSTICE","LABOUR","LANGUAGE","LARGELY","LATTER","LAUGH","LAWYER","LEADER","LEAGUE","LEARN","LEAVE","LEGAL","LENGTH","LESSON","LETTER","LEVEL","LIBERAL","LIBRARY","LICENCE","LIMIT","LIMITED","LITTLE","LOCAL","LONDON","LONGER","MACHINE","MAJOR","MANAGE","MANAGER","MANNER","MANY","MARKET","MARRIAGE","MATCH","MATERIAL","MATTER","MEASURE","MEDIA","MEDICAL","MEETING","MEMBER","MEMORY","MENTAL","MENTION","MERELY","METHOD","MIDDLE","MIGHT","MILE","MILITARY","MINISTER","MINOR","MINORITY","MINUTE","MISSION","MISTAKE","MODEL","MODERN","MODULE","MOMENT","MONEY","MONTH","MORAL","MORNING","MOTHER","MOTION","MOTOR","MOUNTAIN","MOUTH","MOVEMENT","MOVIE","MUCH","MUSIC","MYSELF","NARROW","NATION","NATIONAL","NATIVE","NATURAL","NATURE","NEARLY","NECESSARY","NEEDLE","NEITHER","NERVE","NETWORK","NEVER","NEWLY","NIGHT","NOBODY","NORMAL","NORTHERN","NOTICE","NOTION","NOWHERE","NUMBER","OBJECT","OBSERVE","OBTAIN","OBVIOUS","OCCASION","OCCUR","OFFENCE","OFFER","OFFICE","OFFICER","OFFICIAL","OFTEN","ONCE","ONLINE","ONLY","ONTO","OPENING","OPERATE","OPPORTUNITY","OPPOSE","OPPOSITE","ORDER","ORDINARY","ORGANISE","ORIGIN","ORIGINAL","OTHER","OUGHT","OUTCOME","OUTSIDE","OVERALL","OWNER","PACKAGE","PAINT","PANEL","PARENT","PARISH","PARLIAMENT","PARTLY","PARTNER","PARTY","PASSAGE","PATIENT","PATTERN","PEACE","PEOPLE","PERFORM","PERHAPS","PERIOD","PERMIT","PERSON","PERSONAL","PHONE","PHOTO","PHYSICAL","PICTURE","PIECE","PLACE","PLANNING","PLANT","PLASTIC","PLAYER","POCKET","POINT","POLICE","POLICY","POLITICAL","POLLUTION","POPULAR","POSITION","POSITIVE","POSSIBLE","POSTER","POWER","PRACTICE","PREFER","PREPARE","PRESENCE","PRESENT","PRESIDENT","PRESS","PRESSURE","PRETTY","PREVIOUS","PRICE","PRIMARY","PRINCIPLE","PRINT","PRIOR","PRIORITY","PRISON","PRIVATE","PROBABLY","PROBLEM","PROCEDURE","PROCESS","PRODUCE","PRODUCT","PROFESSION","PROFILE","PROFIT","PROGRAM","PROGRESS","PROJECT","PROMISE","PROMOTE","PROPER","PROPERTY","PROPOSE","PROTECT","PROVIDE","PUBLIC","PUBLISH","PURPOSE","PUSH","QUALITY","QUARTER","QUESTION","QUICKLY","QUITE","RAISE","RANGE","RAPIDLY","RATELY","RATHER","REACH","REACTION","READER","READING","READY","REALISE","REALLY","REASON","RECALL","RECEIVE","RECENT","RECENTLY","RECOGNISE","RECORD","RECOVER","REDUCE","REFER","REFLECT","REFORM","REFUSE","REGARD","REGION","REGIONAL","REGULAR","RELATE","RELATION","RELATIVE","RELEASE","RELEVANT","RELIEF","RELIGION","REMAIN","REMEMBER","REMOVE","REPEAT","REPLACE","REPLY","REPORT","REPRESENT","REQUEST","REQUIRE","RESEARCH","RESOURCE","RESPECT","RESPOND","RESPONSE","RESULT","RETAIN","RETURN","REVEAL","REVENUE","REVIEW","REVOLUTION","RIGHT","RING","RISE","ROAD","ROLE","ROOM","ROUND","ROUTE","ROYAL","RULE","SAFETY","SALE","SAME","SAMPLE","SAVE","SCALE","SCENE","SCHEME","SCHOOL","SCIENCE","SCORE","SCREEN","SEARCH","SEASON","SECOND","SECRETARY","SECTION","SECTOR","SECURE","SEEM","SELECT","SENIOR","SENSE","SENSITIVE","SENTENCE","SEPARATE","SEQUENCE","SERIES","SERIOUS","SERVANT","SERVICE","SESSION","SETTLE","SEVEN","SEVERAL","SEVERE","SHARE","SHEET","SHOOT","SHORT","SHOT","SHOULD","SHOULDER","SHOUT","SHOW","SIDE","SIGHT","SIGN","SIGNAL","SILENCE","SIMPLE","SIMPLY","SINCE","SINGLE","SISTER","SITE","SITUATION","SIZE","SKILL","SKIN","SLEEP","SLIGHTLY","SLOWLY","SOCIAL","SOCIETY","SOLDIER","SOLUTION","SOME","SOMEHOW","SOMEONE","SOMETHING","SOMETIMES","SOMEWHAT","SOON","SORRY","SORT","SOUND","SOURCE","SOUTHERN","SPACE","SPEAK","SPECIAL","SPECIFIC","SPEECH","SPEED","SPEND","SPIRIT","SPORT","SPOT","SPREAD","SPRING","SQUARE","STAFF","STAGE","STAND","STANDARD","START","STATE","STATEMENT","STATION","STATUS","STAY","STEP","STILL","STOCK","STONE","STOP","STORE","STORY","STRAIGHT","STRANGE","STRATEGY","STREET","STRENGTH","STRESS","STRIKE","STRONG","STRUCTURE","STUDENT","STUDIO","STUDY","STYLE","SUBJECT","SUBMIT","SUCCEED","SUCCESS","SUCH","SUDDENLY","SUFFER","SUGGEST","SUMMER","SUPPORT","SUPPOSE","SURELY","SURFACE","SURVEY","SURVIVE","SWITCH","SYSTEM","TABLE","TAKE","TALK","TARGET","TASK","TEACH","TEACHER","TEAM","TECHNOLOGY","TELEPHONE","TELEVISION","TEMPERATURE","TERM","TERRIBLE","TEST","THANKS","THEATRE","THEIR","THEME","THEMSELVES","THEN","THEORY","THERE","THESE","THEY","THING","THINK","THIRD","THIRTY","THIS","THOSE","THOUGH","THOUSAND","THREAT","THREATEN","THREE","THROUGH","THROW","TICKET","TIME","TITLE","TODAY","TOGETHER","TOMORROW","TONE","TONIGHT","TOTAL","TOTALLY","TOUCH","TOUR","TOWARDS","TOWN","TRADE","TRADITION","TRAFFIC","TRAIN","TRAINING","TRANSFER","TRANSPORT","TRAVEL","TREAT","TREATMENT","TREATY","TREE","TREND","TRIAL","TRIP","TROOP","TROUBLE","TRUE","TRUST","TRUTH","TWENTY","TWICE","TYPE","UNDER","UNDERSTAND","UNION","UNIQUE","UNIT","UNITED","UNIVERSITY","UNLESS","UNLIKE","UNTIL","UPON","UPPER","URBAN","USER","USUAL","USUALLY","VALLEY","VALUE","VARIETY","VARIOUS","VEHICLE","VERSION","VERY","VIDEO","VIEW","VILLAGE","VIOLENCE","VISION","VISIT","VISITOR","VOICE","VOLUME","VOTE","WAIT","WALK","WALL","WANT","WAR","WATCH","WATER","WAY","WEALTH","WEAPON","WEAR","WEATHER","WEEK","WEEKEND","WEIGHT","WELCOME","WELL","WESTERN","WHAT","WHATEVER","WHEN","WHERE","WHETHER","WHICH","WHILE","WHITE","WHOLE","WHOM","WHOSE","WIDE","WIDELY","WIFE","WILD","WILL","WINDOW","WINE","WINTER","WISH","WITHIN","WITHOUT","WOMAN","WONDER","WOOD","WORD","WORK","WORKER","WORLD","WORRY","WORTH","WOULD","WRITE","WRITER","WRONG","YARD","YEAR","YOUNG","YOURSELF","YOUTH"];
        const prizeEmojis = [ { emoji: '🎁', value: 1500000, type: 'coins' }, { emoji: '🏆', value: 3500000, type: 'trophy' }, { emoji: '💎', value: 20000000, type: 'diamond' }, { emoji: '💣', value: 0, type: 'game_over' }, { emoji: '💣', value: 0, type: 'green_bomb' }, { emoji: '⭐', value: 5000, type: 'coins' }, { emoji: '⚡', value: 20000, type: 'lightning' }, { emoji: '❄️', value: 0, type: 'freeze' }, { emoji: '🔥', value: 400, type: 'fire_column'}, { emoji: '💰', value: 1000000, type: 'cash_money' } ];
        const nonsenseFreebies = ['🌭','🥞','🍕','🍔','🍟','🍗','🥠','🍩', '🍰', '🍭', '🍋‍🟩', '🧋', '🍷', '🍫', '☕', '🍪'];
        const puzzleLayouts = [ { length: 5, indices: [11, 12, 13, 14, 15] }, { length: 7, indices: [28, 29, 30, 31, 32, 33, 34] }, { length: 7, indices: [46, 47, 48, 49, 50, 51, 52] }, { length: 5, indices: [65, 66, 67, 68, 69] } ];
        const trades = [
            { id: 'trade001', name: '10 🌭 for 1 Food Truck', cost: { '🌭': 10 }, reward: { type: 'inventory', item: '🚚', amount: 1 } },
            { id: 'trade002', name: '15 🥞 for 1 Diner', cost: { '🥞': 15 }, reward: { type: 'inventory', item: '🏛️', amount: 1 } },
            { id: 'trade003', name: '20 🍕 for 1 Pizzeria', cost: { '🍕': 20 }, reward: { type: 'inventory', item: '🍕', amount: 1 } },
            { id: 'trade004', name: '25 🍔 for 1 Burger Chain', cost: { '🍔': 25 }, reward: { type: 'inventory', item: '🍔', amount: 1 } },
            { id: 'trade005', name: '30 🍟 for 1 Potato Farm', cost: { '🍟': 30 }, reward: { type: 'inventory', item: '🥔', amount: 1 } },
            { id: 'trade006', name: '25 🍗 for 1 Chicken Farm', cost: { '🍗': 25 }, reward: { type: 'inventory', item: '🐔', amount: 1 } },
            { id: 'trade007', name: '20 🥠 for 1 Chip Plant', cost: { '🥠': 20 }, reward: { type: 'inventory', item: '💽', amount: 1 } },
            { id: 'trade008', name: '15 🍩 for 1 Donut Shop', cost: { '🍩': 15 }, reward: { type: 'inventory', item: '🍩', amount: 1 } },
            { id: 'trade009', name: '10 🍰 for 1 TV Show', cost: { '🍰': 10 }, reward: { type: 'inventory', item: '📺', amount: 1 } },
            { id: 'trade010', name: '5 🍭 for 1 Candy Vendor', cost: { '🍭': 5 }, reward: { type: 'inventory', item: '🍬', amount: 1 } },
            { id: 'trade011', name: '2 🍋‍🟩 for 2M Money Bags', cost: { '🍋‍🟩': 2 }, reward: { type: 'bags', amount: 2000000 } },
            { id: 'trade012', name: '1 🧋 for 2K Coins', cost: { '🧋': 1 }, reward: { type: 'coins', amount: 2000 } },
            { id: 'trade013', name: '1 🍷 for 1 Restaurant', cost: { '🍷': 1 }, reward: { type: 'inventory', item: '🍷', amount: 1 } },
            { id: 'trade014', name: '10 🍫 for 1 Candy Factory', cost: { ' ': 10 }, reward: { type: 'inventory', item: '🏭', amount: 1 } },
            { id: 'trade015', name: '20 ☕ for 1 Headache', cost: { '☕': 20 }, reward: { type: 'inventory', item: '🤕', amount: 1 } },
            { id: 'trade016', name: '25 🍪 for 2 Gold Mines', cost: { '🍪': 25 }, reward: { type: 'inventory', item: '⛏️', amount: 2 } }
        ];
        const inventoryItemNames = {
            '🚚': 'Food Truck', '🏛️': 'Diner', '🍕': 'Pizzeria', '🍔': 'Burger Chain',
            '🥔': 'Potato Farm', '🐔': 'Chicken Farm', '💽': 'Chip Plant', '🍩': 'Donut Shop',
            '📺': 'TV Show', '🍬': 'Candy Vendor', '🍷': 'Restaurant', '🏭': 'Candy Factory',
            '🤕': 'Headache', '⛏️': 'Gold Mine'
        };
        const tips = [
            "💡 Tip! The green bomb is your friend! Drag it anywhere and drop on a word to auto solve.",
            "💡 Another Tip! The green bomb has a range of 9 squares and will capture all freebies!",
            "💡 Tip! If you lose a big chunk of coins during game play, keep playing and in seconds be rich again!",
            "💡 Tip! The green checkmark is your friend to quick solve.",
            "💡 Wow! Another tip for you. Use the green checkmark to break an ice level with ease!"
        ];
        let currentTipIndex = 0;
        
        // --- Game Logic Functions ---
        function generatePuzzlesForLevel() {
            puzzles = [];
            let availableWords = [...wordBank];
            puzzleLayouts.forEach(layout => {
                const wordsOfLength = availableWords.filter(w => w.length === layout.length);
                if (wordsOfLength.length > 0) {
                    const word = wordsOfLength[Math.floor(Math.random() * wordsOfLength.length)];
                    puzzles.push({ word: word, indices: layout.indices, solved: false });
                    availableWords = availableWords.filter(w => w !== word); 
                }
            });
        }
        
        function startLevel() {
            document.getElementById('level-display').textContent = currentLevel;
            trophyCollectedThisLevel = false;
            diamondCollectedThisLevel = false;
            solveButtonClicks = 0;
            timeSinceLastSolve = 0;
            clearTimeout(diamondSequenceTimeout);
            clearTimeout(thawTimeout);
            const iconsContainer = document.getElementById('greed-icons-container');
            iconsContainer.innerHTML = '';
            generatePuzzlesForLevel();
            initializeGrid();
            setupGoodieOrbs();
        }

        function initializeGrid() {
            gridContainer.innerHTML = '';
            puzzles.forEach(p => p.scrambled = shuffleWord(p.word));
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);

            for (let i = 0; i < 81; i++) {
                const tile = document.createElement('div');
                tile.classList.add('w-10', 'h-10', 'md:w-11', 'md:h-11', 'flex', 'items-center', 'justify-center', 'text-2xl', 'font-bold', 'rounded-lg', 'select-none');
                tile.id = `tile-${i}`;

                if (allPuzzleIndices.includes(i)) {
                    for (const puzzle of puzzles) {
                        if (puzzle.indices.includes(i)) {
                            const letterIndex = puzzle.indices.indexOf(i);
                            tile.textContent = puzzle.scrambled[letterIndex];
                            tile.classList.add('word-puzzle-tile');
                            tile.dataset.puzzleIndex = puzzles.indexOf(puzzle);
                            tile.draggable = true;
                            addDragListeners(tile);
                            break;
                        }
                    }
                } else if (i === 40) {
                    tile.id = 'jackpot-square';
                    tile.classList.add('bg-amber-500', 'border-2', 'border-amber-300', 'text-4xl');
                    tile.textContent = '💰';
                    tile.addEventListener('click', onJackpotClick);
                } else {
                    tile.classList.add('bg-slate-900/50', 'border', 'border-slate-800/50');
                }
                gridContainer.appendChild(tile);
            }
        }

        function shuffleWord(word) {
            let array = word.split('');
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            let shuffled = array.join('');
            return shuffled === word ? shuffleWord(word) : shuffled;
        }

        function addDragListeners(tile) {
            tile.addEventListener('dragstart', handleDragStart);
            tile.addEventListener('dragover', handleDragOver);
            tile.addEventListener('drop', handleDrop);
            tile.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            if (timeRemaining <= 0 && !isGoodieRushActive) return;
            draggedTile = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
            if (draggedTile.dataset.prizeType === 'green_bomb') {
                isDraggingBomb = true;
                document.getElementById('bomb-drag-preview').style.display = 'block';
            }
        }

        function handleDragOver(e) { 
            e.preventDefault(); 
            if (isDraggingBomb) {
                const targetTile = e.target.closest('#game-grid > div');
                if (targetTile) {
                    const preview = document.getElementById('bomb-drag-preview');
                    const rect = targetTile.getBoundingClientRect();
                    const gridRect = gridContainer.getBoundingClientRect();
                    const size = rect.width;
                    preview.style.width = `${size * 3}px`;
                    preview.style.height = `${size * 3}px`;
                    preview.style.left = `${rect.left - gridRect.left - size}px`;
                    preview.style.top = `${rect.top - gridRect.top - size}px`;
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('#game-grid > div');
            if (!dropTarget) return;

            if (isDraggingBomb && draggedTile) {
                startGreenBombSequence(dropTarget);
                draggedTile.textContent = '';
                draggedTile.classList.remove('prize-tile', 'green-bomb');
                draggedTile.draggable = false;
            }
            else if (dropTarget.classList.contains('word-puzzle-tile') && 
                draggedTile && draggedTile.classList.contains('word-puzzle-tile') &&
                dropTarget.dataset.puzzleIndex === draggedTile.dataset.puzzleIndex &&
                draggedTile !== dropTarget && !dropTarget.classList.contains('solved')) {
                const tempText = draggedTile.textContent;
                draggedTile.textContent = dropTarget.textContent;
                dropTarget.textContent = tempText;
                checkAllPuzzles();
            }
        }
        
        function handleDragEnd(e) { 
            e.target.classList.remove('dragging'); 
            if (isDraggingBomb) {
                isDraggingBomb = false;
                document.getElementById('bomb-drag-preview').style.display = 'none';
            }
            draggedTile = null;
        }

        function checkAllPuzzles() {
            let allWordsOnBoardAreSolved = true;
            puzzles.forEach((puzzle) => {
                if (!puzzle.solved) {
                    let currentWord = '';
                    puzzle.indices.forEach(index => { currentWord += document.getElementById(`tile-${index}`).textContent; });
                    if (currentWord === puzzle.word) {
                        puzzle.solved = true;
                        timeSinceLastSolve = 0;
                        coins += 10000;
                        updateScoreDisplay();
                        flashScore('gain');
                        const middleTileIndex = puzzle.indices[Math.floor(puzzle.indices.length / 2)];
                        const startTile = document.getElementById(`tile-${middleTileIndex}`);
                        if (!isFrozen) {
                            triggerCoinAnimation(startTile, document.getElementById('coins-display'));
                        }
                        puzzle.indices.forEach(index => {
                            const tile = document.getElementById(`tile-${index}`);
                            tile.classList.add('solved');
                            tile.draggable = false;
                        });
                    } else {
                        allWordsOnBoardAreSolved = false;
                    }
                }
            });

            if (allWordsOnBoardAreSolved && puzzles.length > 0) {
                if (isFrozen) endFreeze();
                coins += 100000;
                updateScoreDisplay();
                flashScore('gain');
                showEventText("Level Up!");
                flashLevelPanel();
                currentLevel++;
                setTimeout(() => startLevel(), 1500);
            }
        }

        function formatScore(num) {
            if (num < 1000) return num.toString();
            const si = [
                { value: 1E12, symbol: "T" }, { value: 1E9, symbol: "B" },
                { value: 1E6, symbol: "M" }, { value: 1E3, symbol: "K" }
            ];
            const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
            for (let i = 0; i < si.length; i++) {
                if (num >= si[i].value) {
                    return (num / si[i].value).toFixed(1).replace(rx, "$1") + si[i].symbol;
                }
            }
            return num.toLocaleString();
        }

        function updateScoreDisplay() {
            bagsOfMoney = Math.floor(coins * 0.01);
            document.getElementById('coins-display').textContent = coins.toLocaleString();
            document.getElementById('bags-of-money-display').textContent = bagsOfMoney.toLocaleString();
            document.getElementById('coins-display').classList.remove('score-decay');
        }

        function flashScore(type = 'gain') {
            const coinsDisplay = document.getElementById('coins-display');
            const flashClass = type === 'gain' ? 'gain-flash' : 'deduct-flash';
            coinsDisplay.classList.remove('gain-flash', 'deduct-flash');
            void coinsDisplay.offsetWidth;
            coinsDisplay.classList.add(flashClass);
            setTimeout(() => { coinsDisplay.classList.remove(flashClass); }, 800);
        }

        function flashBagsPanel() {
            const bagsDisplay = document.getElementById('bags-of-money-display');
            bagsDisplay.classList.add('deduct-flash');
            setTimeout(() => { bagsDisplay.classList.remove('deduct-flash'); }, 1200);
        }

        function flashLevelPanel() {
            const levelDisplay = document.getElementById('level-display');
            levelDisplay.classList.add('level-flash');
            setTimeout(() => { levelDisplay.classList.remove('level-flash'); }, 1500);
        }
        
        function updateTimer() {
            if (isGoodieRushActive) {
                goodieRushTimeRemaining--;
                document.getElementById('timer-display').textContent = `RUSH: ${goodieRushTimeRemaining.toString().padStart(2, '0')}`;
                
                const rushTiles = document.querySelectorAll('.goodie-rush-tile');
                if (rushTiles.length > 0 && Math.random() < 0.3) { // Chance to remove a tile
                    const randomTile = rushTiles[Math.floor(Math.random() * rushTiles.length)];
                    randomTile.classList.add('disappearing');
                    setTimeout(() => {
                        randomTile.textContent = '';
                        randomTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                    }, 500);
                }

                if (goodieRushTimeRemaining <= 0) {
                    endGoodieRush();
                }
                return;
            }

            if (timeRemaining > 0 && !isGamePaused) {
                timeRemaining--;
                timeSinceLastSolve++;
                const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
                const seconds = (timeRemaining % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${minutes}:${seconds}`;

                if (timeRemaining === 580 && !specialCashEmojiSpawned) {
                    specialCashEmojiSpawned = true;
                    spawnSpecialCashEmoji();
                }
                if (timeRemaining === 360 && timedEvents.sixMin) {
                    timedEvents.sixMin = false;
                    spawnImp();
                }
                if (timeRemaining === 180 && timedEvents.threeMin) {
                    timedEvents.threeMin = false;
                    spawnImp();
                }
                if (timeRemaining === 300 && jackpotEventAvailable) {
                    jackpotEventAvailable = false;
                    activateSpecialJackpot();
                }
                if (timeRemaining <= 5 && timeRemaining > 0 && !isGameOver) {
                    activateEndgameJackpot();
                }
                if (timeRemaining === 480 && timedEvents.heartEvent1) {
                    timedEvents.heartEvent1 = false;
                    spawnHeartAnimation();
                }
                if (timeRemaining === 120 && timedEvents.heartEvent2) {
                    timedEvents.heartEvent2 = false;
                    spawnHeartAnimation();
                }
            } else if (timeRemaining <= 0) {
                endGame();
            }
        }
        
        function activateSpecialJackpot() {
            const jackpotSquare = document.getElementById('jackpot-square');
            jackpotSquare.classList.add('wild-pulse');
            const specialJackpotHandler = () => {
                GJACKVARNUM = 0;
                coins += 50000000;
                updateScoreDisplay();
                flashScore('gain');
                showEventText('💰 50,000,000 💰');
                
                jackpotSquare.classList.remove('wild-pulse');
                clearTimeout(specialJackpotTimeout);
                jackpotSquare.removeEventListener('click', specialJackpotHandler);
            };
            jackpotSquare.addEventListener('click', specialJackpotHandler);
            specialJackpotTimeout = setTimeout(() => {
                jackpotSquare.classList.remove('wild-pulse');
                jackpotSquare.removeEventListener('click', specialJackpotHandler);
            }, 15000);
        }

        function activateEndgameJackpot() {
            if (endgameJackpotActive || isGameOver) return;
            endgameJackpotActive = true;

            const jackpotSquare = document.getElementById('jackpot-square');
            jackpotSquare.classList.add('endgame-pulse');

            const endgameJackpotHandler = () => {
                if (isGameOver) return; 
                coins += 1000000000;
                updateScoreDisplay();
                showEventText("Jackpot!", true, true);
                jackpotSquare.classList.remove('endgame-pulse');
            };

            jackpotSquare.addEventListener('click', endgameJackpotHandler, { once: true });
        }

        function triggerCoinAnimation(startElement, endElement) {
            const startRect = startElement.getBoundingClientRect();
            const endRect = endElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const controlX = startX + (endX - startX) / 2;
            const controlY = startY - 100;
            const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;

            for (let i = 0; i < 15; i++) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                coin.style.animation = `fly-along-path 0.8s cubic-bezier(0.4, 0, 0.9, 0.5) forwards`;
                coin.style.offsetPath = `path('${curve}')`;
                coin.style.animationDelay = `${Math.random() * 0.3}s`;
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 1100);
            }
        }

        function triggerBigCoinAnimation(startElement, endElement) {
            const startRect = startElement.getBoundingClientRect();
            const endRect = endElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const controlX = startX + (endX - startX) / 2;
            const controlY = startY - 100;
            const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;
            
            const coin = document.createElement('div');
            coin.classList.add('coin');
            coin.style.animation = `big-coin-tumble 0.8s ease-out forwards, fly-along-path 0.8s ease-out forwards`;
            coin.style.offsetPath = `path('${curve}')`;
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 800);
        }

        function triggerCoinImplosion(originElement) {
            const originRect = originElement.getBoundingClientRect();
            const endRect = document.getElementById('coins-display').getBoundingClientRect();
            const centerX = originRect.left + originRect.width / 2;
            const centerY = originRect.top + originRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const startRadius = 100;

            for (let i = 0; i < 20; i++) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                const angle = (i / 20) * (2 * Math.PI);
                const startX = centerX + Math.cos(angle) * startRadius;
                const startY = centerY + Math.sin(angle) * startRadius;
                const controlX = startX + (endX - startX) / 2 + (Math.random() - 0.5) * 200;
                const controlY = startY + (endY - startY) / 2 + (Math.random() - 0.5) * 200;
                const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;
                coin.style.offsetPath = `path('${curve}')`;
                coin.style.animation = `coin-swirl-in 1s cubic-bezier(0.5, 0, 0.9, 0.5) forwards`;
                coin.style.animationDelay = `${Math.random() * 0.3}s`;
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 1300);
            }
        }

        function onSolveButtonClick() {
            if (timeRemaining <= 0 || solveButtonCooldown > 0 || isGoodieRushActive) return;
            GJACKVARNUM = 0;

            const unsolvedPuzzles = puzzles.filter(p => !p.solved);
            if (unsolvedPuzzles.length === 0) return;

            const solveButton = document.getElementById('solve-button');
            solveButton.classList.remove('big-pulse');
            timeSinceLastSolve = 0;
            solveButtonClicks++;
            triggerCoinImplosion(document.getElementById('solve-button'));
            coins -= 200000;
            updateScoreDisplay();
            flashScore('deduct');

            const puzzleToSolve = unsolvedPuzzles[Math.floor(Math.random() * unsolvedPuzzles.length)];
            puzzleToSolve.indices.forEach((tileIndex, letterIndex) => {
                document.getElementById(`tile-${tileIndex}`).textContent = puzzleToSolve.word[letterIndex];
            });
            checkAllPuzzles();

            if (solveButtonClicks >= 4) {
                startSolveButtonCooldown();
            }
        }

        function startSolveButtonCooldown() {
            solveButtonCooldown = 60;
            const solveButton = document.getElementById('solve-button');
            solveButton.disabled = true;
            solveButton.classList.remove('text-3xl');
            solveButton.classList.add('cooldown-timer');
            
            solveButtonTimerInterval = setInterval(() => {
                if (solveButtonCooldown > 0) {
                    solveButtonCooldown--;
                    solveButton.textContent = `0:${solveButtonCooldown.toString().padStart(2, '0')}`;
                } else {
                    clearInterval(solveButtonTimerInterval);
                    solveButton.textContent = '✅';
                    solveButton.classList.remove('cooldown-timer');
                    solveButton.classList.add('text-3xl');
                    solveButton.disabled = false;
                    solveButtonClicks = 0;
                }
            }, 1000);
        }

        let GJACKVARNUM = 0;
        function onJackpotClick(event) {
            const jackpotSquare = event.currentTarget;
            if (jackpotSquare.classList.contains('cooldown') || jackpotSquare.classList.contains('wild-pulse') || jackpotSquare.classList.contains('endgame-pulse')) return;

            timeSinceLastSolve = 0;
            GJACKVARNUM++;
            coins += 50000;
            updateScoreDisplay();
            flashScore('gain');
            triggerCoinAnimation(jackpotSquare, document.getElementById('coins-display'));

            if (GJACKVARNUM === 4) {
                showEventText("Yep! You're Greedy!");
            } else if (GJACKVARNUM === 8) {
                showEventText("Get outta here!");
            } else if (GJACKVARNUM >= 12) {
                coins = Math.floor(coins / 2);
                updateScoreDisplay();
                flashScore('deduct');
                flashBagsPanel();
                GJACKVARNUM = 0;
                jackpotSquare.classList.add('cooldown');
                setTimeout(() => {
                    jackpotSquare.classList.remove('cooldown');
                }, 15000);
            }
        }

        function scheduleNextPrizeSpawn() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen || isSpecialAnimationActive || isGoodieRushActive) return;
            
            const timeElapsed = totalGameTime - timeRemaining;
            const progress = timeElapsed / totalGameTime;
            const maxDelay = 2500;
            const minDelay = 100;
            const currentDelay = minDelay + (maxDelay - minDelay) * Math.pow(1 - progress, 3);

            prizeSpawnerTimeout = setTimeout(() => {
                if (levelGoodies.length > 0 && Math.random() < 0.1) { // 10% chance for a goodie
                    spawnSpecialGoodie();
                } else {
                    spawnPrizeEmoji();
                }
                scheduleNextPrizeSpawn();
            }, currentDelay);
        }

        function spawnSpecialGoodie() {
            if (isGamePaused || isGameOver || levelGoodies.length === 0) return;

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            let emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) {
                        emptyTiles.push(tile);
                    }
                }
            }
            if (emptyTiles.length === 0) return;
            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            
            // Clean the tile before use
            const newTile = tile.cloneNode(false);
            tile.parentNode.replaceChild(newTile, tile);

            const goodieIndex = Math.floor(Math.random() * levelGoodies.length);
            const goodieEmoji = levelGoodies.splice(goodieIndex, 1)[0];

            newTile.textContent = goodieEmoji;
            newTile.classList.add('prize-tile', 'cash-money-prize');

            const clickHandler = () => {
                // Immediately neutralize the tile to prevent race conditions
                newTile.textContent = '';
                newTile.classList.remove('prize-tile', 'cash-money-prize');
                clearTimeout(despawnTimer);

                // Then, perform game logic
                coins += 1000000;
                updateScoreDisplay();
                flashScore('gain');
                triggerCoinAnimation(newTile, document.getElementById('coins-display'));

                if (!playerData.nonsenseFreebiesCollected[goodieEmoji]) {
                    playerData.nonsenseFreebiesCollected[goodieEmoji] = 0;
                }
                playerData.nonsenseFreebiesCollected[goodieEmoji]++;
                savePlayerProfile();
            };

            const despawnTimer = setTimeout(() => {
                levelGoodies.push(goodieEmoji);
                newTile.textContent = '';
                newTile.classList.remove('prize-tile', 'cash-money-prize');
                newTile.removeEventListener('click', clickHandler);
            }, 8000);

            newTile.addEventListener('click', clickHandler, { once: true });
        }

        function spawnPrizeEmoji() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen) return;

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            let emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) {
                        emptyTiles.push(tile);
                    }
                }
            }
            // BUG FIX: If the board is full, clear a few random tiles to make space
            if (emptyTiles.length === 0) {
                const nonPuzzleTiles = [];
                 for(let i=0; i<81; i++) {
                    if (!allPuzzleIndices.includes(i) && i !== 40) {
                        nonPuzzleTiles.push(document.getElementById(`tile-${i}`));
                    }
                }
                for (let i = 0; i < 3; i++) {
                    if (nonPuzzleTiles.length > 0) {
                        const randomTile = nonPuzzleTiles.splice(Math.floor(Math.random() * nonPuzzleTiles.length), 1)[0];
                        if (randomTile) {
                             randomTile.textContent = '';
                             randomTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                             emptyTiles.push(randomTile);
                        }
                    }
                }
                if (emptyTiles.length === 0) return; // Still no space, so we give up for this cycle
            }

            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            
            // Clean the tile before use
            const newTile = tile.cloneNode(false);
            tile.parentNode.replaceChild(newTile, tile);
            
            let prizePool = prizeEmojis.filter(p => p.type !== 'cash_money');
            
            const prize = prizePool[Math.floor(Math.random() * prizePool.length)];

            newTile.textContent = prize.emoji;
            newTile.dataset.prizeValue = prize.value;
            newTile.dataset.prizeType = prize.type;
            newTile.classList.add('prize-tile');
            if (prize.type === 'game_over') newTile.classList.add('red-bomb');
            else if (prize.type === 'green_bomb') {
                newTile.classList.add('green-bomb');
                newTile.draggable = true;
                addDragListeners(newTile);
            }
            else if (prize.type === 'fire_column') newTile.classList.add('fire-bomb');
            
            const clickHandler = () => {
                GJACKVARNUM = 0;
                timeSinceLastSolve = 0;
                
                // Immediately clear the despawn timer
                clearTimeout(despawnTimer);

                if (newTile.dataset.prizeType === 'game_over') { 
                    endGame(true); 
                } 
                else if (newTile.dataset.prizeType === 'diamond') { startDiamondSequence(newTile); } 
                else if (newTile.dataset.prizeType === 'green_bomb') { startGreenBombSequence(newTile); }
                else if (newTile.dataset.prizeType === 'fire_column') { startFireColumnSequence(newTile); }
                else if (newTile.dataset.prizeType === 'freeze') { startFreezeSequence(); }
                else if (newTile.dataset.prizeType === 'lightning') {
                    coins = 0;
                    coins += parseInt(newTile.dataset.prizeValue);
                    updateScoreDisplay();
                    flashBagsPanel();
                    triggerCoinAnimation(newTile, document.getElementById('coins-display'));
                }
                else {
                    coins += parseInt(newTile.dataset.prizeValue);
                    updateScoreDisplay();
                    flashScore('gain');
                    triggerCoinAnimation(newTile, document.getElementById('coins-display'));
                    if (newTile.dataset.prizeType === 'trophy' && !trophyCollectedThisLevel) {
                        trophyCollectedThisLevel = true;
                        updateGreedPanelWithTrophy();
                        showEventText("Oh Yeah!");
                    }
                }
                // Clean up the tile after processing, unless it's a dragged bomb
                if (newTile.dataset.prizeType !== 'green_bomb' || !isDraggingBomb) {
                    newTile.textContent = '';
                    newTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            };

            const despawnTimer = setTimeout(() => {
                newTile.textContent = '';
                newTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                newTile.removeEventListener('click', clickHandler);
            }, 5000);

            newTile.addEventListener('click', clickHandler, { once: true });
        }

        function spawnSpecialCashEmoji() {
             if (isGamePaused || isGameOver || isFrozen) return;
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;
            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            const prize = prizeEmojis.find(p => p.type === 'cash_money');
            tile.textContent = prize.emoji;
            tile.dataset.prizeValue = prize.value;
            tile.dataset.prizeType = prize.type;
            tile.classList.add('prize-tile', 'cash-money-prize');
            
            const clickHandler = () => {
                GJACKVARNUM = 0;
                coins += parseInt(tile.dataset.prizeValue);
                updateScoreDisplay();
                flashScore('gain');
                showEventText('💰 1,000,000 💰', true);
                tile.textContent = '';
                tile.classList.remove('prize-tile', 'cash-money-prize');
            };
            tile.addEventListener('click', clickHandler, { once: true });
        }

        function spawnImp() {
            if (isGamePaused || isGameOver || isFrozen) return;
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;
            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            tile.innerHTML = `<div class="w-full h-full flex items-center justify-center prize-tile red-bomb">😈</div>`;
            const impElement = tile.firstChild;

            const clickHandler = () => {
                GJACKVARNUM = 0;
                coins = 0;
                updateScoreDisplay();
                showEventText("Ha ha!");
                tile.innerHTML = '';
                tile.classList.remove('prize-tile', 'red-bomb');
                clearTimeout(despawnTimer);
            };

            const despawnTimer = setTimeout(() => {
                tile.innerHTML = '';
                tile.classList.remove('prize-tile', 'red-bomb');
                impElement.removeEventListener('click', clickHandler, { once: true });
            }, 10000);
            impElement.addEventListener('click', clickHandler, { once: true });
        }

        function updateGreedPanelWithTrophy() {
            const iconsContainer = document.getElementById('greed-icons-container');
            const trophyElement = document.createElement('div');
            trophyElement.classList.add('greed-icon');
            trophyElement.textContent = '🏆';
            trophyElement.addEventListener('click', () => {
                showEventText("You're so greedy!");
            });
            iconsContainer.appendChild(trophyElement);
        }
        
        function updateGreedPanelWithDiamond() {
            if (diamondCollectedThisLevel) return;
            diamondCollectedThisLevel = true;
            const iconsContainer = document.getElementById('greed-icons-container');
            const diamondElement = document.createElement('div');
            diamondElement.classList.add('greed-icon');
            diamondElement.textContent = '💎';
            diamondElement.addEventListener('click', () => {
                showEventText("Diamonds, oh yeah!");
            });
            iconsContainer.appendChild(diamondElement);
        }

        function showEventText(text, greenGlow = false, longFlash = false) {
            if (isGamePaused && !longFlash && !isGoodieRushActive) return;
            const eventTextContainer = document.getElementById('event-text-container');
            const eventText = document.getElementById('event-text');
            eventText.innerHTML = text;
            eventText.classList.toggle('green-glow', greenGlow);
            eventText.classList.toggle('long-flash', longFlash);
            
            eventTextContainer.classList.remove('hidden');
            const duration = longFlash ? 4000 : 2000;
            setTimeout(() => {
                eventTextContainer.classList.add('hidden');
                eventText.classList.remove('green-glow', 'long-flash');
            }, duration);
        }

        function startDiamondSequence(clickedTile) {
            isSpecialAnimationActive = true;
            coins += currentDiamondValue;
            updateScoreDisplay();
            flashScore('gain');
            showEventText("Diamonds, oh yeah!");
            currentDiamondValue = Math.floor(currentDiamondValue / 2);
            updateGreedPanelWithDiamond();

            document.querySelectorAll('.prize-tile').forEach(t => {
                if (t !== clickedTile) { 
                    t.textContent = ''; 
                    t.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const diamondTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if(tile) {
                        tile.textContent = '💎';
                        tile.classList.add('temp-diamond');
                        diamondTiles.push(tile);
                    }
                }
            }

            diamondSequenceTimeout = setTimeout(() => {
                triggerVortexAnimation(diamondTiles);
            }, 2000);
        }

        function triggerVortexAnimation(diamondTiles) {
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            diamondTiles.forEach(tile => {
                if (!tile || !document.body.contains(tile)) return;
                const startRect = tile.getBoundingClientRect();
                const startX = startRect.left;
                const startY = startRect.top;

                const flyingDiamond = document.createElement('div');
                flyingDiamond.textContent = '💎';
                flyingDiamond.classList.add('temp-diamond');
                flyingDiamond.style.position = 'absolute';
                flyingDiamond.style.left = `${startX}px`;
                flyingDiamond.style.top = `${startY}px`;
                flyingDiamond.style.zIndex = '200';
                flyingDiamond.style.setProperty('--start-x', `0px`);
                flyingDiamond.style.setProperty('--start-y', `0px`);
                flyingDiamond.style.setProperty('--end-x', `${endX - startX}px`);
                flyingDiamond.style.setProperty('--end-y', `${endY - startY}px`);
                flyingDiamond.style.animation = `diamond-vortex 1s ease-in forwards`;
                document.body.appendChild(flyingDiamond);

                tile.textContent = '';
                tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                setTimeout(() => { flyingDiamond.remove(); }, 1000);
            });

            setTimeout(() => {
                 isSpecialAnimationActive = false;
                 scheduleNextPrizeSpawn();
            }, 1500);
        }
        
        function getAdjacentIndices(index) {
            const indices = [];
            const row = Math.floor(index / 9);
            const col = index % 9;
            for (let r = -1; r <= 1; r++) {
                for (let c = -1; c <= 1; c++) {
                    const newRow = row + r;
                    const newCol = col + c;
                    if (newRow >= 0 && newRow < 9 && newCol >= 0 && newCol < 9) {
                        indices.push(newRow * 9 + newCol);
                    }
                }
            }
            return indices;
        }

        function startGreenBombSequence(bombTile) {
            playerData.greenBombsUsed++; // Increment badge counter
            const bombIndex = parseInt(bombTile.id.split('-')[1]);
            const adjacentIndices = getAdjacentIndices(bombIndex);
            
            adjacentIndices.forEach(index => {
                const adjTile = document.getElementById(`tile-${index}`);
                if (adjTile) {
                    if (adjTile.classList.contains('prize-tile') || adjTile.classList.contains('goodie-rush-tile')) {
                        if (adjTile.classList.contains('goodie-rush-tile')) {
                            const goodieEmoji = adjTile.textContent;
                            if (currentGoodieRushCollections[goodieEmoji]) {
                                currentGoodieRushCollections[goodieEmoji]++;
                            } else {
                                currentGoodieRushCollections[goodieEmoji] = 1;
                            }
                            coins += 50000;
                            triggerCoinAnimation(adjTile, document.getElementById('coins-display'));
                        } else {
                            const prizeValue = parseInt(adjTile.dataset.prizeValue) || 0;
                            if (prizeValue > 0) {
                                coins += prizeValue;
                                triggerCoinAnimation(adjTile, document.getElementById('coins-display'));
                            }
                        }
                        adjTile.textContent = '';
                        adjTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                    } else if (adjTile.classList.contains('word-puzzle-tile') && !adjTile.classList.contains('solved')) {
                        const puzzleIndex = parseInt(adjTile.dataset.puzzleIndex);
                        const puzzle = puzzles[puzzleIndex];
                        const letterIndex = puzzle.indices.indexOf(index);
                        const correctLetter = puzzle.word[letterIndex];
                        
                        for (const i of puzzle.indices) {
                            const sourceTile = document.getElementById(`tile-${i}`);
                            if (sourceTile && sourceTile.textContent === correctLetter) {
                                const tempText = adjTile.textContent;
                                adjTile.textContent = sourceTile.textContent;
                                sourceTile.textContent = tempText;
                                break;
                            }
                        }
                        coins += 1;
                        triggerBigCoinAnimation(adjTile, document.getElementById('coins-display'));
                    }
                }
            });
            setTimeout(() => {
                updateScoreDisplay();
                checkAllPuzzles();
                savePlayerProfile(); // Save after using the bomb
            }, 100);
        }

        function startFireColumnSequence(fireTile) {
            const fireIndex = parseInt(fireTile.id.split('-')[1]);
            const column = fireIndex % 9;
            let collectedFromColumn = 0;

            for (let i = column; i < 81; i += 9) {
                const tileInColumn = document.getElementById(`tile-${i}`);
                if (tileInColumn && tileInColumn !== fireTile) { 
                    if (tileInColumn.classList.contains('prize-tile')) {
                        const prizeValue = parseInt(tileInColumn.dataset.prizeValue) || 0;
                        if (prizeValue > 0) {
                            collectedFromColumn += prizeValue;
                            triggerCoinAnimation(tileInColumn, document.getElementById('coins-display'));
                        }
                        tileInColumn.textContent = '';
                        tileInColumn.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';

                    } else if (tileInColumn.classList.contains('word-puzzle-tile') && !tileInColumn.classList.contains('solved')) {
                        const puzzleIndex = parseInt(tileInColumn.dataset.puzzleIndex);
                        const puzzle = puzzles[puzzleIndex];
                        const letterIndex = puzzle.indices.indexOf(i);
                        const correctLetter = puzzle.word[letterIndex];
                        
                        if (tileInColumn.textContent !== correctLetter) {
                            for (const sourceIndex of puzzle.indices) {
                                const sourceTile = document.getElementById(`tile-${sourceIndex}`);
                                if (sourceTile && sourceTile.textContent === correctLetter) {
                                    const tempText = tileInColumn.textContent;
                                    tileInColumn.textContent = sourceTile.textContent;
                                    sourceTile.textContent = tempText;
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            const fireBombValue = parseInt(fireTile.dataset.prizeValue) || 400;
            coins += fireBombValue + collectedFromColumn;
            
            updateScoreDisplay();
            flashScore('gain');
            checkAllPuzzles();
        }

        function endGame(isBomb = false) {
            if (isGameOver) return;
            isGameOver = true;
            isGamePaused = true; 
            
            const jackpotSquare = document.getElementById('jackpot-square');
            if (jackpotSquare) jackpotSquare.classList.remove('endgame-pulse');
            
            // Clear all timers
            clearInterval(mainTimerInterval);
            mainTimerInterval = null;
            clearTimeout(prizeSpawnerTimeout);
            prizeSpawnerTimeout = null;
            clearTimeout(diamondSequenceTimeout);
            diamondSequenceTimeout = null;
            clearInterval(scoreDecayInterval);
            scoreDecayInterval = null;
            clearTimeout(impTimeout);
            impTimeout = null;
            clearInterval(solveButtonPulseManager);
            solveButtonPulseManager = null;
            if (isGoodieRushActive) endGoodieRush(true); // End rush immediately

            // Update inventories before showing the modal
            for (const [goodie, count] of Object.entries(currentGoodieRushCollections)) {
                if (!playerData.nonsenseFreebiesCollected[goodie]) {
                    playerData.nonsenseFreebiesCollected[goodie] = 0;
                }
                playerData.nonsenseFreebiesCollected[goodie] += count;
            }

            saveGameResult(); 
            checkAndAwardBadges(coins);
            
            endFreeze();
            endHeartAnimation();
            
            timeRemaining = 0;
            document.getElementById('timer-display').textContent = "00:00";
            
            if (!isBomb) {
                triggerSwirlAnimation();
            }

            setTimeout(() => {
                showGameOverModal();
            }, isBomb ? 100 : 1500);
        }

        function triggerSwirlAnimation() {
            const elementsToSwirl = document.querySelectorAll('#game-grid > div');
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            elementsToSwirl.forEach(el => {
                if (el.textContent) {
                    const startRect = el.getBoundingClientRect();
                    const startX = startRect.left;
                    const startY = startRect.top;
                    const flyingEl = el.cloneNode(true);
                    flyingEl.style.position = 'absolute';
                    flyingEl.style.left = `${startX}px`;
                    flyingEl.style.top = `${startY}px`;
                    flyingEl.style.zIndex = '200';
                    flyingEl.style.margin = '0';
                    flyingEl.style.setProperty('--start-x', `0px`);
                    flyingEl.style.setProperty('--start-y', `0px`);
                    flyingEl.style.setProperty('--end-x', `${endX - startX}px`);
                    flyingEl.style.setProperty('--end-y', `${endY - startY}px`);
                    flyingEl.style.animation = `game-over-swirl 1.5s ease-in forwards`;
                    document.body.appendChild(flyingEl);
                    el.textContent = '';
                    el.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });
        }

        async function showGameOverModal() {
            document.getElementById('final-coins-display').textContent = coins.toLocaleString();
            document.getElementById('final-bags-display').textContent = bagsOfMoney.toLocaleString();
            
            // Populate goodies collected
            const goodiesContainer = document.getElementById('final-goodies-inventory');
            goodiesContainer.innerHTML = '';
            if (Object.keys(currentGoodieRushCollections).length > 0) {
                for (const [goodie, count] of Object.entries(currentGoodieRushCollections)) {
                    const goodieEl = document.createElement('div');
                    goodieEl.className = 'text-center';
                    goodieEl.innerHTML = `<div class="text-2xl">${goodie}</div><div class="text-xs font-bold">x${count}</div>`;
                    goodiesContainer.appendChild(goodieEl);
                }
            } else {
                goodiesContainer.innerHTML = '<p class="col-span-4 text-slate-400 text-sm">None this round.</p>';
            }

            // Fetch and display leaderboard
            await populateLeaderboard();

            const gameOverModal = document.getElementById('game-over-modal');
            gameOverModal.classList.remove('hidden');

            clearInterval(gameOverAnimationInterval);
            gameOverAnimationInterval = setInterval(() => { 
                const animations = ['🪙', '❄️', '❤️'];
                const animationChar = animations[Math.floor(Math.random() * animations.length)];
                
                const el = document.createElement('div');
                el.textContent = animationChar;
                el.style.left = `${Math.random() * 100}%`;
                el.style.animationDuration = `${Math.random() * 2 + 3}s`;
                el.style.fontSize = `${Math.random() * 1 + 0.5}rem`;
                el.style.position = 'fixed';
                el.style.top = '-5%';
                el.style.zIndex = '100';

                if (animationChar === '🪙') el.classList.add('falling-coin');
                else if (animationChar === '❄️') el.classList.add('falling-snowflake');
                else if (animationChar === '❤️') el.classList.add('falling-heart');

                document.body.appendChild(el);
                setTimeout(() => el.remove(), 5000);

            }, 200);
        }
        
        function pauseGame() {
            isGamePaused = true;
            clearInterval(mainTimerInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            document.querySelectorAll('.ice-block').forEach(block => block.style.display = 'none');
        }

        function resumeGame() {
            if (isGameOver || isGoodieRushActive) return;
            isGamePaused = false;
            mainTimerInterval = setInterval(updateTimer, 1000);
            if (!isFrozen) {
                scheduleNextPrizeSpawn();
            }
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
            if (isFrozen) {
                document.querySelectorAll('.ice-block').forEach(block => block.style.display = 'block');
            }
        }

        function handleScoreDecay() {
            if (isGamePaused || isGameOver) return;
            if (timeSinceLastSolve > 20) {
                const decayAmount = Math.floor(Math.pow(timeSinceLastSolve - 19, 1.5) * 10);
                coins -= decayAmount;
                if (coins < 0) coins = 0;
                updateScoreDisplay();
                document.getElementById('coins-display').classList.add('score-decay');
            } else {
                document.getElementById('coins-display').classList.remove('score-decay');
            }
        }

        function startFreezeSequence() {
            isFrozen = true;
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(impTimeout);
            
            // Clear any existing freeze animation before starting a new one
            clearInterval(freezeAnimationInterval);

            freezeAnimationInterval = setInterval(() => {
                const snowflake = document.createElement('div');
                snowflake.classList.add('falling-snowflake');
                snowflake.textContent = '❄️';
                snowflake.style.left = `${Math.random() * 100}%`;
                snowflake.style.animationDuration = `${Math.random() * 3 + 4}s`;
                snowflake.style.fontSize = `${Math.random() * 1 + 0.75}rem`;
                document.body.appendChild(snowflake);
                setTimeout(() => snowflake.remove(), 7000);
            }, 200);

            const frozenTiles = [];
            document.querySelectorAll('#game-grid > div:not(.word-puzzle-tile)').forEach(tile => {
                const rect = tile.getBoundingClientRect();
                const iceBlock = document.createElement('div');
                iceBlock.className = 'ice-block';
                iceBlock.style.width = `${rect.width}px`;
                iceBlock.style.height = `${rect.height}px`;
                iceBlock.style.left = `${rect.left}px`;
                iceBlock.style.top = `${rect.top}px`;
                document.body.appendChild(iceBlock);
                frozenTiles.push(iceBlock);
            });

            thawTimeout = setTimeout(() => {
                const thawDuration = 15000;
                if (frozenTiles.length === 0) {
                    endFreeze();
                    return;
                }
                const thawIntervalTime = thawDuration / frozenTiles.length;
                
                function thawNext() {
                    if (frozenTiles.length > 0) {
                        const tileToThaw = frozenTiles.shift();
                        if (tileToThaw) {
                            tileToThaw.remove();
                        }
                        setTimeout(thawNext, thawIntervalTime);
                    } else {
                        endFreeze();
                    }
                }
                thawNext();
            }, 15000);
        }

        function endFreeze() {
            clearInterval(freezeAnimationInterval);
            freezeAnimationInterval = null;
            clearTimeout(thawTimeout);
            isFrozen = false;
            document.querySelectorAll('.ice-block').forEach(block => block.remove());
            if (!isGamePaused && !isGameOver) {
                setTimeout(() => scheduleNextPrizeSpawn(), 500);
            }
        }
        
        function spawnHeartAnimation() {
            if (heartAnimationInterval) return; // Don't start if already running
            heartAnimationInterval = setInterval(() => {
                const heart = document.createElement('div');
                heart.classList.add('falling-heart');
                heart.textContent = '❤️';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.animationDuration = `${Math.random() * 4 + 5}s`;
                heart.style.fontSize = `${Math.random() * 1 + 0.75}rem`;
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 9000);
            }, 500);
            setTimeout(endHeartAnimation, 8000); // Let it run for 8 seconds
        }

        function endHeartAnimation() {
            clearInterval(heartAnimationInterval);
            heartAnimationInterval = null;
        }

        function startGame() {
            document.getElementById('start-modal').classList.add('hidden');
            musicPlayer.muted = true;
            playTrack(currentTrackIndex);
            musicPlayer.play().catch(e => console.error("Audio play failed on initial click:", e));

            const todayStr = new Date().toISOString().split('T')[0];
            if (playerData.lastLoginDate !== todayStr) {
                showWelcomeBonus();
            } else {
                actuallyStartGame();
            }
        }

        function actuallyStartGame() {
            musicPlayer.muted = false;
            musicPlayer.volume = lastVolume;
            document.getElementById('volume-slider').value = lastVolume;
            updateVolumeIcon(lastVolume);
            
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('game-container').classList.add('flex');
            clearInterval(startModalAnimationInterval);
            isGamePaused = false;
            mainTimerInterval = setInterval(updateTimer, 1000);
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
            scheduleNextPrizeSpawn();
            clearInterval(solveButtonPulseManager); 
            solveButtonPulseManager = setInterval(() => {
                if (isGamePaused || isGameOver) return;
                const solveButton = document.getElementById('solve-button');
                const unsolvedPuzzles = puzzles.filter(p => !p.solved);
                if (unsolvedPuzzles.length > 0 && timeSinceLastSolve >= 30) {
                    solveButton.classList.add('big-pulse');
                    setTimeout(() => {
                        solveButton.classList.remove('big-pulse');
                    }, 10000);
                    timeSinceLastSolve = 0;
                }
            }, 1000);
        }

        function restartGame() {
            // --- Clear all active timers and intervals ---
            clearInterval(mainTimerInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(diamondSequenceTimeout);
            clearInterval(solveButtonTimerInterval);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            clearTimeout(thawTimeout);
            clearInterval(solveButtonPulseManager);
            clearInterval(freezeAnimationInterval);
            clearInterval(heartAnimationInterval);
            clearInterval(gameOverAnimationInterval);
            clearTimeout(specialJackpotTimeout);
            if (isGoodieRushActive) endGoodieRush(true); // End rush immediately

            // --- Reset all game state variables to their initial values ---
            coins = 0;
            bagsOfMoney = 0;
            currentLevel = 1;
            timeRemaining = totalGameTime;
            isGameOver = false;
            isGamePaused = false; 
            trophyCollectedThisLevel = false;
            diamondCollectedThisLevel = false;
            currentDiamondValue = 20000000;
            solveButtonClicks = 0;
            solveButtonCooldown = 0;
            timeSinceLastSolve = 0;
            isFrozen = false;
            jackpotEventAvailable = true;
            specialCashEmojiSpawned = false;
            timedEvents = { sixMin: true, threeMin: true, heartEvent1: true, heartEvent2: true };
            isSpecialAnimationActive = false;
            endgameJackpotActive = false;
            levelGoodies = [...nonsenseFreebies];
            currentGoodieRushCollections = {};
            
            // --- Reset UI Elements ---
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('timer-display').textContent = "10:00";
            const solveButton = document.getElementById('solve-button');
            solveButton.textContent = '✅';
            solveButton.classList.remove('cooldown-timer', 'big-pulse');
            solveButton.classList.add('text-3xl');
            solveButton.disabled = false;
            updateScoreDisplay();

            // --- Start the new game flow ---
            startLevel();
            actuallyStartGame();
        }

        function playNextTrack() {
            if (userPlaylist.length === 0) return;
            const nextIndex = (currentTrackIndex + 1) % userPlaylist.length;
            playTrack(nextIndex);
        }

        function playPreviousTrack() {
            if (userPlaylist.length === 0) return;
            const prevIndex = (currentTrackIndex - 1 + userPlaylist.length) % userPlaylist.length;
            playTrack(prevIndex);
        }

        function playTrack(index) {
            if (userPlaylist.length === 0 || index < 0 || index >= userPlaylist.length) return;
            currentTrackIndex = index;
            const trackName = userPlaylist[currentTrackIndex];
            musicPlayer.src = musicBaseURL + trackName;
            
            const playPromise = musicPlayer.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    updateNowPlayingIndicator();
                }).catch(error => {
                    if (error.name !== 'AbortError') {
                         console.error("Audio play failed for " + trackName + ":", error);
                    }
                });
            }
        }
        
        function setupAudioControls() {
            const volumeSlider = document.getElementById('volume-slider');
            const volumeToggleButton = document.getElementById('volume-toggle-button');
            const playlistPlayPauseBtn = document.getElementById('playlist-play-pause');
            const playlistNextBtn = document.getElementById('playlist-next');
            const playlistPrevBtn = document.getElementById('playlist-prev');
            const playlistShuffleBtn = document.getElementById('playlist-shuffle');

            volumeSlider.value = lastVolume;
            updateVolumeIcon(musicPlayer.volume);

            volumeSlider.addEventListener('input', (e) => {
                const newVolume = parseFloat(e.target.value);
                musicPlayer.volume = newVolume;
                updateVolumeIcon(newVolume);
                if (newVolume > 0) {
                    lastVolume = newVolume;
                }
            });

            volumeToggleButton.addEventListener('click', () => {
                if (musicPlayer.volume > 0) {
                    musicPlayer.volume = 0;
                    volumeSlider.value = 0;
                    updateVolumeIcon(0);
                } else {
                    musicPlayer.volume = lastVolume;
                    volumeSlider.value = lastVolume;
                    updateVolumeIcon(lastVolume);
                }
            });

            playlistPlayPauseBtn.addEventListener('click', () => {
                if (musicPlayer.paused) {
                    musicPlayer.play();
                } else {
                    musicPlayer.pause();
                }
            });
            playlistNextBtn.addEventListener('click', playNextTrack);
            playlistPrevBtn.addEventListener('click', playPreviousTrack);
            playlistShuffleBtn.addEventListener('click', toggleShuffle);

            musicPlayer.addEventListener('play', updatePlayPauseIcon);
            musicPlayer.addEventListener('pause', updatePlayPauseIcon);

            updatePlayPauseIcon();
        }
function updatePlayPauseIcon() {
            const playlistPlayPauseBtn = document.getElementById('playlist-play-pause');
            if (musicPlayer.paused) {
                playlistPlayPauseBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>`;
            } else {
                playlistPlayPauseBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75zM14.25 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z"></path></svg>`;
            }
        }

        function updateVolumeIcon(volume) {
            const volumeToggleButton = document.getElementById('volume-toggle-button');
            const favicon = document.getElementById('favicon');
            if (volume > 0) {
                volumeToggleButton.textContent = '🔊';
                favicon.href = speakerIconHref;
            } else {
                volumeToggleButton.textContent = '🔇';
                favicon.href = mutedIconHref;
            }
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            document.getElementById('playlist-shuffle').classList.toggle('shuffle-active', isShuffled);
            if (isShuffled) {
                const currentTrack = userPlaylist[currentTrackIndex];
                userPlaylist = userPlaylist.filter(t => t !== currentTrack);
                for (let i = userPlaylist.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [userPlaylist[i], userPlaylist[j]] = [userPlaylist[j], userPlaylist[i]];
                }
                userPlaylist.unshift(currentTrack);
                currentTrackIndex = 0;
            } else {
                const currentTrack = userPlaylist[currentTrackIndex];
                userPlaylist = [...originalUserPlaylist];
                currentTrackIndex = userPlaylist.indexOf(currentTrack);
            }
            populatePlaylistModal();
        }

        function updateNowPlayingIndicator() {
            document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('now-playing'));
            const trackName = userPlaylist[currentTrackIndex];
            const nowPlayingItem = document.querySelector(`.playlist-item[data-track-filename="${trackName}"]`);
            if (nowPlayingItem) {
                nowPlayingItem.classList.add('now-playing');
            }
        }

        // --- Firebase & Data Persistence ---
        function initializeFirebase() {
            try {
                const firebaseConfig = window.firebaseConfig;
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Firebase config not found or is placeholder.");
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseConnected = true;
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        loadPlayerProfile();
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous sign-in failed:", error);
                            loadLocalData(); 
                        });
                    }
                });
            } catch (error) {
                console.warn("Firebase initialization failed:", error.message, "Using local storage.");
                isFirebaseConnected = false;
                loadLocalData();
            }
        }

        async function loadPlayerProfile() {
            if (!isFirebaseConnected || !userId) {
                loadLocalData();
                return;
            }
            try {
                const docRef = doc(db, "playerProfiles", userId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    playerData = docSnap.data();
                    // Ensure all properties exist
                    playerData.themes = playerData.themes || { unlocked: ['default'], active: 'default' };
                    playerData.stats = playerData.stats || { highScore: 0, gamesPlayed: 0, greenBombsUsed: 0, totalBagsCollected: 0, totalPuzzlesSolved: 0 };
                    playerData.dailyRewards = playerData.dailyRewards || { lastClaimed: null, streak: 0 };
                    playerData.nonsenseFreebiesCollected = playerData.nonsenseFreebiesCollected || {};
                    playerData.inventory = playerData.inventory || {};
                    playerData.badges = playerData.badges || {};
                } else {
                    initializeNewPlayerData();
                    await setDoc(docRef, playerData);
                }
            } catch (error) {
                console.error("Error loading profile from Firestore:", error);
                loadLocalData();
            } finally {
                postLoadSetup();
            }
        }

        async function savePlayerProfile() {
            if (!isFirebaseConnected || !userId) {
                saveLocalData();
                return;
            }
            try {
                const docRef = doc(db, "playerProfiles", userId);
                await setDoc(docRef, playerData, { merge: true });
            } catch (error) {
                console.error("Error saving profile to Firestore:", error);
                saveLocalData();
            }
        }

        function loadLocalData() {
            const localData = localStorage.getItem('wordGreedPlayer');
            if (localData) {
                playerData = JSON.parse(localData);
            } else {
                initializeNewPlayerData();
            }
            postLoadSetup();
        }

        function saveLocalData() {
            localStorage.setItem('wordGreedPlayer', JSON.stringify(playerData));
        }

        function initializeNewPlayerData() {
            playerData = {
                playerName: "Player" + Math.floor(Math.random() * 1000),
                themes: { unlocked: ['default'], active: 'default' },
                stats: { highScore: 0, gamesPlayed: 0, greenBombsUsed: 0, totalBagsCollected: 0, totalPuzzlesSolved: 0 },
                dailyRewards: { lastClaimed: null, streak: 0 },
                nonsenseFreebiesCollected: {},
                inventory: {},
                badges: {},
                lastLoginDate: null
            };
        }

        function postLoadSetup() {
            playerNameInput.value = playerData.playerName || '';
            applyTheme(playerData.themes.active || 'default');
            updateSetupModalDisplays();
            updateBadgesPanel();

            const startButton = document.getElementById('start-game-button');
            if (startButton) {
                startButton.disabled = false;
                startButton.textContent = 'Start Game';
            }
        }

        function saveGameResult() {
            playerData.stats.gamesPlayed = (playerData.stats.gamesPlayed || 0) + 1;
            if (coins > (playerData.stats.highScore || 0)) {
                playerData.stats.highScore = coins;
            }
            playerData.stats.totalBagsCollected = (playerData.stats.totalBagsCollected || 0) + bagsOfMoney;
            savePlayerProfile();
        }

        function resetProgress() {
            initializeNewPlayerData();
            savePlayerProfile();
            postLoadSetup();
            location.reload();
        }
        
        // --- UI & Modal Logic ---
        function setupModal(modalId, openBtnId, closeBtnId) {
            const modal = document.getElementById(modalId);
            const openBtn = document.getElementById(openBtnId);
            const closeBtn = document.getElementById(closeBtnId);
            if (openBtn) openBtn.addEventListener('click', () => { modal.classList.remove('hidden'); pauseGame(); });
            if (closeBtn) closeBtn.addEventListener('click', () => { 
                modal.classList.add('hidden'); 
                if (modalId !== 'game-over-modal') {
                    resumeGame(); 
                }
            });
        }

        function setupAllModals() {
            setupModal('help-modal', 'help-button', 'close-help-button');
            setupModal('about-modal', 'about-button', 'close-about-button');
            setupModal('playlist-modal', 'playlist-button', 'close-playlist-button');
            setupModal('setup-modal', 'setup-button', 'close-setup-button');
            setupModal('daily-rewards-modal', 'daily-rewards-button', 'close-daily-rewards-button');
            setupModal('trading-post-modal', 'trade-goodies-button', 'close-trading-post-button');
            setupModal('riches-modal', 'riches-button', 'close-riches-button');
            setupModal('tips-modal', 'tips-button', 'close-tips-button');
            setupModal('privacy-modal', 'privacy-policy-button', 'close-privacy-button');
            setupModal('badges-modal', 'badges-button', 'close-badges-button');
            setupModal('giving-modal', 'give-button', 'close-giving-button');
            
            document.getElementById('start-game-button').addEventListener('click', startGame);

            document.getElementById('play-again-button').addEventListener('click', () => {
                document.getElementById('game-over-modal').classList.add('hidden');
                clearInterval(gameOverAnimationInterval);
                restartGame();
            });

            document.getElementById('reset-progress-button').addEventListener('click', () => {
                document.getElementById('confirm-reset-modal').classList.remove('hidden');
            });
            document.getElementById('cancel-reset-button').addEventListener('click', () => {
                document.getElementById('confirm-reset-modal').classList.add('hidden');
            });
            document.getElementById('confirm-reset-button').addEventListener('click', () => {
                document.getElementById('confirm-reset-modal').classList.add('hidden');
                resetProgress();
            });

            document.getElementById('claim-bonus-button').addEventListener('click', () => {
                document.getElementById('welcome-bonus-modal').classList.add('hidden');
                actuallyStartGame();
            });
            
            document.getElementById('execute-trade-button').addEventListener('click', executeTrade);
            document.getElementById('execute-give-button').addEventListener('click', executeGive);

            document.getElementById('copy-userid-button').addEventListener('click', copyUserIdToClipboard);

            // Setup tips carousel
            document.getElementById('carousel-next').addEventListener('click', () => showNextTip(1));
            document.getElementById('carousel-prev').addEventListener('click', () => showNextTip(-1));
        }

        function populatePlaylistModal() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';
            userPlaylist.forEach((trackFilename, index) => {
                const trackInfo = verifiedPlaylist.find(t => t.filename === trackFilename);
                if (trackInfo) {
                    const item = document.createElement('div');
                    item.className = 'playlist-item';
                    item.dataset.trackIndex = index;
                    item.dataset.trackFilename = trackFilename;
                    item.innerHTML = `
                        <span>${trackInfo.title}</span>
                        <span class="now-playing-indicator">Now Playing...</span>
                    `;
                    item.addEventListener('click', () => playTrack(index));
                    container.appendChild(item);
                }
            });
            updatePlayPauseIcon();
        }

        function updateSetupModalDisplays() {
            document.getElementById('total-bags-display').textContent = (playerData.stats.totalBagsCollected || 0).toLocaleString();
            document.getElementById('high-score-display').textContent = (playerData.stats.highScore || 0).toLocaleString();
            document.getElementById('user-id-display').textContent = `User ID: ${userId ? userId.substring(0, 8) + '...' : 'N/A'}`;
            populateThemeStore();
            populateNonsenseFreebies();
        }

        function populateThemeStore() {
            const container = document.getElementById('theme-store-container');
            container.innerHTML = '';
            const allThemes = [
                { id: 'default', name: 'Violet', cost: 0 }, { id: 'red', name: 'Red', cost: 1000 },
                { id: 'green', name: 'Green', cost: 1000 }, { id: 'blue', name: 'Blue', cost: 1000 },
                { id: 'christmas', name: 'Christmas', cost: 5000 }, { id: 'halloween', name: 'Halloween', cost: 5000 },
                { id: 'winter', name: 'Winter', cost: 7500 }, { id: 'beach', name: 'Beach', cost: 7500 },
                { id: 'grove', name: 'Grove', cost: 10000 }, { id: 'dark-purple', name: 'Dark Purple', cost: 15000 },
                { id: 'grayscale', name: 'Grayscale', cost: 15000 }, { id: 'stage-lights', name: 'Stage Lights', cost: 20000 },
                { id: 'dark-aqua', name: 'Dark Aqua', cost: 25000 }, { id: 'brownstone', name: 'Brownstone', cost: 30000 }
            ];

            allThemes.forEach(theme => {
                const isUnlocked = playerData.themes.unlocked.includes(theme.id);
                const item = document.createElement('div');
                item.className = 'theme-item p-2 rounded-lg flex flex-col justify-between';
                if (!isUnlocked) item.classList.add('locked');
                if (playerData.themes.active === theme.id) item.classList.add('active');

                item.innerHTML = `
                    <div class="font-bold text-sm">${theme.name}</div>
                    <div class="text-xs">${isUnlocked ? 'Unlocked' : `💰 ${theme.cost.toLocaleString()}`}</div>
                `;
                item.style.backgroundColor = `var(--panel-bg)`; // Use CSS variables for preview
                item.style.border = `2px solid var(--panel-border)`;

                // Temporarily apply theme to the item for preview
                const originalBodyClasses = document.body.className;
                document.body.className = `theme-${theme.id}`;
                item.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--panel-bg').trim();
                item.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--panel-border').trim();
                document.body.className = originalBodyClasses;

                item.addEventListener('click', () => {
                    if (isUnlocked) {
                        applyTheme(theme.id);
                    } else if ((playerData.stats.totalBagsCollected || 0) >= theme.cost) {
                        playerData.stats.totalBagsCollected -= theme.cost;
                        playerData.themes.unlocked.push(theme.id);
                        applyTheme(theme.id);
                        savePlayerProfile();
                        updateSetupModalDisplays();
                    }
                });
                container.appendChild(item);
            });
        }
        
        function applyTheme(themeId) {
            document.body.className = `text-white flex items-center justify-center min-h-screen p-4 theme-${themeId}`;
            playerData.themes.active = themeId;
            savePlayerProfile();
            // Re-render theme store to show active state
            if (!document.getElementById('setup-modal').classList.contains('hidden')) {
                populateThemeStore();
            }
        }

        function populateNonsenseFreebies() {
            const container = document.getElementById('nonsense-freebies-container');
            container.innerHTML = '';
            nonsenseFreebies.forEach(freebie => {
                const count = playerData.nonsenseFreebiesCollected[freebie] || 0;
                const item = document.createElement('div');
                item.className = 'freebie-item';
                if (trades.some(t => t.cost[freebie])) {
                    item.classList.add('tradable');
                }
                item.innerHTML = `
                    <div>${freebie}</div>
                    <div class="freebie-count">x${count}</div>
                `;
                container.appendChild(item);
            });
        }
        
        // --- Daily Rewards Logic ---
        function showWelcomeBonus() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const lastClaimedDate = playerData.dailyRewards.lastClaimed ? new Date(playerData.dailyRewards.lastClaimed) : null;
            
            // Check if already claimed today
            if (lastClaimedDate && lastClaimedDate.toISOString().split('T')[0] === todayStr) {
                actuallyStartGame(); // Already claimed, proceed to game
                return;
            }

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (lastClaimedDate && lastClaimedDate.toISOString().split('T')[0] === yesterdayStr) {
                playerData.dailyRewards.streak++;
            } else {
                playerData.dailyRewards.streak = 1; // Reset streak
            }
            playerData.dailyRewards.lastClaimed = todayStr;
            playerData.lastLoginDate = todayStr;

            const streak = playerData.dailyRewards.streak;
            const coinBonus = 1000 * streak;
            const bagBonus = 100 * streak;
            
            coins += coinBonus;
            playerData.stats.totalBagsCollected += bagBonus;
            
            const bonusContainer = document.getElementById('bonus-rewards-container');
            bonusContainer.innerHTML = `
                <div class="bonus-item text-center" style="animation-delay: 0.1s;">
                    <div class="text-4xl">🪙</div>
                    <div class="font-bold text-lg text-white">${coinBonus.toLocaleString()}</div>
                </div>
                <div class="bonus-item text-center" style="animation-delay: 0.2s;">
                    <div class="text-4xl">💰</div>
                    <div class="font-bold text-lg text-green-400">${bagBonus.toLocaleString()}</div>
                </div>
            `;
            
            document.getElementById('welcome-bonus-modal').classList.remove('hidden');
            savePlayerProfile();
            updateScoreDisplay();
            updateSetupModalDisplays();
        }

        function populateCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Add legend
            const legend = document.createElement('div');
            legend.id = 'calendar-legend';
            legend.innerHTML = `
                <div class="text-lg font-bold">Streak: ${playerData.dailyRewards.streak || 0} days</div>
                <div class="flex gap-2 text-xs"><div class="w-3 h-3 rounded-full bg-amber-400 border border-amber-200"></div> Double Bonus</div>
                <div class="flex gap-2 text-xs"><div class="w-3 h-3 rounded-full bg-red-500 border border-red-300"></div> Triple Bonus</div>
            `;
            grid.appendChild(legend);

            // Add empty cells for days before the 1st
            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.appendChild(document.createElement('div'));
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                
                const dayDate = new Date(currentYear, currentMonth, day);
                const dayStr = dayDate.toISOString().split('T')[0];
                const isClaimed = new Date(playerData.dailyRewards.lastClaimed) >= dayDate;
                
                const coinReward = 1000 * day;
                const bagReward = 100 * day;
                
                dayCell.innerHTML = `<div class="day-number">${day}</div><div class="reward-text">🪙${coinReward}<br>💰${bagReward}</div>`;

                if (day < today.getDate()) {
                    dayCell.classList.add('past-day');
                } else if (day === today.getDate()) {
                    dayCell.classList.add('today');
                    if (playerData.dailyRewards.lastClaimed === dayStr) {
                        dayCell.classList.add('claimed');
                    }
                } else {
                    dayCell.classList.add('future');
                }
                
                if (day % 5 === 0) dayCell.classList.add('double-bonus');
                if (day % 10 === 0) dayCell.classList.add('triple-bonus');

                grid.appendChild(dayCell);
            }
        }
        
        // --- Trading Post & Giving Logic ---
        function populateTradingPost() {
            const container = document.getElementById('available-trades-container');
            container.innerHTML = '';
            trades.forEach(trade => {
                const item = document.createElement('div');
                item.className = 'trade-item p-2 rounded-lg cursor-pointer';
                item.innerHTML = `<div class="font-bold text-sm">${trade.name}</div>`;
                item.addEventListener('click', () => selectTrade(trade));
                container.appendChild(item);
            });
        }

        function selectTrade(trade) {
            selectedTrade = trade;
            document.querySelectorAll('.trade-item').forEach(el => el.classList.remove('selected'));
            const selectedEl = Array.from(document.querySelectorAll('.trade-item')).find(el => el.textContent === trade.name);
            if(selectedEl) selectedEl.classList.add('selected');

            const previewPanel = document.getElementById('trade-preview-panel');
            const costText = Object.entries(trade.cost).map(([emoji, amount]) => `${amount} ${emoji}`).join(', ');
            const rewardText = trade.reward.type === 'inventory' ? `${trade.reward.amount} ${trade.reward.item}` : `${trade.reward.amount.toLocaleString()} ${trade.reward.type}`;
            previewPanel.innerHTML = `
                <div class="text-center">
                    <div class="text-sm text-slate-300">COST</div>
                    <div class="text-3xl">${costText}</div>
                </div>
                <div class="text-3xl my-4">➡️</div>
                <div class="text-center">
                    <div class="text-sm text-slate-300">REWARD</div>
                    <div class="text-3xl">${rewardText}</div>
                </div>
            `;
            
            const canAfford = Object.entries(trade.cost).every(([emoji, amount]) => (playerData.nonsenseFreebiesCollected[emoji] || 0) >= amount);
            document.getElementById('execute-trade-button').disabled = !canAfford;
        }

        function executeTrade() {
            if (!selectedTrade) return;
            // Double check affordability
            const canAfford = Object.entries(selectedTrade.cost).every(([emoji, amount]) => (playerData.nonsenseFreebiesCollected[emoji] || 0) >= amount);
            if (!canAfford) return;

            // Deduct cost
            Object.entries(selectedTrade.cost).forEach(([emoji, amount]) => {
                playerData.nonsenseFreebiesCollected[emoji] -= amount;
            });

            // Add reward
            if (selectedTrade.reward.type === 'inventory') {
                const item = selectedTrade.reward.item;
                playerData.inventory[item] = (playerData.inventory[item] || 0) + selectedTrade.reward.amount;
            } else if (selectedTrade.reward.type === 'coins') {
                coins += selectedTrade.reward.amount;
            } else if (selectedTrade.reward.type === 'bags') {
                playerData.stats.totalBagsCollected += selectedTrade.reward.amount;
            }
            
            playerData.badges.trader = true; // Award badge
            
            savePlayerProfile();
            updateSetupModalDisplays();
            updateScoreDisplay();
            populateTradingPost(); // Refresh list to update affordibility
            document.getElementById('execute-trade-button').disabled = true;
            document.getElementById('trade-preview-panel').innerHTML = `<div class="text-xl font-bold">Trade Complete!</div>`;
        }

        function populateGivingModal() {
            const container = document.getElementById('giving-inventory');
            container.innerHTML = '';
            selectedDonation = null;
            document.getElementById('execute-give-button').disabled = true;

            Object.entries(playerData.inventory).forEach(([item, count]) => {
                if (count > 0) {
                    const card = document.createElement('div');
                    card.className = 'giving-item p-2 rounded-lg cursor-pointer text-center';
                    card.innerHTML = `
                        <div class="text-4xl">${item}</div>
                        <div class="text-sm font-bold">${inventoryItemNames[item] || 'Item'}</div>
                        <div class="text-xs text-slate-400">x${count}</div>
                    `;
                    card.addEventListener('click', () => {
                        document.querySelectorAll('.giving-item').forEach(el => el.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedDonation = item;
                        document.getElementById('execute-give-button').disabled = false;
                    });
                    container.appendChild(card);
                }
            });
        }

        function executeGive() {
            if (!selectedDonation) return;
            if (playerData.inventory[selectedDonation] > 0) {
                playerData.inventory[selectedDonation]--;
                
                if (!playerData.badges.philanthropist) {
                    playerData.badges.philanthropist = true;
                    showEventText("Badge Unlocked: Philanthropist!", true);
                    updateBadgesPanel();
                }
                
                savePlayerProfile();
                populateGivingModal();
                showEventText("Thank you for your donation!", true);
            }
        }

        // --- Riches Modal Logic ---
        function populateRichesModal() {
            const container = document.getElementById('riches-inventory');
            container.innerHTML = '';
            const allItems = { ...playerData.inventory, ...playerData.nonsenseFreebiesCollected };
            
            if (Object.keys(allItems).length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-slate-400">Your inventory is empty. Play the game to collect goodies!</p>`;
            } else {
                for (const [item, count] of Object.entries(allItems)) {
                    if (count > 0) {
                        const card = document.createElement('div');
                        card.className = 'riches-card';
                        card.innerHTML = `
                            <div class="text-5xl">${item}</div>
                            <div class="text-sm font-bold mt-1">${inventoryItemNames[item] || 'Goodie'}</div>
                            <div class="text-xs text-slate-300">x${count}</div>
                        `;
                        container.appendChild(card);
                    }
                }
            }
            document.getElementById('net-worth-panel').innerHTML = calculateNetWorth();
        }

Of course. My apologies for the previous issues. Here is the remainder of the code, starting from the line you specified.

```javascript
        function calculateNetWorth() {
            let netWorth = 0;
            const itemValues = { '🚚': 100, '🏛️': 150, '🍕': 200, '🍔': 250, '🥔': 300, '🐔': 250, '💽': 200, '🍩': 150, '📺': 100, '🍬': 50, '🍷': 100, '🏭': 1000, '🤕': -50, '⛏️': 2000 };
            
            Object.entries(playerData.inventory).forEach(([item, count]) => {
                netWorth += (itemValues[item] || 0) * count;
            });

            let netWorthDescription = "Just starting out.";
            if (netWorth > 1000000) netWorthDescription = "You're a tycoon!";
            else if (netWorth > 100000) netWorthDescription = "Big time operator!";
            else if (netWorth > 10000) netWorthDescription = "Savvy investor.";
            else if (netWorth > 1000) netWorthDescription = "Getting established.";

            return { netWorth, netWorthDescription };
        }


        // --- Tips Carousel Logic ---
        function populateTipsCarousel() {
            const container = document.getElementById('tip-card-container');
            container.innerHTML = '';
            tips.forEach((tip, index) => {
                const card = document.createElement('div');
                card.className = 'tip-card';
                if (index === 0) card.classList.add('active');
                card.textContent = tip;
                container.appendChild(card);
            });
        }
        
        function showNextTip(direction) {
            const cards = document.querySelectorAll('.tip-card');
            cards[currentTipIndex].classList.remove('active');
            currentTipIndex = (currentTipIndex + direction + cards.length) % cards.length;
            cards[currentTipIndex].classList.add('active');
        }

        // --- Privacy Policy Fetching ---
        async function fetchPrivacyPolicy() {
            const contentEl = document.getElementById('privacy-policy-content');
            try {
                const response = await fetch('https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/privacy.html');
                if (!response.ok) throw new Error('Network response was not ok');
                const html = await response.text();
                contentEl.innerHTML = html;
            } catch (error) {
                console.error('Failed to fetch privacy policy:', error);
                contentEl.innerHTML = '<p>Could not load the privacy policy. Please try again later.</p>';
            }
        }

        function copyUserIdToClipboard() {
            if (!userId) return;
            navigator.clipboard.writeText(userId).then(() => {
                const button = document.getElementById('copy-userid-button');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        }

        // --- Badges Logic ---
        const badgeDefinitions = {
            redHeart: { emoji: '❤️', name: 'Red Heart', description: 'Play 1 game.' },
            orangeHeart: { emoji: '🧡', name: 'Orange Heart', description: 'Play 10 games.' },
            yellowHeart: { emoji: '💛', name: 'Yellow Heart', description: 'Score over 1,000,000 coins.' },
            greenHeart: { emoji: '💚', name: 'Green Heart', description: 'Use 50 green bombs.' },
            blueHeart: { emoji: '💙', name: 'Blue Heart', description: 'Collect 1,000,000 total bags.' },
            purpleHeart: { emoji: '💜', name: 'Purple Heart', description: 'Make your first trade.' }
        };

        function checkAndAwardBadges(finalScore) {
            const stats = playerData.stats;
            const badges = playerData.badges;
            let newBadgeAwarded = false;

            if (!badges.redHeart) { badges.redHeart = true; newBadgeAwarded = true; }
            if (stats.gamesPlayed >= 10 && !badges.orangeHeart) { badges.orangeHeart = true; newBadgeAwarded = true; }
            if (finalScore >= 1000000 && !badges.yellowHeart) { badges.yellowHeart = true; newBadgeAwarded = true; }
            if (stats.greenBombsUsed >= 50 && !badges.greenHeart) { badges.greenHeart = true; newBadgeAwarded = true; }
            if (stats.totalBagsCollected >= 1000000 && !badges.blueHeart) { badges.blueHeart = true; newBadgeAwarded = true; }
            // The purple heart for trading is awarded in executeTrade()
            
            if (newBadgeAwarded) {
                savePlayerProfile();
                updateBadgesPanel();
                showEventText("New Badge Unlocked!", true);
            }
        }

        function updateBadgesPanel() {
            const panel = document.getElementById('badges-panel');
            panel.innerHTML = '';
            Object.entries(badgeDefinitions).forEach(([id, badge]) => {
                if (playerData.badges[id]) {
                    const item = document.createElement('div');
                    item.className = 'badge-item';
                    item.innerHTML = `<span class="tooltip">${badge.name}</span>${badge.emoji}`;
                    panel.appendChild(item);
                }
            });
        }

        function populateBadgesInfoModal() {
            const container = document.getElementById('badges-info-container');
            container.innerHTML = '';
            Object.entries(badgeDefinitions).forEach(([id, badge]) => {
                const isUnlocked = playerData.badges[id];
                const card = document.createElement('div');
                card.className = 'badge-info-card';
                if (!isUnlocked) card.classList.add('locked');
                card.innerHTML = `
                    <div class="badge-info-emoji">${badge.emoji}</div>
                    <div>
                        <div class="font-bold text-lg">${badge.name}</div>
                        <div class="text-sm text-slate-300">${badge.description}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Goodie Rush Logic ---
        function setupGoodieRushOrbs() {
            goodieOrbsContainer.innerHTML = '';
            goodieRushOrbs = [];
            const availableGoodies = [...(playerData.awardedGoodies || nonsenseFreebies)];
            if (availableGoodies.length < 4) {
                 availableGoodies.push(...nonsenseFreebies.slice(0, 4 - availableGoodies.length));
            }

            for (let i = 0; i < 4; i++) {
                const randomIndex = Math.floor(Math.random() * availableGoodies.length);
                const goodie = availableGoodies.splice(randomIndex, 1)[0];
                const orb = document.createElement('div');
                orb.className = 'goodie-orb';
                orb.innerHTML = `<div class="emoji">${goodie}</div>`;
                orb.dataset.goodie = goodie;
                orb.dataset.spent = "false";
                
                orb.addEventListener('click', () => onOrbClick(orb));
                
                goodieOrbsContainer.appendChild(orb);
                goodieRushOrbs.push({emoji: goodie, element: orb, spent: false});
            }
        }

        function onOrbClick(orbElement) {
            if (isGoodieRushActive || orbElement.dataset.spent === "true") return;

            const goodie = orbElement.dataset.goodie;
            orbElement.dataset.spent = "true";
            orbElement.classList.add('spent');
            
            startGoodieRush(goodie);
        }

        function startGoodieRush(goodieEmoji) {
            isGoodieRushActive = true;
            goodieRushTimeRemaining = 20;

            // Pause main game logic
            clearTimeout(prizeSpawnerTimeout);
            clearInterval(mainTimerInterval);
            
            showEventText("Goodie Rush!", true);

            setTimeout(() => {
                // Fill the board
                const allPuzzleIndices = puzzles.flatMap(p => p.indices);
                for(let i=0; i<81; i++) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!allPuzzleIndices.includes(i)) {
                        tile.textContent = ''; // Clear previous content
                        tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center font-bold rounded-lg select-none';
                        
                        if (i === 0 || i === 8 || i === 72 || i === 80) { // Corners
                             tile.textContent = '💣';
                             tile.classList.add('prize-tile', 'green-bomb');
                             tile.draggable = true;
                             addDragListeners(tile);
                        } else {
                            tile.textContent = goodieEmoji;
                            tile.classList.add('goodie-rush-tile');
                            tile.addEventListener('click', onGoodieRushTileClick, { once: true });
                        }
                    }
                }
                // Start the 20-second timer
                goodieRushTimerInterval = setInterval(updateGoodieRushTimer, 1000);
            }, 2000); // Wait 2 seconds after "Goodie Rush!" message
        }
        
        function updateGoodieRushTimer() {
            goodieRushTimeRemaining--;
            document.getElementById('timer-display').textContent = `RUSH: ${goodieRushTimeRemaining.toString().padStart(2, '0')}`;
            
            // Randomly disappear tiles
            const rushTiles = document.querySelectorAll('.goodie-rush-tile');
            if (rushTiles.length > 0) {
                const tileToRemove = rushTiles[Math.floor(Math.random() * rushTiles.length)];
                tileToRemove.classList.add('disappearing');
                setTimeout(() => {
                    tileToRemove.textContent = '';
                    tileToRemove.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }, 500);
            }

            if (goodieRushTimeRemaining <= 0) {
                endGoodieRush();
            }
        }

        function onGoodieRushTileClick(e) {
            const tile = e.currentTarget;
            const goodieEmoji = tile.textContent;
            
            coins += 50000;
            updateScoreDisplay();
            triggerCoinAnimation(tile, document.getElementById('coins-display'));

            if (!currentGoodieRushCollections[goodieEmoji]) {
                currentGoodieRushCollections[goodieEmoji] = 0;
            }
            currentGoodieRushCollections[goodieEmoji]++;
            
            tile.textContent = '';
            tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
        }

        function endGoodieRush() {
            clearInterval(goodieRushTimerInterval);
            isGoodieRushActive = false;
            
            // Clear remaining goodies and bombs from the board
            initializeGrid();
            
            // Re-enable other orbs
            goodieRushOrbs.forEach(orb => {
                if (!orb.spent) {
                    orb.element.classList.remove('spent');
                }
            });

            // Resume main game timer and logic
            mainTimerInterval = setInterval(updateTimer, 1000);
            scheduleNextPrizeSpawn();
        }


        // --- Init & Event Listeners ---
        function init() {
            initializeFirebase();
            setupAllModals();
            setupAudioControls();
            populateTipsCarousel();
            
            document.getElementById('solve-button').addEventListener('click', onSolveButtonClick);

            musicPlayer.addEventListener('ended', playNextTrack);
            
            playerNameInput.addEventListener('change', (e) => {
                const newName = e.target.value.trim();
                if (newName.length > 0 && newName.length <= 15) {
                    playerData.playerName = newName;
                    savePlayerProfile();
                    playerNameInput.classList.remove('invalid-input');
                } else {
                    playerNameInput.classList.add('invalid-input');
                }
            });

            document.getElementById('help-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.remove('hidden');
                pauseGame();
            });

            document.getElementById('setup-button').addEventListener('click', () => {
                updateSetupModalDisplays();
            });
            
            document.getElementById('daily-rewards-button').addEventListener('click', populateCalendar);
            document.getElementById('trade-goodies-button').addEventListener('click', populateTradingPost);
            document.getElementById('riches-button').addEventListener('click', populateRichesModal);
            document.getElementById('privacy-policy-button').addEventListener('click', fetchPrivacyPolicy);
            document.getElementById('badges-button').addEventListener('click', populateBadgesInfoModal);
            document.getElementById('give-button').addEventListener('click', populateGivingModal);

            startLevel();
            pauseGame(); // Game starts paused until modals are closed
        }

        // --- Start the game ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>