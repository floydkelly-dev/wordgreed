<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Greed</title>
    <link id="favicon" rel="icon" href="https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Lobster+Two:ital,wght@1,700&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9BVWMWR6X5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-9BVWMWR6X5');
    </script>
    <style>
        :root {
            --primary-color: #a78bfa; --primary-color-dark: #8b5cf6; --primary-color-light: #c4b5fd; --primary-text-dark: #1e1b4b; --panel-bg: rgba(55, 25, 85, 0.4); --panel-border: rgba(167, 139, 250, 0.3);
        }
        body.theme-red { --primary-color: #f87171; --primary-color-dark: #ef4444; --primary-color-light: #fca5a5; --primary-text-dark: #7f1d1d; --panel-bg: rgba(127, 29, 29, 0.4); --panel-border: rgba(239, 68, 68, 0.3); }
        body.theme-green { --primary-color: #4ade80; --primary-color-dark: #22c55e; --primary-color-light: #86efac; --primary-text-dark: #14532d; --panel-bg: rgba(22, 101, 52, 0.4); --panel-border: rgba(34, 197, 94, 0.3); }
        body.theme-blue { --primary-color: #60a5fa; --primary-color-dark: #3b82f6; --primary-color-light: #93c5fd; --primary-text-dark: #1e3a8a; --panel-bg: rgba(30, 58, 138, 0.4); --panel-border: rgba(59, 130, 246, 0.3); }
        body.theme-christmas { --primary-color: #ef4444; --primary-color-dark: #b91c1c; --primary-color-light: #fca5a5; --primary-text-dark: #166534; --panel-bg: rgba(22, 101, 52, 0.6); --panel-border: rgba(220, 38, 38, 0.5); }
        body.theme-halloween { --primary-color: #f97316; --primary-color-dark: #ea580c; --primary-color-light: #fb923c; --primary-text-dark: #4a044e; --panel-bg: rgba(28, 25, 23, 0.6); --panel-border: rgba(249, 115, 22, 0.5); }
        body.theme-winter { --primary-color: #67e8f9; --primary-color-dark: #0891b2; --primary-color-light: #a5f3fc; --primary-text-dark: #1e3a8a; --panel-bg: rgba(224, 242, 254, 0.4); --panel-border: rgba(56, 189, 248, 0.5); }
        body.theme-beach { --primary-color: #2dd4bf; --primary-color-dark: #0d9488; --primary-color-light: #5eead4; --primary-text-dark: #134e4a; --panel-bg: rgba(253, 230, 138, 0.4); --panel-border: rgba(6, 182, 212, 0.5); }
        body.theme-grove { --primary-color: #f59e0b; --primary-color-dark: #d97706; --primary-color-light: #fbbf24; --primary-text-dark: #1a2e05; --panel-bg: rgba(34, 197, 94, 0.4); --panel-border: rgba(134, 239, 172, 0.5); }
        body.theme-dark-purple { --primary-color: #5b21b6; --primary-color-dark: #4c1d95; --primary-color-light: #7c3aed; --primary-text-dark: #e0e7ff; --panel-bg: rgba(23, 2, 46, 0.5); --panel-border: rgba(109, 40, 217, 0.5); }
        body.theme-grayscale { --primary-color: #9ca3af; --primary-color-dark: #6b7280; --primary-color-light: #d1d5db; --primary-text-dark: #111827; --panel-bg: rgba(107, 114, 128, 0.4); --panel-border: rgba(156, 163, 175, 0.5); }
        body.theme-stage-lights { --primary-color: #ec4899; --primary-color-dark: #db2777; --primary-color-light: #f472b6; --primary-text-dark: #1e1b4b; --panel-bg: rgba(13, 13, 33, 0.6); --panel-border: rgba(236, 72, 153, 0.5); }
        
        @keyframes move-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(125deg, #000000, #0c1e42, #1e3a8a, #000000); background-size: 400% 400%; animation: move-gradient 20s ease infinite; overflow-x: hidden; }
        
        .game-title-style { 
            font-family: 'Lobster Two', cursive; 
            color: #FDD835;
            font-weight: 700; 
            font-style: italic; 
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 3px 0 #4a2c0f, 3px 3px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .coin-rotate { display: inline-block; animation: spin 5s linear infinite; }
        @keyframes fly-along-path { 0% { offset-distance: 0%; opacity: 1; } 100% { offset-distance: 100%; opacity: 0; } }
        @keyframes coin-swirl-in { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 100% { transform: scale(0) rotate(360deg); opacity: 0; } }
        @keyframes diamond-vortex { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(720deg); opacity: 0; } }
        @keyframes game-over-swirl { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(-360deg); opacity: 0; } }
        @keyframes big-coin-tumble { 0% { transform: scale(8) rotate(0deg); opacity: 1; } 50% { transform: scale(5) rotate(360deg); } 100% { transform: scale(1) rotate(720deg); opacity: 1; } }
        .coin { position: absolute; top: 0; left: 0; width: 20px; height: 20px; background-color: #FFD700; border-radius: 50%; border: 2px solid #B8860B; pointer-events: none; z-index: 100; }
        @keyframes pulse-glow-red { 0%, 100% { box-shadow: 0 0 8px #ef4444, 0 0 15px #ef4444; } 50% { box-shadow: 0 0 12px #f87171, 0 0 25px #f87171; } }
        @keyframes pulse-glow-fire { 0%, 100% { box-shadow: 0 0 10px #fb923c, 0 0 20px #fb923c; } 50% { box-shadow: 0 0 15px #f97316, 0 0 30px #f97316; } }
        @keyframes wild-pulse-animation { 0%, 100% { transform: scale(1); box-shadow: 0 0 15px #F59E0B, 0 0 30px #F59E0B; } 50% { transform: scale(1.2) rotate(10deg); box-shadow: 0 0 25px #facc15, 0 0 50px #facc15; } }
        @keyframes big-pulse-animation { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.25); } }
        #jackpot-square.wild-pulse { animation: wild-pulse-animation 0.5s infinite ease-in-out !important; }
        #jackpot-square.cooldown { background-color: #4b5563 !important; border-color: #6b7280 !important; cursor: not-allowed; }
        #solve-button.big-pulse { animation: big-pulse-animation 1.5s ease-in-out infinite; }
        .prize-tile { animation: pulse-glow-blue 1.5s infinite; cursor: pointer; font-size: 2rem; }
        .prize-tile.red-bomb { background-color: #ef4444 !important; animation-name: pulse-glow-red; }
        .prize-tile.green-bomb { background-color: #22c55e !important; animation-name: pulse-glow-green; cursor: grab; }
        .prize-tile.fire-bomb { background-color: #f97316 !important; animation-name: pulse-glow-fire; }
        .glass-panel { background-color: rgba(20, 20, 40, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        #start-modal .glass-panel, #welcome-bonus-modal .glass-panel { box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), 0 0 0 2px #f59e0b; }
        .word-puzzle-tile { background-color: #FFFFFF !important; color: #111827 !important; border: 2px solid #d1d5db; cursor: grab; }
        .word-puzzle-tile.dragging { opacity: 0.5; cursor: grabbing; }
        .word-puzzle-tile.solved { background-color: #15803d !important; color: #FFFFFF !important; border-color: #14532d; box-shadow: inset 3px 3px 4px rgba(0, 0, 0, 0.5); cursor: default; }
        .greed-panel { background-color: var(--panel-bg); border: 1px solid var(--panel-border); }
        #solve-button { background-color: var(--primary-color); color: var(--primary-text-dark); border: 1px solid var(--primary-color-light); box-shadow: 0 2px 5px rgba(0,0,0,0.4); transition: all 0.2s ease; flex-shrink: 0; }
        #solve-button:hover { background-color: var(--primary-color-dark); color: #FFFFFF; }
        #solve-button:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        #solve-button:disabled { background-color: #6b7280; color: #d1d5db; cursor: not-allowed; }
        #solve-button.cooldown-timer { font-size: 1.25rem; font-family: 'Inter', sans-serif; }
        
        .event-text {
            font-family: 'Lobster Two', cursive; font-size: 5rem; color: #FDD835;
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 2px 0 #4a2c0f, 3px 2px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
            animation: event-flash 2s ease-out forwards;
        }
        .event-text.long-flash { animation-duration: 4s; }
        .event-text.green-glow {
            color: #4ade80;
            text-shadow: -2px -2px 0 #14532d, 2px -2px 0 #14532d, -2px 2px 0 #14532d, 2px 2px 0 #14532d, 0 0 10px #4ade80, 0 0 20px #22c55e;
        }
        @keyframes event-flash { 0%, 100% { opacity: 0; transform: scale(0.8); } 20%, 80% { opacity: 1; transform: scale(1.1); } }
        
        @keyframes button-shimmer { 0% { transform: translateX(-100%) skewX(-15deg); } 100% { transform: translateX(200%) skewX(-15deg); } }
        .glassy-button {
            border: 1px solid; box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease-out; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .glassy-button::before {
            content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: button-shimmer 4s infinite linear;
        }
        .glassy-button:active { transform: translateY(2px); border-bottom-width: 2px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); }
        @keyframes start-button-pulse { 0%, 100% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } 5% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 20px #3b82f6, 0 0 40px #3b82f6; } 15% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } }
        #start-game-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; animation: start-button-pulse 15s infinite; }
        #claim-bonus-button { background: linear-gradient(145deg, #16a34a, #15803d); border-color: #4ade80; border-bottom: 4px solid #14532d; }
        #play-again-button { background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af; border-bottom: 4px solid #1f2937; }
        #close-help-button, #close-about-button, #close-playlist-button, #close-setup-button, #close-daily-rewards-button, #close-trading-post-button, #close-riches-button, #close-tips-button, #close-privacy-button, #close-giving-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; }
        #about-button, #privacy-policy-button { background: linear-gradient(145deg, #8b5cf6, #7c3aed); border-color: #a78bfa; border-bottom: 4px solid #5b21b6; }
        #setup-button { background: linear-gradient(145deg, #22c55e, #15803d); border-color: #4ade80; border-bottom: 4px solid #14532d; }
        #daily-rewards-button { background: linear-gradient(145deg, #f59e0b, #d97706); border-color: #fbbf24; border-bottom: 4px solid #92400e; }
        #tips-button { background: linear-gradient(145deg, #f97316, #ea580c); border-color: #fb923c; border-bottom: 4px solid #c2410c; }
        #confirm-reset-button { background: linear-gradient(145deg, #f87171, #ef4444); border-color: #fca5a5; border-bottom: 4px solid #7f1d1d; }
        .theme-button { width: 2.5rem; height: 2.5rem; border-radius: 50%; background-color: var(--panel-bg); border: 1px solid var(--panel-border); color: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; position: relative; }
        .theme-button:hover .tooltip { opacity: 1; visibility: visible; }
        .theme-button.difficulty-active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.6); transform: translateY(1px); }
        .theme-button svg { transform: scale(0.9); }
        .tooltip { visibility: hidden; opacity: 0; width: 120px; background-color: black; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; transition: opacity 0.3s; font-size: 0.75rem; }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: black transparent transparent transparent; }
        #help-button { font-size: 1.25rem; font-weight: bold; }
        #difficulty-default .orb { fill: #8B5CF6; } #difficulty-easy .orb { fill: #3B82F6; } #difficulty-medium .orb { fill: #F59E0B; } #difficulty-hard .orb { fill: #EF4444; }
        .score-decay { color: #ef4444 !important; }
        .greed-icon {
            width: 3rem; height: 3rem; background-color: var(--primary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.75rem; border: 1px solid var(--primary-color-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); cursor: pointer; color: white;
        }
        @keyframes ice-shimmer { 0% { background-position: -100% 0; } 100% { background-position: 100% 0; } }
        @keyframes crack-fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes ice-fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(90deg); opacity: 0; } }
        .ice-block {
            position: absolute; background: linear-gradient(145deg, rgba(173, 216, 230, 0.5), rgba(135, 206, 250, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.5), 0 4px 6px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 50; overflow: hidden;
        }
        .ice-block::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: ice-shimmer 3s infinite linear;
        }
        .ice-block.cracked {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44"><path d="M 10 0 L 10 15 L 0 20 L 10 25 L 10 44 M 20 0 L 25 10 L 15 15 L 25 20 L 20 44 M 35 0 L 30 22 L 44 28" stroke="rgba(255,255,255,0.7)" stroke-width="1" fill="none"/></svg>'), linear-gradient(145deg, rgba(173, 216, 230, 0.6), rgba(135, 206, 250, 0.7));
            background-size: cover; animation: crack-fade-in 0.2s forwards;
        }
        #bomb-drag-preview { position: absolute; border: 3px dashed #22c55e; background-color: rgba(34, 197, 94, 0.3); pointer-events: none; z-index: 200; display: none; }
        @keyframes cash-money-pulse { 0%, 100% { box-shadow: 0 0 15px #4ade80, 0 0 30px #4ade80; } 50% { box-shadow: 0 0 25px #22c55e, 0 0 50px #22c55e; } }
        .cash-money-prize { background-color: #16a34a !important; animation: cash-money-pulse 0.7s infinite ease-in-out; }
        @keyframes fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        @keyframes twinkle { 0%, 100% { transform: scale(0); opacity: 0; } 50% { transform: scale(1); opacity: 1; } }
        .falling-coin { position: absolute; font-size: 1.5rem; animation: fall linear forwards; pointer-events: none; }
        .sparkle { position: absolute; width: 8px; height: 8px; background-color: #fde047; border-radius: 50%; box-shadow: 0 0 5px #fde047, 0 0 10px #facc15; animation: twinkle ease-in-out infinite; pointer-events: none; }
        
        @keyframes fall-sway {
            0% { transform: translateY(-100%) translateX(0vw) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            50% { transform: translateY(50vh) translateX(5vw) rotate(180deg); }
            100% { transform: translateY(100vh) translateX(-5vw) rotate(360deg); opacity: 0; }
        }
        .falling-snowflake, .falling-heart {
            position: fixed;
            top: -10%;
            font-size: 1.5rem;
            animation: fall-sway linear forwards;
            pointer-events: none;
            z-index: 55;
        }

        input[type=range].volume-slider { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range].volume-slider:focus { outline: none; }
        input[type=range].volume-slider::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].volume-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; margin-top: -7px; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }
        input[type=range].volume-slider::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].volume-slider::-moz-range-thumb { height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }
        /* Playlist & Setup Styles */
        #playlist-container { max-height: 220px; overflow-y: auto; background-color: rgba(0,0,0,0.2); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); padding: 0.5rem; border-radius: 0.5rem;}
        .playlist-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; transition: background-color 0.2s; user-select: none; cursor: pointer; }
        .playlist-item:hover { background-color: rgba(0,0,0,0.4); }
        .now-playing-indicator { font-size: 0.75rem; color: var(--primary-color-light); font-style: italic; display: none; }
        .playlist-item.now-playing { background-color: rgba(139, 92, 246, 0.3); }
        .playlist-item.now-playing .now-playing-indicator { display: block; }
        #playlist-controls { background-color: rgba(0,0,0,0.2); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); padding: 0.5rem; border-radius: 9999px; display: flex; align-items: center; gap: 0.5rem;}
        #playlist-controls button { width: 2.5rem; height: 2.5rem; }
        #playlist-controls button.shuffle-active { background: var(--primary-color); }
        #player-name-input { background-color: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); }
        #player-name-input.invalid-input { border-color: #ef4444 !important; box-shadow: 0 0 8px #ef4444; }
        #theme-store-container { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 1rem; flex-wrap: nowrap; }
        #theme-store-container::-webkit-scrollbar { height: 8px; }
        #theme-store-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #theme-store-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        .theme-item {
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
            position: relative; overflow: hidden; flex-shrink: 0; width: 160px; height: 110px;
        }
        .theme-item > div { position: relative; z-index: 1; }
        .theme-item.active { border-color: var(--primary-color-light); box-shadow: 0 0 10px var(--primary-color); }
        .theme-item.locked::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            border-radius: 0.5rem;
            z-index: 2;
        }
        .theme-item.locked::after {
            content: 'üîí';
            position: absolute;
            bottom: 0.25rem;
            right: 0.5rem;
            font-size: 1.75rem;
            z-index: 3;
            transform: none;
        }
        /* Daily Rewards Calendar */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .calendar-day {
            background-color: rgba(0,0,0,0.2); border: 2px solid var(--panel-border);
            border-radius: 0.5rem; padding: 0.25rem; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 80px; position: relative;
        }
        .calendar-day.claimed { background-color: #166534; color: #a7f3d0; cursor: not-allowed; }
        .calendar-day.today { background-color: var(--primary-color); border-color: var(--primary-color-light); cursor: pointer; }
        .calendar-day.today.claimed { background-color: #166534; border-color: #14532d; }
        .calendar-day.future { background-color: rgba(0,0,0,0.1); color: #6b7280; }
        .calendar-day.past-day { background-color: rgba(22, 59, 41, 0.5); color: #4b5563; cursor: not-allowed; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); }
        .calendar-day.double-bonus { border-color: #fde047; }
        .calendar-day.triple-bonus { border-color: #f87171; }
        .day-number { font-weight: bold; font-size: 0.9rem; position: absolute; top: 2px; right: 5px; }
        .reward-text { font-size: 0.65rem; line-height: 1; }
        #calendar-legend { grid-column: span 4; align-self: stretch; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; padding: 0.5rem 0.75rem; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem;}
        /* Welcome Bonus Animation */
        @keyframes bonus-reveal {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .bonus-item { animation: bonus-reveal 0.5s ease-out forwards; }
        #nonsense-freebies-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
        }
        .freebie-item { text-align: center; font-size: 1.25rem; }
        .freebie-count { font-size: 0.75rem; font-weight: bold; color: var(--primary-color-light); }
        .freebie-item.tradable {
            animation: pulse-glow-amber 1.5s infinite ease-in-out;
            border-radius: 0.5rem;
        }
        /* Help Modal Footer Layout */
        #help-modal-footer {
            display: flex; flex-direction: column; align-items: center; width: 100%; gap: 0.75rem;
        }
        /* Setup Modal Scroll FIX */
        #setup-modal > .glass-panel { /* max-height: 90vh; overflow-y: auto; */ }
        /* Background Clouds */
        @keyframes slide {
            0% { transform: translateX(-25%); }
            100% { transform: translateX(25%); }
        }
        .clouds {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 200%;
            height: 100%;
            display: block;
            z-index: -1;
            background-repeat: repeat-x;
            animation: slide 120s linear infinite;
            opacity: 0.3;
        }
        #clouds-day {
            background-image: url('https://placehold.co/2048x1024/87CEEB/FFFFFF?text=Day+Clouds+Here'); /* Replace with your day cloud PNG */
        }
        #clouds-night {
            background-image: url('https://placehold.co/2048x1024/000033/FFFFFF?text=Night+Clouds+Here'); /* Replace with your night cloud PNG */
        }

        @keyframes pulse-glow-amber { 
            0%, 100% { 
                box-shadow: 0 0 15px #f59e0b, 0 0 30px #f59e0b, inset 0 2px 4px rgba(255, 255, 255, 0.4);
                transform: scale(1);
            } 
            50% { 
                box-shadow: 0 0 30px #fbbf24, 0 0 60px #fbbf24, inset 0 2px 4px rgba(255, 255, 255, 0.4);
                transform: scale(1.05);
            } 
        }
        .trade-button-pulse {
            animation: pulse-glow-amber 1.5s infinite ease-in-out;
        }

        .trade-item, .giving-item {
            border: 2px solid var(--panel-border);
            transition: all 0.2s ease-in-out;
        }
        .trade-item.selected, .giving-item.selected {
            border-color: var(--primary-color-light);
            background-color: var(--panel-bg);
            box-shadow: 0 0 10px var(--primary-color);
        }

        /* Tips Modal & Carousel */
        #tips-carousel {
            position: relative;
            width: 100%;
            height: 200px; /* Adjust height as needed */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tip-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 2rem;
            width: 80%;
            text-align: center;
            font-size: 1.25rem;
            position: absolute;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .tip-card.active {
            opacity: 1;
            pointer-events: auto;
        }
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 2rem;
            z-index: 10;
        }
        .carousel-arrow:hover {
            background: rgba(0,0,0,0.5);
        }
        #carousel-prev { left: 1rem; }
        #carousel-next { right: 1rem; }

        /* User ID Display */
        #user-id-container {
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        #copy-userid-button {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        #copy-userid-button:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        /* Privacy Policy Modal */
        #privacy-policy-content {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid var(--panel-border);
            box-shadow: inset 2px 2px 8px rgba(0,0,0,0.6);
            padding: 1rem;
            border-radius: 0.5rem;
            height: 300px;
            overflow-y: auto;
            text-align: left;
            font-size: 0.875rem;
            color: #d1d5db;
        }
        #privacy-policy-content::-webkit-scrollbar { width: 8px; }
        #privacy-policy-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #privacy-policy-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }

        /* Badges Panel */
        #badges-panel {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 2px 4px 0 rgba(0,0,0,0.5);
        }
        .badge-item {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            position: relative;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), rgba(255,255,255,0) 70.71%),
                        radial-gradient(circle at 70% 70%, rgba(0,0,0,0.2), rgba(0,0,0,0) 70.71%);
            box-shadow: inset 0 3px 5px rgba(255,255,255,0.2), 0 4px 6px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .badge-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: button-shimmer 5s infinite linear;
        }
        
        /* Riches Modal */
        #riches-inventory {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            width: 100%;
            max-height: 40vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
        }
        .riches-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        #net-worth-panel {
            background-color: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }

    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">
    <script src="config.js" defer></script>

    <div id="clouds-day" class="clouds hidden"></div>
    <div id="clouds-night" class="clouds hidden"></div>

    <!-- Audio Player for background music -->
    <audio id="background-music">
        <!-- Source will be set dynamically by JavaScript -->
    </audio>

    <!-- Main Game Container -->
    <div id="game-container" class="hidden flex-col md:flex-row gap-4 justify-center md:items-stretch">
        <!-- Game Grid Section -->
        <div class="flex flex-col gap-1 items-center">
            <div class="relative">
                <div id="game-grid" class="grid grid-cols-9 gap-1 bg-slate-800/70 p-3 rounded-xl shadow-2xl border border-slate-700/50"></div>
                <!-- This div is used to show a preview of the green bomb's effect area -->
                <div id="bomb-drag-preview"></div>
            </div>
            <!-- Badges Panel -->
            <div id="badges-panel" class="w-full mt-2 p-2 rounded-xl flex justify-center items-center gap-2 h-20">
                <!-- Badges will be injected here -->
            </div>
        </div>

        <!-- Score & Control Panel -->
        <div id="score-panel" class="glass-panel p-4 rounded-xl w-full max-w-xs md:w-[20rem] flex flex-col justify-between gap-3 relative">
            <div class="flex-grow flex flex-col gap-2"> 
                <!-- Game Title -->
                <div class="relative w-full h-24 flex justify-center items-center flex-shrink-0">
                    <h1 class="game-title-style text-6xl relative" style="width: 15rem; height: 7rem; left: 1rem;">
                        <span class="absolute" style="top: 0; left: 0;">Word</span>
                        <span class="absolute" style="top: 2.7rem; left: 2.5rem;">Greed</span>
                    </h1>
                </div>
                <!-- Level and Timer Display -->
                <div class="p-2 flex justify-around text-center flex-shrink-0">
                    <div><span class="text-sm font-bold text-slate-300">LEVEL</span><div id="level-display" class="text-2xl font-bold text-white">1</div></div>
                    <div><span class="text-sm font-bold text-slate-300">TIME</span><div id="timer-display" class="text-2xl font-bold text-white">10:00</div></div>
                </div>
                <!-- Score Container -->
                <div id="score-container" class="greed-panel p-3 rounded-lg text-center flex flex-col gap-2 flex-grow">
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="text-4xl coin-rotate" style="filter: drop-shadow(0 0 5px #fde047);">ü™ô</div>
                        <div class="text-4xl" style="filter: drop-shadow(0 0 5px #fde047);">üí∞</div>
                        <div id="coins-display" class="text-lg font-bold text-white">0</div>
                        <div id="bags-of-money-display" class="text-lg font-bold text-green-400">0</div>
                    </div>
                    <!-- Greed Score and Solve Button -->
                    <div id="greed-content" class="mx-auto flex flex-col items-center justify-center gap-1 flex-grow">
                        <div class="flex items-center justify-center gap-2"><span class="text-sm font-bold text-violet-200">GREED SCORE</span></div>
                        <hr class="border-violet-300/20 w-full my-1">
                        <div class="flex items-center justify-center gap-2 mt-1">
                            <button id="solve-button" class="w-12 h-12 rounded-full text-3xl font-black flex items-center justify-center">‚úÖ</button>
                            <div id="greed-icons-container" class="flex items-center justify-center gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Theme and Difficulty Buttons -->
            <div id="theme-buttons-container" class="flex justify-around items-center mt-auto flex-shrink-0">
                <button id="help-button" class="theme-button">?</button>
                <button id="difficulty-default" class="theme-button difficulty-button difficulty-active">
                    <span class="tooltip">Default: Max 4</span>
                    <svg viewBox="0 0 100 100" class="w-full h-full"><defs><radialGradient id="highlight1" cx="0.3" cy="0.3" r="0.4"><stop offset="0%" stop-color="white" stop-opacity="0.8"/><stop offset="100%" stop-color="white" stop-opacity="0"/></radialGradient><radialGradient id="highlight2" cx="0.7" cy="0.7" r="0.3"><stop offset="0%" stop-color="white" stop-opacity="0.6"/><stop offset="100%" stop-color="white" stop-opacity="0"/></radialGradient></defs><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
                <button id="difficulty-easy" class="theme-button difficulty-button">
                     <span class="tooltip">Easy: Max 8</span>
                     <svg viewBox="0 0 100 100" class="w-full h-full"><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
                <button id="difficulty-medium" class="theme-button difficulty-button">
                     <span class="tooltip">Medium: Max 4</span>
                     <svg viewBox="0 0 100 100" class="w-full h-full"><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
                <button id="difficulty-hard" class="theme-button difficulty-button">
                     <span class="tooltip">Hard: Max 2</span>
                     <svg viewBox="0 0 100 100" class="w-full h-full"><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Start Modal -->
    <div id="start-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-panel p-8 pb-12 rounded-2xl text-center flex flex-col items-center gap-6 w-full max-w-md relative overflow-hidden">
            <h1 class="game-title-style text-8xl relative" style="width: 22rem; height: 10rem;">
                <span class="absolute" style="top: 0; left: 1rem;">Word</span>
                <span class="absolute" style="top: 4rem; left: 5rem;">Greed</span>
            </h1>
            <p class="text-lg text-slate-300">Drag and drop letters to solve jumbled words. Grab Big Prizes and Get Greedy!</p>
            <button id="start-game-button" class="glassy-button text-white font-bold py-3 px-8 rounded-lg text-2xl">Start Game</button>
            <div class="absolute bottom-2 right-4 text-xs text-slate-500">v2.9</div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl text-center flex flex-col items-center gap-6 w-full max-w-md relative overflow-hidden">
             <h1 class="game-title-style text-6xl relative" style="width: 15rem; height: 7rem;">
                <span class="absolute" style="top: 0; left: 0;">Word</span>
                <span class="absolute" style="top: 2.7rem; left: 2.5rem;">Greed</span>
            </h1>
            <h3 class="text-2xl font-bold text-amber-300 mb-4">Game Over!</h3>
            <div id="final-score-panel" class="greed-panel p-4 rounded-lg w-full max-w-sm" style="box-shadow: inset 2px 2px 8px rgba(0,0,0,0.6), 0 1px 1px rgba(255,255,255,0.2);">
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div class="text-3xl">ü™ô</div>
                    <div class="text-3xl">üí∞</div>
                    <div id="final-coins-display" class="text-lg font-bold text-white">0</div>
                    <div id="final-bags-display" class="text-lg font-bold text-green-400">0</div>
                </div>
            </div>
            <button id="play-again-button" class="glassy-button mt-2 text-white font-bold py-3 px-6 rounded-lg text-xl">Play Again</button>
        </div>
    </div>
    
    <!-- Floating Event Text (e.g., "Level Up!") -->
    <div id="event-text-container" class="hidden fixed inset-0 flex items-center justify-center pointer-events-none z-[60]">
        <div id="event-text" class="event-text text-center"></div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-3 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300">How to Play</h2>
            <table class="w-full text-sm my-2">
                <tbody>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">‚úÖ</td><td class="py-1 pr-2 font-bold text-green-400">Complete Words</td><td class="py-1 text-slate-300">Drag letters to solve words for <strong>10,000 coins</strong>. Solve all 4 for a big bonus!<br>Press the green checkmark for Quick Solve.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">üéÅ</td><td class="py-1 pr-2 font-bold text-white">Present</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">1,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">üèÜ</td><td class="py-1 pr-2 font-bold text-white">Trophy</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">3,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">üíé</td><td class="py-1 pr-2 font-bold text-white">Diamond</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">20,000,000</span> coins & board clear.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">‚ö°</td><td class="py-1 pr-2 font-bold text-white">Lightning</td><td class="py-1 text-slate-300">+<span class="font-bold text-white">20,000</span> coins, but <strong class="text-red-400">resets Bags of Money!</strong></td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">üí£</td><td class="py-1 pr-2 font-bold text-green-400">Green Bomb</td><td class="py-1 text-slate-300">Drag to a puzzle to solve key letters & collect prizes.</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">üí£</td><td class="py-1 pr-2 font-bold text-red-400">Red Bomb</td><td class="py-1 text-slate-300">GAME OVER!</td></tr>
                    <tr class="align-middle"><td class="py-1 pr-2 text-2xl">‚ùÑÔ∏è</td><td class="py-1 pr-2 font-bold text-blue-300">Snowflake</td><td class="py-1 text-slate-300">Freezes all prizes for 15 seconds.</td></tr>
                </tbody>
            </table>
            <div id="help-modal-footer" class="mt-2">
                <div class="flex justify-center w-full items-center gap-2 max-w-xs mx-auto">
                    <button id="volume-toggle-button" class="text-2xl hover:text-white text-slate-300 transition-colors"></button>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" class="volume-slider">
                </div>
                <div class="flex justify-center w-full flex-wrap items-center gap-2">
                    <button id="playlist-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Playlist</button>
                    <button id="daily-rewards-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Daily</button>
                    <button id="tips-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Tips</button>
                    <button id="setup-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Setup</button>
                    <button id="about-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">About</button>
                    <button id="close-help-button" class="glassy-button text-white font-bold py-2 px-3 rounded-lg text-sm">Close</button>
                </div>
            </div>
            <div class="absolute bottom-2 right-4 text-xs text-slate-500">v2.9</div>
        </div>
    </div>

    <!-- Tips Modal -->
    <div id="tips-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Game Tips</h2>
            <div id="tips-carousel" class="w-full">
                <div id="carousel-prev" class="carousel-arrow">‚¨ÖÔ∏è</div>
                <div id="tip-card-container" class="w-full h-full flex items-center justify-center">
                    <!-- Tip cards will be injected here -->
                </div>
                <div id="carousel-next" class="carousel-arrow">‚û°Ô∏è</div>
            </div>
            <button id="close-tips-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">About Word Greed</h2>
            <div class="text-slate-300 space-y-2">
                <p>Created by: <span class="font-bold text-white">Floyd Kelly</span></p>
                <p>Music by: <span class="font-bold text-white">Floyd Kelly and Udio</span></p>
                <p>Version: <span class="font-bold text-white">2.9</span></p>
                <p>Build Date: <span class="font-bold text-white">August 9, 2025</span></p>
                <p><a href="https://floydkellycreates.wordpress.com/contact-me/" target="_blank" class="text-purple-300 hover:text-purple-200">Contact the Developer</a></p>
            </div>
            <div class="flex justify-between w-full mt-4">
                <button id="privacy-policy-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-sm">Privacy Policy</button>
                <button id="close-about-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Privacy Policy</h2>
            <div id="privacy-policy-content">
                Loading...
            </div>
            <button id="close-privacy-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Playlist Modal -->
    <div id="playlist-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative">
            <h2 class="text-2xl font-bold text-amber-300">Soundtrack Playlist</h2>
            <div id="playlist-container" class="w-full space-y-1 my-2 text-left">
                <!-- Playlist items will be injected here by JS -->
            </div>
            <div id="playlist-controls" class="flex items-center justify-center gap-4 my-4">
                <button id="playlist-prev" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.006V5.994a1 1 0 00-1.555-.832L4.16 9.168a1 1 0 000 1.664l4.286 4.001zM11 5h2v10h-2V5z"></path></svg>
                </button>
                <button id="playlist-play-pause" class="glassy-button p-3 rounded-full w-14 h-14" style="background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd;">
                    <!-- Play/Pause SVG will be injected here -->
                </button>
                <button id="playlist-next" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 5.168A1 1 0 0010 5.994v8.012a1 1 0 001.555.832l4.286-4.001a1 1 0 000-1.664l-4.286-4.001zM7 5h2v10H7V5z"></path></svg>
                </button>
                <button id="playlist-shuffle" class="glassy-button p-2 rounded-full" style="background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af;">
                     <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.083 4.083a.75.75 0 011.06 0L9.47 8.414l1.72-1.72a.75.75 0 111.06 1.06l-1.72 1.72 4.327 4.327a.75.75 0 01-1.06 1.06L9.47 10.586l-1.72 1.72a.75.75 0 11-1.06-1.06l1.72-1.72L4.083 5.143a.75.75 0 010-1.06zM6.5 14.25a.75.75 0 01.75-.75h8a.75.75 0 010 1.5h-8a.75.75 0 01-.75-.75zm0-8.5a.75.75 0 01.75-.75h8a.75.75 0 010 1.5h-8a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <button id="close-playlist-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Setup & Store Modal -->
    <div id="setup-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Player Setup & Store</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center">
                <div class="greed-panel p-2 rounded-lg">
                    <label for="player-name-input" class="text-sm font-bold text-slate-300">PLAYER NAME</label>
                    <input type="text" id="player-name-input" class="w-full mt-1 p-1 rounded-md text-center text-lg font-bold" placeholder="Enter Name">
                </div>
                <div class="greed-panel p-2 rounded-lg">
                    <div class="text-sm font-bold text-slate-300">TOTAL MONEY BAGS</div>
                    <div id="total-bags-display" class="text-2xl font-bold text-green-400">0</div>
                </div>
                <div class="greed-panel p-2 rounded-lg">
                    <div class="text-sm font-bold text-slate-300">Highest Score</div>
                    <div id="high-score-display" class="text-2xl font-bold text-white">0</div>
                </div>
            </div>

            <div class="greed-panel p-4 rounded-lg">
                <h3 class="text-lg font-bold text-amber-300 text-left mb-3">Awarded Goodies</h3>
                <div class="flex items-center justify-between">
                    <div id="nonsense-freebies-container" class="flex-grow">
                        <!-- Nonsense freebies will be injected here -->
                    </div>
                    <button id="trade-goodies-button" class="glassy-button text-white font-bold rounded-lg text-lg ml-4" style="background: linear-gradient(145deg, #f59e0b, #d97706); border-color: #fbbf24; width: 160px; height: 55px;">Trade</button>
                </div>
            </div>
            
            <div class="mt-2">
                <h3 class="text-lg font-bold text-amber-300 text-left">Theme Store</h3>
                <div id="theme-store-container" class="mt-2">
                    <!-- Themes will be injected here -->
                </div>
            </div>
            <div class="flex justify-between items-center mt-4">
                <div>
                    <button id="riches-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-sm" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;">View Riches</button>
                    <div id="user-id-container">
                        <span id="user-id-display"></span>
                        <button id="copy-userid-button">Copy</button>
                    </div>
                </div>
                <button id="reset-progress-button" class="text-xs text-red-400 hover:text-red-300">Reset Progress</button>
                <button id="close-setup-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Reset Modal -->
    <div id="confirm-reset-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-sm relative text-center">
            <h2 class="text-xl font-bold text-red-400">Reset Progress?</h2>
            <p class="text-slate-300">Are you sure? All your stats, money bags, and unlocked themes will be permanently deleted.</p>
            <div class="flex items-center gap-4 mt-4">
                <button id="cancel-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Cancel</button>
                <button id="confirm-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Daily Rewards Modal -->
    <div id="daily-rewards-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300">Daily Rewards</h2>
            <div id="calendar-grid" class="w-full">
                <!-- Calendar will be populated by JS -->
            </div>
            <button id="close-daily-rewards-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <!-- Welcome Bonus Modal -->
    <div id="welcome-bonus-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[70] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">Welcome Back!</h2>
            <p class="text-slate-300">Here's your daily bonus for playing!</p>
            <div id="bonus-rewards-container" class="flex items-center justify-center gap-4 my-4 flex-wrap">
                <!-- Bonus items will be injected here -->
            </div>
            <button id="claim-bonus-button" class="glassy-button text-white font-bold py-3 px-8 rounded-lg text-xl">Claim!</button>
        </div>
    </div>

    <!-- Trading Post Modal -->
    <div id="trading-post-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Trading Post</h2>
            <div class="flex gap-4 mt-4">
                <div id="available-trades-container" class="w-1/2 grid grid-cols-2 gap-2">
                    <!-- Available trades will be injected here -->
                </div>
                <div id="trade-preview-panel" class="w-1/2 greed-panel flex flex-col items-center justify-center p-4 rounded-lg">
                    <div id="trade-preview-emoji" class="text-8xl">‚ùî</div>
                    <div id="trade-preview-name" class="text-xl font-bold mt-2">Select a Trade</div>
                </div>
            </div>
            <div class="flex justify-center mt-4 gap-4">
                 <button id="give-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;">Give</button>
                 <button id="execute-trade-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #22c55e, #15803d); border-color: #4ade80;" disabled>Trade</button>
                <button id="close-trading-post-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Giving Modal -->
    <div id="giving-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[70] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-2xl relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Give to Charity</h2>
            <p class="text-slate-300 text-center text-sm">Select an item from your riches to donate and earn a badge!</p>
            <div id="giving-inventory" class="grid grid-cols-4 gap-4 mt-4">
                <!-- Inventory items for giving will be injected here -->
            </div>
            <div class="flex justify-center mt-4 gap-4">
                <button id="execute-give-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg" style="background: linear-gradient(145deg, #a78bfa, #8b5cf6); border-color: #c4b5fd;" disabled>Give Selected Item</button>
                <button id="close-giving-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Riches Modal -->
    <div id="riches-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-3xl relative">
             <h2 class="text-2xl font-bold text-amber-300 text-center">Your Riches</h2>
             <div id="riches-inventory" class="min-h-[200px]">
                <!-- Inventory items will be injected here -->
             </div>
             <hr class="w-full border-t border-slate-600 my-4">
             <div id="net-worth-panel">
                <!-- Net worth description will be injected here -->
             </div>
             <button id="close-riches-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg self-center">Close</button>
        </div>
    </div>
    
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const gridContainer = document.getElementById('game-grid');
        const musicPlayer = document.getElementById('background-music');
        const playerNameInput = document.getElementById('player-name-input');

        // --- Firebase State ---
        let auth, db, userId;
        let isFirebaseConnected = false;

        // --- Game Data & State ---
        let coins = 0, bagsOfMoney = 0, draggedTile = null, playerData = {}, currentLevel = 1;
        const totalGameTime = 600;
        let timeRemaining = totalGameTime, mainTimerInterval = null, prizeSpawnerTimeout = null;
        let diamondSequenceTimeout = null, puzzles = [], trophyCollectedThisLevel = false;
        let diamondCollectedThisLevel = false, currentDiamondValue = 20000000;
        let solveButtonClicks = 0, solveButtonCooldown = 0, solveButtonTimerInterval = null;
        let isGamePaused = true, isGameOver = false, timeSinceLastSolve = 0;
        let scoreDecayInterval = null, impTimeout = null, isFrozen = false, thawTimeout = null;
        let jackpotEventAvailable = true, specialJackpotTimeout = null, specialCashEmojiSpawned = false;
        let timedEvents = { sixMin: true, threeMin: true, heartEvent1: true, heartEvent2: true };
        let isSpecialAnimationActive = false;
        let startModalAnimationInterval = null, maxSameEmoji = 4, isDraggingBomb = false;
        let lastVolume = 0.5, solveButtonPulseManager = null;
        let freezeAnimationInterval = null, heartAnimationInterval = null, gameOverAnimationInterval = null;
        let levelGoodies = [];
        let selectedTrade = null;
        let selectedDonation = null;
        
        // --- Playlist Data ---
        const songDatabase = [
            { id: '001', title: 'Word Greed', filename: 'wordgreed001.mp3' },
            { id: '002', title: 'Diamond Focus', filename: 'wordgreed002.mp3' },
            { id: '003', title: 'Elevated Echoes', filename: 'wordgreed003.mp3' },
            { id: '004', title: 'Smooth Vibes', filename: 'wordgreed004.mp3' },
            { id: '005', title: 'Cash Flow', filename: 'wordgreed005.mp3' },
            { id: '006', title: 'Golden Glow', filename: 'wordgreed006.mp3' },
            { id: '007', title: 'Rich Shadows', filename: 'wordgreed007.mp3' },
            { id: '008', title: 'Reversal of Fortune', filename: 'wordgreed008.mp3' },
            { id: '009', title: 'Ascending Choices', filename: 'wordgreed009.mp3' }
        ];
        let verifiedPlaylist = [], userPlaylist = [], originalUserPlaylist = [];
        let currentTrackIndex = 0, isShuffled = false;
        const musicBaseURL = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/';
        const mutedIconHref = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png';
        const speakerSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M 20 40 L 40 40 L 60 20 L 60 80 L 40 60 L 20 60 Z" fill="white" stroke="black" stroke-width="2"/><path d="M 70 30 C 80 40, 80 60, 70 70" stroke="white" stroke-width="5" fill="none"/><path d="M 80 20 C 95 35, 95 65, 80 80" stroke="white" stroke-width="5" fill="none"/></svg>`;
        const speakerIconHref = `data:image/svg+xml,${encodeURIComponent(speakerSVG)}`;

        // --- Word Bank & Prize Data ---
        const wordBank = ["ABROAD","ACCEPT","ACCESS","ACROSS","ACTION","ACTIVE","ADMIRE","ADVICE","AFFAIR","AFFECT","AFFORD","AGENCY","AGENDA","ALMOST","ALWAYS","AMOUNT","ANIMAL","ANNUAL","ANSWER","ANYONE","ANYWAY","APART","APPEAL","APPEAR","APPLY","APPROVE","AROUND","ARRIVE","ARTIST","ASLEEP","ASPECT","ASSESS","ASSIST","ASSUME","ATTACK","ATTEND","ATTRACT","AUTHOR","AWARD","BALANCE","BECOME","BEHAVE","BELIEF","BELONG","BENEATH","BENEFIT","BESIDE","BEYOND","BISHOP","BORDER","BOTTLE","BOTTOM","BRANCH","BREATH","BRIDGE","BRIEFLY","BRIGHT","BROKEN","BUDGET","BURDEN","CAMERA","CANCEL","CANCER","CANDLE","CAPITAL","CAREER","CAREFUL","CENTRAL","CENTURY","CERTAIN","CHAIR","CHALLENGE","CHANCE","CHANGE","CHARGE","CHOICE","CHOOSE","CHURCH","CIRCLE","CLIENT","CLIMB","CLOSELY","CLOSER","COFFEE","COLLECT","COLLEGE","COLUMN","COMBINE","COMFORT","COMMAND","COMMENT","COMMIT","COMMON","COMPARE","COMPETE","COMPLEX","CONCEPT","CONCERN","CONFIRM","CONFLICT","CONNECT","CONSENT","CONSIST","CONTACT","CONTAIN","CONTENT","CONTEST","CONTEXT","CONTROL","CONVERT","CORNER","COUNCIL","COUNTY","COUPLE","COVER","CREATE","CREDIT","CRISIS","CRITERION","CRITIC","CROWD","CULTURE","CURRENT","CUSTOM","DAMAGE","DANGER","DEALER","DEBATE","DECADE","DECIDE","DECLARE","DECREASE","DEEPLY","DEFAULT","DEFENCE","DEFEND","DEFINE","DEGREE","DELAY","DELIVER","DEMAND","DEPEND","DEPICT","DEPOSIT","DEPUTY","DERIVE","DESIGN","DESIRE","DESPITE","DESTROY","DETAIL","DETECT","DEVELOP","DEVICE","DEVOTE","DIFFER","DIFFICULT","DINNER","DIRECT","DISCUSS","DISEASE","DISMISS","DISPLAY","DISTANT","DIVIDE","DIVISION","DOCTOR","DOCUMENT","DOUBLE","DOUBT","DOZEN","DREAM","DRINK","DRIVE","EAGER","EARLY","EARTH","EASTERN","ECONOMIC","ECONOMY","EDITOR","EDUCATE","EFFECT","EFFORT","EIGHT","EITHER","ELDERLY","ELECT","ELEMENT","ELSE","EMERGE","EMPHASIS","EMPLOY","ENABLE","ENCOURAGE","ENGINE","ENJOY","ENOUGH","ENSURE","ENTER","ENTIRE","ENTITLE","EQUALLY","EQUIP","ESCAPE","ESSAY","ESSENTIAL","ESTATE","ETHNIC","EVENT","EVERY","EXACTLY","EXAMINE","EXAMPLE","EXCEED","EXCEPT","EXCHANGE","EXCITE","EXCLUDE","EXCUSE","EXERCISE","EXIST","EXPECT","EXPENSE","EXPERIENCE","EXPERT","EXPLAIN","EXPLORE","EXPOSE","EXPRESS","EXTEND","EXTENT","EXTERNAL","EXTRA","EXTREME","FACTOR","FACULTY","FAILED","FAILURE","FAIRLY","FAITH","FAMLIAR","FAMOUS","FARMER","FASHION","FATHER","FAVOUR","FEELING","FEMALE","FIFTEEN","FIGHT","FIGURE","FINANCE","FINALLY","FINGER","FINISH","FLIGHT","FLOWER","FOLLOW","FOOTBALL","FORCE","FOREIGN","FOREST","FORGET","FORMAL","FORMER","FORWARD","FOUND","FOURTH","FRAME","FREEDOM","FRIEND","FUNCTION","FUTURE","GARDEN","GATHER","GENERAL","GENERATION","GENTLE","GLOBAL","GOLDEN","GROUND","GROWTH","GUARD","GUILTY","HANDLE","HAPPEN","HARDLY","HEALTH","HEAVILY","HEIGHT","HENCE","HOLIDAY","HORSE","HOSPITAL","HOUSE","HOWEVER","HUMAN","HUSBAND","IMPACT","IMPLY","IMPORT","IMPOSE","IMPROVE","INCLUDE","INCREASE","INDEED","INDICATE","INDIVIDUAL","INDUSTRY","INFORM","INITIAL","INJURY","INSIDE","INSIST","INSTANCE","INSTEAD","INSTITUTE","INTEND","INTEREST","INTERNAL","INVOLVE","ISLAND","ISSUE","ITSELF","JOINT","JUDGE","JUDGMENT","JUNIOR","JUSTICE","LABOUR","LANGUAGE","LARGELY","LATTER","LAUGH","LAWYER","LEADER","LEAGUE","LEARN","LEAVE","LEGAL","LENGTH","LESSON","LETTER","LEVEL","LIBERAL","LIBRARY","LICENCE","LIMIT","LIMITED","LITTLE","LOCAL","LONDON","LONGER","MACHINE","MAJOR","MANAGE","MANAGER","MANNER","MANY","MARKET","MARRIAGE","MATCH","MATERIAL","MATTER","MEASURE","MEDIA","MEDICAL","MEETING","MEMBER","MEMORY","MENTAL","MENTION","MERELY","METHOD","MIDDLE","MIGHT","MILE","MILITARY","MINISTER","MINOR","MINORITY","MINUTE","MISSION","MISTAKE","MODEL","MODERN","MODULE","MOMENT","MONEY","MONTH","MORAL","MORNING","MOTHER","MOTION","MOTOR","MOUNTAIN","MOUTH","MOVEMENT","MOVIE","MUCH","MUSIC","MYSELF","NARROW","NATION","NATIONAL","NATIVE","NATURAL","NATURE","NEARLY","NECESSary","NEEDLE","NEITHER","NERVE","NETWORK","NEVER","NEWLY","NIGHT","NOBODY","NORMAL","NORTHERN","NOTICE","NOTION","NOWHERE","NUMBER","OBJECT","OBSERVE","OBTAIN","OBVIOUS","OCCASION","OCCUR","OFFENCE","OFFER","OFFICE","OFFICER","OFFICIAL","OFTEN","ONCE","ONLINE","ONLY","ONTO","OPENING","OPERATE","OPPORTUNITY","OPPOSE","OPPOSITE","ORDER","ORDINARY","ORGANISE","ORIGIN","ORIGINAL","OTHER","OUGHT","OUTCOME","OUTSIDE","OVERALL","OWNER","PACKAGE","PAINT","PANEL","PARENT","PARISH","PARLIAMENT","PARTLY","PARTNER","PARTY","PASSAGE","PATIENT","PATTERN","PEACE","PEOPLE","PERFORM","PERHAPS","PERIOD","PERMIT","PERSON","PERSONAL","PHONE","PHOTO","PHYSICAL","PICTURE","PIECE","PLACE","PLANNING","PLANT","PLASTIC","PLAYER","POCKET","POINT","POLICE","POLICY","POLITICAL","POLLUTION","POPULAR","POSITION","POSITIVE","POSSIBLE","POSTER","POWER","PRACTICE","PREFER","PREPARE","PRESENCE","PRESENT","PRESIDENT","PRESS","PRESSURE","PRETTY","PREVIOUS","PRICE","PRIMARY","PRINCIPLE","PRINT","PRIOR","PRIORITY","PRISON","PRIVATE","PROBABLY","PROBLEM","PROCEDURE","PROCESS","PRODUCE","PRODUCT","PROFESSION","PROFILE","PROFIT","PROGRAM","PROGRESS","PROJECT","PROMISE","PROMOTE","PROPER","PROPERTY","PROPOSE","PROTECT","PROVIDE","PUBLIC","PUBLISH","PURPOSE","PUSH","QUALITY","QUARTER","QUESTION","QUICKLY","QUITE","RAISE","RANGE","RAPIDLY","RATELY","RATHER","REACH","REACTION","READER","READING","READY","REALISE","REALLY","REASON","RECALL","RECEIVE","RECENT","RECENTLY","RECOGNISE","RECORD","RECOVER","REDUCE","REFER","REFLECT","REFORM","REFUSE","REGARD","REGION","REGIONAL","REGULAR","RELATE","RELATION","RELATIVE","RELEASE","RELEVANT","RELIEF","RELIGION","REMAIN","REMEMBER","REMOVE","REPEAT","REPLACE","REPLY","REPORT","REPRESENT","REQUEST","REQUIRE","RESEARCH","RESOURCE","RESPECT","RESPOND","RESPONSE","RESULT","RETAIN","RETURN","REVEAL","REVENUE","REVIEW","REVOLUTION","RIGHT","RING","RISE","ROAD","ROLE","ROOM","ROUND","ROUTE","ROYAL","RULE","SAFETY","SALE","SAME","SAMPLE","SAVE","SCALE","SCENE","SCHEME","SCHOOL","SCIENCE","SCORE","SCREEN","SEARCH","SEASON","SECOND","SECRETARY","SECTION","SECTOR","SECURE","SEEM","SELECT","SENIOR","SENSE","SENSITIVE","SENTENCE","SEPARATE","SEQUENCE","SERIES","SERIOUS","SERVANT","SERVICE","SESSION","SETTLE","SEVEN","SEVERAL","SEVERE","SHARE","SHEET","SHOOT","SHORT","SHOT","SHOULD","SHOULDER","SHOUT","SHOW","SIDE","SIGHT","SIGN","SIGNAL","SILENCE","SIMPLE","SIMPLY","SINCE","SINGLE","SISTER","SITE","SITUATION","SIZE","SKILL","SKIN","SLEEP","SLIGHTLY","SLOWLY","SOCIAL","SOCIETY","SOLDIER","SOLUTION","SOME","SOMEHOW","SOMEONE","SOMETHING","SOMETIMES","SOMEWHAT","SOON","SORRY","SORT","SOUND","SOURCE","SOUTHERN","SPACE","SPEAK","SPECIAL","SPECIFIC","SPEECH","SPEED","SPEND","SPIRIT","SPORT","SPOT","SPREAD","SPRING","SQUARE","STAFF","STAGE","STAND","STANDARD","START","STATE","STATEMENT","STATION","STATUS","STAY","STEP","STILL","STOCK","STONE","STOP","STORE","STORY","STRAIGHT","STRANGE","STRATEGY","STREET","STRENGTH","STRESS","STRIKE","STRONG","STRUCTURE","STUDENT","STUDIO","STUDY","STYLE","SUBJECT","SUBMIT","SUCCEED","SUCCESS","SUCH","SUDDENLY","SUFFER","SUGGEST","SUMMER","SUPPORT","SUPPOSE","SURELY","SURFACE","SURVEY","SURVIVE","SWITCH","SYSTEM","TABLE","TAKE","TALK","TARGET","TASK","TEACH","TEACHER","TEAM","TECHNOLOGY","TELEPHONE","TELEVISION","TEMPERATURE","TERM","TERRIBLE","TEST","THANKS","THEATRE","THEIR","THEME","THEMSELVES","THEN","THEORY","THERE","THESE","THEY","THING","THINK","THIRD","THIRTY","THIS","THOSE","THOUGH","THOUSAND","THREAT","THREATEN","THREE","THROUGH","THROW","TICKET","TIME","TITLE","TODAY","TOGETHER","TOMORROW","TONE","TONIGHT","TOTAL","TOTALLY","TOUCH","TOUR","TOWARDS","TOWN","TRADE","TRADITION","TRAFFIC","TRAIN","TRAINING","TRANSFER","TRANSPORT","TRAVEL","TREAT","TREATMENT","TREATY","TREE","TREND","TRIAL","TRIP","TROOP","TROUBLE","TRUE","TRUST","TRUTH","TWENTY","TWICE","TYPE","UNDER","UNDERSTAND","UNION","UNIQUE","UNIT","UNITED","UNIVERSITY","UNLESS","UNLIKE","UNTIL","UPON","UPPER","URBAN","USER","USUAL","USUALLY","VALLEY","VALUE","VARIETY","VARIOUS","VEHICLE","VERSION","VERY","VIDEO","VIEW","VILLAGE","VIOLENCE","VISION","VISIT","VISITOR","VOICE","VOLUME","VOTE","WAIT","WALK","WALL","WANT","WAR","WATCH","WATER","WAY","WEALTH","WEAPON","WEAR","WEATHER","WEEK","WEEKEND","WEIGHT","WELCOME","WELL","WESTERN","WHAT","WHATEVER","WHEN","WHERE","WHETHER","WHICH","WHILE","WHITE","WHOLE","WHOM","WHOSE","WIDE","WIDELY","WIFE","WILD","WILL","WINDOW","WINE","WINTER","WISH","WITHIN","WITHOUT","WOMAN","WONDER","WOOD","WORD","WORK","WORKER","WORLD","WORRY","WORTH","WOULD","WRITE","WRITER","WRONG","YARD","YEAR","YOUNG","YOURSELF","YOUTH"];
        const prizeEmojis = [ { emoji: 'üéÅ', value: 1500000, type: 'coins' }, { emoji: 'üèÜ', value: 3500000, type: 'trophy' }, { emoji: 'üíé', value: 20000000, type: 'diamond' }, { emoji: 'üí£', value: 0, type: 'game_over' }, { emoji: 'üí£', value: 0, type: 'green_bomb' }, { emoji: '‚≠ê', value: 5000, type: 'coins' }, { emoji: '‚ö°', value: 20000, type: 'lightning' }, { emoji: '‚ùÑÔ∏è', value: 0, type: 'freeze' }, { emoji: 'üî•', value: 400, type: 'fire_column'}, { emoji: 'üí∞', value: 1000000, type: 'cash_money' } ];
        const nonsenseFreebies = ['üå≠','ü•û','üçï','üçî','üçü','üçó','ü•†','üç©', 'üç∞', 'üç≠', 'üçã‚Äçüü©', 'üßã', 'üç∑', 'üç´', '‚òï', 'üç™'];
        const puzzleLayouts = [ { length: 5, indices: [11, 12, 13, 14, 15] }, { length: 7, indices: [28, 29, 30, 31, 32, 33, 34] }, { length: 7, indices: [46, 47, 48, 49, 50, 51, 52] }, { length: 5, indices: [65, 66, 67, 68, 69] } ];
        // This is the new, exact trading table as requested.
        const trades = [
            { id: 'trade001', name: '10 üå≠ for 1 Food Truck', cost: { 'üå≠': 10 }, reward: { type: 'inventory', item: 'üöö', amount: 1 } },
            { id: 'trade002', name: '15 ü•û for 1 Diner', cost: { 'ü•û': 15 }, reward: { type: 'inventory', item: 'üèõÔ∏è', amount: 1 } },
            { id: 'trade003', name: '20 üçï for 1 Pizzeria', cost: { 'üçï': 20 }, reward: { type: 'inventory', item: 'üçï', amount: 1 } },
            { id: 'trade004', name: '25 üçî for 1 Burger Chain', cost: { 'üçî': 25 }, reward: { type: 'inventory', item: 'üçî', amount: 1 } },
            { id: 'trade005', name: '30 üçü for 1 Potato Farm', cost: { 'üçü': 30 }, reward: { type: 'inventory', item: 'ü•î', amount: 1 } },
            { id: 'trade006', name: '25 üçó for 1 Chicken Farm', cost: { 'üçó': 25 }, reward: { type: 'inventory', item: 'üêî', amount: 1 } },
            { id: 'trade007', name: '20 ü•† for 1 Chip Plant', cost: { 'ü•†': 20 }, reward: { type: 'inventory', item: 'üíæ', amount: 1 } },
            { id: 'trade008', name: '15 üç© for 1 Donut Shop', cost: { 'üç©': 15 }, reward: { type: 'inventory', item: 'üç©', amount: 1 } },
            { id: 'trade009', name: '10 üç∞ for 1 TV Show', cost: { 'üç∞': 10 }, reward: { type: 'inventory', item: 'üì∫', amount: 1 } },
            { id: 'trade010', name: '5 üç≠ for 1 Candy Vendor', cost: { 'üç≠': 5 }, reward: { type: 'inventory', item: 'üç¨', amount: 1 } },
            { id: 'trade011', name: '2 üçã‚Äçüü© for 2M Money Bags', cost: { 'üçã‚Äçüü©': 2 }, reward: { type: 'bags', amount: 2000000 } },
            { id: 'trade012', name: '1 üßã for 2K Coins', cost: { 'üßã': 1 }, reward: { type: 'coins', amount: 2000 } },
            { id: 'trade013', name: '1 üç∑ for 1 Restaurant', cost: { 'üç∑': 1 }, reward: { type: 'inventory', item: 'üç∑', amount: 1 } },
            { id: 'trade014', name: '10 üç´ for 1 Candy Factory', cost: { 'üç´': 10 }, reward: { type: 'inventory', item: 'üè≠', amount: 1 } },
            { id: 'trade015', name: '20 ‚òï for 1 Headache', cost: { '‚òï': 20 }, reward: { type: 'inventory', item: 'ü§ï', amount: 1 } },
            { id: 'trade016', name: '25 üç™ for 2 Gold Mines', cost: { 'üç™': 25 }, reward: { type: 'inventory', item: '‚õèÔ∏è', amount: 2 } }
        ];
        const inventoryItemNames = {
            'üöö': 'Food Truck', 'üèõÔ∏è': 'Diner', 'üçï': 'Pizzeria', 'üçî': 'Burger Chain',
            'ü•î': 'Potato Farm', 'üêî': 'Chicken Farm', 'üíæ': 'Chip Plant', 'üç©': 'Donut Shop',
            'üì∫': 'TV Show', 'üç¨': 'Candy Vendor', 'üç∑': 'Restaurant', 'üè≠': 'Candy Factory',
            'ü§ï': 'Headache', '‚õèÔ∏è': 'Gold Mine'
        };
        const tips = [
            "üí° Tip! The green bomb is your friend! Drag it anywhere and drop on a word to auto solve.",
            "üí° Another Tip! The green bomb has a range of 9 squares and will capture all freebies!",
            "üí° Tip! If you lose a big chunk of coins during game play, keep playing and in seconds be rich again!",
            "üí° Tip! The green checkmark is your friend to quick solve.",
            "üí° Wow! Another tip for you. Use the green checkmark to break an ice level with ease!"
        ];
        let currentTipIndex = 0;
        
        // --- Game Logic Functions ---
        function generatePuzzlesForLevel() {
            puzzles = [];
            let availableWords = [...wordBank];
            puzzleLayouts.forEach(layout => {
                const wordsOfLength = availableWords.filter(w => w.length === layout.length);
                if (wordsOfLength.length > 0) {
                    const word = wordsOfLength[Math.floor(Math.random() * wordsOfLength.length)];
                    puzzles.push({ word: word, indices: layout.indices, solved: false });
                    availableWords = availableWords.filter(w => w !== word); 
                }
            });
        }
        
        function startLevel() {
            document.getElementById('level-display').textContent = currentLevel;
            trophyCollectedThisLevel = false;
            diamondCollectedThisLevel = false;
            solveButtonClicks = 0;
            timeSinceLastSolve = 0;
            clearTimeout(diamondSequenceTimeout);
            clearTimeout(thawTimeout);
            const iconsContainer = document.getElementById('greed-icons-container');
            iconsContainer.innerHTML = '';
            generatePuzzlesForLevel();
            initializeGrid();
        }

        function initializeGrid() {
            gridContainer.innerHTML = '';
            puzzles.forEach(p => p.scrambled = shuffleWord(p.word));
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);

            for (let i = 0; i < 81; i++) {
                const tile = document.createElement('div');
                tile.classList.add('w-10', 'h-10', 'md:w-11', 'md:h-11', 'flex', 'items-center', 'justify-center', 'text-2xl', 'font-bold', 'rounded-lg', 'select-none');
                tile.id = `tile-${i}`;

                if (allPuzzleIndices.includes(i)) {
                    for (const puzzle of puzzles) {
                        if (puzzle.indices.includes(i)) {
                            const letterIndex = puzzle.indices.indexOf(i);
                            tile.textContent = puzzle.scrambled[letterIndex];
                            tile.classList.add('word-puzzle-tile');
                            tile.dataset.puzzleIndex = puzzles.indexOf(puzzle);
                            tile.draggable = true;
                            addDragListeners(tile);
                            break;
                        }
                    }
                } else if (i === 40) {
                    tile.id = 'jackpot-square';
                    tile.classList.add('bg-amber-500', 'border-2', 'border-amber-300', 'text-4xl');
                    tile.textContent = 'üí∞';
                    tile.addEventListener('click', onJackpotClick);
                } else {
                    tile.classList.add('bg-slate-900/50', 'border', 'border-slate-800/50');
                }
                gridContainer.appendChild(tile);
            }
        }

        function shuffleWord(word) {
            let array = word.split('');
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            let shuffled = array.join('');
            return shuffled === word ? shuffleWord(word) : shuffled;
        }

        function addDragListeners(tile) {
            tile.addEventListener('dragstart', handleDragStart);
            tile.addEventListener('dragover', handleDragOver);
            tile.addEventListener('drop', handleDrop);
            tile.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            if (timeRemaining <= 0) return;
            draggedTile = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
            if (draggedTile.dataset.prizeType === 'green_bomb') {
                isDraggingBomb = true;
                document.getElementById('bomb-drag-preview').style.display = 'block';
            }
        }

        function handleDragOver(e) { 
            e.preventDefault(); 
            if (isDraggingBomb) {
                const targetTile = e.target.closest('#game-grid > div');
                if (targetTile) {
                    const preview = document.getElementById('bomb-drag-preview');
                    const rect = targetTile.getBoundingClientRect();
                    const gridRect = gridContainer.getBoundingClientRect();
                    const size = rect.width;
                    preview.style.width = `${size * 3}px`;
                    preview.style.height = `${size * 3}px`;
                    preview.style.left = `${rect.left - gridRect.left - size}px`;
                    preview.style.top = `${rect.top - gridRect.top - size}px`;
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('#game-grid > div');
            if (!dropTarget) return;

            if (isDraggingBomb && draggedTile) {
                startGreenBombSequence(dropTarget);
                draggedTile.textContent = '';
                draggedTile.classList.remove('prize-tile', 'green-bomb');
                draggedTile.draggable = false;
            }
            else if (dropTarget.classList.contains('word-puzzle-tile') && 
                draggedTile && draggedTile.classList.contains('word-puzzle-tile') &&
                dropTarget.dataset.puzzleIndex === draggedTile.dataset.puzzleIndex &&
                draggedTile !== dropTarget && !dropTarget.classList.contains('solved')) {
                const tempText = draggedTile.textContent;
                draggedTile.textContent = dropTarget.textContent;
                dropTarget.textContent = tempText;
                checkAllPuzzles();
            }
        }
        
        function handleDragEnd(e) { 
            e.target.classList.remove('dragging'); 
            if (isDraggingBomb) {
                isDraggingBomb = false;
                document.getElementById('bomb-drag-preview').style.display = 'none';
            }
            draggedTile = null;
        }

        function checkAllPuzzles() {
            let allWordsOnBoardAreSolved = true;
            puzzles.forEach((puzzle) => {
                if (!puzzle.solved) {
                    let currentWord = '';
                    puzzle.indices.forEach(index => { currentWord += document.getElementById(`tile-${index}`).textContent; });
                    if (currentWord === puzzle.word) {
                        puzzle.solved = true;
                        timeSinceLastSolve = 0;
                        coins += 10000;
                        updateScoreDisplay();
                        flashScore('gain');
                        const middleTileIndex = puzzle.indices[Math.floor(puzzle.indices.length / 2)];
                        const startTile = document.getElementById(`tile-${middleTileIndex}`);
                        if (!isFrozen) {
                            triggerCoinAnimation(startTile, document.getElementById('coins-display'));
                        }
                        puzzle.indices.forEach(index => {
                            const tile = document.getElementById(`tile-${index}`);
                            tile.classList.add('solved');
                            tile.draggable = false;
                        });
                    } else {
                        allWordsOnBoardAreSolved = false;
                    }
                }
            });

            if (allWordsOnBoardAreSolved && puzzles.length > 0) {
                if (isFrozen) endFreeze();
                coins += 100000;
                updateScoreDisplay();
                flashScore('gain');
                showEventText("Level Up!");
                flashLevelPanel();
                currentLevel++;
                setTimeout(() => startLevel(), 1500);
            }
        }

        function formatScore(num) {
            if (num < 1000) return num.toString();
            const si = [
                { value: 1E12, symbol: "T" }, { value: 1E9, symbol: "B" },
                { value: 1E6, symbol: "M" }, { value: 1E3, symbol: "K" }
            ];
            const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
            for (let i = 0; i < si.length; i++) {
                if (num >= si[i].value) {
                    return (num / si[i].value).toFixed(1).replace(rx, "$1") + si[i].symbol;
                }
            }
            return num.toLocaleString();
        }

        function updateScoreDisplay() {
            bagsOfMoney = Math.floor(coins * 0.01);
            document.getElementById('coins-display').textContent = coins.toLocaleString();
            document.getElementById('bags-of-money-display').textContent = bagsOfMoney.toLocaleString();
            document.getElementById('coins-display').classList.remove('score-decay');
        }

        function flashScore(type = 'gain') {
            const coinsDisplay = document.getElementById('coins-display');
            const flashClass = type === 'gain' ? 'gain-flash' : 'deduct-flash';
            coinsDisplay.classList.remove('gain-flash', 'deduct-flash');
            void coinsDisplay.offsetWidth;
            coinsDisplay.classList.add(flashClass);
            setTimeout(() => { coinsDisplay.classList.remove(flashClass); }, 800);
        }

        function flashBagsPanel() {
            const bagsDisplay = document.getElementById('bags-of-money-display');
            bagsDisplay.classList.add('deduct-flash');
            setTimeout(() => { bagsDisplay.classList.remove('deduct-flash'); }, 1200);
        }

        function flashLevelPanel() {
            const levelDisplay = document.getElementById('level-display');
            levelDisplay.classList.add('level-flash');
            setTimeout(() => { levelDisplay.classList.remove('level-flash'); }, 1500);
        }
        
        function updateTimer() {
            if (timeRemaining > 0 && !isGamePaused) {
                timeRemaining--;
                timeSinceLastSolve++;
                const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
                const seconds = (timeRemaining % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${minutes}:${seconds}`;

                if (timeRemaining === 580 && !specialCashEmojiSpawned) {
                    specialCashEmojiSpawned = true;
                    spawnSpecialCashEmoji();
                }
                if (timeRemaining === 360 && timedEvents.sixMin) {
                    timedEvents.sixMin = false;
                    spawnImp();
                }
                if (timeRemaining === 180 && timedEvents.threeMin) {
                    timedEvents.threeMin = false;
                    spawnImp();
                }
                if (timeRemaining === 300 && jackpotEventAvailable) {
                    jackpotEventAvailable = false;
                    activateSpecialJackpot();
                }
                if (timeRemaining === 480 && timedEvents.heartEvent1) {
                    timedEvents.heartEvent1 = false;
                    spawnHeartAnimation();
                }
                if (timeRemaining === 120 && timedEvents.heartEvent2) {
                    timedEvents.heartEvent2 = false;
                    spawnHeartAnimation();
                }
            } else if (timeRemaining <= 0) {
                endGame();
            }
        }
        
        function activateSpecialJackpot() {
            const jackpotSquare = document.getElementById('jackpot-square');
            jackpotSquare.classList.add('wild-pulse');
            const specialJackpotHandler = () => {
                GJACKVARNUM = 0;
                coins += 50000000;
                updateScoreDisplay();
                flashScore('gain');
                showEventText('üí∞ 50,000,000 üí∞');
                
                jackpotSquare.classList.remove('wild-pulse');
                clearTimeout(specialJackpotTimeout);
                jackpotSquare.removeEventListener('click', specialJackpotHandler);
            };
            jackpotSquare.addEventListener('click', specialJackpotHandler);
            specialJackpotTimeout = setTimeout(() => {
                jackpotSquare.classList.remove('wild-pulse');
                jackpotSquare.removeEventListener('click', specialJackpotHandler);
            }, 15000);
        }

        function triggerCoinAnimation(startElement, endElement) {
            const startRect = startElement.getBoundingClientRect();
            const endRect = endElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const controlX = startX + (endX - startX) / 2;
            const controlY = startY - 100;
            const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;

            for (let i = 0; i < 15; i++) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                coin.style.animation = `fly-along-path 0.8s cubic-bezier(0.4, 0, 0.9, 0.5) forwards`;
                coin.style.offsetPath = `path('${curve}')`;
                coin.style.animationDelay = `${Math.random() * 0.3}s`;
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 1100);
            }
        }

        function triggerBigCoinAnimation(startElement, endElement) {
            const startRect = startElement.getBoundingClientRect();
            const endRect = endElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const controlX = startX + (endX - startX) / 2;
            const controlY = startY - 100;
            const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;
            
            const coin = document.createElement('div');
            coin.classList.add('coin');
            coin.style.animation = `big-coin-tumble 0.8s ease-out forwards, fly-along-path 0.8s ease-out forwards`;
            coin.style.offsetPath = `path('${curve}')`;
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 800);
        }

        function triggerCoinImplosion(originElement) {
            const originRect = originElement.getBoundingClientRect();
            const endRect = document.getElementById('coins-display').getBoundingClientRect();
            const centerX = originRect.left + originRect.width / 2;
            const centerY = originRect.top + originRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const startRadius = 100;

            for (let i = 0; i < 20; i++) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                const angle = (i / 20) * (2 * Math.PI);
                const startX = centerX + Math.cos(angle) * startRadius;
                const startY = centerY + Math.sin(angle) * startRadius;
                const controlX = startX + (endX - startX) / 2 + (Math.random() - 0.5) * 200;
                const controlY = startY + (endY - startY) / 2 + (Math.random() - 0.5) * 200;
                const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;
                coin.style.offsetPath = `path('${curve}')`;
                coin.style.animation = `coin-swirl-in 1s cubic-bezier(0.5, 0, 0.9, 0.5) forwards`;
                coin.style.animationDelay = `${Math.random() * 0.3}s`;
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 1300);
            }
        }

        function onSolveButtonClick() {
            if (timeRemaining <= 0 || solveButtonCooldown > 0) return;
            GJACKVARNUM = 0;

            const unsolvedPuzzles = puzzles.filter(p => !p.solved);
            if (unsolvedPuzzles.length === 0) return;

            const solveButton = document.getElementById('solve-button');
            solveButton.classList.remove('big-pulse');
            timeSinceLastSolve = 0;
            solveButtonClicks++;
            triggerCoinImplosion(document.getElementById('solve-button'));
            coins -= 200000;
            updateScoreDisplay();
            flashScore('deduct');

            const puzzleToSolve = unsolvedPuzzles[Math.floor(Math.random() * unsolvedPuzzles.length)];
            puzzleToSolve.indices.forEach((tileIndex, letterIndex) => {
                document.getElementById(`tile-${tileIndex}`).textContent = puzzleToSolve.word[letterIndex];
            });
            checkAllPuzzles();

            if (solveButtonClicks >= 4) {
                startSolveButtonCooldown();
            }
        }

        function startSolveButtonCooldown() {
            solveButtonCooldown = 60;
            const solveButton = document.getElementById('solve-button');
            solveButton.disabled = true;
            solveButton.classList.remove('text-3xl');
            solveButton.classList.add('cooldown-timer');
            
            solveButtonTimerInterval = setInterval(() => {
                if (solveButtonCooldown > 0) {
                    solveButtonCooldown--;
                    solveButton.textContent = `0:${solveButtonCooldown.toString().padStart(2, '0')}`;
                } else {
                    clearInterval(solveButtonTimerInterval);
                    solveButton.textContent = '‚úÖ';
                    solveButton.classList.remove('cooldown-timer');
                    solveButton.classList.add('text-3xl');
                    solveButton.disabled = false;
                    solveButtonClicks = 0;
                }
            }, 1000);
        }

        let GJACKVARNUM = 0;
        function onJackpotClick(event) {
            const jackpotSquare = event.currentTarget;
            if (jackpotSquare.classList.contains('cooldown') || jackpotSquare.classList.contains('wild-pulse')) return;

            timeSinceLastSolve = 0;
            GJACKVARNUM++;
            coins += 50000;
            updateScoreDisplay();
            flashScore('gain');
            triggerCoinAnimation(jackpotSquare, document.getElementById('coins-display'));

            if (GJACKVARNUM === 4) {
                showEventText("Yep! You're Greedy!");
            } else if (GJACKVARNUM === 8) {
                showEventText("Get outta here!");
            } else if (GJACKVARNUM >= 12) {
                coins = Math.floor(coins / 2);
                updateScoreDisplay();
                flashScore('deduct');
                flashBagsPanel();
                GJACKVARNUM = 0;
                jackpotSquare.classList.add('cooldown');
                setTimeout(() => {
                    jackpotSquare.classList.remove('cooldown');
                }, 15000);
            }
        }

        function scheduleNextPrizeSpawn() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen || isSpecialAnimationActive) return;
            
            const timeElapsed = totalGameTime - timeRemaining;
            const progress = timeElapsed / totalGameTime;
            const maxDelay = 2500;
            const minDelay = 100;
            const currentDelay = minDelay + (maxDelay - minDelay) * Math.pow(1 - progress, 3);

            prizeSpawnerTimeout = setTimeout(() => {
                if (levelGoodies.length > 0 && Math.random() < 0.1) { // 10% chance for a goodie
                    spawnSpecialGoodie();
                } else {
                    spawnPrizeEmoji();
                }
                scheduleNextPrizeSpawn();
            }, currentDelay);
        }

        function spawnSpecialGoodie() {
            if (isGamePaused || isGameOver || levelGoodies.length === 0) return;

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) {
                        emptyTiles.push(tile);
                    }
                }
            }
            if (emptyTiles.length === 0) return;
            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            
            // Clean the tile before use
            const newTile = tile.cloneNode(false);
            tile.parentNode.replaceChild(newTile, tile);

            const goodieIndex = Math.floor(Math.random() * levelGoodies.length);
            const goodieEmoji = levelGoodies.splice(goodieIndex, 1)[0];

            newTile.textContent = goodieEmoji;
            newTile.classList.add('prize-tile', 'cash-money-prize');

            const clickHandler = () => {
                // Immediately neutralize the tile to prevent race conditions
                newTile.textContent = '';
                newTile.classList.remove('prize-tile', 'cash-money-prize');
                clearTimeout(despawnTimer);

                // Then, perform game logic
                coins += 1000000;
                updateScoreDisplay();
                flashScore('gain');
                triggerCoinAnimation(newTile, document.getElementById('coins-display'));

                if (!playerData.nonsenseFreebiesCollected[goodieEmoji]) {
                    playerData.nonsenseFreebiesCollected[goodieEmoji] = 0;
                }
                playerData.nonsenseFreebiesCollected[goodieEmoji]++;
                savePlayerProfile();
            };

            const despawnTimer = setTimeout(() => {
                levelGoodies.push(goodieEmoji);
                newTile.textContent = '';
                newTile.classList.remove('prize-tile', 'cash-money-prize');
                newTile.removeEventListener('click', clickHandler);
            }, 8000);

            newTile.addEventListener('click', clickHandler, { once: true });
        }

        function spawnPrizeEmoji() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen) return;

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) {
                        emptyTiles.push(tile);
                    }
                }
            }
            if (emptyTiles.length === 0) return;

            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            
            // Clean the tile before use
            const newTile = tile.cloneNode(false);
            tile.parentNode.replaceChild(newTile, tile);
            
            let prizePool = prizeEmojis.filter(p => p.type !== 'cash_money');
            if (timeRemaining > 580) {
                prizePool = prizePool.filter(p => p.type !== 'freeze' && p.type !== 'game_over' && p.type !== 'green_bomb');
            }
            const prize = prizePool[Math.floor(Math.random() * prizePool.length)];

            newTile.textContent = prize.emoji;
            newTile.dataset.prizeValue = prize.value;
            newTile.dataset.prizeType = prize.type;
            newTile.classList.add('prize-tile');
            if (prize.type === 'game_over') newTile.classList.add('red-bomb');
            else if (prize.type === 'green_bomb') {
                newTile.classList.add('green-bomb');
                newTile.draggable = true;
                addDragListeners(newTile);
            }
            else if (prize.type === 'fire_column') newTile.classList.add('fire-bomb');
            
            const clickHandler = () => {
                GJACKVARNUM = 0;
                timeSinceLastSolve = 0;
                
                // Immediately clear the despawn timer
                clearTimeout(despawnTimer);

                if (newTile.dataset.prizeType === 'game_over') { 
                    endGame(true); 
                } 
                else if (newTile.dataset.prizeType === 'diamond') { startDiamondSequence(newTile); } 
                else if (newTile.dataset.prizeType === 'green_bomb') { startGreenBombSequence(newTile); }
                else if (newTile.dataset.prizeType === 'fire_column') { startFireColumnSequence(newTile); }
                else if (newTile.dataset.prizeType === 'freeze') { startFreezeSequence(); }
                else if (newTile.dataset.prizeType === 'lightning') {
                    coins = 0;
                    coins += parseInt(newTile.dataset.prizeValue);
                    updateScoreDisplay();
                    flashBagsPanel();
                    triggerCoinAnimation(newTile, document.getElementById('coins-display'));
                }
                else {
                    coins += parseInt(newTile.dataset.prizeValue);
                    updateScoreDisplay();
                    flashScore('gain');
                    triggerCoinAnimation(newTile, document.getElementById('coins-display'));
                    if (newTile.dataset.prizeType === 'trophy' && !trophyCollectedThisLevel) {
                        trophyCollectedThisLevel = true;
                        updateGreedPanelWithTrophy();
                        showEventText("Oh Yeah!");
                    }
                }
                // Clean up the tile after processing, unless it's a dragged bomb
                if (newTile.dataset.prizeType !== 'green_bomb' || !isDraggingBomb) {
                    newTile.textContent = '';
                    newTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            };

            const despawnTimer = setTimeout(() => {
                newTile.textContent = '';
                newTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                newTile.removeEventListener('click', clickHandler);
            }, 5000);

            newTile.addEventListener('click', clickHandler, { once: true });
        }

        function spawnSpecialCashEmoji() {
             if (isGamePaused || isGameOver || isFrozen) return;
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;
            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            const prize = prizeEmojis.find(p => p.type === 'cash_money');
            tile.textContent = prize.emoji;
            tile.dataset.prizeValue = prize.value;
            tile.dataset.prizeType = prize.type;
            tile.classList.add('prize-tile', 'cash-money-prize');
            
            const clickHandler = () => {
                GJACKVARNUM = 0;
                coins += parseInt(tile.dataset.prizeValue);
                updateScoreDisplay();
                flashScore('gain');
                showEventText('üí∞ 1,000,000 üí∞', true);
                tile.textContent = '';
                tile.classList.remove('prize-tile', 'cash-money-prize');
            };
            tile.addEventListener('click', clickHandler, { once: true });
        }

        function spawnImp() {
            if (isGamePaused || isGameOver || isFrozen) return;
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;
            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            tile.innerHTML = `<div class="w-full h-full flex items-center justify-center prize-tile red-bomb">üòà</div>`;
            const impElement = tile.firstChild;

            const clickHandler = () => {
                GJACKVARNUM = 0;
                coins = 0;
                updateScoreDisplay();
                showEventText("Ha ha!");
                tile.innerHTML = '';
                tile.classList.remove('prize-tile', 'red-bomb');
                clearTimeout(despawnTimer);
            };

            const despawnTimer = setTimeout(() => {
                tile.innerHTML = '';
                tile.classList.remove('prize-tile', 'red-bomb');
                impElement.removeEventListener('click', clickHandler, { once: true });
            }, 10000);
            impElement.addEventListener('click', clickHandler, { once: true });
        }

        function updateGreedPanelWithTrophy() {
            const iconsContainer = document.getElementById('greed-icons-container');
            const trophyElement = document.createElement('div');
            trophyElement.classList.add('greed-icon');
            trophyElement.textContent = 'üèÜ';
            trophyElement.addEventListener('click', () => {
                showEventText("You're so greedy!");
            });
            iconsContainer.appendChild(trophyElement);
        }
        
        function updateGreedPanelWithDiamond() {
            if (diamondCollectedThisLevel) return;
            diamondCollectedThisLevel = true;
            const iconsContainer = document.getElementById('greed-icons-container');
            const diamondElement = document.createElement('div');
            diamondElement.classList.add('greed-icon');
            diamondElement.textContent = 'üíé';
            diamondElement.addEventListener('click', () => {
                showEventText("You're so greedy!");
            });
            iconsContainer.appendChild(diamondElement);
        }

        function showEventText(text, greenGlow = false, longFlash = false) {
            if (isGamePaused && !longFlash) return;
            const eventTextContainer = document.getElementById('event-text-container');
            const eventText = document.getElementById('event-text');
            eventText.innerHTML = text;
            eventText.classList.toggle('green-glow', greenGlow);
            eventText.classList.toggle('long-flash', longFlash);
            
            eventTextContainer.classList.remove('hidden');
            const duration = longFlash ? 4000 : 2000;
            setTimeout(() => {
                eventTextContainer.classList.add('hidden');
                eventText.classList.remove('green-glow', 'long-flash');
            }, duration);
        }

        function startDiamondSequence(clickedTile) {
            isSpecialAnimationActive = true;
            coins += currentDiamondValue;
            updateScoreDisplay();
            flashScore('gain');
            showEventText("You're Greedy!");
            currentDiamondValue = Math.floor(currentDiamondValue / 2);
            updateGreedPanelWithDiamond();

            document.querySelectorAll('.prize-tile').forEach(t => {
                if (t !== clickedTile) { 
                    t.textContent = ''; 
                    t.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const diamondTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if(tile) {
                        tile.textContent = 'üíé';
                        tile.classList.add('temp-diamond');
                        diamondTiles.push(tile);
                    }
                }
            }

            diamondSequenceTimeout = setTimeout(() => {
                triggerVortexAnimation(diamondTiles);
            }, 2000);
        }

        function triggerVortexAnimation(diamondTiles) {
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            diamondTiles.forEach(tile => {
                if (!tile || !document.body.contains(tile)) return;
                const startRect = tile.getBoundingClientRect();
                const startX = startRect.left;
                const startY = startRect.top;

                const flyingDiamond = document.createElement('div');
                flyingDiamond.textContent = 'üíé';
                flyingDiamond.classList.add('temp-diamond');
                flyingDiamond.style.position = 'absolute';
                flyingDiamond.style.left = `${startX}px`;
                flyingDiamond.style.top = `${startY}px`;
                flyingDiamond.style.zIndex = '200';
                flyingDiamond.style.setProperty('--start-x', `0px`);
                flyingDiamond.style.setProperty('--start-y', `0px`);
                flyingDiamond.style.setProperty('--end-x', `${endX - startX}px`);
                flyingDiamond.style.setProperty('--end-y', `${endY - startY}px`);
                flyingDiamond.style.animation = `diamond-vortex 1s ease-in forwards`;
                document.body.appendChild(flyingDiamond);

                tile.textContent = '';
                tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                setTimeout(() => { flyingDiamond.remove(); }, 1000);
            });

            setTimeout(() => {
                 isSpecialAnimationActive = false;
                 scheduleNextPrizeSpawn();
            }, 1500);
        }
        
        function getAdjacentIndices(index) {
            const indices = [];
            const row = Math.floor(index / 9);
            const col = index % 9;
            for (let r = -1; r <= 1; r++) {
                for (let c = -1; c <= 1; c++) {
                    const newRow = row + r;
                    const newCol = col + c;
                    if (newRow >= 0 && newRow < 9 && newCol >= 0 && newCol < 9) {
                        indices.push(newRow * 9 + newCol);
                    }
                }
            }
            return indices;
        }

        function startGreenBombSequence(bombTile) {
            playerData.greenBombsUsed++; // Increment badge counter
            const bombIndex = parseInt(bombTile.id.split('-')[1]);
            const adjacentIndices = getAdjacentIndices(bombIndex);
            
            adjacentIndices.forEach(index => {
                const adjTile = document.getElementById(`tile-${index}`);
                if (adjTile) {
                    if (adjTile.classList.contains('prize-tile')) {
                        const prizeValue = parseInt(adjTile.dataset.prizeValue) || 0;
                        if (prizeValue > 0) {
                            coins += prizeValue;
                            triggerCoinAnimation(adjTile, document.getElementById('coins-display'));
                        }
                        if (adjTile.classList.contains('cash-money-prize')) {
                            const goodieEmoji = adjTile.textContent;
                            if (!playerData.nonsenseFreebiesCollected[goodieEmoji]) {
                                playerData.nonsenseFreebiesCollected[goodieEmoji] = 0;
                            }
                            playerData.nonsenseFreebiesCollected[goodieEmoji]++;
                        }
                        adjTile.textContent = '';
                        adjTile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                    } else if (adjTile.classList.contains('word-puzzle-tile') && !adjTile.classList.contains('solved')) {
                        const puzzleIndex = parseInt(adjTile.dataset.puzzleIndex);
                        const puzzle = puzzles[puzzleIndex];
                        const letterIndex = puzzle.indices.indexOf(index);
                        const correctLetter = puzzle.word[letterIndex];
                        
                        for (const i of puzzle.indices) {
                            const sourceTile = document.getElementById(`tile-${i}`);
                            if (sourceTile && sourceTile.textContent === correctLetter) {
                                const tempText = adjTile.textContent;
                                adjTile.textContent = sourceTile.textContent;
                                sourceTile.textContent = tempText;
                                break;
                            }
                        }
                        coins += 1;
                        triggerBigCoinAnimation(adjTile, document.getElementById('coins-display'));
                    }
                }
            });
            setTimeout(() => {
                updateScoreDisplay();
                checkAllPuzzles();
                savePlayerProfile(); // Save after using the bomb
            }, 100);
        }

        function startFireColumnSequence(fireTile) {
            const fireIndex = parseInt(fireTile.id.split('-')[1]);
            const column = fireIndex % 9;
            let collectedFromColumn = 0;

            for (let i = column; i < 81; i += 9) {
                const tileInColumn = document.getElementById(`tile-${i}`);
                if (tileInColumn && tileInColumn !== fireTile) { 
                    if (tileInColumn.classList.contains('prize-tile')) {
                        const prizeValue = parseInt(tileInColumn.dataset.prizeValue) || 0;
                        if (prizeValue > 0) {
                            collectedFromColumn += prizeValue;
                            triggerCoinAnimation(tileInColumn, document.getElementById('coins-display'));
                        }
                        tileInColumn.textContent = '';
                        tileInColumn.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';

                    } else if (tileInColumn.classList.contains('word-puzzle-tile') && !tileInColumn.classList.contains('solved')) {
                        const puzzleIndex = parseInt(tileInColumn.dataset.puzzleIndex);
                        const puzzle = puzzles[puzzleIndex];
                        const letterIndex = puzzle.indices.indexOf(i);
                        const correctLetter = puzzle.word[letterIndex];
                        
                        if (tileInColumn.textContent !== correctLetter) {
                            for (const sourceIndex of puzzle.indices) {
                                const sourceTile = document.getElementById(`tile-${sourceIndex}`);
                                if (sourceTile && sourceTile.textContent === correctLetter) {
                                    const tempText = tileInColumn.textContent;
                                    tileInColumn.textContent = sourceTile.textContent;
                                    sourceTile.textContent = tempText;
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            const fireBombValue = parseInt(fireTile.dataset.prizeValue) || 400;
            coins += fireBombValue + collectedFromColumn;
            
            updateScoreDisplay();
            flashScore('gain');
            checkAllPuzzles();
        }

        function endGame(isBomb = false) {
            isGameOver = true;
            saveGameResult(); // This now increments gamesPlayed
            checkAndAwardBadges(coins); // Check for new badges at the end of the game
            clearInterval(mainTimerInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(diamondSequenceTimeout);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            endFreeze(); // Ensure freeze effect is cleared
            endHeartAnimation(); // Ensure heart effect is cleared
            clearInterval(solveButtonPulseManager);
            timeRemaining = 0;
            document.getElementById('timer-display').textContent = "00:00";
            triggerSwirlAnimation();
            setTimeout(showGameOverModal, 1500);
        }

        function triggerSwirlAnimation() {
            const elementsToSwirl = document.querySelectorAll('#game-grid > div');
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            elementsToSwirl.forEach(el => {
                if (el.textContent) {
                    const startRect = el.getBoundingClientRect();
                    const startX = startRect.left;
                    const startY = startRect.top;
                    const flyingEl = el.cloneNode(true);
                    flyingEl.style.position = 'absolute';
                    flyingEl.style.left = `${startX}px`;
                    flyingEl.style.top = `${startY}px`;
                    flyingEl.style.zIndex = '200';
                    flyingEl.style.margin = '0';
                    flyingEl.style.setProperty('--start-x', `0px`);
                    flyingEl.style.setProperty('--start-y', `0px`);
                    flyingEl.style.setProperty('--end-x', `${endX - startX}px`);
                    flyingEl.style.setProperty('--end-y', `${endY - startY}px`);
                    flyingEl.style.animation = `game-over-swirl 1.5s ease-in forwards`;
                    document.body.appendChild(flyingEl);
                    el.textContent = '';
                    el.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });
        }

        function showGameOverModal() {
            document.getElementById('final-coins-display').textContent = coins.toLocaleString();
            document.getElementById('final-bags-display').textContent = bagsOfMoney.toLocaleString();
            const gameOverModal = document.getElementById('game-over-modal');
            gameOverModal.classList.remove('hidden');

            const animationContainer = document.body;

            gameOverAnimationInterval = setInterval(() => { 
                const animations = ['ü™ô', '‚ùÑÔ∏è', 'üíù'];
                const animationChar = animations[Math.floor(Math.random() * animations.length)];
                
                const el = document.createElement('div');
                el.textContent = animationChar;
                el.style.left = `${Math.random() * 100}%`;
                el.style.animationDuration = `${Math.random() * 2 + 3}s`;
                el.style.fontSize = `${Math.random() * 1 + 0.5}rem`;
                el.style.position = 'fixed';
                el.style.top = '-5%';
                el.style.zIndex = '100';

                if (animationChar === 'ü™ô') el.classList.add('falling-coin');
                else if (animationChar === '‚ùÑÔ∏è') el.classList.add('falling-snowflake');
                else if (animationChar === 'üíù') el.classList.add('falling-heart');

                animationContainer.appendChild(el);
                setTimeout(() => el.remove(), 5000);

            }, 200);
        }
        
        function pauseGame() {
            isGamePaused = true;
            clearInterval(mainTimerInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            document.querySelectorAll('.ice-block').forEach(block => block.style.display = 'none');
        }

        function resumeGame() {
            if (isGameOver) return;
            isGamePaused = false;
            mainTimerInterval = setInterval(updateTimer, 1000);
            if (!isFrozen) {
                scheduleNextPrizeSpawn();
            }
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
            if (isFrozen) {
                document.querySelectorAll('.ice-block').forEach(block => block.style.display = 'block');
            }
        }

        function handleScoreDecay() {
            if (isGamePaused || isGameOver) return;
            if (timeSinceLastSolve > 20) {
                const decayAmount = Math.floor(Math.pow(timeSinceLastSolve - 19, 1.5) * 10);
                coins -= decayAmount;
                if (coins < 0) coins = 0;
                updateScoreDisplay();
                document.getElementById('coins-display').classList.add('score-decay');
            } else {
                document.getElementById('coins-display').classList.remove('score-decay');
            }
        }

        function startFreezeSequence() {
            isFrozen = true;
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(impTimeout);
            
            // Clear any existing freeze animation before starting a new one
            clearInterval(freezeAnimationInterval);

            freezeAnimationInterval = setInterval(() => {
                const snowflake = document.createElement('div');
                snowflake.classList.add('falling-snowflake');
                snowflake.textContent = '‚ùÑÔ∏è';
                snowflake.style.left = `${Math.random() * 100}%`;
                snowflake.style.animationDuration = `${Math.random() * 3 + 4}s`;
                snowflake.style.fontSize = `${Math.random() * 1 + 0.75}rem`;
                document.body.appendChild(snowflake);
                setTimeout(() => snowflake.remove(), 7000);
            }, 200);

            const frozenTiles = [];
            document.querySelectorAll('#game-grid > div:not(.word-puzzle-tile)').forEach(tile => {
                const rect = tile.getBoundingClientRect();
                const iceBlock = document.createElement('div');
                iceBlock.className = 'ice-block';
                iceBlock.style.width = `${rect.width}px`;
                iceBlock.style.height = `${rect.height}px`;
                iceBlock.style.left = `${rect.left}px`;
                iceBlock.style.top = `${rect.top}px`;
                document.body.appendChild(iceBlock);
                frozenTiles.push(iceBlock);
            });

            thawTimeout = setTimeout(() => {
                const thawDuration = 15000;
                if (frozenTiles.length === 0) {
                    endFreeze();
                    return;
                }
                const thawIntervalTime = thawDuration / frozenTiles.length;
                
                function thawNext() {
                    if (frozenTiles.length > 0) {
                        const tileToThaw = frozenTiles.shift();
                        if (tileToThaw) {
                            tileToThaw.remove();
                        }
                        setTimeout(thawNext, thawIntervalTime);
                    } else {
                        endFreeze();
                    }
                }
                thawNext();
            }, 15000);
        }

        function endFreeze() {
            clearInterval(freezeAnimationInterval);
            freezeAnimationInterval = null;
            clearTimeout(thawTimeout);
            isFrozen = false;
            document.querySelectorAll('.ice-block').forEach(block => block.remove());
            if (!isGamePaused && !isGameOver) {
                setTimeout(() => scheduleNextPrizeSpawn(), 500);
            }
        }
        
        function spawnHeartAnimation() {
            if (heartAnimationInterval) return; // Don't start if already running
            heartAnimationInterval = setInterval(() => {
                const heart = document.createElement('div');
                heart.classList.add('falling-heart');
                heart.textContent = 'üíù';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.animationDuration = `${Math.random() * 4 + 5}s`;
                heart.style.fontSize = `${Math.random() * 1 + 0.75}rem`;
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 9000);
            }, 500);
            setTimeout(endHeartAnimation, 8000); // Let it run for 8 seconds
        }

        function endHeartAnimation() {
            clearInterval(heartAnimationInterval);
            heartAnimationInterval = null;
        }

        function startGame() {
            musicPlayer.muted = true;
            playTrack(currentTrackIndex);
            musicPlayer.play().catch(e => console.error("Audio play failed on initial click:", e));

            const todayStr = new Date().toISOString().split('T')[0];
            if (playerData.lastLoginDate !== todayStr) {
                showWelcomeBonus();
            } else {
                actuallyStartGame();
            }
        }

        function actuallyStartGame() {
            musicPlayer.muted = false;
            musicPlayer.volume = lastVolume;
            document.getElementById('volume-slider').value = lastVolume;
            updateVolumeIcon(lastVolume);
            
            document.getElementById('start-modal').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('game-container').classList.add('flex');
            clearInterval(startModalAnimationInterval);
            isGamePaused = false;
            mainTimerInterval = setInterval(updateTimer, 1000);
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
            scheduleNextPrizeSpawn();
            clearInterval(solveButtonPulseManager); 
            solveButtonPulseManager = setInterval(() => {
                if (isGamePaused || isGameOver) return;
                const solveButton = document.getElementById('solve-button');
                const unsolvedPuzzles = puzzles.filter(p => !p.solved);
                if (unsolvedPuzzles.length > 0 && timeSinceLastSolve >= 30) {
                    solveButton.classList.add('big-pulse');
                    setTimeout(() => {
                        solveButton.classList.remove('big-pulse');
                    }, 10000);
                    timeSinceLastSolve = 0;
                }
            }, 1000);
        }

        function restartGame() {
            clearInterval(gameOverAnimationInterval);
            gameOverAnimationInterval = null;
            document.getElementById('game-over-modal').classList.add('hidden');
            coins = 0;
            bagsOfMoney = 0;
            currentLevel = 1;
            timeRemaining = totalGameTime;
            isGameOver = false;
            isGamePaused = false;
            trophyCollectedThisLevel = false;
            diamondCollectedThisLevel = false;
            currentDiamondValue = 20000000;
            solveButtonClicks = 0;
            solveButtonCooldown = 0;
            timeSinceLastSolve = 0;
            isFrozen = false;
            jackpotEventAvailable = true;
            specialCashEmojiSpawned = false;
            timedEvents = { sixMin: true, threeMin: true, heartEvent1: true, heartEvent2: true };
            isSpecialAnimationActive = false;
            
            clearInterval(mainTimerInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(diamondSequenceTimeout);
            clearInterval(solveButtonTimerInterval);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            clearTimeout(thawTimeout);
            clearInterval(solveButtonPulseManager);
            endFreeze();
            endHeartAnimation();

            levelGoodies = [...nonsenseFreebies];
            document.getElementById('timer-display').textContent = "10:00";
            const solveButton = document.getElementById('solve-button');
            solveButton.textContent = '‚úÖ';
            solveButton.classList.remove('cooldown-timer', 'big-pulse');
            solveButton.classList.add('text-3xl');
            solveButton.disabled = false;
            updateScoreDisplay();
            startLevel(); 
            mainTimerInterval = setInterval(updateTimer, 1000);
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
            scheduleNextPrizeSpawn();
            
            solveButtonPulseManager = setInterval(() => {
                if (isGamePaused || isGameOver) return;
                const solveButton = document.getElementById('solve-button');
                const unsolvedPuzzles = puzzles.filter(p => !p.solved);
                if (unsolvedPuzzles.length > 0 && timeSinceLastSolve >= 30) {
                    solveButton.classList.add('big-pulse');
                    setTimeout(() => {
                        solveButton.classList.remove('big-pulse');
                    }, 10000);
                    timeSinceLastSolve = 0;
                }
            }, 1000);
        }

        function playNextTrack() {
            if (userPlaylist.length === 0) return;
            const nextIndex = (currentTrackIndex + 1) % userPlaylist.length;
            playTrack(nextIndex);
        }

        function playPreviousTrack() {
            if (userPlaylist.length === 0) return;
            const prevIndex = (currentTrackIndex - 1 + userPlaylist.length) % userPlaylist.length;
            playTrack(prevIndex);
        }

        function playTrack(index) {
            if (userPlaylist.length === 0 || index < 0 || index >= userPlaylist.length) return;
            currentTrackIndex = index;
            const trackName = userPlaylist[currentTrackIndex];
            musicPlayer.src = musicBaseURL + trackName;
            
            const playPromise = musicPlayer.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    updateNowPlayingIndicator();
                }).catch(error => {
                    if (error.name !== 'AbortError') {
                         console.error("Audio play failed for " + trackName + ":", error);
                    }
                });
            }
        }
        
        function setupAudioControls() {
            const volumeSlider = document.getElementById('volume-slider');
            const volumeToggleButton = document.getElementById('volume-toggle-button');
            const playlistPlayPauseBtn = document.getElementById('playlist-play-pause');
            const playlistNextBtn = document.getElementById('playlist-next');
            const playlistPrevBtn = document.getElementById('playlist-prev');
            const playlistShuffleBtn = document.getElementById('playlist-shuffle');

            volumeSlider.value = lastVolume;
            updateVolumeIcon(musicPlayer.volume);

            volumeSlider.addEventListener('input', (e) => {
                const newVolume = parseFloat(e.target.value);
                musicPlayer.volume = newVolume;
                updateVolumeIcon(newVolume);
                if (newVolume > 0) {
                    lastVolume = newVolume;
                }
            });

            volumeToggleButton.addEventListener('click', () => {
                if (musicPlayer.volume > 0) {
                    musicPlayer.volume = 0;
                    volumeSlider.value = 0;
                    updateVolumeIcon(0);
                } else {
                    musicPlayer.volume = lastVolume;
                    volumeSlider.value = lastVolume;
                    updateVolumeIcon(lastVolume);
                }
            });

            playlistPlayPauseBtn.addEventListener('click', () => {
                if (musicPlayer.paused) {
                    musicPlayer.play();
                } else {
                    musicPlayer.pause();
                }
            });
            playlistNextBtn.addEventListener('click', playNextTrack);
            playlistPrevBtn.addEventListener('click', playPreviousTrack);
            playlistShuffleBtn.addEventListener('click', toggleShuffle);

            musicPlayer.addEventListener('play', updatePlayPauseIcon);
            musicPlayer.addEventListener('pause', updatePlayPauseIcon);

            updatePlayPauseIcon();
        }

        function updatePlayPauseIcon() {
            const playlistPlayPauseBtn = document.getElementById('playlist-play-pause');
            if (musicPlayer.paused) {
                playlistPlayPauseBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>`;
            } else {
                playlistPlayPauseBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75zM14.25 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z"></path></svg>`;
            }
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            document.getElementById('playlist-shuffle').classList.toggle('shuffle-active', isShuffled);
            
            if (isShuffled) {
                const currentTrackFilename = userPlaylist[currentTrackIndex];
                for (let i = userPlaylist.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [userPlaylist[i], userPlaylist[j]] = [userPlaylist[j], userPlaylist[i]];
                }
                currentTrackIndex = userPlaylist.findIndex(filename => filename === currentTrackFilename);
            } else {
                const currentTrackFilename = userPlaylist[currentTrackIndex];
                userPlaylist = [...originalUserPlaylist];
                currentTrackIndex = userPlaylist.findIndex(filename => filename === currentTrackFilename);
            }
            updateNowPlayingIndicator();
        }

        function updateVolumeIcon(volume) {
            const volumeToggleButton = document.getElementById('volume-toggle-button');
            const favicon = document.getElementById('favicon');
            
            if (volume === 0) {
                volumeToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`;
                favicon.href = mutedIconHref;
            } else {
                 volumeToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
                 favicon.href = speakerIconHref;
            }
        }

        function updateNowPlayingIndicator() {
            document.querySelectorAll('.playlist-item').forEach((item) => {
                item.classList.remove('now-playing');
                const trackTitle = item.querySelector('.song-title').textContent;
                const currentTrackTitle = songDatabase.find(t => t.filename === userPlaylist[currentTrackIndex])?.title;
                if (trackTitle === currentTrackTitle) {
                    item.classList.add('now-playing');
                }
            });
        }

        function populatePlaylistModal() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';
            verifiedPlaylist.forEach(track => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.innerHTML = `
                    <span class="song-title">${track.title}</span>
                    <span class="now-playing-indicator">Now Playing...</span>
                `;
                container.appendChild(item);
                item.addEventListener('click', () => {
                    const trackFilename = track.filename;
                    const playIndex = userPlaylist.findIndex(filename => filename === trackFilename);
                    if (playIndex !== -1) {
                        playTrack(playIndex);
                    }
                });
            });
            updateNowPlayingIndicator();
        }
        
        async function buildVerifiedPlaylist() {
            const checkTrack = async (track) => {
                try {
                    const response = await fetch(musicBaseURL + track.filename, { method: 'HEAD' });
                    return response.ok;
                } catch (error) {
                    console.error("Network error checking track:", track.filename, error);
                    return false;
                }
            };
            const checks = songDatabase.map(track => checkTrack(track));
            const results = await Promise.all(checks);
            verifiedPlaylist = songDatabase.filter((_, index) => results[index]);
            userPlaylist = verifiedPlaylist.map(track => track.filename);
            originalUserPlaylist = [...userPlaylist];
        }
        
        // --- Player Data & Store Logic (LocalStorage with Firebase Sync) ---
        function getDefaultPlayerData() {
            return {
                userId: userId || 'local', // Use 'local' if no userId yet
                name: 'Player',
                moneyBags: 0,
                highScore: 0,
                unlockedSkins: ['default'],
                activeSkin: 'default',
                lastLoginDate: null,
                lastDailyClaim: null,
                claimedDays: [],
                nonsenseFreebiesCollected: {},
                inventory: {},
                unlockedBadges: [],
                gamesPlayed: 0,
                greenBombsUsed: 0,
            };
        }

        function loadPlayerFromLocalStorage() {
            const savedData = localStorage.getItem('wordGreedPlayerData');
            if (savedData) {
                playerData = { ...getDefaultPlayerData(), ...JSON.parse(savedData) };
                 if (!playerData.unlockedBadges) playerData.unlockedBadges = [];
                 if (!playerData.gamesPlayed) playerData.gamesPlayed = 0;
                 if (!playerData.greenBombsUsed) playerData.greenBombsUsed = 0;
            } else {
                playerData = getDefaultPlayerData();
            }
            applyTheme(playerData.activeSkin);
            populateSetupModal();
            displayBadges(); // Display badges on load
        }
        
        async function syncWithFirebase() {
            if (!isFirebaseConnected || !userId) return;

            const playerDocRef = doc(db, "players", userId);
            try {
                const docSnap = await getDoc(playerDocRef);
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    // Simple merge: cloud data takes precedence for scores and bags
                    playerData.highScore = Math.max(playerData.highScore || 0, cloudData.highScore || 0);
                    playerData.moneyBags = Math.max(playerData.moneyBags || 0, cloudData.moneyBags || 0);
                    playerData.gamesPlayed = Math.max(playerData.gamesPlayed || 0, cloudData.gamesPlayed || 0);
                    playerData.greenBombsUsed = Math.max(playerData.greenBombsUsed || 0, cloudData.greenBombsUsed || 0);
                    // Merge badges
                    const localBadges = new Set(playerData.unlockedBadges || []);
                    const cloudBadges = new Set(cloudData.unlockedBadges || []);
                    playerData.unlockedBadges = Array.from(new Set([...localBadges, ...cloudBadges]));
                    
                    console.log("Player data synced with Firebase.");
                }
                // Always save the latest (potentially merged) data back to Firebase
                await savePlayerProfile();
                displayBadges(); // Re-display badges after sync
            } catch (error) {
                console.error("Error syncing with Firestore:", error);
            }
        }

        async function savePlayerProfile() {
            localStorage.setItem('wordGreedPlayerData', JSON.stringify(playerData));
            if (isFirebaseConnected && userId) {
                const playerDocRef = doc(db, "players", userId);
                try {
                    const dataToSave = JSON.parse(JSON.stringify(playerData));
                    await setDoc(playerDocRef, dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving player profile to Firestore:", error);
                }
            }
        }

        // --- Trading Post & Riches Logic ---
        function canAffordAnyTrade() {
            return trades.some(trade => {
                const costItem = Object.keys(trade.cost)[0];
                const costAmount = trade.cost[costItem];
                const playerAmount = playerData.nonsenseFreebiesCollected[costItem] || 0;
                return playerAmount >= costAmount;
            });
        }

        function updateTradeButtonPulse() {
            const tradeButton = document.getElementById('trade-goodies-button');
            if (tradeButton) {
                if (canAffordAnyTrade()) {
                    tradeButton.classList.add('trade-button-pulse');
                } else {
                    tradeButton.classList.remove('trade-button-pulse');
                }
            }
        }

        function openTradingPost() {
            document.getElementById('setup-modal').classList.add('hidden');
            populateTradingPost();
            document.getElementById('trading-post-modal').classList.remove('hidden');
        }

        function populateTradingPost() {
            const container = document.getElementById('available-trades-container');
            container.innerHTML = '';
            selectedTrade = null;
            updateTradePreview();
            document.getElementById('execute-trade-button').disabled = true;

            trades.forEach(trade => {
                const costItem = Object.keys(trade.cost)[0];
                const costAmount = trade.cost[costItem];
                const playerAmount = playerData.nonsenseFreebiesCollected[costItem] || 0;

                if (playerAmount >= costAmount) {
                    const item = document.createElement('div');
                    item.className = 'trade-item p-4 rounded-lg text-center cursor-pointer';
                    const rewardItem = trade.reward.item || (trade.reward.type === 'bags' ? 'üí∞' : 'ü™ô');
                    item.innerHTML = `
                        <div class="text-2xl">${costItem} ‚ûú ${rewardItem}</div>
                        <div class="text-sm font-bold">${trade.name}</div>
                    `;
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.trade-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedTrade = trade;
                        updateTradePreview();
                        document.getElementById('execute-trade-button').disabled = false;
                    });
                    container.appendChild(item);
                }
            });
        }

        function updateTradePreview() {
            const emojiEl = document.getElementById('trade-preview-emoji');
            const nameEl = document.getElementById('trade-preview-name');
            if (selectedTrade) {
                const rewardItem = selectedTrade.reward.item || (selectedTrade.reward.type === 'bags' ? 'üí∞' : 'ü™ô');
                const rewardName = selectedTrade.name.split(' for ')[1];
                emojiEl.textContent = rewardItem;
                nameEl.textContent = `Get: ${rewardName}`;
            } else {
                emojiEl.textContent = '‚ùî';
                nameEl.textContent = 'Select a Trade';
            }
        }

        function executeTrade() {
            if (!selectedTrade) return;

            const costItem = Object.keys(selectedTrade.cost)[0];
            const costAmount = selectedTrade.cost[costItem];
            const playerAmount = playerData.nonsenseFreebiesCollected[costItem] || 0;

            if (playerAmount >= costAmount) {
                playerData.nonsenseFreebiesCollected[costItem] -= costAmount;

                if (selectedTrade.reward.type === 'bags') {
                    playerData.moneyBags += selectedTrade.reward.amount;
                } else if (selectedTrade.reward.type === 'coins') {
                    coins += selectedTrade.reward.amount;
                    updateScoreDisplay();
                } else if (selectedTrade.reward.type === 'inventory') {
                    const rewardItem = selectedTrade.reward.item;
                    playerData.inventory[rewardItem] = (playerData.inventory[rewardItem] || 0) + selectedTrade.reward.amount;
                }

                showEventText("Trade Successful!", true);
                savePlayerProfile();
                populateTradingPost();
                populateSetupModal();
                selectedTrade = null;
                updateTradePreview();
                document.getElementById('execute-trade-button').disabled = true;
            } else {
                showEventText("Not enough items!", false);
            }
        }
        
        function populateRichesModal() {
            const container = document.getElementById('riches-inventory');
            container.innerHTML = '';
            const inventory = playerData.inventory || {};
            const items = Object.keys(inventory);

            if (items.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-slate-400">You have no special riches yet. Trade for them at the Trading Post!</p>`;
            } else {
                items.forEach(item => {
                    const count = inventory[item];
                    const name = inventoryItemNames[item] || 'Unknown Item';
                    const itemEl = document.createElement('div');
                    itemEl.className = 'riches-card';
                    itemEl.innerHTML = `
                        <div class="text-5xl">${item}</div>
                        <div class="text-md font-bold mt-2">${name}</div>
                        <div class="text-sm text-slate-300">x${count}</div>
                    `;
                    container.appendChild(itemEl);
                });
            }
            
            const netWorthPanel = document.getElementById('net-worth-panel');
            netWorthPanel.innerHTML = calculateNetWorth();
        }

        function calculateNetWorth() {
            const totalItems = Object.values(playerData.inventory || {}).reduce((a, b) => a + b, 0);
            const totalBags = playerData.moneyBags || 0;
            let description = "";

            if (totalItems === 0 && totalBags < 100000) {
                description = "Your portfolio is... let's call it 'minimalist'. Mostly lint and lost dreams.";
            } else if (totalItems < 5 && totalBags < 1000000) {
                description = "You're dabbling in high finance. Your primary asset is a half-eaten sandwich.";
            } else if (totalItems < 20 && totalBags < 10000000) {
                description = "You're a regional business magnate, primarily dealing in slightly-used paperclips.";
            } else if (totalItems >= 20 && totalBags >= 10000000) {
                description = "Congratulations, you now own several small countries. Your cash flow is 'ridiculous'.";
            } else {
                description = "Your financial advisor is a golden goose and your accountant weeps tears of joy.";
            }

            return `<h3 class="text-lg font-bold text-amber-300">Net Worth Analysis</h3><p class="text-slate-300 mt-2">${description}</p>`;
        }
        
        function populateSetupModal() {
            const nameInput = document.getElementById('player-name-input');
            nameInput.value = playerData.name || 'Player';
            nameInput.classList.toggle('invalid-input', !playerData.name?.trim());
            document.getElementById('total-bags-display').textContent = (playerData.moneyBags || 0).toLocaleString();
            document.getElementById('high-score-display').textContent = (playerData.highScore || 0).toLocaleString();
            
            const userIdDisplay = document.getElementById('user-id-display');
            if (userId && isFirebaseConnected) {
                userIdDisplay.textContent = `userId: ${userId}`;
            } else {
                userIdDisplay.textContent = 'Offline Mode';
            }

            populateThemeStore();
            populateNonsenseFreebies();
            updateTradeButtonPulse();
        }

        function populateNonsenseFreebies() {
            const container = document.getElementById('nonsense-freebies-container');
            container.innerHTML = '';
            nonsenseFreebies.forEach(freebie => {
                const count = playerData.nonsenseFreebiesCollected?.[freebie] || 0;
                const item = document.createElement('div');
                item.className = 'freebie-item';
                
                const isTradable = trades.some(trade => {
                    const costItem = Object.keys(trade.cost)[0];
                    const costAmount = trade.cost[costItem];
                    return freebie === costItem && count >= costAmount;
                });

                if (isTradable) {
                    item.classList.add('tradable');
                }

                item.innerHTML = `
                    <div>${freebie}</div>
                    <div class="freebie-count">${count}</div>
                `;
                container.appendChild(item);
            });
        }

        function applyTheme(themeId) {
            document.body.className = 'text-white flex items-center justify-center min-h-screen p-4';
            if (themeId !== 'default') {
                document.body.classList.add(`theme-${themeId}`);
            }
        }

        const themes = [
            { id: 'default', name: 'Purple Haze', cost: 0, colors: ['#a78bfa', '#8b5cf6'] },
            { id: 'blue', name: 'Ocean Blue', cost: 1000000, colors: ['#60a5fa', '#3b82f6'] },
            { id: 'green', name: 'Emerald City', cost: 3000000, colors: ['#4ade80', '#22c55e'] },
            { id: 'red', name: 'Ruby Rush', cost: 5000000, colors: ['#f87171', '#ef4444'] },
            { id: 'christmas', name: 'Christmas', cost: 7000000, colors: ['#dc2626', '#166534'] },
            { id: 'halloween', name: 'Halloween', cost: 9000000, colors: ['#f97316', '#4a044e'] },
            { id: 'winter', name: 'Winter', cost: 11000000, colors: ['#67e8f9', '#0c4a6e'] },
            { id: 'beach', name: 'Beach', cost: 13000000, colors: ['#fde047', '#2dd4bf'] },
            { id: 'grove', name: 'Grove Palms', cost: 15000000, colors: ['#22c55e', '#f59e0b'] },
            { id: 'dark-purple', name: 'Dark Purples', cost: 20000000, colors: ['#5b21b6', '#4c1d95'] },
            { id: 'grayscale', name: 'Grayscale', cost: 25000000, colors: ['#6b7280', '#374151'] },
            { id: 'stage-lights', name: 'Stage Lights', cost: 30000000, colors: ['#ec4899', '#8b5cf6'] }
        ];

        function populateThemeStore() {
            const container = document.getElementById('theme-store-container');
            container.innerHTML = '';
            themes.forEach(theme => {
                const isUnlocked = playerData.unlockedSkins?.includes(theme.id);
                const isActive = playerData.activeSkin === theme.id;
                const item = document.createElement('div');
                item.className = `theme-item p-2 rounded-lg flex flex-col items-center justify-start ${isActive ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
                item.style.background = `linear-gradient(145deg, ${theme.colors[0]}, ${theme.colors[1]})`;
                item.dataset.themeId = theme.id;
                
                let costHTML = isUnlocked ? '<span class="text-xs text-green-300">Unlocked</span>' : `<span class="text-xs">üí∞ ${theme.cost.toLocaleString()}</span>`;
                item.innerHTML = `
                    <div class="w-full text-center pt-2">
                        <span class="font-bold text-sm">${theme.name}</span>
                        ${costHTML}
                    </div>
                `;

                if (isUnlocked) {
                    item.addEventListener('click', () => {
                        playerData.activeSkin = theme.id;
                        applyTheme(theme.id);
                        savePlayerProfile();
                        populateThemeStore();
                    });
                } else {
                    item.addEventListener('click', () => {
                        if (playerData.moneyBags >= theme.cost) {
                            playerData.moneyBags -= theme.cost;
                            playerData.unlockedSkins.push(theme.id);
                            playerData.activeSkin = theme.id;
                            applyTheme(theme.id);
                            savePlayerProfile();
                            populateSetupModal();
                        } else {
                            const needed = theme.cost - playerData.moneyBags;
                            showEventText(`Need ${needed.toLocaleString()} more üí∞!`);
                        }
                    });
                }
                container.appendChild(item);
            });
        }

        function showWelcomeBonus() {
            const bonusCoins = Math.floor(Math.random() * 49001) + 1000;
            const bonusBags = Math.floor(Math.random() * 11);
            
            const container = document.getElementById('bonus-rewards-container');
            container.innerHTML = `
                <div class="bonus-item text-center">
                    <div class="text-5xl">ü™ô</div>
                    <div class="text-xl font-bold">${bonusCoins.toLocaleString()}</div>
                </div>
                <div class="bonus-item text-center" style="animation-delay: 0.2s;">
                    <div class="text-5xl">üí∞</div>
                    <div class="text-xl font-bold">${bonusBags.toLocaleString()}</div>
                </div>
            `;
            
            for (let i = 0; i < 2; i++) {
                const randomFreebie = nonsenseFreebies[Math.floor(Math.random() * nonsenseFreebies.length)];
                const randomQty = Math.floor(Math.random() * 4) + 1;
                const freebieEl = document.createElement('div');
                freebieEl.className = 'bonus-item text-center';
                freebieEl.style.animationDelay = `${0.4 + i * 0.2}s`;
                freebieEl.innerHTML = `
                    <div class="text-5xl">${randomFreebie}</div>
                    <div class="text-xl font-bold">x${randomQty}</div>
                `;
                container.appendChild(freebieEl);
                playerData.nonsenseFreebiesCollected[randomFreebie] = (playerData.nonsenseFreebiesCollected[randomFreebie] || 0) + randomQty;
            }
            
            document.getElementById('welcome-bonus-modal').classList.remove('hidden');

            document.getElementById('claim-bonus-button').onclick = () => {
                playerData.moneyBags += bonusBags;
                coins += bonusCoins;
                updateScoreDisplay();
                playerData.lastLoginDate = new Date().toISOString().split('T')[0];
                savePlayerProfile();
                document.getElementById('welcome-bonus-modal').classList.add('hidden');
                actuallyStartGame();
            };
        }

        const dailyRewards = Array.from({ length: 31 }, (_, i) => {
            const day = i + 1;
            const coinReward = Math.floor(1000 * Math.pow(day, 2.5));
            const bagReward = Math.floor(5 * Math.pow(day, 1.5));
            let bonus = 1;
            if (day === 7 || day === 21) bonus = 2;
            if (day === 10 || day === 20 || day === 30) bonus = 3;
            return { day, coins: coinReward, bags: bagReward, bonus: bonus };
        });
        dailyRewards[30] = { day: 31, coins: 100000000, bags: 5000, bonus: 3 };

        function populateCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const todayDay = today.getDate();

            for (let i = 1; i <= 35; i++) {
                if (i <= dailyRewards.length) {
                    const reward = dailyRewards[i - 1];
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    const isClaimed = playerData.claimedDays?.includes(reward.day);
                    const isToday = reward.day === todayDay;

                    dayEl.innerHTML = `
                        <div class="day-number">${reward.day}</div>
                        <div class="reward-text">ü™ô ${formatScore(reward.coins * reward.bonus)}</div>
                        <div class="reward-text">üí∞ ${formatScore(reward.bags * reward.bonus)}</div>
                    `;

                    if (reward.bonus === 2) dayEl.classList.add('double-bonus');
                    if (reward.bonus === 3) dayEl.classList.add('triple-bonus');

                    if (isClaimed) {
                        dayEl.classList.add('claimed');
                        dayEl.innerHTML += '<div class="text-xs font-bold mt-1">CLAIMED</div>';
                    } else if (isToday && playerData.lastDailyClaim !== todayStr) {
                        dayEl.classList.add('today');
                        dayEl.addEventListener('click', () => claimDailyReward(reward));
                    } else if (isToday && playerData.lastDailyClaim === todayStr) {
                        dayEl.classList.add('today', 'claimed');
                        dayEl.innerHTML += '<div class="text-xs font-bold mt-1">CLAIMED</div>';
                    } else if (reward.day > todayDay) {
                        dayEl.classList.add('future');
                    } else {
                        dayEl.classList.add('past-day');
                    }
                    grid.appendChild(dayEl);
                } else if (i === 32) {
                    const legendEl = document.createElement('div');
                    legendEl.id = 'calendar-legend';
                    legendEl.className = 'text-xs text-center greed-panel p-2 rounded-lg flex flex-col justify-center items-center';
                    legendEl.style.gridColumn = 'span 4';
                    legendEl.innerHTML = `
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full border-2 border-yellow-300"></div> 2x Bonus</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full border-2 border-red-500"></div> 3x Bonus</div>
                    `;
                    grid.appendChild(legendEl);
                }
            }
        }

        function claimDailyReward(reward) {
            const todayStr = new Date().toISOString().split('T')[0];
            if (playerData.lastDailyClaim === todayStr || playerData.claimedDays.includes(reward.day)) {
                showEventText("Already Claimed Today!");
                return;
            }

            const randomFreebie = nonsenseFreebies[Math.floor(Math.random() * nonsenseFreebies.length)];
            playerData.nonsenseFreebiesCollected[randomFreebie] = (playerData.nonsenseFreebiesCollected[randomFreebie] || 0) + 1;
            
            playerData.moneyBags += (reward.bags * reward.bonus);
            coins += (reward.coins * reward.bonus);
            updateScoreDisplay();
            showEventText(`+${randomFreebie} Claimed!<br>New Prizes Tomorrow!`, true, true);

            playerData.claimedDays.push(reward.day);
            playerData.lastDailyClaim = todayStr;
            savePlayerProfile();
            
            populateCalendar();
        }
        
        function saveGameResult() {
            playerData.moneyBags += bagsOfMoney;
            if (coins > playerData.highScore) {
                playerData.highScore = coins;
            }
            playerData.gamesPlayed++;
            savePlayerProfile();
        }

        // --- Tips Carousel Logic ---
        function populateTipsCarousel() {
            const container = document.getElementById('tip-card-container');
            container.innerHTML = '';
            tips.forEach((tip, index) => {
                const card = document.createElement('div');
                card.className = 'tip-card';
                card.textContent = tip;
                if (index === currentTipIndex) {
                    card.classList.add('active');
                }
                container.appendChild(card);
            });
        }

        function showTip(index) {
            const cards = document.querySelectorAll('.tip-card');
            cards.forEach((card, i) => {
                card.classList.toggle('active', i === index);
            });
        }

        function nextTip() {
            currentTipIndex = (currentTipIndex + 1) % tips.length;
            showTip(currentTipIndex);
        }

        function prevTip() {
            currentTipIndex = (currentTipIndex - 1 + tips.length) % tips.length;
            showTip(currentTipIndex);
        }
        
        // --- Badge Logic ---
        const badges = [
            { id: 'beginner', name: 'Beginner', emoji: 'ü§ç', score: 1000000 },
            { id: 'novice', name: 'Novice', emoji: 'üß°', score: 100000000 },
            { id: 'expert', name: 'Expert', emoji: 'üíô', score: 10000000000 },
            { id: 'trillion', name: 'Trillionaire', emoji: 'üíú', score: 1000000000000 },
            { id: 'charity', name: 'Philanthropist', emoji: 'üíñ', condition: (p) => p.unlockedBadges.includes('charity') },
            { id: 'play5', name: 'Frequent Player', emoji: 'ü•â', condition: (p) => p.gamesPlayed >= 5 },
            { id: 'play25', name: 'Veteran Player', emoji: 'ü•à', condition: (p) => p.gamesPlayed >= 25 },
            { id: 'bomb1000', name: 'Demolitionist', emoji: 'üí•', condition: (p) => p.greenBombsUsed >= 1000 },
        ];

        function checkAndAwardBadges(finalScore) {
            let newBadgeEarned = false;
            badges.forEach(badge => {
                if (!playerData.unlockedBadges.includes(badge.id)) {
                    let earned = false;
                    if (badge.score && finalScore >= badge.score) {
                        earned = true;
                    } else if (badge.condition && badge.condition(playerData)) {
                        earned = true;
                    }
                    if (earned) {
                        playerData.unlockedBadges.push(badge.id);
                        newBadgeEarned = true;
                        showEventText(`Badge Unlocked: ${badge.name}!`, true);
                    }
                }
            });
            if (newBadgeEarned) {
                displayBadges();
                savePlayerProfile();
            }
        }

        function displayBadges() {
            const panel = document.getElementById('badges-panel');
            panel.innerHTML = ''; // Clear previous badges
            if (playerData.unlockedBadges) {
                playerData.unlockedBadges.forEach(badgeId => {
                    const badgeData = badges.find(b => b.id === badgeId);
                    if (badgeData) {
                        const badgeEl = document.createElement('div');
                        badgeEl.className = 'badge-item';
                        badgeEl.textContent = badgeData.emoji;
                        panel.appendChild(badgeEl);
                    }
                });
            }
        }
        
        // --- Giving Modal Logic ---
        function openGivingModal() {
            document.getElementById('trading-post-modal').classList.add('hidden');
            populateGivingModal();
            document.getElementById('giving-modal').classList.remove('hidden');
        }

        function populateGivingModal() {
            const container = document.getElementById('giving-inventory');
            container.innerHTML = '';
            selectedDonation = null;
            document.getElementById('execute-give-button').disabled = true;

            const inventory = playerData.inventory || {};
            const items = Object.keys(inventory);

            if (items.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-slate-400">You have nothing to give! Acquire some riches first.</p>`;
                return;
            }

            items.forEach(item => {
                const count = inventory[item];
                if (count > 0) {
                    const name = inventoryItemNames[item] || 'Item';
                    const itemEl = document.createElement('div');
                    itemEl.className = 'giving-item p-2 rounded-lg text-center cursor-pointer';
                    itemEl.innerHTML = `
                        <div class="text-4xl">${item}</div>
                        <div class="text-xs font-bold">${name}</div>
                        <div class="text-xs text-slate-400">x${count}</div>
                    `;
                    itemEl.addEventListener('click', () => {
                        document.querySelectorAll('.giving-item').forEach(el => el.classList.remove('selected'));
                        itemEl.classList.add('selected');
                        selectedDonation = item;
                        document.getElementById('execute-give-button').disabled = false;
                    });
                    container.appendChild(itemEl);
                }
            });
        }

        function executeGive() {
            if (!selectedDonation) return;

            if (playerData.inventory[selectedDonation] > 0) {
                playerData.inventory[selectedDonation]--;

                if (!playerData.unlockedBadges.includes('charity')) {
                    playerData.unlockedBadges.push('charity');
                    showEventText("Badge Unlocked: Philanthropist!", true, true);
                    displayBadges();
                } else {
                    showEventText("Thank you for your generosity!", true);
                }
                
                savePlayerProfile();
                populateGivingModal(); // Refresh the view
                populateRichesModal(); // Also refresh riches view
            }
        }

        async function initGame() {
            loadPlayerFromLocalStorage();
            for (let i = 0; i < wordBank.length; i++) {
                wordBank[i] = wordBank[i].toUpperCase();
            }
            await buildVerifiedPlaylist();
            if (userPlaylist.length > 0) {
                currentTrackIndex = Math.floor(Math.random() * userPlaylist.length);
            }
            musicPlayer.addEventListener('ended', playNextTrack);
            playerNameInput.disabled = false;
            playerNameInput.placeholder = "Enter Name";
            levelGoodies = [...nonsenseFreebies];
            startLevel();
            updateScoreDisplay();
            setupAudioControls();
            populatePlaylistModal();
            populateTipsCarousel();
            startModalAnimationInterval = setInterval(() => { 
                const startModal = document.getElementById('start-modal');
                if (!startModal || startModal.classList.contains('hidden')) {
                    clearInterval(startModalAnimationInterval);
                    return;
                };
                const coin = document.createElement('div');
                coin.classList.add('falling-coin');
                coin.textContent = 'ü™ô';
                coin.style.left = `${Math.random() * 100}%`;
                coin.style.animationDuration = `${Math.random() * 2 + 3}s`;
                coin.style.fontSize = `${Math.random() * 1 + 0.5}rem`;
                startModal.appendChild(coin);
                setTimeout(() => coin.remove(), 5000);
             }, 300);

            try {
                let config;
                if (typeof window.firebaseConfig !== 'undefined') {
                    config = window.firebaseConfig;
                } else {
                    config = {
                        apiKey: "%FIREBASE_API_KEY%",
                        authDomain: "%FIREBASE_AUTH_DOMAIN%",
                        projectId: "%FIREBASE_PROJECT_ID%",
                        storageBucket: "%FIREBASE_STORAGE_BUCKET%",
                        messagingSenderId: "%FIREBASE_MESSAGING_SENDER_ID%",
                        appId: "%FIREBASE_APP_ID%",
                        measurementId: "%FIREBASE_MEASUREMENT_ID%"
                    };
                }
                if (!config.apiKey || config.apiKey.startsWith('%')) {
                    throw new Error("Firebase config not found. Running in offline mode.");
                }
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isFirebaseConnected = true;
                        await syncWithFirebase();
                    } else {
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            isFirebaseConnected = true;
                            await syncWithFirebase();
                        } catch (error) {
                            console.warn("Anonymous sign-in failed. Game will continue in offline mode.", error.message);
                            isFirebaseConnected = false;
                        }
                    }
                });
            } catch (e) {
                console.warn(e.message);
                isFirebaseConnected = false;
            }

            // --- Global Event Listeners ---
            document.getElementById('start-game-button').addEventListener('click', startGame);
            document.getElementById('play-again-button').addEventListener('click', restartGame);
            document.getElementById('help-button').addEventListener('click', () => {
                pauseGame();
                document.getElementById('help-modal').classList.remove('hidden');
            });
            document.getElementById('close-help-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                resumeGame();
            });
            document.getElementById('solve-button').addEventListener('click', onSolveButtonClick);
            document.getElementById('about-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                document.getElementById('about-modal').classList.remove('hidden');
            });
            document.getElementById('close-about-button').addEventListener('click', () => {
                document.getElementById('about-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });
            document.getElementById('playlist-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                populatePlaylistModal();
                document.getElementById('playlist-modal').classList.remove('hidden');
            });
            document.getElementById('close-playlist-button').addEventListener('click', () => {
                document.getElementById('playlist-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });
            document.getElementById('setup-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                populateSetupModal();
                document.getElementById('setup-modal').classList.remove('hidden');
            });
            document.getElementById('close-setup-button').addEventListener('click', () => {
                document.getElementById('setup-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });
            document.getElementById('reset-progress-button').addEventListener('click', () => {
                document.getElementById('confirm-reset-modal').classList.remove('hidden');
            });
            document.getElementById('cancel-reset-button').addEventListener('click', () => {
                document.getElementById('confirm-reset-modal').classList.add('hidden');
            });
            document.getElementById('confirm-reset-button').addEventListener('click', async () => {
                playerData = getDefaultPlayerData();
                await savePlayerProfile();
                populateSetupModal();
                applyTheme('default');
                document.getElementById('confirm-reset-modal').classList.add('hidden');
            });
            document.querySelectorAll('.difficulty-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.difficulty-button').forEach(btn => btn.classList.remove('difficulty-active'));
                    const clickedButton = e.currentTarget;
                    clickedButton.classList.add('difficulty-active');
                    if (clickedButton.id === 'difficulty-easy') maxSameEmoji = 8;
                    else if (clickedButton.id === 'difficulty-medium') maxSameEmoji = 4;
                    else if (clickedButton.id === 'difficulty-hard') maxSameEmoji = 2;
                    else maxSameEmoji = 4;
                });
            });
            document.getElementById('daily-rewards-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                populateCalendar();
                document.getElementById('daily-rewards-modal').classList.remove('hidden');
            });
            document.getElementById('close-daily-rewards-button').addEventListener('click', () => {
                document.getElementById('daily-rewards-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });
            document.getElementById('trade-goodies-button')?.addEventListener('click', openTradingPost);
            document.getElementById('execute-trade-button').addEventListener('click', executeTrade);
            document.getElementById('close-trading-post-button').addEventListener('click', () => {
                document.getElementById('trading-post-modal').classList.add('hidden');
                document.getElementById('setup-modal').classList.remove('hidden');
            });
            document.getElementById('riches-button').addEventListener('click', () => {
                document.getElementById('setup-modal').classList.add('hidden');
                populateRichesModal();
                document.getElementById('riches-modal').classList.remove('hidden');
            });
            document.getElementById('close-riches-button').addEventListener('click', () => {
                document.getElementById('riches-modal').classList.add('hidden');
                document.getElementById('setup-modal').classList.remove('hidden');
            });
            document.getElementById('player-name-input').addEventListener('blur', (e) => {
                playerData.name = e.target.value.trim() || 'Player';
                e.target.classList.toggle('invalid-input', !e.target.value.trim());
                savePlayerProfile();
            });
            document.getElementById('tips-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                document.getElementById('tips-modal').classList.remove('hidden');
            });
            document.getElementById('close-tips-button').addEventListener('click', () => {
                document.getElementById('tips-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });
            document.getElementById('carousel-next').addEventListener('click', nextTip);
            document.getElementById('carousel-prev').addEventListener('click', prevTip);
            document.getElementById('privacy-policy-button').addEventListener('click', async () => {
                document.getElementById('about-modal').classList.add('hidden');
                document.getElementById('privacy-modal').classList.remove('hidden');
                const policyContainer = document.getElementById('privacy-policy-content');
                try {
                    const response = await fetch('https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/PrivacyPolicy.html');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const policyHTML = await response.text();
                    policyContainer.innerHTML = policyHTML;
                } catch (error) {
                    console.error('Failed to fetch privacy policy:', error);
                    policyContainer.textContent = 'Could not load the privacy policy. Please try again later.';
                }
            });
            document.getElementById('close-privacy-button').addEventListener('click', () => {
                document.getElementById('privacy-modal').classList.add('hidden');
                document.getElementById('about-modal').classList.remove('hidden');
            });
            document.getElementById('copy-userid-button').addEventListener('click', () => {
                const textToCopy = userId;
                if (textToCopy) {
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showEventText("User ID Copied!");
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                    document.body.removeChild(textArea);
                }
            });
            // Giving Modal Listeners
            document.getElementById('give-button').addEventListener('click', openGivingModal);
            document.getElementById('close-giving-button').addEventListener('click', () => {
                document.getElementById('giving-modal').classList.add('hidden');
                document.getElementById('trading-post-modal').classList.remove('hidden');
            });
            document.getElementById('execute-give-button').addEventListener('click', executeGive);
        }
        
        window.onload = initGame;
    </script>
</body>
</html>
