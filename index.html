<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Greed</title>
    <link id="favicon" rel="icon" href="https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Lobster+Two:ital,wght@1,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #a78bfa; --primary-color-dark: #8b5cf6; --primary-color-light: #c4b5fd; --primary-text-dark: #1e1b4b; --panel-bg: rgba(55, 25, 85, 0.4); --panel-border: rgba(167, 139, 250, 0.3);
        }
        body.theme-red { --primary-color: #f87171; --primary-color-dark: #ef4444; --primary-color-light: #fca5a5; --primary-text-dark: #7f1d1d; --panel-bg: rgba(127, 29, 29, 0.4); --panel-border: rgba(239, 68, 68, 0.3); }
        body.theme-green { --primary-color: #4ade80; --primary-color-dark: #22c55e; --primary-color-light: #86efac; --primary-text-dark: #14532d; --panel-bg: rgba(22, 101, 52, 0.4); --panel-border: rgba(34, 197, 94, 0.3); }
        body.theme-blue { --primary-color: #60a5fa; --primary-color-dark: #3b82f6; --primary-color-light: #93c5fd; --primary-text-dark: #1e3a8a; --panel-bg: rgba(30, 58, 138, 0.4); --panel-border: rgba(59, 130, 246, 0.3); }
        /* Holiday Themes */
        body.theme-christmas { --primary-color: #ef4444; --primary-color-dark: #b91c1c; --primary-color-light: #fca5a5; --primary-text-dark: #ffffff; --panel-bg: rgba(22, 101, 52, 0.6); --panel-border: rgba(34, 197, 94, 0.5); }
        body.theme-halloween { --primary-color: #f97316; --primary-color-dark: #ea580c; --primary-color-light: #fb923c; --primary-text-dark: #ffffff; --panel-bg: rgba(28, 25, 23, 0.6); --panel-border: rgba(249, 115, 22, 0.5); }
        body.theme-july4th { --primary-color: #3b82f6; --primary-color-dark: #2563eb; --primary-color-light: #60a5fa; --primary-text-dark: #ffffff; --panel-bg: rgba(185, 28, 28, 0.6); --panel-border: rgba(220, 38, 38, 0.5); }
        
        @keyframes move-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(125deg, #000000, #0c1e42, #1e3a8a, #000000); background-size: 400% 400%; animation: move-gradient 20s ease infinite; overflow-x: hidden; }
        
        .game-title-style { 
            font-family: 'Lobster Two', cursive; 
            color: #FDD835;
            font-weight: 700; 
            font-style: italic; 
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 3px 0 #4a2c0f, 3px 3px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
        }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .coin-rotate { display: inline-block; animation: spin 5s linear infinite; }

        @keyframes fly-along-path { 0% { offset-distance: 0%; opacity: 1; } 100% { offset-distance: 100%; opacity: 0; } }
        @keyframes coin-swirl-in { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 100% { transform: scale(0) rotate(360deg); opacity: 0; } }
        @keyframes diamond-vortex { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(720deg); opacity: 0; } }
        @keyframes game-over-swirl { 0% { transform: translate(var(--start-x), var(--start-y)) scale(1) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--end-x), var(--end-y)) scale(0) rotate(-360deg); opacity: 0; } }
        @keyframes big-coin-tumble { 0% { transform: scale(8) rotate(0deg); opacity: 1; } 50% { transform: scale(5) rotate(360deg); } 100% { transform: scale(1) rotate(720deg); opacity: 1; } }
        .coin { position: absolute; top: 0; left: 0; width: 20px; height: 20px; background-color: #FFD700; border-radius: 50%; border: 2px solid #B8860B; pointer-events: none; z-index: 100; }
        @keyframes pulse-glow-red { 0%, 100% { box-shadow: 0 0 10px #f87171, 0 0 20px #f87171; } 50% { box-shadow: 0 0 15px #ef4444, 0 0 30px #ef4444; } }
        @keyframes pulse-glow-fire { 0%, 100% { box-shadow: 0 0 10px #fb923c, 0 0 20px #fb923c; } 50% { box-shadow: 0 0 15px #f97316, 0 0 30px #f97316; } }
        @keyframes wild-pulse-animation { 0%, 100% { transform: scale(1); box-shadow: 0 0 15px #F59E0B, 0 0 30px #F59E0B; } 50% { transform: scale(1.2) rotate(10deg); box-shadow: 0 0 25px #facc15, 0 0 50px #facc15; } }
        @keyframes big-pulse-animation { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        #jackpot-square.wild-pulse { animation: wild-pulse-animation 0.5s infinite ease-in-out !important; }
        #solve-button.big-pulse { animation: big-pulse-animation 0.5s infinite; }
        .prize-tile { animation: pulse-glow-blue 1.5s infinite; cursor: pointer; font-size: 2rem; }
        .prize-tile.red-bomb { background-color: #ef4444 !important; animation-name: pulse-glow-red; }
        .prize-tile.green-bomb { background-color: #22c55e !important; animation-name: pulse-glow-green; cursor: grab; }
        .prize-tile.fire-bomb { background-color: #f97316 !important; animation-name: pulse-glow-fire; }
        .glass-panel { background-color: rgba(20, 20, 40, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        #start-modal .glass-panel { box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), 0 0 0 2px #f59e0b; }
        .word-puzzle-tile { background-color: #FFFFFF !important; color: #111827 !important; border: 2px solid #d1d5db; cursor: grab; }
        .word-puzzle-tile.dragging { opacity: 0.5; cursor: grabbing; }
        .word-puzzle-tile.solved { background-color: #15803d !important; color: #FFFFFF !important; border-color: #14532d; box-shadow: inset 3px 3px 4px rgba(0, 0, 0, 0.5); cursor: default; }
        .greed-panel { background-color: var(--panel-bg); border: 1px solid var(--panel-border); }
        #solve-button { background-color: var(--primary-color); color: var(--primary-text-dark); border: 1px solid var(--primary-color-light); box-shadow: 0 2px 5px rgba(0,0,0,0.4); transition: all 0.2s ease; flex-shrink: 0; }
        #solve-button:hover { background-color: var(--primary-color-dark); color: #FFFFFF; }
        #solve-button:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        #solve-button:disabled { background-color: #6b7280; color: #d1d5db; cursor: not-allowed; }
        #solve-button.cooldown-timer { font-size: 1.25rem; font-family: 'Inter', sans-serif; }
        
        .event-text {
            font-family: 'Lobster Two', cursive; font-size: 5rem; color: #FDD835;
            text-shadow: -3px -3px 0 #4a2c0f, 3px -3px 0 #4a2c0f, -3px 3px 0 #4a2c0f, 3px 3px 0 #4a2c0f, 4px 4px 2px rgba(0,0,0,0.6);
            animation: event-flash 2s ease-out forwards;
        }
        .event-text.green-glow {
            color: #4ade80;
            text-shadow: -2px -2px 0 #14532d, 2px -2px 0 #14532d, -2px 2px 0 #14532d, 2px 2px 0 #14532d, 0 0 10px #4ade80, 0 0 20px #22c55e;
        }

        @keyframes event-flash { 0%, 100% { opacity: 0; transform: scale(0.8); } 20%, 80% { opacity: 1; transform: scale(1.1); } }
        
        @keyframes button-shimmer { 0% { transform: translateX(-100%) skewX(-15deg); } 100% { transform: translateX(200%) skewX(-15deg); } }
        .glassy-button {
            border: 1px solid; box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease-out; position: relative; overflow: hidden;
        }
        .glassy-button::before {
            content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: button-shimmer 4s infinite linear;
        }
        .glassy-button:active { transform: translateY(2px); border-bottom-width: 2px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); }

        @keyframes start-button-pulse { 0%, 100% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } 5% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 20px #3b82f6, 0 0 40px #3b82f6; } 15% { box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), 0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px #60a5fa, 0 0 20px #60a5fa; } }
        #start-game-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; animation: start-button-pulse 15s infinite; }

        #play-again-button, #about-button, #playlist-button { background: linear-gradient(145deg, #6b7280, #4b5563); border-color: #9ca3af; border-bottom: 4px solid #1f2937; }
        #close-help-button, #close-about-button, #close-playlist-button, #close-setup-button { background: linear-gradient(145deg, #5c97f5, #3b82f6); border-color: #93c5fd; border-bottom: 4px solid #1e3a8a; }
        #setup-button { background: linear-gradient(145deg, #4ade80, #22c55e); border-color: #86efac; border-bottom: 4px solid #14532d; }
        #confirm-reset-button { background: linear-gradient(145deg, #f87171, #ef4444); border-color: #fca5a5; border-bottom: 4px solid #7f1d1d; }


        .theme-button { width: 2.5rem; height: 2.5rem; border-radius: 50%; background-color: var(--panel-bg); border: 1px solid var(--panel-border); color: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; position: relative; }
        .theme-button:hover .tooltip { opacity: 1; visibility: visible; }
        .theme-button.difficulty-active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.6); transform: translateY(1px); }
        .theme-button svg { transform: scale(0.9); }
        .tooltip { visibility: hidden; opacity: 0; width: 120px; background-color: black; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; transition: opacity 0.3s; font-size: 0.75rem; }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: black transparent transparent transparent; }
        #help-button { font-size: 1.25rem; font-weight: bold; }
        #difficulty-default .orb { fill: #8B5CF6; } #difficulty-easy .orb { fill: #3B82F6; } #difficulty-medium .orb { fill: #F59E0B; } #difficulty-hard .orb { fill: #EF4444; }

        .score-decay { color: #ef4444 !important; }
        .greed-icon {
            width: 3rem; height: 3rem; background-color: var(--primary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.75rem; border: 1px solid var(--primary-color-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); cursor: pointer; color: white;
        }
        @keyframes ice-shimmer { 0% { background-position: -100% 0; } 100% { background-position: 100% 0; } }
        @keyframes crack-fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes ice-fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(90deg); opacity: 0; } }
        .ice-block {
            position: absolute; background: linear-gradient(145deg, rgba(173, 216, 230, 0.5), rgba(135, 206, 250, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.5), 0 4px 6px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 50; overflow: hidden;
        }
        .ice-block::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: ice-shimmer 3s infinite linear;
        }
        .ice-block.cracked {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44"><path d="M 10 0 L 10 15 L 0 20 L 10 25 L 10 44 M 20 0 L 25 10 L 15 15 L 25 20 L 20 44 M 35 0 L 30 22 L 44 28" stroke="rgba(255,255,255,0.7)" stroke-width="1" fill="none"/></svg>'), linear-gradient(145deg, rgba(173, 216, 230, 0.6), rgba(135, 206, 250, 0.7));
            background-size: cover; animation: crack-fade-in 0.2s forwards;
        }
        #bomb-drag-preview { position: absolute; border: 3px dashed #22c55e; background-color: rgba(34, 197, 94, 0.3); pointer-events: none; z-index: 200; display: none; }
        @keyframes cash-money-pulse { 0%, 100% { box-shadow: 0 0 15px #4ade80, 0 0 30px #4ade80; } 50% { box-shadow: 0 0 25px #22c55e, 0 0 50px #22c55e; } }
        .cash-money-prize { background-color: #16a34a !important; animation: cash-money-pulse 0.7s infinite ease-in-out; }

        @keyframes fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        @keyframes twinkle { 0%, 100% { transform: scale(0); opacity: 0; } 50% { transform: scale(1); opacity: 1; } }
        .falling-coin { position: absolute; font-size: 1.5rem; animation: fall linear forwards; pointer-events: none; }
        .sparkle { position: absolute; width: 8px; height: 8px; background-color: #fde047; border-radius: 50%; box-shadow: 0 0 5px #fde047, 0 0 10px #facc15; animation: twinkle ease-in-out infinite; pointer-events: none; }
        
        input[type=range].volume-slider { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range].volume-slider:focus { outline: none; }
        input[type=range].volume-slider::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].volume-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; margin-top: -7px; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }
        input[type=range].volume-slider::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: rgba(0, 0, 0, 0.5); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.2); }
        input[type=range].volume-slider::-moz-range-thumb { height: 20px; width: 20px; border-radius: 50%; background: #a78bfa; cursor: pointer; border: 2px solid #c4b5fd; box-shadow: 0 0 5px #8b5cf6; }

        /* Playlist & Setup Styles */
        .playlist-item { display: flex; align-items: center; padding: 0.5rem 0.75rem; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem; transition: background-color 0.2s; }
        .playlist-item:hover { background-color: rgba(0,0,0,0.4); }
        .playlist-item input[type="checkbox"] { display: none; }
        .playlist-item .custom-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--primary-color-light); border-radius: 4px;
            display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;
            cursor: pointer; background-color: rgba(0,0,0,0.3);
        }
        .playlist-item .custom-checkbox svg { display: none; }
        .playlist-item input[type="checkbox"]:checked + .custom-checkbox { background-color: var(--primary-color); }
        .playlist-item input[type="checkbox"]:checked + .custom-checkbox svg { display: block; }
        #player-name-input { background-color: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); }
        #theme-store-container { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 1rem; }
        #theme-store-container::-webkit-scrollbar { height: 8px; }
        #theme-store-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #theme-store-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        .theme-item {
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
            position: relative; overflow: hidden; flex-shrink: 0; width: 120px; height: 80px;
        }
        .theme-item.active { border-color: var(--primary-color-light); box-shadow: 0 0 10px var(--primary-color); }
        .theme-item.locked::after {
            content: '🔒';
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <audio id="background-music">
        <!-- Source will be set dynamically by JavaScript -->
    </audio>

    <div id="game-container" class="hidden flex-col md:flex-row gap-4 items-start justify-center">
        <!-- Game Grid Section -->
        <div class="flex flex-col gap-1 items-center">
            <div class="relative">
                <div id="game-grid" class="grid grid-cols-9 gap-1 bg-slate-800/70 p-3 rounded-xl shadow-2xl border border-slate-700/50"></div>
                <div id="bomb-drag-preview"></div>
            </div>
        </div>

        <!-- Score & Control Panel -->
        <div id="score-panel" class="glass-panel p-4 rounded-xl w-full max-w-xs md:w-[17rem] flex flex-col justify-between gap-3 relative">
            <div class="flex flex-col gap-2"> 
                <div class="relative w-full h-24 flex justify-center items-center">
                    <h1 class="game-title-style text-6xl relative" style="width: 15rem; height: 7rem; left: 1rem;">
                        <span class="absolute" style="top: 0; left: 0;">Word</span>
                        <span class="absolute" style="top: 2.7rem; left: 2.5rem;">Greed</span>
                    </h1>
                </div>
                <div class="p-2 flex justify-around text-center">
                    <div><span class="text-sm font-bold text-slate-300">LEVEL</span><div id="level-display" class="text-2xl font-bold text-white">1</div></div>
                    <div><span class="text-sm font-bold text-slate-300">TIME</span><div id="timer-display" class="text-2xl font-bold text-white">10:00</div></div>
                </div>
                <div id="score-container" class="greed-panel p-3 rounded-lg text-center flex flex-col gap-2">
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="text-4xl coin-rotate" style="filter: drop-shadow(0 0 5px #fde047);">🪙</div>
                        <div class="text-4xl" style="filter: drop-shadow(0 0 5px #fde047);">💰</div>
                        <div id="coins-display" class="text-lg font-bold text-white">0</div>
                        <div id="bags-of-money-display" class="text-lg font-bold text-green-400">0</div>
                    </div>
                    <hr class="border-violet-300/20">
                    <div id="greed-content" class="mx-auto flex flex-col items-center justify-center gap-1">
                         <div class="flex items-center justify-center gap-2"><span class="text-sm font-bold text-violet-200">GREED SCORE</span></div>
                        <div class="flex items-center justify-center gap-2 mt-1">
                            <button id="solve-button" class="w-12 h-12 rounded-full text-3xl font-black flex items-center justify-center">✅</button>
                            <div id="greed-icons-container" class="flex items-center justify-center gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="theme-buttons-container" class="flex justify-around items-center">
                <button id="help-button" class="theme-button">?</button>
                <button id="difficulty-default" class="theme-button difficulty-button difficulty-active">
                    <span class="tooltip">Default: Max 4</span>
                    <svg viewBox="0 0 100 100" class="w-full h-full"><defs><radialGradient id="highlight1" cx="0.3" cy="0.3" r="0.4"><stop offset="0%" stop-color="white" stop-opacity="0.8"/><stop offset="100%" stop-color="white" stop-opacity="0"/></radialGradient><radialGradient id="highlight2" cx="0.7" cy="0.7" r="0.3"><stop offset="0%" stop-color="white" stop-opacity="0.6"/><stop offset="100%" stop-color="white" stop-opacity="0"/></radialGradient></defs><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
                <button id="difficulty-easy" class="theme-button difficulty-button">
                     <span class="tooltip">Easy: Max 8</span>
                     <svg viewBox="0 0 100 100" class="w-full h-full"><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
                <button id="difficulty-medium" class="theme-button difficulty-button">
                     <span class="tooltip">Medium: Max 4</span>
                     <svg viewBox="0 0 100 100" class="w-full h-full"><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
                <button id="difficulty-hard" class="theme-button difficulty-button">
                     <span class="tooltip">Hard: Max 2</span>
                     <svg viewBox="0 0 100 100" class="w-full h-full"><circle class="orb" cx="50" cy="50" r="45"/><circle cx="50" cy="50" r="45" fill="url(#highlight1)"/><circle cx="50" cy="50" r="45" fill="url(#highlight2)"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="start-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass-panel p-8 rounded-2xl text-center flex flex-col items-center gap-6 w-full max-w-md relative overflow-hidden">
            <h1 class="game-title-style text-8xl relative" style="width: 22rem; height: 10rem;">
                <span class="absolute" style="top: 0; left: 0;">Word</span>
                <span class="absolute" style="top: 4rem; left: 4rem;">Greed</span>
            </h1>
            <p class="text-lg text-slate-300">Drag and drop letters to solve jumbled words. Grab Big Prizes and Get Greedy!</p>
            <button id="start-game-button" class="glassy-button text-white font-bold py-3 px-8 rounded-lg text-2xl">Start Game</button>
        </div>
    </div>

    <div id="game-over-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl text-center flex flex-col items-center gap-6 w-full max-w-md relative overflow-hidden">
             <h1 class="game-title-style text-6xl relative" style="width: 15rem; height: 7rem;">
                <span class="absolute" style="top: 0; left: 0;">Word</span>
                <span class="absolute" style="top: 2.7rem; left: 2.5rem;">Greed</span>
            </h1>
            <div id="leaderboard-container" class="w-full"></div>
            <button id="play-again-button" class="glassy-button mt-2 text-white font-bold py-3 px-6 rounded-lg text-xl">Play Again</button>
        </div>
    </div>
    
    <div id="event-text-container" class="hidden fixed inset-0 flex items-center justify-center pointer-events-none z-[60]">
        <div id="event-text" class="event-text"></div>
    </div>

    <div id="help-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-3 w-full max-w-3xl relative">
            <h2 class="text-2xl font-bold text-amber-300">How to Play</h2>
            <table class="w-full text-sm my-2">
                <tbody class="divide-y divide-slate-600">
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">🖊️</td><td class="py-0.5 pr-2 font-bold text-green-400">Solve Words</td><td class="py-0.5 text-slate-300">Drag letters to solve words for <span class="font-bold text-white">10,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">✅</td><td class="py-0.5 pr-2 font-bold text-green-400">Complete Level</td><td class="py-0.5 text-slate-300">Solve all 4 words for a <span class="font-bold text-white">100,000</span> coin bonus.</td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">🎁</td><td class="py-0.5 pr-2 font-bold text-white">Present</td><td class="py-0.5 text-slate-300">+<span class="font-bold text-white">1,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">🏆</td><td class="py-0.5 pr-2 font-bold text-white">Trophy</td><td class="py-0.5 text-slate-300">+<span class="font-bold text-white">3,500,000</span> coins.</td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">💎</td><td class="py-0.5 pr-2 font-bold text-white">Diamond</td><td class="py-0.5 text-slate-300">+<span class="font-bold text-white">20,000,000</span> coins & board clear.</td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">⚡</td><td class="py-0.5 pr-2 font-bold text-white">Lightning</td><td class="py-0.5 text-slate-300">+<span class="font-bold text-white">20,000</span> coins, but <strong class="text-red-400">resets Bags of Money!</strong></td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">💣</td><td class="py-0.5 pr-2 font-bold text-green-400">Green Bomb</td><td class="py-0.5 text-slate-300">Drag to a puzzle to solve key letters & collect prizes.</td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">💣</td><td class="py-0.5 pr-2 font-bold text-red-400">Red Bomb</td><td class="py-0.5 text-slate-300">GAME OVER!</td></tr>
                    <tr class="align-middle"><td class="py-0.5 pr-2 text-2xl">❄️</td><td class="py-0.5 pr-2 font-bold text-blue-300">Snowflake</td><td class="py-0.5 text-slate-300">Freezes all prizes for 15 seconds.</td></tr>
                </tbody>
            </table>
            <div class="w-full flex justify-between items-center mt-2 gap-4">
                <div class="flex items-center gap-3">
                    <button id="volume-toggle-button" class="text-2xl hover:text-white text-slate-300 transition-colors"></button>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" class="volume-slider w-32">
                </div>
                <div class="flex items-center gap-2">
                    <button id="playlist-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-base">Playlist</button>
                    <button id="setup-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-base">Setup</button>
                    <button id="about-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-base">About</button>
                    <button id="close-help-button" class="glassy-button text-white font-bold py-2 px-4 rounded-lg text-base">Close</button>
                </div>
            </div>
            <div class="absolute bottom-2 right-4 text-xs text-slate-500">v1.4</div>
        </div>
    </div>

    <div id="about-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">About Word Greed</h2>
            <div class="text-slate-300 space-y-2">
                <p>Created by: <span class="font-bold text-white">Floyd Kelly</span></p>
                <p>Music by: <span class="font-bold text-white">Floyd Kelly and Udio</span></p>
                <p>Version: <span class="font-bold text-white">1.4</span></p>
                <p>Build Date: <span class="font-bold text-white">August 3, 2025</span></p>
            </div>
            <p class="text-xs text-slate-500 mt-4">Copyright © 2025</p>
            <button id="close-about-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <div id="playlist-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-md relative text-center">
            <h2 class="text-2xl font-bold text-amber-300">Soundtrack Playlist</h2>
            <div id="playlist-container" class="w-full space-y-2 my-2 text-left">
                <!-- Playlist items will be injected here by JS -->
            </div>
            <button id="close-playlist-button" class="glassy-button mt-4 text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
        </div>
    </div>

    <div id="setup-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col gap-4 w-full max-w-lg relative">
            <h2 class="text-2xl font-bold text-amber-300 text-center">Player Setup & Store</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                <div class="greed-panel p-3 rounded-lg">
                    <label for="player-name-input" class="text-sm font-bold text-slate-300">PLAYER NAME</label>
                    <input type="text" id="player-name-input" class="w-full mt-1 p-2 rounded-md text-center text-lg font-bold" placeholder="Enter Name">
                </div>
                <div class="greed-panel p-3 rounded-lg">
                    <div class="text-sm font-bold text-slate-300">TOTAL MONEY BAGS</div>
                    <div id="total-bags-display" class="text-2xl font-bold text-green-400">0</div>
                </div>
                <div class="greed-panel p-3 rounded-lg">
                    <div class="text-sm font-bold text-slate-300">HIGH SCORE</div>
                    <div id="high-score-display" class="text-2xl font-bold text-white">0</div>
                </div>
                <div class="greed-panel p-3 rounded-lg">
                    <div class="text-sm font-bold text-slate-300">GAMES PLAYED</div>
                    <div id="games-played-display" class="text-2xl font-bold text-white">0</div>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-bold text-amber-300 text-center mt-2">Theme Store</h3>
                <div id="theme-store-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2">
                    <!-- Themes will be injected here -->
                </div>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button id="reset-progress-button" class="text-xs text-red-400 hover:text-red-300">Reset Progress</button>
                <button id="close-setup-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Close</button>
            </div>
        </div>
    </div>

    <div id="confirm-reset-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4">
        <div class="glass-panel p-8 rounded-2xl flex flex-col items-center gap-4 w-full max-w-sm relative text-center">
            <h2 class="text-xl font-bold text-red-400">Reset Progress?</h2>
            <p class="text-slate-300">Are you sure? All your stats, money bags, and unlocked themes will be permanently deleted.</p>
            <div class="flex items-center gap-4 mt-4">
                <button id="cancel-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Cancel</button>
                <button id="confirm-reset-button" class="glassy-button text-white font-bold py-2 px-6 rounded-lg text-lg">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const gridContainer = document.getElementById('game-grid');
        const musicPlayer = document.getElementById('background-music');

        // --- Game Data ---
        let coins = 0;
        let bagsOfMoney = 0;
        let draggedTile = null;

        // --- Player Data (Persistent) ---
        let playerData = {};

        // --- Playlist Data ---
        const playlist = [ 'wordgreed001.mp3', 'wordgreed002.mp3', 'wordgreed003.mp3', 'wordgreed004.mp3', 'wordgreed005.mp3' ];
        let verifiedPlaylist = [];
        let userPlaylist = [];
        let currentTrackIndex = 0;
        const musicBaseURL = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/';
        const mutedIconHref = 'https://raw.githubusercontent.com/floydkelly-dev/wordgreed/main/public/WordGreedSiteIcon.png';
        const speakerSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M 20 40 L 40 40 L 60 20 L 60 80 L 40 60 L 20 60 Z" fill="white" stroke="black" stroke-width="2"/><path d="M 70 30 C 80 40, 80 60, 70 70" stroke="white" stroke-width="5" fill="none"/><path d="M 80 20 C 95 35, 95 65, 80 80" stroke="white" stroke-width="5" fill="none"/></svg>`;
        const speakerIconHref = `data:image/svg+xml,${encodeURIComponent(speakerSVG)}`;

        // --- Game State ---
        let currentLevel = 1;
        const totalGameTime = 600;
        let timeRemaining = totalGameTime;
        let mainTimerInterval = null;
        let prizeSpawnerTimeout = null;
        let diamondSequenceTimeout = null;
        let puzzles = [];
        let trophyCollectedThisLevel = false;
        let diamondCollectedThisLevel = false;
        let currentDiamondValue = 20000000;
        let solveButtonClicks = 0;
        let solveButtonCooldown = 0;
        let solveButtonTimerInterval = null;
        let isGamePaused = true;
        let isGameOver = false;
        let timeSinceLastSolve = 0;
        let scoreDecayInterval = null;
        let impTimeout = null;
        let isFrozen = false;
        let thawTimeout = null;
        let jackpotEventAvailable = true; 
        let specialJackpotTimeout = null;
        let specialCashEmojiSpawned = false;
        let impEvents = { sixMin: true, threeMin: true };
        let isSpecialAnimationActive = false;
        let startModalAnimationInterval = null;
        let maxSameEmoji = 4;
        let isDraggingBomb = false;
        let lastVolume = 0.5;

        const wordBank = ["ABROAD","ACCEPT","ACCESS","ACROSS","ACTION","ACTIVE","ADMIRE","ADVICE","AFFAIR","AFFECT","AFFORD","AGENCY","AGENDA","ALMOST","ALWAYS","AMOUNT","ANIMAL","ANNUAL","ANSWER","ANYONE","ANYWAY","APART","APPEAL","APPEAR","APPLY","APPROVE","AROUND","ARRIVE","ARTIST","ASLEEP","ASPECT","ASSESS","ASSIST","ASSUME","ATTACK","ATTEND","ATTRACT","AUTHOR","AWARD","BALANCE","BECOME","BEHAVE","BELIEF","BELONG","BENEATH","BENEFIT","BESIDE","BEYOND","BISHOP","BORDER","BOTTLE","BOTTOM","BRANCH","BREATH","BRIDGE","BRIEFLY","BRIGHT","BROKEN","BUDGET","BURDEN","CAMERA","CANCEL","CANCER","CANDLE","CAPITAL","CAREER","CAREFUL","CENTRAL","CENTURY","CERTAIN","CHAIR","CHALLENGE","CHANCE","CHANGE","CHARGE","CHOICE","CHOOSE","CHURCH","CIRCLE","CLIENT","CLIMB","CLOSELY","CLOSER","COFFEE","COLLECT","COLLEGE","COLUMN","COMBINE","COMFORT","COMMAND","COMMENT","COMMIT","COMMON","COMPARE","COMPETE","COMPLEX","CONCEPT","CONCERN","CONFIRM","CONFLICT","CONNECT","CONSENT","CONSIST","CONTACT","CONTAIN","CONTENT","CONTEST","CONTEXT","CONTROL","CONVERT","CORNER","COUNCIL","COUNTY","COUPLE","COVER","CREATE","CREDIT","CRISIS","CRITERION","CRITIC","CROWD","CULTURE","CURRENT","CUSTOM","DAMAGE","DANGER","DEALER","DEBATE","DECADE","DECIDE","DECLARE","DECREASE","DEEPLY","DEFAULT","DEFENCE","DEFEND","DEFINE","DEGREE","DELAY","DELIVER","DEMAND","DEPEND","DEPICT","DEPOSIT","DEPUTY","DERIVE","DESIGN","DESIRE","DESPITE","DESTROY","DETAIL","DETECT","DEVELOP","DEVICE","DEVOTE","DIFFER","DIFFICULT","DINNER","DIRECT","DISCUSS","DISEASE","DISMISS","DISPLAY","DISTANT","DIVIDE","DIVISION","DOCTOR","DOCUMENT","DOUBLE","DOUBT","DOZEN","DREAM","DRINK","DRIVE","EAGER","EARLY","EARTH","EASTERN","ECONOMIC","ECONOMY","EDITOR","EDUCATE","EFFECT","EFFORT","EIGHT","EITHER","ELDERLY","ELECT","ELEMENT","ELSE","EMERGE","EMPHASIS","EMPLOY","ENABLE","ENCOURAGE","ENGINE","ENJOY","ENOUGH","ENSURE","ENTER","ENTIRE","ENTITLE","EQUALLY","EQUIP","ESCAPE","ESSAY","ESSENTIAL","ESTATE","ETHNIC","EVENT","EVERY","EXACTLY","EXAMINE","EXAMPLE","EXCEED","EXCEPT","EXCHANGE","EXCITE","EXCLUDE","EXCUSE","EXERCISE","EXIST","EXPECT","EXPENSE","EXPERIENCE","EXPERT","EXPLAIN","EXPLORE","EXPOSE","EXPRESS","EXTEND","EXTENT","EXTERNAL","EXTRA","EXTREME","FACTOR","FACULTY","FAILED","FAILURE","FAIRLY","FAITH","FAMLIAR","FAMOUS","FARMER","FASHION","FATHER","FAVOUR","FEELING","FEMALE","FIFTEEN","FIGHT","FIGURE","FINANCE","FINALLY","FINGER","FINISH","FLIGHT","FLOWER","FOLLOW","FOOTBALL","FORCE","FOREIGN","FOREST","FORGET","FORMAL","FORMER","FORWARD","FOUND","FOURTH","FRAME","FREEDOM","FRIEND","FUNCTION","FUTURE","GARDEN","GATHER","GENERAL","GENERATION","GENTLE","GLOBAL","GOLDEN","GROUND","GROWTH","GUARD","GUILTY","HANDLE","HAPPEN","HARDLY","HEALTH","HEAVILY","HEIGHT","HENCE","HOLIDAY","HORSE","HOSPITAL","HOUSE","HOWEVER","HUMAN","HUSBAND","IMPACT","IMPLY","IMPORT","IMPOSE","IMPROVE","INCLUDE","INCREASE","INDEED","INDICATE","INDIVIDUAL","INDUSTRY","INFORM","INITIAL","INJURY","INSIDE","INSIST","INSTANCE","INSTEAD","INSTITUTE","INTEND","INTEREST","INTERNAL","INVOLVE","ISLAND","ISSUE","ITSELF","JOINT","JUDGE","JUDGMENT","JUNIOR","JUSTICE","LABOUR","LANGUAGE","LARGELY","LATTER","LAUGH","LAWYER","LEADER","LEAGUE","LEARN","LEAVE","LEGAL","LENGTH","LESSON","LETTER","LEVEL","LIBERAL","LIBRARY","LICENCE","LIMIT","LIMITED","LITTLE","LOCAL","LONDON","LONGER","MACHINE","MAJOR","MANAGE","MANAGER","MANNER","MANY","MARKET","MARRIAGE","MATCH","MATERIAL","MATTER","MEASURE","MEDIA","MEDICAL","MEETING","MEMBER","MEMORY","MENTAL","MENTION","MERELY","METHOD","MIDDLE","MIGHT","MILE","MILITARY","MINISTER","MINOR","MINORITY","MINUTE","MISSION","MISTAKE","MODEL","MODERN","MODULE","MOMENT","MONEY","MONTH","MORAL","MORNING","MOTHER","MOTION","MOTOR","MOUNTAIN","MOUTH","MOVEMENT","MOVIE","MUCH","MUSIC","MYSELF","NARROW","NATION","NATIONAL","NATIVE","NATURAL","NATURE","NEARLY","NECESSary","NEEDLE","NEITHER","NERVE","NETWORK","NEVER","NEWLY","NIGHT","NOBODY","NORMAL","NORTHERN","NOTICE","NOTION","NOWHERE","NUMBER","OBJECT","OBSERVE","OBTAIN","OBVIOUS","OCCASION","OCCUR","OFFENCE","OFFER","OFFICE","OFFICER","OFFICIAL","OFTEN","ONCE","ONLINE","ONLY","ONTO","OPENING","OPERATE","OPPORTUNITY","OPPOSE","OPPOSITE","ORDER","ORDINARY","ORGANISE","ORIGIN","ORIGINAL","OTHER","OUGHT","OUTCOME","OUTSIDE","OVERALL","OWNER","PACKAGE","PAINT","PANEL","PARENT","PARISH","PARLIAMENT","PARTLY","PARTNER","PARTY","PASSAGE","PATIENT","PATTERN","PEACE","PEOPLE","PERFORM","PERHAPS","PERIOD","PERMIT","PERSON","PERSONAL","PHONE","PHOTO","PHYSICAL","PICTURE","PIECE","PLACE","PLANNING","PLANT","PLASTIC","PLAYER","POCKET","POINT","POLICE","POLICY","POLITICAL","POLLUTION","POPULAR","POSITION","POSITIVE","POSSIBLE","POSTER","POWER","PRACTICE","PREFER","PREPARE","PRESENCE","PRESENT","PRESIDENT","PRESS","PRESSURE","PRETTY","PREVIOUS","PRICE","PRIMARY","PRINCIPLE","PRINT","PRIOR","PRIORITY","PRISON","PRIVATE","PROBABLY","PROBLEM","PROCEDURE","PROCESS","PRODUCE","PRODUCT","PROFESSION","PROFILE","PROFIT","PROGRAM","PROGRESS","PROJECT","PROMISE","PROMOTE","PROPER","PROPERTY","PROPOSE","PROTECT","PROVIDE","PUBLIC","PUBLISH","PURPOSE","PUSH","QUALITY","QUARTER","QUESTION","QUICKLY","QUITE","RAISE","RANGE","RAPIDLY","RATELY","RATHER","REACH","REACTION","READER","READING","READY","REALISE","REALLY","REASON","RECALL","RECEIVE","RECENT","RECENTLY","RECOGNISE","RECORD","RECOVER","REDUCE","REFER","REFLECT","REFORM","REFUSE","REGARD","REGION","REGIONAL","REGULAR","RELATE","RELATION","RELATIVE","RELEASE","RELEVANT","RELIEF","RELIGION","REMAIN","REMEMBER","REMOVE","REPEAT","REPLACE","REPLY","REPORT","REPRESENT","REQUEST","REQUIRE","RESEARCH","RESOURCE","RESPECT","RESPOND","RESPONSE","RESULT","RETAIN","RETURN","REVEAL","REVENUE","REVIEW","REVOLUTION","RIGHT","RING","RISE","ROAD","ROLE","ROOM","ROUND","ROUTE","ROYAL","RULE","SAFETY","SALE","SAME","SAMPLE","SAVE","SCALE","SCENE","SCHEME","SCHOOL","SCIENCE","SCORE","SCREEN","SEARCH","SEASON","SECOND","SECRETARY","SECTION","SECTOR","SECURE","SEEM","SELECT","SENIOR","SENSE","SENSITIVE","SENTENCE","SEPARATE","SEQUENCE","SERIES","SERIOUS","SERVANT","SERVICE","SESSION","SETTLE","SEVEN","SEVERAL","SEVERE","SHARE","SHEET","SHOOT","SHORT","SHOT","SHOULD","SHOULDER","SHOUT","SHOW","SIDE","SIGHT","SIGN","SIGNAL","SILENCE","SIMPLE","SIMPLY","SINCE","SINGLE","SISTER","SITE","SITUATION","SIZE","SKILL","SKIN","SLEEP","SLIGHTLY","SLOWLY","SOCIAL","SOCIETY","SOLDIER","SOLUTION","SOME","SOMEHOW","SOMEONE","SOMETHING","SOMETIMES","SOMEWHAT","SOON","SORRY","SORT","SOUND","SOURCE","SOUTHERN","SPACE","SPEAK","SPECIAL","SPECIFIC","SPEECH","SPEED","SPEND","SPIRIT","SPORT","SPOT","SPREAD","SPRING","SQUARE","STAFF","STAGE","STAND","STANDARD","START","STATE","STATEMENT","STATION","STATUS","STAY","STEP","STILL","STOCK","STONE","STOP","STORE","STORY","STRAIGHT","STRANGE","STRATEGY","STREET","STRENGTH","STRESS","STRIKE","STRONG","STRUCTURE","STUDENT","STUDIO","STUDY","STYLE","SUBJECT","SUBMIT","SUCCEED","SUCCESS","SUCH","SUDDENLY","SUFFER","SUGGEST","SUMMER","SUPPORT","SUPPOSE","SURELY","SURFACE","SURVEY","SURVIVE","SWITCH","SYSTEM","TABLE","TAKE","TALK","TARGET","TASK","TEACH","TEACHER","TEAM","TECHNOLOGY","TELEPHONE","TELEVISION","TEMPERATURE","TERM","TERRIBLE","TEST","THANKS","THEATRE","THEIR","THEME","THEMSELVES","THEN","THEORY","THERE","THESE","THEY","THING","THINK","THIRD","THIRTY","THIS","THOSE","THOUGH","THOUSAND","THREAT","THREATEN","THREE","THROUGH","THROW","TICKET","TIME","TITLE","TODAY","TOGETHER","TOMORROW","TONE","TONIGHT","TOTAL","TOTALLY","TOUCH","TOUR","TOWARDS","TOWN","TRADE","TRADITION","TRAFFIC","TRAIN","TRAINING","TRANSFER","TRANSPORT","TRAVEL","TREAT","TREATMENT","TREATY","TREE","TREND","TRIAL","TRIP","TROOP","TROUBLE","TRUE","TRUST","TRUTH","TWENTY","TWICE","TYPE","UNDER","UNDERSTAND","UNION","UNIQUE","UNIT","UNITED","UNIVERSITY","UNLESS","UNLIKE","UNTIL","UPON","UPPER","URBAN","USER","USUAL","USUALLY","VALLEY","VALUE","VARIETY","VARIOUS","VEHICLE","VERSION","VERY","VIDEO","VIEW","VILLAGE","VIOLENCE","VISION","VISIT","VISITOR","VOICE","VOLUME","VOTE","WAIT","WALK","WALL","WANT","WAR","WATCH","WATER","WAY","WEALTH","WEAPON","WEAR","WEATHER","WEEK","WEEKEND","WEIGHT","WELCOME","WELL","WESTERN","WHAT","WHATEVER","WHEN","WHERE","WHETHER","WHICH","WHILE","WHITE","WHOLE","WHOM","WHOSE","WIDE","WIDELY","WIFE","WILD","WILL","WINDOW","WINE","WINTER","WISH","WITHIN","WITHOUT","WOMAN","WONDER","WOOD","WORD","WORK","WORKER","WORLD","WORRY","WORTH","WOULD","WRITE","WRITER","WRONG","YARD","YEAR","YOUNG","YOURSELF","YOUTH"];
        const prizeEmojis = [
            { emoji: '🎁', value: 1500000, type: 'coins' }, { emoji: '🏆', value: 3500000, type: 'trophy' }, { emoji: '💎', value: 20000000, type: 'diamond' }, { emoji: '💣', value: 0, type: 'game_over' }, { emoji: '💣', value: 0, type: 'green_bomb' }, { emoji: '⭐', value: 5000, type: 'coins' }, { emoji: '⚡', value: 20000, type: 'lightning' }, { emoji: '❄️', value: 0, type: 'freeze' }, { emoji: '🔥', value: 400, type: 'fire_column'}, { emoji: '💰', value: 1000000, type: 'cash_money' }
        ];
        const puzzleLayouts = [
            { length: 5, indices: [11, 12, 13, 14, 15] }, { length: 7, indices: [28, 29, 30, 31, 32, 33, 34] }, { length: 7, indices: [46, 47, 48, 49, 50, 51, 52] }, { length: 5, indices: [65, 66, 67, 68, 69] }
        ];
        
        function generatePuzzlesForLevel() {
            puzzles = [];
            let availableWords = [...wordBank];
            puzzleLayouts.forEach(layout => {
                const wordsOfLength = availableWords.filter(w => w.length === layout.length);
                if (wordsOfLength.length > 0) {
                    const word = wordsOfLength[Math.floor(Math.random() * wordsOfLength.length)];
                    puzzles.push({ word: word, indices: layout.indices, solved: false });
                    availableWords = availableWords.filter(w => w !== word); 
                }
            });
        }
        
        function startLevel() {
            document.getElementById('level-display').textContent = currentLevel;
            trophyCollectedThisLevel = false;
            diamondCollectedThisLevel = false;
            solveButtonClicks = 0;
            timeSinceLastSolve = 0;
            clearTimeout(diamondSequenceTimeout);
            clearTimeout(thawTimeout);
            const iconsContainer = document.getElementById('greed-icons-container');
            iconsContainer.innerHTML = '';
            generatePuzzlesForLevel();
            initializeGrid();
        }

        function initializeGrid() {
            gridContainer.innerHTML = '';
            puzzles.forEach(p => p.scrambled = shuffleWord(p.word));
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);

            for (let i = 0; i < 81; i++) {
                const tile = document.createElement('div');
                tile.classList.add('w-10', 'h-10', 'md:w-11', 'md:h-11', 'flex', 'items-center', 'justify-center', 'text-2xl', 'font-bold', 'rounded-lg', 'select-none');
                tile.id = `tile-${i}`;

                if (allPuzzleIndices.includes(i)) {
                    for (const puzzle of puzzles) {
                        if (puzzle.indices.includes(i)) {
                            const letterIndex = puzzle.indices.indexOf(i);
                            tile.textContent = puzzle.scrambled[letterIndex];
                            tile.classList.add('word-puzzle-tile');
                            tile.dataset.puzzleIndex = puzzles.indexOf(puzzle);
                            tile.draggable = true;
                            addDragListeners(tile);
                            break;
                        }
                    }
                } else if (i === 40) {
                    tile.id = 'jackpot-square';
                    tile.classList.add('bg-amber-500', 'border-2', 'border-amber-300', 'text-4xl');
                    tile.textContent = '💰';
                    tile.addEventListener('click', onJackpotClick);
                } else {
                    tile.classList.add('bg-slate-900/50', 'border', 'border-slate-800/50');
                }
                gridContainer.appendChild(tile);
            }
        }

        function shuffleWord(word) {
            let array = word.split('');
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            let shuffled = array.join('');
            return shuffled === word ? shuffleWord(word) : shuffled;
        }

        function addDragListeners(tile) {
            tile.addEventListener('dragstart', handleDragStart);
            tile.addEventListener('dragover', handleDragOver);
            tile.addEventListener('drop', handleDrop);
            tile.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(e) {
            if (timeRemaining <= 0) return;
            draggedTile = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);

            if (draggedTile.dataset.prizeType === 'green_bomb') {
                isDraggingBomb = true;
                document.getElementById('bomb-drag-preview').style.display = 'block';
            }
        }

        function handleDragOver(e) { 
            e.preventDefault(); 
            if (isDraggingBomb) {
                const targetTile = e.target.closest('#game-grid > div');
                if (targetTile) {
                    const preview = document.getElementById('bomb-drag-preview');
                    const rect = targetTile.getBoundingClientRect();
                    const gridRect = gridContainer.getBoundingClientRect();
                    const size = rect.width;

                    preview.style.width = `${size * 3}px`;
                    preview.style.height = `${size * 3}px`;
                    preview.style.left = `${rect.left - gridRect.left - size}px`;
                    preview.style.top = `${rect.top - gridRect.top - size}px`;
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('#game-grid > div');
            if (!dropTarget) return;

            if (isDraggingBomb && draggedTile) {
                startGreenBombSequence(dropTarget);
                draggedTile.textContent = '';
                draggedTile.classList.remove('prize-tile', 'green-bomb');
                draggedTile.draggable = false;
            }
            else if (dropTarget.classList.contains('word-puzzle-tile') && 
                draggedTile && draggedTile.classList.contains('word-puzzle-tile') &&
                dropTarget.dataset.puzzleIndex === draggedTile.dataset.puzzleIndex &&
                draggedTile !== dropTarget && !dropTarget.classList.contains('solved')) {
                const tempText = draggedTile.textContent;
                draggedTile.textContent = dropTarget.textContent;
                dropTarget.textContent = tempText;
                checkAllPuzzles();
            }
        }
        
        function handleDragEnd(e) { 
            e.target.classList.remove('dragging'); 
            if (isDraggingBomb) {
                isDraggingBomb = false;
                document.getElementById('bomb-drag-preview').style.display = 'none';
            }
            draggedTile = null;
        }

        function checkAllPuzzles() {
            let allWordsOnBoardAreSolved = true;
            puzzles.forEach((puzzle) => {
                if (!puzzle.solved) {
                    let currentWord = '';
                    puzzle.indices.forEach(index => { currentWord += document.getElementById(`tile-${index}`).textContent; });

                    if (currentWord === puzzle.word) {
                        puzzle.solved = true;
                        timeSinceLastSolve = 0;
                        coins += 10000;
                        updateScoreDisplay();
                        flashScore('gain');
                        const middleTileIndex = puzzle.indices[Math.floor(puzzle.indices.length / 2)];
                        const startTile = document.getElementById(`tile-${middleTileIndex}`);
                        if (!isFrozen) {
                            triggerCoinAnimation(startTile, document.getElementById('coins-display'));
                        }
                        puzzle.indices.forEach(index => {
                            const tile = document.getElementById(`tile-${index}`);
                            tile.classList.add('solved');
                            tile.draggable = false;
                        });
                    } else {
                        allWordsOnBoardAreSolved = false;
                    }
                }
            });

            if (allWordsOnBoardAreSolved && puzzles.length > 0) {
                if (isFrozen) endFreeze();
                coins += 100000;
                updateScoreDisplay();
                flashScore('gain');
                showEventText("Level Up!");
                flashLevelPanel();
                currentLevel++;
                setTimeout(() => startLevel(), 1500);
            }
        }

        function formatScore(num) {
            if (num < 1000000000) {
                return num.toLocaleString();
            }
            const si = [
                { value: 1E12, symbol: "T" },
                { value: 1E9,  symbol: "B" },
            ];
            const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
            let i;
            for (i = 0; i < si.length; i++) {
                if (num >= si[i].value) {
                    return (num / si[i].value).toFixed(2).replace(rx, "$1") + si[i].symbol;
                }
            }
            return num.toLocaleString();
        }

        function updateScoreDisplay() {
            bagsOfMoney = Math.floor(currentLevel * (Math.floor(coins / 1000) / 10));
            document.getElementById('coins-display').textContent = formatScore(coins);
            document.getElementById('bags-of-money-display').textContent = bagsOfMoney.toLocaleString();
            document.getElementById('coins-display').classList.remove('score-decay');
        }

        function flashScore(type = 'gain') {
            const coinsDisplay = document.getElementById('coins-display');
            const flashClass = type === 'gain' ? 'gain-flash' : 'deduct-flash';
            coinsDisplay.classList.remove('gain-flash', 'deduct-flash');
            void coinsDisplay.offsetWidth;
            coinsDisplay.classList.add(flashClass);
            setTimeout(() => { coinsDisplay.classList.remove(flashClass); }, 800);
        }

        function flashBagsPanel() {
            const bagsDisplay = document.getElementById('bags-of-money-display');
            bagsDisplay.classList.add('deduct-flash');
            setTimeout(() => { bagsDisplay.classList.remove('deduct-flash'); }, 1200);
        }

        function flashLevelPanel() {
            const levelDisplay = document.getElementById('level-display');
            levelDisplay.classList.add('level-flash');
            setTimeout(() => { levelDisplay.classList.remove('level-flash'); }, 1500);
        }
        
        function updateTimer() {
            if (timeRemaining > 0 && !isGamePaused) {
                timeRemaining--;
                timeSinceLastSolve++;
                const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
                const seconds = (timeRemaining % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').textContent = `${minutes}:${seconds}`;

                if (timeRemaining === 580 && !specialCashEmojiSpawned) {
                    specialCashEmojiSpawned = true;
                    spawnSpecialCashEmoji();
                }
                if (timeRemaining === 360 && impEvents.sixMin) {
                    impEvents.sixMin = false;
                    spawnImp();
                }
                if (timeRemaining === 180 && impEvents.threeMin) {
                    impEvents.threeMin = false;
                    spawnImp();
                }
                if (timeRemaining === 300 && jackpotEventAvailable) {
                    jackpotEventAvailable = false;
                    activateSpecialJackpot();
                }
            } else if (timeRemaining <= 0) {
                endGame();
            }
        }
        
        function activateSpecialJackpot() {
            const jackpotSquare = document.getElementById('jackpot-square');
            jackpotSquare.classList.add('wild-pulse');
            const specialJackpotHandler = () => {
                coins += 50000000;
                updateScoreDisplay();
                flashScore('gain');
                showEventText('💰 50,000,000 💰');
                
                jackpotSquare.classList.remove('wild-pulse');
                clearTimeout(specialJackpotTimeout);
                jackpotSquare.removeEventListener('click', specialJackpotHandler);
            };
            jackpotSquare.addEventListener('click', specialJackpotHandler);

            specialJackpotTimeout = setTimeout(() => {
                jackpotSquare.classList.remove('wild-pulse');
                jackpotSquare.removeEventListener('click', specialJackpotHandler);
            }, 15000);
        }

        function triggerCoinAnimation(startElement, endElement) {
            const startRect = startElement.getBoundingClientRect();
            const endRect = endElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const controlX = startX + (endX - startX) / 2;
            const controlY = startY - 100;
            const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;

            for (let i = 0; i < 15; i++) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                coin.style.animation = `fly-along-path 0.8s cubic-bezier(0.4, 0, 0.9, 0.5) forwards`;
                coin.style.offsetPath = `path('${curve}')`;
                coin.style.animationDelay = `${Math.random() * 0.3}s`;
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 1100);
            }
        }

        function triggerBigCoinAnimation(startElement, endElement) {
            const startRect = startElement.getBoundingClientRect();
            const endRect = endElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const controlX = startX + (endX - startX) / 2;
            const controlY = startY - 100;
            const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;
            
            const coin = document.createElement('div');
            coin.classList.add('coin');
            coin.style.animation = `big-coin-tumble 0.8s ease-out forwards, fly-along-path 0.8s ease-out forwards`;
            coin.style.offsetPath = `path('${curve}')`;
            document.body.appendChild(coin);
            setTimeout(() => coin.remove(), 800);
        }

        function triggerCoinImplosion(originElement) {
            const originRect = originElement.getBoundingClientRect();
            const endRect = document.getElementById('coins-display').getBoundingClientRect();
            const centerX = originRect.left + originRect.width / 2;
            const centerY = originRect.top + originRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const startRadius = 100;

            for (let i = 0; i < 20; i++) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                const angle = (i / 20) * (2 * Math.PI);
                const startX = centerX + Math.cos(angle) * startRadius;
                const startY = centerY + Math.sin(angle) * startRadius;
                const controlX = startX + (endX - startX) / 2 + (Math.random() - 0.5) * 200;
                const controlY = startY + (endY - startY) / 2 + (Math.random() - 0.5) * 200;
                const curve = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;

                coin.style.offsetPath = `path('${curve}')`;
                coin.style.animation = `coin-swirl-in 1s cubic-bezier(0.5, 0, 0.9, 0.5) forwards`;
                coin.style.animationDelay = `${Math.random() * 0.3}s`;
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 1300);
            }
        }

        function onSolveButtonClick() {
            if (timeRemaining <= 0 || solveButtonCooldown > 0) return;
            const unsolvedPuzzles = puzzles.filter(p => !p.solved);
            if (unsolvedPuzzles.length === 0) return;

            solveButtonClicks++;
            triggerCoinImplosion(document.getElementById('solve-button'));
            coins -= 200000;
            updateScoreDisplay();
            flashScore('deduct');

            const puzzleToSolve = unsolvedPuzzles[Math.floor(Math.random() * unsolvedPuzzles.length)];
            puzzleToSolve.indices.forEach((tileIndex, letterIndex) => {
                document.getElementById(`tile-${tileIndex}`).textContent = puzzleToSolve.word[letterIndex];
            });
            checkAllPuzzles();

            if (solveButtonClicks >= 4) {
                startSolveButtonCooldown();
            }
        }

        function startSolveButtonCooldown() {
            solveButtonCooldown = 60;
            const solveButton = document.getElementById('solve-button');
            solveButton.disabled = true;
            solveButton.classList.remove('text-3xl');
            solveButton.classList.add('cooldown-timer');
            
            solveButtonTimerInterval = setInterval(() => {
                if (solveButtonCooldown > 0) {
                    solveButtonCooldown--;
                    solveButton.textContent = `0:${solveButtonCooldown.toString().padStart(2, '0')}`;
                } else {
                    clearInterval(solveButtonTimerInterval);
                    solveButton.textContent = '✅';
                    solveButton.classList.remove('cooldown-timer');
                    solveButton.classList.add('text-3xl');
                    solveButton.disabled = false;
                    solveButtonClicks = 0;
                }
            }, 1000);
        }

        let GJACKVARNUM = 0;
        function onJackpotClick(event) {
            timeSinceLastSolve = 0; 
            
            const jackpotSquare = event.currentTarget;
            if (jackpotSquare.classList.contains('cooldown')) return;

            GJACKVARNUM++; 

            coins += 50000; 
            updateScoreDisplay();
            flashScore('gain');
            triggerCoinAnimation(jackpotSquare, document.getElementById('coins-display'));

            if (GJACKVARNUM >= 4) {
                showEventText("Yep! You're Greedy!");
                GJACKVARNUM = 0; 
                
                jackpotSquare.classList.add('cooldown');
                setTimeout(() => {
                    jackpotSquare.classList.remove('cooldown');
                }, 2000);
            }
        }

        function reinitializeJackpotSquare(square) {
            square.textContent = '💰';
            square.style.backgroundColor = '';
            square.classList.remove('cooldown');
        }

        function scheduleNextPrizeSpawn() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen || isSpecialAnimationActive) return;
            const timeElapsed = totalGameTime - timeRemaining;
            const progress = timeElapsed / totalGameTime;
            const maxDelay = 2500;
            const minDelay = 100;
            const currentDelay = minDelay + (maxDelay - minDelay) * Math.pow(1 - progress, 3);

            prizeSpawnerTimeout = setTimeout(() => {
                spawnPrizeEmoji();
                scheduleNextPrizeSpawn();
            }, currentDelay);
        }

        function spawnPrizeEmoji() {
            if (timeRemaining <= 0 || isGamePaused || isFrozen) return;

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) {
                        emptyTiles.push(tile);
                    }
                }
            }

            if (emptyTiles.length === 0) return;

            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            
            let prizePool = prizeEmojis.filter(p => p.type !== 'cash_money');
            if (timeRemaining > 580) {
                prizePool = prizePool.filter(p => p.type !== 'freeze' && p.type !== 'game_over' && p.type !== 'green_bomb');
            }

            const prize = prizePool[Math.floor(Math.random() * prizePool.length)];
            tile.textContent = prize.emoji;
            tile.dataset.prizeValue = prize.value;
            tile.dataset.prizeType = prize.type;
            tile.classList.add('prize-tile');

            if (prize.type === 'game_over') tile.classList.add('red-bomb');
            else if (prize.type === 'green_bomb') {
                tile.classList.add('green-bomb');
                tile.draggable = true;
                addDragListeners(tile);
            }
            else if (prize.type === 'fire_column') tile.classList.add('fire-bomb');
            
            const clickHandler = () => {
                if (tile.dataset.prizeType === 'game_over') { endGame(true); } 
                else if (tile.dataset.prizeType === 'diamond') { startDiamondSequence(tile); } 
                else if (tile.dataset.prizeType === 'green_bomb') { startGreenBombSequence(tile); }
                else if (tile.dataset.prizeType === 'fire_column') { startFireColumnSequence(tile); }
                else if (tile.dataset.prizeType === 'freeze') { startFreezeSequence(); }
                else if (tile.dataset.prizeType === 'lightning') {
                    bagsOfMoney = 0;
                    coins += parseInt(tile.dataset.prizeValue);
                    updateScoreDisplay();
                    flashBagsPanel();
                    triggerCoinAnimation(tile, document.getElementById('coins-display'));
                }
                else {
                    coins += parseInt(tile.dataset.prizeValue);
                    updateScoreDisplay();
                    flashScore('gain');
                    triggerCoinAnimation(tile, document.getElementById('coins-display'));
                    if (tile.dataset.prizeType === 'trophy' && !trophyCollectedThisLevel) {
                        trophyCollectedThisLevel = true;
                        updateGreedPanelWithTrophy();
                        showEventText("Oh Yeah!");
                    }
                }
                tile.textContent = '';
                tile.classList.remove('prize-tile', 'red-bomb', 'green-bomb', 'fire-bomb', 'cash-money-prize');
            };

            const despawnTimer = setTimeout(() => {
                tile.textContent = '';
                tile.classList.remove('prize-tile', 'red-bomb', 'green-bomb', 'fire-bomb', 'cash-money-prize');
                tile.removeEventListener('click', clickHandler, { once: true });
            }, 5000);

            tile.addEventListener('click', () => {
                clearTimeout(despawnTimer);
                clickHandler();
            }, { once: true });
        }

        function spawnSpecialCashEmoji() {
             if (isGamePaused || isGameOver || isFrozen) return;
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;

            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            const prize = prizeEmojis.find(p => p.type === 'cash_money');
            tile.textContent = prize.emoji;
            tile.dataset.prizeValue = prize.value;
            tile.dataset.prizeType = prize.type;
            tile.classList.add('prize-tile', 'cash-money-prize');
            
            const clickHandler = () => {
                coins += parseInt(tile.dataset.prizeValue);
                updateScoreDisplay();
                flashScore('gain');
                showEventText('💰 1,000,000 💰', true);
                tile.textContent = '';
                tile.classList.remove('prize-tile', 'cash-money-prize');
            };
            tile.addEventListener('click', clickHandler, { once: true });
        }

        function spawnImp() {
            if (isGamePaused || isGameOver || isFrozen) return;
            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const emptyTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if (!tile.textContent) emptyTiles.push(tile);
                }
            }
            if (emptyTiles.length === 0) return;

            const tile = emptyTiles[Math.floor(Math.random() * emptyTiles.length)];
            tile.innerHTML = `<div class="w-full h-full flex items-center justify-center prize-tile red-bomb">😈</div>`;
            const impElement = tile.firstChild;

            const clickHandler = () => {
                coins = 0;
                updateScoreDisplay();
                showEventText("Ha ha!");
                tile.innerHTML = '';
                tile.classList.remove('prize-tile', 'red-bomb');
                clearTimeout(despawnTimer);
            };

            const despawnTimer = setTimeout(() => {
                tile.innerHTML = '';
                tile.classList.remove('prize-tile', 'red-bomb');
                impElement.removeEventListener('click', clickHandler, { once: true });
            }, 10000);

            impElement.addEventListener('click', clickHandler, { once: true });
        }

        function updateGreedPanelWithTrophy() {
            const iconsContainer = document.getElementById('greed-icons-container');
            const trophyElement = document.createElement('div');
            trophyElement.classList.add('greed-icon');
            trophyElement.textContent = '🏆';
            trophyElement.addEventListener('click', () => {
                showEventText("You're so greedy!");
            });
            iconsContainer.appendChild(trophyElement);
        }
        
        function updateGreedPanelWithDiamond() {
            if (diamondCollectedThisLevel) return;
            diamondCollectedThisLevel = true;
            const iconsContainer = document.getElementById('greed-icons-container');
            const diamondElement = document.createElement('div');
            diamondElement.classList.add('greed-icon');
            diamondElement.textContent = '💎';
            diamondElement.addEventListener('click', () => {
                showEventText("You're so greedy!");
            });
            iconsContainer.appendChild(diamondElement);
        }

        function showEventText(text, greenGlow = false) {
            const eventTextContainer = document.getElementById('event-text-container');
            const eventText = document.getElementById('event-text');
            eventText.textContent = text;
            eventText.classList.toggle('green-glow', greenGlow);
            
            eventTextContainer.classList.remove('hidden');
            setTimeout(() => {
                eventTextContainer.classList.add('hidden');
                eventText.classList.remove('green-glow');
            }, 2000);
        }

        function startDiamondSequence(clickedTile) {
            isSpecialAnimationActive = true;
            coins += currentDiamondValue;
            updateScoreDisplay();
            flashScore('gain');
            showEventText("You're Greedy!");
            currentDiamondValue = Math.floor(currentDiamondValue / 2);
            updateGreedPanelWithDiamond();

            document.querySelectorAll('.prize-tile').forEach(t => {
                if (t !== clickedTile) { 
                    t.textContent = ''; 
                    t.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });

            const allPuzzleIndices = puzzles.flatMap(p => p.indices);
            const diamondTiles = [];
            for(let i=0; i<81; i++) {
                if (!allPuzzleIndices.includes(i) && i !== 40) {
                    const tile = document.getElementById(`tile-${i}`);
                    if(tile) {
                        tile.textContent = '💎';
                        tile.classList.add('temp-diamond');
                        diamondTiles.push(tile);
                    }
                }
            }

            diamondSequenceTimeout = setTimeout(() => {
                triggerVortexAnimation(diamondTiles);
            }, 2000);
        }

        function triggerVortexAnimation(diamondTiles) {
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            diamondTiles.forEach(tile => {
                if (!tile || !document.body.contains(tile)) return;
                const startRect = tile.getBoundingClientRect();
                const startX = startRect.left;
                const startY = startRect.top;

                const flyingDiamond = document.createElement('div');
                flyingDiamond.textContent = '💎';
                flyingDiamond.classList.add('temp-diamond');
                flyingDiamond.style.position = 'absolute';
                flyingDiamond.style.left = `${startX}px`;
                flyingDiamond.style.top = `${startY}px`;
                flyingDiamond.style.zIndex = '200';
                flyingDiamond.style.setProperty('--start-x', `0px`);
                flyingDiamond.style.setProperty('--start-y', `0px`);
                flyingDiamond.style.setProperty('--end-x', `${endX - startX}px`);
                flyingDiamond.style.setProperty('--end-y', `${endY - startY}px`);
                flyingDiamond.style.animation = `diamond-vortex 1s ease-in forwards`;
                document.body.appendChild(flyingDiamond);

                tile.textContent = '';
                tile.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                setTimeout(() => { flyingDiamond.remove(); }, 1000);
            });

            setTimeout(() => {
                 isSpecialAnimationActive = false;
                 scheduleNextPrizeSpawn();
            }, 1500);
        }
        
        function getAdjacentIndices(index) {
            const indices = [];
            const row = Math.floor(index / 9);
            const col = index % 9;
            for (let r = -1; r <= 1; r++) {
                for (let c = -1; c <= 1; c++) {
                    const newRow = row + r;
                    const newCol = col + c;
                    if (newRow >= 0 && newRow < 9 && newCol >= 0 && newCol < 9) {
                        indices.push(newRow * 9 + newCol);
                    }
                }
            }
            return indices;
        }

        function startGreenBombSequence(bombTile) {
            const bombIndex = parseInt(bombTile.id.split('-')[1]);
            const adjacentIndices = getAdjacentIndices(bombIndex);
            
            adjacentIndices.forEach(index => {
                const adjTile = document.getElementById(`tile-${index}`);
                if (adjTile && adjTile.classList.contains('prize-tile')) {
                    const prizeValue = parseInt(adjTile.dataset.prizeValue) || 0;
                    coins += prizeValue;
                    triggerCoinAnimation(adjTile, document.getElementById('coins-display'));
                    adjTile.textContent = '';
                    adjTile.classList.remove('prize-tile', 'red-bomb', 'green-bomb');
                } else if (adjTile && adjTile.classList.contains('word-puzzle-tile') && !adjTile.classList.contains('solved')) {
                    const puzzleIndex = parseInt(adjTile.dataset.puzzleIndex);
                    const puzzle = puzzles[puzzleIndex];
                    const letterIndex = puzzle.indices.indexOf(index);
                    const correctLetter = puzzle.word[letterIndex];
                    
                    for (const i of puzzle.indices) {
                        const sourceTile = document.getElementById(`tile-${i}`);
                        if (sourceTile && sourceTile.textContent === correctLetter) {
                            const tempText = adjTile.textContent;
                            adjTile.textContent = sourceTile.textContent;
                            sourceTile.textContent = tempText;
                            break;
                        }
                    }
                    coins += 1;
                    triggerBigCoinAnimation(adjTile, document.getElementById('coins-display'));
                }
            });

            setTimeout(() => {
                updateScoreDisplay();
                checkAllPuzzles();
            }, 100);
        }

        function startFireColumnSequence(fireTile) {
            const fireIndex = parseInt(fireTile.id.split('-')[1]);
            const column = fireIndex % 9;

            for (let i = column; i < 81; i += 9) {
                const tileInColumn = document.getElementById(`tile-${i}`);
                if (tileInColumn) {
                    if (tileInColumn.classList.contains('prize-tile')) {
                        tileInColumn.textContent = '';
                        tileInColumn.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                    } else if (tileInColumn.classList.contains('word-puzzle-tile') && !tileInColumn.classList.contains('solved')) {
                        const puzzleIndex = parseInt(tileInColumn.dataset.puzzleIndex);
                        const puzzle = puzzles[puzzleIndex];
                        const letterIndex = puzzle.indices.indexOf(i);
                        const correctLetter = puzzle.word[letterIndex];
                        if (tileInColumn.textContent !== correctLetter) {
                            for (const sourceIndex of puzzle.indices) {
                                const sourceTile = document.getElementById(`tile-${sourceIndex}`);
                                if (sourceTile && sourceTile.textContent === correctLetter) {
                                    const tempText = tileInColumn.textContent;
                                    tileInColumn.textContent = sourceTile.textContent;
                                    sourceTile.textContent = tempText;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            coins += 400;
            updateScoreDisplay();
            flashScore('gain');
            checkAllPuzzles();
        }

        function endGame(isBomb = false) {
            isGameOver = true;
            savePlayerData();
            clearInterval(mainTimerInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(diamondSequenceTimeout);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            clearTimeout(thawTimeout);
            timeRemaining = 0;
            document.getElementById('timer-display').textContent = "00:00";
            triggerSwirlAnimation();
            setTimeout(showGameOverModal, 1500);
        }

        function triggerSwirlAnimation() {
            const elementsToSwirl = document.querySelectorAll('#game-grid > div');
            const vortexCenterEl = document.getElementById('jackpot-square');
            if (!vortexCenterEl) return;
            const vortexCenter = vortexCenterEl.getBoundingClientRect();
            const endX = vortexCenter.left + vortexCenter.width / 2;
            const endY = vortexCenter.top + vortexCenter.height / 2;

            elementsToSwirl.forEach(el => {
                if (el.textContent) {
                    const startRect = el.getBoundingClientRect();
                    const startX = startRect.left;
                    const startY = startRect.top;
                    const flyingEl = el.cloneNode(true);
                    flyingEl.style.position = 'absolute';
                    flyingEl.style.left = `${startX}px`;
                    flyingEl.style.top = `${startY}px`;
                    flyingEl.style.zIndex = '200';
                    flyingEl.style.margin = '0';
                    flyingEl.style.setProperty('--start-x', `0px`);
                    flyingEl.style.setProperty('--start-y', `0px`);
                    flyingEl.style.setProperty('--end-x', `${endX - startX}px`);
                    flyingEl.style.setProperty('--end-y', `${endY - startY}px`);
                    flyingEl.style.animation = `game-over-swirl 1.5s ease-in forwards`;
                    document.body.appendChild(flyingEl);
                    el.textContent = '';
                    el.className = 'w-10 h-10 md:w-11 md:h-11 flex items-center justify-center text-2xl font-bold rounded-lg select-none bg-slate-900/50 border border-slate-800/50';
                }
            });
        }

        function showGameOverModal() {
            displayLeaderboard();
            document.getElementById('game-over-modal').classList.remove('hidden');
        }
        
        function displayLeaderboard() {
            const fakeScores = [
                { name: 'Olivia', score: 234000000 }, { name: 'James', score: 42000000 },
                { name: 'Sophia', score: 35000000 }, { name: 'Liam', score: 28000000 },
            ];
            
            const allScores = [...fakeScores, { name: playerData.name || 'You', score: coins }];
            allScores.sort((a, b) => b.score - a.score);
            const top5 = allScores.slice(0, 5);
            const container = document.getElementById('leaderboard-container');
            container.innerHTML = `
                <h3 class="text-2xl font-bold text-amber-300 mb-4">Top 5 Players</h3>
                <ol class="text-left w-full space-y-2">
                    ${top5.map((entry, index) => `
                        <li class="flex justify-between p-2 rounded-lg ${entry.name === (playerData.name || 'You') ? 'bg-purple-600' : 'bg-black/20'}">
                            <span class="font-bold">${index + 1}. ${entry.name} (Lvl ${entry.name === (playerData.name || 'You') ? currentLevel : Math.floor(Math.random() * 15) + 5})</span>
                            <span class="font-semibold">${formatScore(entry.score)}</span>
                        </li>
                    `).join('')}
                </ol>
            `;
        }

        function pauseGame() {
            isGamePaused = true;
            clearInterval(mainTimerInterval);
            clearTimeout(prizeSpawnerTimeout);
            clearInterval(scoreDecayInterval);
            clearTimeout(impTimeout);
            document.querySelectorAll('.ice-block').forEach(block => block.style.display = 'none');
        }

        function resumeGame() {
            if (isGameOver) return;
            isGamePaused = false;
            mainTimerInterval = setInterval(updateTimer, 1000);
            if (!isFrozen) {
                scheduleNextPrizeSpawn();
            }
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
            document.querySelectorAll('.ice-block').forEach(block => block.style.display = 'block');
        }

        function handleScoreDecay() {
            if (isGamePaused || isGameOver) return;
            if (timeSinceLastSolve > 20) {
                const decayAmount = Math.floor(Math.pow(timeSinceLastSolve - 19, 1.5) * 10);
                coins -= decayAmount;
                if (coins < 0) coins = 0;
                updateScoreDisplay();
                document.getElementById('coins-display').classList.add('score-decay');
            } else {
                document.getElementById('coins-display').classList.remove('score-decay');
            }
        }

        function startFreezeSequence() {
            isFrozen = true;
            clearTimeout(prizeSpawnerTimeout);
            clearTimeout(impTimeout);
            const frozenTiles = [];
            document.querySelectorAll('#game-grid > div:not(.word-puzzle-tile)').forEach(tile => {
                const rect = tile.getBoundingClientRect();
                const iceBlock = document.createElement('div');
                iceBlock.className = 'ice-block';
                iceBlock.style.width = `${rect.width}px`;
                iceBlock.style.height = `${rect.height}px`;
                iceBlock.style.left = `${rect.left}px`;
                iceBlock.style.top = `${rect.top}px`;
                document.body.appendChild(iceBlock);
                frozenTiles.push(iceBlock);
            });

            thawTimeout = setTimeout(() => {
                const thawDuration = 15000;
                if (frozenTiles.length === 0) {
                    endFreeze();
                    return;
                }
                const thawIntervalTime = thawDuration / frozenTiles.length;
                
                function thawNext() {
                    if (frozenTiles.length > 0) {
                        const tileToThaw = frozenTiles.shift();
                        if (tileToThaw) {
                            tileToThaw.remove();
                        }
                        setTimeout(thawNext, thawIntervalTime);
                    } else {
                        endFreeze();
                    }
                }
                thawNext();
            }, 15000);
        }

        function endFreeze() {
            clearTimeout(thawTimeout);
            isFrozen = false;
            document.querySelectorAll('.ice-block').forEach(block => block.remove());
            if (!isGamePaused && !isGameOver) {
                setTimeout(() => scheduleNextPrizeSpawn(), 500);
            }
        }
        
        function startGame() {
            musicPlayer.volume = 0.5;
            lastVolume = 0.5;
            document.getElementById('volume-slider').value = 0.5;
            updateVolumeIcon(0.5);

            playNextTrack();

            document.getElementById('start-modal').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('game-container').classList.add('flex');
            clearInterval(startModalAnimationInterval);
            isGamePaused = false;
            mainTimerInterval = setInterval(updateTimer, 1000);
            scoreDecayInterval = setInterval(handleScoreDecay, 1000);
            scheduleNextPrizeSpawn();
        }

        function playNextTrack() {
            if (userPlaylist.length === 0) {
                return; 
            }
            currentTrackIndex = (currentTrackIndex + 1) % userPlaylist.length;
            const trackName = userPlaylist[currentTrackIndex];
            musicPlayer.src = musicBaseURL + trackName;
            musicPlayer.play().catch(error => console.error("Audio play failed for " + trackName + ":", error));
        }
        
        function setupAudioControls() {
            const volumeSlider = document.getElementById('volume-slider');
            const volumeToggleButton = document.getElementById('volume-toggle-button');

            volumeSlider.value = lastVolume;
            updateVolumeIcon(musicPlayer.volume);

            volumeSlider.addEventListener('input', (e) => {
                const newVolume = parseFloat(e.target.value);
                musicPlayer.volume = newVolume;
                updateVolumeIcon(newVolume);
                if (newVolume > 0) {
                    lastVolume = newVolume;
                }
            });

            volumeToggleButton.addEventListener('click', () => {
                if (musicPlayer.volume > 0) {
                    musicPlayer.volume = 0;
                    volumeSlider.value = 0;
                    updateVolumeIcon(0);
                } else {
                    musicPlayer.volume = lastVolume;
                    volumeSlider.value = lastVolume;
                    updateVolumeIcon(lastVolume);
                }
            });
        }

        function updateVolumeIcon(volume) {
            const volumeToggleButton = document.getElementById('volume-toggle-button');
            const favicon = document.getElementById('favicon');
            
            if (volume === 0) {
                volumeToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`;
                favicon.href = mutedIconHref;
            } else {
                 volumeToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
                 favicon.href = speakerIconHref;
            }
        }

        function populatePlaylistModal() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';
            verifiedPlaylist.forEach(trackName => {
                const isChecked = userPlaylist.includes(trackName);
                const item = document.createElement('label');
                item.className = 'playlist-item';
                item.innerHTML = `
                    <input type="checkbox" value="${trackName}" ${isChecked ? 'checked' : ''}>
                    <span class="custom-checkbox">
                        <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    </span>
                    <span>${trackName}</span>
                `;
                container.appendChild(item);

                item.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        userPlaylist.push(e.target.value);
                    } else {
                        userPlaylist = userPlaylist.filter(t => t !== e.target.value);
                    }
                    userPlaylist.sort((a, b) => verifiedPlaylist.indexOf(a) - verifiedPlaylist.indexOf(b));
                });
            });
        }
        
        async function buildVerifiedPlaylist() {
            const checkTrack = async (trackName) => {
                try {
                    const response = await fetch(musicBaseURL + trackName, { method: 'HEAD' });
                    return response.ok;
                } catch (error) {
                    console.error("Network error checking track:", trackName, error);
                    return false;
                }
            };
            const checks = playlist.map(track => checkTrack(track));
            const results = await Promise.all(checks);
            verifiedPlaylist = playlist.filter((_, index) => results[index]);
            userPlaylist = [...verifiedPlaylist];
        }

        async function initGame() {
            await buildVerifiedPlaylist();
            loadPlayerData();
            startLevel();
            updateScoreDisplay();
            setupAudioControls();
            populatePlaylistModal();
            populateSetupModal();
            
            const startModal = document.getElementById('start-modal');
            startModalAnimationInterval = setInterval(() => {
                const coin = document.createElement('div');
                coin.classList.add('falling-coin');
                coin.textContent = '🪙';
                coin.style.left = `${Math.random() * 100}%`;
                coin.style.animationDuration = `${Math.random() * 2 + 3}s`;
                coin.style.fontSize = `${Math.random() * 1 + 0.5}rem`;
                startModal.appendChild(coin);
                setTimeout(() => coin.remove(), 5000);

                if (Math.random() < 0.3) {
                    const sparkle = document.createElement('div');
                    sparkle.classList.add('sparkle');
                    sparkle.style.left = `${Math.random() * 100}%`;
                    sparkle.style.top = `${Math.random() * 100}%`;
                    sparkle.style.animationDuration = `${Math.random() * 1 + 0.5}s`;
                    startModal.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 1500);
                }
            }, 300);

            // --- Event Listeners ---
            musicPlayer.addEventListener('ended', playNextTrack);
            document.getElementById('start-game-button').addEventListener('click', startGame);
            document.getElementById('play-again-button').addEventListener('click', () => { 
                savePlayerData();
                location.reload(); 
            });
            document.getElementById('help-button').addEventListener('click', () => {
                pauseGame();
                document.getElementById('help-modal').classList.remove('hidden');
            });
            document.getElementById('close-help-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                resumeGame();
            });
            document.getElementById('solve-button').addEventListener('click', onSolveButtonClick);

            document.getElementById('about-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                document.getElementById('about-modal').classList.remove('hidden');
            });
            document.getElementById('close-about-button').addEventListener('click', () => {
                document.getElementById('about-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });
            
            document.getElementById('playlist-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                document.getElementById('playlist-modal').classList.remove('hidden');
            });
            document.getElementById('close-playlist-button').addEventListener('click', () => {
                document.getElementById('playlist-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });

            document.getElementById('setup-button').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('hidden');
                populateSetupModal();
                document.getElementById('setup-modal').classList.remove('hidden');
            });
            document.getElementById('close-setup-button').addEventListener('click', () => {
                document.getElementById('setup-modal').classList.add('hidden');
                document.getElementById('help-modal').classList.remove('hidden');
            });

            document.getElementById('reset-progress-button').addEventListener('click', () => {
                document.getElementById('confirm-reset-modal').classList.remove('hidden');
            });
            document.getElementById('cancel-reset-button').addEventListener('click', () => {
                document.getElementById('confirm-reset-modal').classList.add('hidden');
            });
            document.getElementById('confirm-reset-button').addEventListener('click', () => {
                playerData = getDefaultPlayerData();
                localStorage.removeItem('wordGreedPlayerData');
                populateSetupModal();
                applyTheme('default');
                document.getElementById('confirm-reset-modal').classList.add('hidden');
            });


            document.querySelectorAll('.difficulty-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.difficulty-button').forEach(btn => btn.classList.remove('difficulty-active'));
                    const clickedButton = e.currentTarget;
                    clickedButton.classList.add('difficulty-active');

                    if (clickedButton.id === 'difficulty-easy') maxSameEmoji = 8;
                    else if (clickedButton.id === 'difficulty-medium') maxSameEmoji = 4;
                    else if (clickedButton.id === 'difficulty-hard') maxSameEmoji = 2;
                    else maxSameEmoji = 4;
                });
            });
        }

        // --- NEW: Player Data & Store Logic ---
        function getDefaultPlayerData() {
            return {
                name: '',
                moneyBags: 0,
                highScore: 0,
                gamesPlayed: 0,
                unlockedSkins: ['default'],
                activeSkin: 'default'
            };
        }

        function loadPlayerData() {
            const savedData = localStorage.getItem('wordGreedPlayerData');
            if (savedData) {
                playerData = JSON.parse(savedData);
            } else {
                playerData = getDefaultPlayerData();
            }
            applyTheme(playerData.activeSkin);
        }

        function savePlayerData() {
            playerData.gamesPlayed++;
            playerData.moneyBags += bagsOfMoney;
            if (coins > playerData.highScore) {
                playerData.highScore = coins;
            }
            localStorage.setItem('wordGreedPlayerData', JSON.stringify(playerData));
        }

        function populateSetupModal() {
            document.getElementById('player-name-input').value = playerData.name;
            document.getElementById('total-bags-display').textContent = playerData.moneyBags.toLocaleString();
            document.getElementById('high-score-display').textContent = formatScore(playerData.highScore);
            document.getElementById('games-played-display').textContent = playerData.gamesPlayed;
            populateThemeStore();
        }

        function applyTheme(themeId) {
            document.body.className = 'text-white flex items-center justify-center min-h-screen p-4';
            if (themeId !== 'default') {
                document.body.classList.add(`theme-${themeId}`);
            }
        }

        const themes = [
            { id: 'default', name: 'Purple Haze', cost: 0, colors: ['#a78bfa', '#8b5cf6'] },
            { id: 'blue', name: 'Ocean Blue', cost: 100, colors: ['#60a5fa', '#3b82f6'] },
            { id: 'green', name: 'Emerald City', cost: 250, colors: ['#4ade80', '#22c55e'] },
            { id: 'red', name: 'Ruby Rush', cost: 500, colors: ['#f87171', '#ef4444'] }
        ];

        function populateThemeStore() {
            const container = document.getElementById('theme-store-container');
            container.innerHTML = '';
            themes.forEach(theme => {
                const isUnlocked = playerData.unlockedSkins.includes(theme.id);
                const isActive = playerData.activeSkin === theme.id;

                const item = document.createElement('div');
                item.className = `theme-item p-2 rounded-lg flex flex-col items-center justify-center ${isActive ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
                item.style.background = `linear-gradient(145deg, ${theme.colors[0]}, ${theme.colors[1]})`;
                item.dataset.themeId = theme.id;
                
                let costHTML = isUnlocked ? '<span class="text-xs text-green-300">Unlocked</span>' : `<span class="text-xs">💰 ${theme.cost}</span>`;
                item.innerHTML = `<span class="font-bold text-sm">${theme.name}</span>${costHTML}`;

                if (isUnlocked) {
                    item.addEventListener('click', () => {
                        playerData.activeSkin = theme.id;
                        applyTheme(theme.id);
                        localStorage.setItem('wordGreedPlayerData', JSON.stringify(playerData));
                        populateThemeStore(); // Refresh to show active state
                    });
                } else {
                    item.addEventListener('click', () => {
                        if (playerData.moneyBags >= theme.cost) {
                            playerData.moneyBags -= theme.cost;
                            playerData.unlockedSkins.push(theme.id);
                            playerData.activeSkin = theme.id;
                            applyTheme(theme.id);
                            localStorage.setItem('wordGreedPlayerData', JSON.stringify(playerData));
                            populateSetupModal(); // Refresh whole modal
                        } else {
                            showEventText("Not Enough Bags!");
                        }
                    });
                }
                container.appendChild(item);
            });
        }

        document.getElementById('player-name-input').addEventListener('change', (e) => {
            playerData.name = e.target.value;
            localStorage.setItem('wordGreedPlayerData', JSON.stringify(playerData));
        });

        document.getElementById('reset-progress-button').addEventListener('click', () => {
            document.getElementById('confirm-reset-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-reset-button').addEventListener('click', () => {
            document.getElementById('confirm-reset-modal').classList.add('hidden');
        });
        document.getElementById('confirm-reset-button').addEventListener('click', () => {
            playerData = getDefaultPlayerData();
            localStorage.removeItem('wordGreedPlayerData');
            populateSetupModal();
            applyTheme('default');
            document.getElementById('confirm-reset-modal').classList.add('hidden');
        });

        window.onload = initGame;
    </script>
</body>
</html>
